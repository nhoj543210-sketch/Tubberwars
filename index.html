<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>TUPPER WARS</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;image-rendering:pixelated;}
html,body{width:100%;height:100%;overflow:hidden;background:#000011;font-family:'Press Start 2P',monospace;user-select:none;touch-action:none;}

/* ── MAIN LAYOUT ── */
#app{display:flex;flex-direction:column;width:100vw;height:100vh;align-items:center;justify-content:center;}
#game-col{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;position:relative;}
#canvas-wrap{position:relative;flex-shrink:0;}
canvas{display:block;touch-action:none;}
#overlay-msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Press Start 2P',monospace;font-size:clamp(0.75rem,3vw,1.5rem);color:#fff;letter-spacing:2px;text-shadow:3px 3px 0 #000,0 0 18px #ff6b35;pointer-events:none;display:none;text-align:center;white-space:pre-line;line-height:1.6;background:rgba(0,0,0,0.55);padding:14px 22px;border:2px solid transparent;transition:color .3s,text-shadow .3s,border-color .3s,background .3s;}

/* ── IN-GAME HUD BAR ── */
#hud-bar{display:none;width:100%;max-width:900px;background:rgba(0,0,10,0.88);border-bottom:2px solid #ff6b35;padding:4px 12px;flex-direction:row;align-items:center;gap:10px;flex-shrink:0;}
.hud-cell{display:flex;flex-direction:column;align-items:center;min-width:60px;}
.hud-lbl{color:#a78bfa;font-size:0.3rem;letter-spacing:1px;text-transform:uppercase;margin-bottom:1px;}
.hud-val{color:#ffd166;font-size:0.52rem;}
#hud-shield-val{color:#00aaff;font-size:0.45rem;}
#hud-laser-wrap{display:flex;flex-direction:column;align-items:center;min-width:70px;}
#hud-lbar-bg{width:60px;height:4px;background:#222;margin-top:2px;}
#hud-lbar{height:100%;width:100%;background:linear-gradient(90deg,#06d6a0,#00ffcc);}
#hud-lives{display:flex;gap:2px;align-items:center;}
#hud-score{color:#ffd166;font-size:0.6rem;}
#hud-pause-btn{margin-left:auto;padding:4px 10px;background:#1a1a40;border:2px solid #4444aa;color:#aaaaff;font-family:'Press Start 2P',monospace;font-size:0.36rem;cursor:pointer;}

/* ── MAIN MENU OVERLAY ── */
#main-menu{position:fixed;top:0;left:0;width:100vw;height:100vh;height:100dvh;background:#00000a;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;overflow:hidden;}
#main-menu.hidden{display:none;}
#mm-bg-canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:block;}
#mm-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:space-evenly;width:100%;max-width:100%;height:100%;padding:clamp(8px,2vh,20px) 16px;gap:0;box-sizing:border-box;}
#mm-canvas{display:block;margin:0;width:min(480px,88vw);max-width:88vw;height:auto;}
#mm-sub{font-size:clamp(0.28rem,1.5vw,0.62rem);color:#ff6600;letter-spacing:1px;text-align:center;text-shadow:0 0 12px #ff440055;margin:0;}
#mm-buttons{display:flex;flex-direction:column;align-items:center;gap:clamp(5px,1.2vh,11px);width:min(320px,90vw);}
.mm-btn{width:100%;padding:clamp(7px,1.6vh,13px) 0;border:3px solid;font-family:'Press Start 2P',monospace;font-size:clamp(0.42rem,1.6vw,0.76rem);cursor:pointer;letter-spacing:2px;transition:transform .07s,box-shadow .07s,opacity .07s;text-align:center;}
.mm-btn:hover{transform:scale(1.03);opacity:0.9;}
.mm-btn:active{transform:scale(0.96);}
#mm-play{background:#cc3300;border-color:#ff6b35;color:#fff;box-shadow:0 4px 0 #550000,0 0 20px #ff330033;}
#mm-levels{background:#3a1070;border-color:#a78bfa;color:#ddd;box-shadow:0 4px 0 #1a0040;}
#mm-scores{background:#001a10;border-color:#06d6a0;color:#06d6a0;box-shadow:0 4px 0 #001a08;}
#mm-diff{display:flex;gap:6px;justify-content:center;margin-top:4px;}
.mm-diff-btn{padding:clamp(4px,1vh,7px) clamp(8px,2vw,14px);border:2px solid #333;color:#555;font-family:'Press Start 2P',monospace;font-size:clamp(0.3rem,1.2vw,0.38rem);cursor:pointer;background:#0a0a0a;transition:all .15s;}
.mm-diff-btn.sel{color:#ff9f1c;border-color:#ff9f1c;background:rgba(255,159,28,0.12);box-shadow:0 0 8px #ff9f1c44;}
#mm-footer{color:#2a2a2a;font-size:clamp(0.2rem,0.9vw,0.3rem);text-align:center;line-height:2;margin:0;}

/* ── SCOREBOARD SCREEN ── */
#scores-screen{position:fixed;top:0;left:0;width:100vw;height:100vh;height:100dvh;background:#000011;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:400;gap:12px;}
.sb-ttl{color:#ff6b35;font-size:0.6rem;letter-spacing:4px;text-align:center;}
#sb-list{display:flex;flex-direction:column;gap:4px;width:min(400px,90vw);}
.sbr{display:flex;align-items:center;gap:6px;padding:5px 8px;font-size:0.4rem;background:rgba(255,255,255,0.03);border:1px solid #222;}
.sbr.gold{background:rgba(255,209,102,0.11);border-color:rgba(255,209,102,0.4);}
.sbr.silver{background:rgba(180,180,180,0.07);border-color:#444;}
.sbr.bronze{background:rgba(200,120,50,0.08);border-color:#553311;}
.sbr-rank{color:#a78bfa;width:20px;flex-shrink:0;}
.sbr-name{color:#fff;flex:1;}
.sbr-score{color:#ffd166;flex-shrink:0;}
#scores-back{padding:10px 24px;background:#222;border:2px solid #555;color:#aaa;font-family:'Press Start 2P',monospace;font-size:0.5rem;cursor:pointer;}

/* ── SHARED BOXES ── */
.sbox{background:rgba(255,255,255,0.04);border:2px solid #a78bfa;padding:4px 6px;text-align:center;}
.slbl{color:#a78bfa;font-size:0.38rem;letter-spacing:1px;text-transform:uppercase;}
.sval{color:#ffd166;font-size:0.65rem;line-height:1.4;}

/* Legacy sidebar (hidden, keep for HUD IDs) */
#sidebar{display:none;}
#play-btn{display:none;}
#levels-btn{display:none;}
#pause-btn{display:none;}

/* TOUCH CONTROLS */
#controls{display:none;justify-content:space-between;align-items:center;width:100%;padding:4px 10px 2px;flex-shrink:0;gap:4px;}
.btn-grp{display:flex;gap:6px;align-items:center;}
.c-btn-cv{display:block;border-radius:6px;border:3px solid #555;cursor:pointer;touch-action:none;flex-shrink:0;transition:transform .05s,opacity .05s;image-rendering:pixelated;background:rgba(0,0,0,0.5);}
.c-btn-cv.tapped{transform:scale(0.87);opacity:0.6;}
#cb-left,#cb-right{border-color:#a78bfa;}
#cb-fire{border-color:#ff6b35;}
#cb-laser{border-color:#06d6a0;}
#cb-shield{border-color:#00aaff;}
#cb-pause{border-color:#aaaaff;}
#hint{color:rgba(167,139,250,0.35);font-size:0.45rem;text-align:center;padding:1px 0 2px;flex-shrink:0;}

/* MODALS */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.88);display:none;align-items:center;justify-content:center;z-index:200;}
.modal-bg.show{display:flex;}
.mbox{background:#0d001a;border:4px solid #ff6b35;padding:18px 24px;display:flex;flex-direction:column;gap:10px;text-align:center;min-width:240px;max-width:94vw;max-height:90vh;overflow-y:auto;}
.mbox h2{color:#ff6b35;font-size:0.9rem;letter-spacing:2px;}
.mbox p{color:#a78bfa;font-size:0.42rem;line-height:1.6;}
#name-input{background:#000011;border:3px solid #a78bfa;color:#fff;font-family:'Press Start 2P',monospace;font-size:0.75rem;padding:7px 10px;outline:none;text-align:center;touch-action:auto;}
#name-input:focus{border-color:#ffd166;}
.mbtn{padding:8px;border:3px solid #fff;color:#fff;font-family:'Press Start 2P',monospace;font-size:0.65rem;cursor:pointer;transition:opacity .15s;}
.mbtn:hover{opacity:0.8;}
.mbtn.primary{background:#ff6b35;}
.mbtn.secondary{background:#7c3aed;border-color:#a78bfa;}

/* LEVELS GRID */
#lvl-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;padding:4px;}
.lc{padding:7px 2px;font-size:0.42rem;text-align:center;border:2px solid #222;color:#333;font-family:'Press Start 2P',monospace;}
.lc.open{color:#ffd166;border-color:#555;cursor:pointer;}
.lc.open:hover{background:rgba(167,139,250,0.15);border-color:#a78bfa;}
.lc.cur{color:#ff6b35;border-color:#ff6b35;background:rgba(255,107,53,0.1);}
.lc.boss{color:#ff4444;}
.lc.boss.open{border-color:#ff0040;}
.lc.boss.cur{border-color:#ff0040;background:rgba(255,0,64,0.1);}

/* PAUSE OVERLAY */
#pause-ov{position:fixed;inset:0;background:rgba(0,0,0,0.78);display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px;z-index:150;}
#pause-ov.show{display:flex;}
#pause-ov h2{font-size:1.4rem;color:#fff;text-shadow:3px 3px 0 #000;}
#pause-ov .mbtn{min-width:160px;}

/* PIXEL HEART LIVES */
.hrt{display:inline-block;width:13px;height:13px;margin:1px;image-rendering:pixelated;position:relative;}
.hrt.alive::before{content:'';position:absolute;inset:0;
  background:#ff2244;
  clip-path:polygon(25% 0%,50% 15%,75% 0%,100% 25%,100% 50%,50% 100%,0% 50%,0% 25%);}
.hrt.dead::before{content:'';position:absolute;inset:0;
  background:#333;
  clip-path:polygon(25% 0%,50% 15%,75% 0%,100% 25%,100% 50%,50% 100%,0% 50%,0% 25%);}
/* canvas button styles unified above */
/* RESPONSIVE */
@media(max-width:560px) and (orientation:landscape){#sidebar{width:118px;}.sval{font-size:0.56rem;}}
@media(max-width:360px) and (orientation:landscape){#sidebar{display:none;}}
@media(orientation:portrait){
  body{overflow:hidden;}
  #app{transform-origin:top left;transform:rotate(90deg) translateY(-100%);width:100vh;height:100vw;position:fixed;top:0;left:0;}
  #controls{padding:3px 8px 1px;}
  #cb-left,#cb-right{width:76px;height:76px;}
  #cb-fire,#cb-laser,#cb-shield{width:64px;height:64px;}
  #cb-pause{width:50px;height:50px;}
  #sidebar{width:128px;}
  .sval{font-size:0.55rem;}
  #name-modal,#levels-modal,#pause-ov,#lvlcomplete-modal{transform:rotate(-90deg) translateX(-100%);transform-origin:top left;width:100vw;height:100vh;top:0;left:0;}
  #main-menu,#scores-screen{transform:none !important;width:100vw !important;height:100vh !important;top:0 !important;left:0 !important;}
}
</style>
</head>
<body>

<!-- ══════════════ MAIN MENU ══════════════ -->
<div id="main-menu">
  <canvas id="mm-bg-canvas"></canvas>
  <div id="mm-content">
    <canvas id="mm-canvas" width="560" height="120"></canvas>
    <div id="mm-sub">30 LEVELS &nbsp;·&nbsp; 6 BOSSES &nbsp;·&nbsp; UNLIMITED CHAOS</div>
    <div id="mm-buttons">
      <button class="mm-btn" id="mm-play">▶ &nbsp; PLAY</button>
      <button class="mm-btn" id="mm-levels">LEVEL SELECT</button>
      <button class="mm-btn" id="mm-scores">HIGH SCORES</button>
      <div id="mm-diff">
        <button class="mm-diff-btn sel" data-d="easy">EASY</button>
        <button class="mm-diff-btn" data-d="medium">MEDIUM</button>
        <button class="mm-diff-btn" data-d="hard">HARD</button>
      </div>
    </div>
    <div id="mm-footer">A/D MOVE &nbsp;·&nbsp; SPACE FIRE &nbsp;·&nbsp; X LASER &nbsp;·&nbsp; B SHIELD &nbsp;·&nbsp; P PAUSE</div>
  </div>
</div>

<!-- ══════════════ SCORES SCREEN ══════════════ -->
<div id="scores-screen">
  <div class="sb-ttl">TOP SCORES</div>
  <div id="sb-list"></div>
  <button id="scores-back">BACK</button>
</div>

<!-- ══════════════ GAME ══════════════ -->
<div id="app">
  <!-- Hidden sidebar kept for HUD element IDs used by JS -->
  <div id="sidebar" style="display:none;">
    <div id="sb-logo"></div>
    <div class="sbox"><div class="slbl">Score</div><div class="sval" id="el-score">0</div></div>
    <div class="sbox"><div class="slbl">Level</div><div class="sval" id="el-level">1/30</div></div>
    <div class="sbox"><div class="slbl">Wave</div><div class="sval" id="el-wave">-</div></div>
    <div class="sbox"><div class="slbl">Lives</div><div class="sval" id="el-lives"></div></div>
    <div id="shield-box"><div id="shield-lbl"></div><div id="shield-val">READY</div></div>
    <div id="laser-box" class="ready"><div class="llbl"></div><div id="laser-status">READY!</div><div id="lbar-bg"><div id="lbar"></div></div></div>
    <div id="diff-box"><div id="diff-lbl"></div></div>
    <div id="scoreboard"><div class="sb-ttl"></div></div>
    <button id="play-btn" style="display:none;"></button>
    <button id="levels-btn" style="display:none;"></button>
    <button id="pause-btn" style="display:none;"></button>
  </div>

  <div id="game-col">
    <!-- HUD BAR shown during gameplay -->
    <div id="hud-bar">
      <div class="hud-cell">
        <div class="hud-lbl">SCORE</div>
        <div class="hud-val" id="hud-score-val">0</div>
      </div>
      <div class="hud-cell">
        <div class="hud-lbl">LEVEL</div>
        <div class="hud-val" id="hud-level-val">1/30</div>
      </div>
      <div class="hud-cell">
        <div class="hud-lbl">WAVE</div>
        <div class="hud-val" id="hud-wave-val">1</div>
      </div>
      <div class="hud-cell">
        <div class="hud-lbl">LIVES</div>
        <div id="hud-lives"></div>
      </div>
      <div id="hud-laser-wrap">
        <div class="hud-lbl">LASER</div>
        <div class="hud-val" id="hud-laser-val">READY</div>
        <div id="hud-lbar-bg"><div id="hud-lbar"></div></div>
      </div>
      <div class="hud-cell">
        <div class="hud-lbl">SHIELD</div>
        <div id="hud-shield-val">READY</div>
      </div>
      <div class="hud-cell" id="hud-diff-cell" style="margin-left:auto;">
        <div class="hud-lbl">MODE</div>
        <div class="hud-val" id="hud-diff-val" style="color:#ff9f1c;font-size:0.38rem;">EASY</div>
      </div>
      <button id="hud-pause-btn">PAUSE</button>
    </div>

    <div id="canvas-wrap">
      <canvas id="gameCanvas"></canvas>
      <div id="overlay-msg"></div>
    </div>
    <div id="controls">
      <div class="btn-grp">
        <canvas class="c-btn-cv" id="cb-left" width="80" height="80"></canvas>
        <canvas class="c-btn-cv" id="cb-right" width="80" height="80"></canvas>
      </div>
      <canvas class="c-btn-cv" id="cb-pause" width="52" height="52"></canvas>
      <div class="btn-grp">
        <canvas class="c-btn-cv" id="cb-fire" width="72" height="72"></canvas>
        <canvas class="c-btn-cv" id="cb-laser" width="72" height="72"></canvas>
        <canvas class="c-btn-cv" id="cb-shield" width="72" height="72"></canvas>
      </div>
    </div>
    <div id="hint" style="display:none;">A/D Move · Space Fire · X Laser · B Shield · P Pause</div>
  </div>
</div>

<!-- NAME MODAL -->
<div class="modal-bg" id="name-modal">
  <div class="mbox">
    <h2>GAME OVER</h2>
    <p>Enter your name for the leaderboard</p>
    <input id="name-input" maxlength="12" placeholder="Your name…" autocomplete="off"/>
    <button class="mbtn primary" id="name-ok">SUBMIT</button>
  </div>
</div>

<!-- LEVELS MODAL -->
<div class="modal-bg" id="levels-modal">
  <div class="mbox">
    <h2>SELECT LEVEL</h2>
    <p>Boss every 5th level · Red = Boss stage</p>
    <div id="lvl-grid"></div>
    <button class="mbtn secondary" id="lvl-close">CLOSE</button>
  </div>
</div>

<!-- PAUSE -->
<div id="pause-ov">
  <h2>PAUSED</h2>
  <button class="mbtn primary" id="resume-btn">RESUME</button>
  <button class="mbtn secondary" id="quit-btn">QUIT</button>
</div>

<!-- LEVEL COMPLETE MODAL -->
<div class="modal-bg" id="lvlcomplete-modal">
  <div class="mbox" style="gap:12px;">
    <h2 id="lc-title" style="color:#ffd166;">LEVEL COMPLETE!</h2>
    <p id="lc-sub" style="font-size:0.55rem;color:#fff;">Stage cleared!</p>
    <p id="lc-score" style="font-size:0.55rem;color:#ffd166;"></p>
    <button class="mbtn primary" id="lc-continue">▶ NEXT LEVEL</button>
    <button class="mbtn secondary" id="lc-levels">LEVEL SELECT</button>
    <button class="mbtn" style="background:#222;border-color:#555;" id="lc-menu">MAIN MENU</button>
  </div>
</div>

<script>
'use strict';
// ═══════════════════════════════════════════════════
//  AUDIO ENGINE
// ═══════════════════════════════════════════════════
let AC=null,MG=null,bgmOn=false,laserNodes=[],bgmTO=null,bossTO=null,_bgmSection=0;
function ga(){
  if(!AC){AC=new(window.AudioContext||window.webkitAudioContext)();MG=AC.createGain();MG.gain.value=0.30;MG.connect(AC.destination);}
  if(AC.state==='suspended')AC.resume();return AC;
}
function tone(f,tp,t,dur,v,sl){
  const ac=ga(),o=ac.createOscillator(),g=ac.createGain();
  o.connect(g);g.connect(MG);o.type=tp||'square';o.frequency.setValueAtTime(f,t);
  if(sl!==undefined)o.frequency.linearRampToValueAtTime(sl,t+dur);
  g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.start(t);o.stop(t+dur+0.02);return o;
}
function noise(t,dur,v,ff){
  const ac=ga(),len=Math.ceil(ac.sampleRate*dur),buf=ac.createBuffer(1,len,ac.sampleRate);
  const d=buf.getChannelData(0);for(let i=0;i<len;i++)d[i]=Math.random()*2-1;
  const s=ac.createBufferSource();s.buffer=buf;
  const fl=ac.createBiquadFilter();fl.type='bandpass';fl.frequency.value=ff||800;fl.Q.value=0.5;
  const g=ac.createGain();g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  s.connect(fl);fl.connect(g);g.connect(MG);s.start(t);s.stop(t+dur+0.02);
}

function sfxShoot(){const ac=ga(),t=ac.currentTime;tone(1800,'sawtooth',t,0.17,0.26,180);tone(900,'sawtooth',t,0.13,0.13,280);tone(3000,'square',t,0.02,0.16,80);tone(120,'sine',t,0.07,0.26,120);}
function sfxLaserStart(){
  sfxLaserStop();const ac=ga(),t=ac.currentTime;
  const w=ac.createOscillator(),wg=ac.createGain();w.connect(wg);wg.connect(MG);w.type='sawtooth';
  w.frequency.setValueAtTime(200,t);w.frequency.exponentialRampToValueAtTime(6000,t+0.6);
  wg.gain.setValueAtTime(0,t);wg.gain.linearRampToValueAtTime(0.38,t+0.3);wg.gain.linearRampToValueAtTime(0.55,t+0.58);wg.gain.linearRampToValueAtTime(0,t+0.62);
  w.start(t);w.stop(t+0.65);laserNodes.push(w);
  const bT=t+0.60;
  const sub=ac.createOscillator(),sg=ac.createGain();sub.connect(sg);sg.connect(MG);sub.type='sine';
  sub.frequency.setValueAtTime(80,bT);sub.frequency.exponentialRampToValueAtTime(20,bT+1.4);
  sg.gain.setValueAtTime(0.8,bT);sg.gain.exponentialRampToValueAtTime(0.0001,bT+1.4);sub.start(bT);sub.stop(bT+1.5);laserNodes.push(sub);
  noise(bT,0.06,0.9,300);noise(bT+0.05,0.15,0.7,200);noise(bT+0.18,0.4,0.5,120);noise(bT+0.55,0.6,0.3,80);
  const hum=ac.createOscillator(),hg=ac.createGain(),lfo=ac.createOscillator(),lg=ac.createGain();
  lfo.frequency.value=14;lg.gain.value=60;lfo.connect(lg);lg.connect(hum.frequency);hum.connect(hg);hg.connect(MG);
  hum.type='sawtooth';hum.frequency.setValueAtTime(55,bT+0.05);hg.gain.setValueAtTime(0,bT);hg.gain.linearRampToValueAtTime(0.22,bT+0.3);
  hum.start(bT);lfo.start(bT);laserNodes.push(hum);laserNodes.push(lfo);laserNodes._hg=hg;
}
function sfxLaserStop(){
  if(!laserNodes.length)return;const ac=ga();
  if(laserNodes._hg){try{laserNodes._hg.gain.setValueAtTime(laserNodes._hg.gain.value,ac.currentTime);laserNodes._hg.gain.linearRampToValueAtTime(0,ac.currentTime+0.25);}catch(e){}}
  laserNodes.forEach(n=>{try{n.stop(ac.currentTime+0.28);}catch(e){}});laserNodes=[];
}
function sfxExplode(big){
  const ac=ga(),t=ac.currentTime,fs=big?[55,40,70,35,90]:[140,110,180];
  fs.forEach((f,i)=>{tone(f,'sawtooth',t+i*0.025,big?.5:.22,big?.28:.18,f*0.25);tone(f*2,'square',t+i*0.025,big?.35:.16,big?.14:.09,f*0.18);});
  noise(t,big?.5:.22,big?.55:.28,big?200:500);
}
function sfxBossAlarm(){const ac=ga(),t=ac.currentTime;for(let i=0;i<5;i++){tone(180,'square',t+i*.2,.12,.3,360);tone(360,'square',t+i*.2+.1,.1,.2,180);}}
function sfxBossWin(){const ac=ga(),t=ac.currentTime;[523,659,784,1047,784,1047,1319,1047,1319,1568].forEach((f,i)=>tone(f,'square',t+i*.075,.09,.28,f*1.04));sfxExplode(true);noise(t+.1,.8,.4,150);}
function sfxHit(){const ac=ga(),t=ac.currentTime;tone(800,'square',t,.05,.22,400);tone(400,'square',t+.04,.08,.16,200);noise(t,.07,.14,2000);}
function sfxLoseLife(){const ac=ga(),t=ac.currentTime;tone(440,'square',t,.12,.3,220);tone(330,'square',t+.1,.12,.25,165);tone(220,'sawtooth',t+.22,.22,.35,80);noise(t+.22,.25,.12,300);}
function sfxGameOver(){sfxLaserStop();stopBGM();const ac=ga(),t=ac.currentTime;[440,349,294,220,196,165,147,110].forEach((f,i)=>tone(f,'square',t+i*.16,.20,.28-i*.02));}
function sfxWaveDone(){const ac=ga(),t=ac.currentTime;[523,659,784,659,784,1047].forEach((f,i)=>tone(f,'square',t+i*.1,.12,.22));}
function sfxLevelUp(){const ac=ga(),t=ac.currentTime;[392,494,587,784,1047,1319].forEach((f,i)=>tone(f,'square',t+i*.09,.13,.28));}
function sfxBossLaserSfx(){const ac=ga(),t=ac.currentTime;tone(400,'sawtooth',t,.05,.28,2200);noise(t+.04,.09,.22,3200);}
function sfxLidSlam(){const ac=ga(),t=ac.currentTime;noise(t,.08,.6,120);tone(60,'sine',t,.15,.45,30);tone(180,'square',t,.06,.22,80);}
function sfxIceRing(){const ac=ga(),t=ac.currentTime;for(let i=0;i<8;i++){tone(2000+i*200,'triangle',t+i*.04,.06,.12,1000+i*100);noise(t+i*.04,.03,.06,6000);}
}
function sfxHeatWave(){const ac=ga(),t=ac.currentTime;for(let i=0;i<5;i++){tone(200-i*20,'sawtooth',t+i*.06,.1,.20,80);noise(t+i*.06,.08,.14,500+i*100);}}
function sfxBarrage(){const ac=ga(),t=ac.currentTime;for(let i=0;i<6;i++){tone(1600,'sawtooth',t+i*.05,.04,.18,200);tone(800,'square',t+i*.05,.03,.10,100);}}

function sfxBubbleActivate(){
  const ac=ga(),t=ac.currentTime;
  tone(1000,'sine',t,.03,.12,2000);tone(1500,'triangle',t+.06,.04,.10,3000);
  tone(500,'sine',t+.1,.05,.08,1000);noise(t,.04,.06,5000);
}

// BGM — "TUPPER WARS EPIC" theme  (D-minor, 160bpm feel)
// Beat grid: _b=1/16 note, _q=1/4, _h=1/2  at 160bpm→ _q≈0.1875s
const _b=0.09375,_q=0.1875,_h=0.375;

// ── SECTION A: Tense build — heavy bass ostinato + sparse lead ──
const BGM_A_BASS=[
  [147,_h],[0,_b],[147,_b],[175,_q],[0,_q],
  [147,_h],[0,_b],[131,_b],[147,_q],[0,_q],
  [175,_h],[0,_b],[175,_b],[196,_q],[0,_q],
  [175,_h],[0,_b],[165,_b],[147,_q],[0,_q],
  [131,_h],[0,_b],[131,_b],[147,_q],[0,_q],
  [131,_h],[0,_b],[117,_b],[131,_q],[0,_q],
  [110,_h],[0,_b],[110,_b],[117,_q],[0,_q],
  [147,_h],[165,_q],[175,_h],[0,_h],
];
const BGM_A_LEAD=[
  [0,_h],[0,_h],[294,_b],[330,_b],[349,_q],[330,_q],
  [294,_h],[262,_q],[294,_q],[0,_h],
  [0,_h],[0,_h],[392,_b],[440,_b],[494,_q],[440,_q],
  [392,_h],[349,_q],[330,_q],[0,_h],
  [0,_h],[0,_h],[523,_b],[494,_b],[466,_q],[440,_q],
  [415,_h],[392,_q],[349,_q],[0,_h],
  [0,_h],[294,_q],[349,_q],[392,_q],[440,_q],
  [494,_h],[523,_h],[0,_h],[0,_h],
];

// ── SECTION B: Epic drive — galloping arp + triumphant lead ──
const BGM_B_BASS=[
  [147,_b],[0,_b],[147,_b],[0,_b],[175,_b],[0,_b],[175,_b],[0,_b],
  [196,_b],[0,_b],[175,_b],[0,_b],[165,_b],[0,_b],[147,_b],[0,_b],
  [131,_b],[0,_b],[131,_b],[0,_b],[147,_b],[0,_b],[147,_b],[0,_b],
  [117,_b],[0,_b],[131,_b],[0,_b],[147,_b],[0,_b],[165,_b],[0,_b],
  [175,_b],[0,_b],[175,_b],[0,_b],[196,_b],[0,_b],[196,_b],[0,_b],
  [208,_b],[0,_b],[196,_b],[0,_b],[175,_b],[0,_b],[165,_b],[0,_b],
  [147,_b],[0,_b],[165,_b],[0,_b],[175,_b],[0,_b],[196,_b],[0,_b],
  [220,_b],[0,_b],[196,_b],[0,_b],[175,_b],[165,_b],[147,_b],[0,_b],
];
const BGM_B_LEAD=[
  [0,_q],[588,_b],[659,_b],[698,_q],[659,_q],[588,_h],
  [0,_q],[523,_b],[588,_b],[659,_q],[698,_q],[784,_h],
  [0,_q],[698,_b],[784,_b],[880,_q],[784,_q],[698,_h],
  [0,_q],[659,_b],[698,_b],[784,_q],[698,_q],[659,_h],
  [0,_q],[523,_b],[588,_b],[659,_q],[588,_q],[523,_h],
  [0,_q],[494,_b],[523,_b],[588,_q],[523,_q],[494,_h],
  [0,_q],[440,_b],[494,_b],[523,_q],[588,_q],[659,_h],
  [0,_q],[784,_b],[880,_b],[988,_q],[880,_q],[784,_h],
];
const BGM_B_ARP=[
  [294,_b],[349,_b],[440,_b],[523,_b],[294,_b],[349,_b],[440,_b],[523,_b],
  [392,_b],[466,_b],[523,_b],[587,_b],[392,_b],[466,_b],[523,_b],[587,_b],
  [349,_b],[440,_b],[523,_b],[659,_b],[349,_b],[440,_b],[523,_b],[659,_b],
  [330,_b],[415,_b],[494,_b],[587,_b],[330,_b],[415,_b],[494,_b],[587,_b],
  [262,_b],[330,_b],[392,_b],[494,_b],[262,_b],[330,_b],[392,_b],[494,_b],
  [247,_b],[311,_b],[370,_b],[466,_b],[247,_b],[311,_b],[370,_b],[466,_b],
  [220,_b],[277,_b],[330,_b],[415,_b],[220,_b],[277,_b],[330,_b],[415,_b],
  [294,_b],[370,_b],[440,_b],[554,_b],[659,_b],[554,_b],[440,_b],[370,_b],
];

// ── SECTION C: Fury — fast chromatic runs, dense texture ──
const BGM_C_BASS=[
  [147,_b],[155,_b],[165,_b],[175,_b],[0,_b],[175,_b],[165,_b],[0,_b],
  [155,_b],[147,_b],[0,_b],[147,_b],[131,_b],[0,_b],[131,_b],[0,_b],
  [196,_b],[208,_b],[220,_b],[233,_b],[0,_b],[220,_b],[208,_b],[0,_b],
  [196,_b],[175,_b],[0,_b],[165,_b],[147,_b],[0,_b],[131,_b],[0,_b],
  [110,_b],[117,_b],[131,_b],[147,_b],[0,_b],[147,_b],[131,_b],[0,_b],
  [117,_b],[110,_b],[0,_b],[110,_b],[98,_b],[0,_b],[98,_b],[0,_b],
  [131,_b],[147,_b],[165,_b],[175,_b],[196,_b],[175,_b],[165,_b],[147,_b],
  [131,_b],[147,_b],[165,_b],[175,_b],[196,_b],[220,_b],[247,_b],[294,_b],
];
const BGM_C_LEAD=[
  [588,_b],[659,_b],[698,_b],[784,_b],[0,_b],[784,_b],[698,_b],[659,_b],
  [588,_b],[523,_b],[0,_b],[523,_b],[494,_b],[0,_b],[523,_b],[0,_b],
  [784,_b],[880,_b],[988,_b],[1047,_b],[0,_b],[988,_b],[880,_b],[784,_b],
  [698,_b],[659,_b],[0,_b],[588,_b],[523,_b],[0,_b],[466,_b],[0,_b],
  [523,_b],[494,_b],[466,_b],[440,_b],[0,_b],[440,_b],[466,_b],[494,_b],
  [523,_b],[587,_b],[0,_b],[659,_b],[698,_b],[0,_b],[784,_b],[0,_b],
  [880,_b],[0,_b],[784,_b],[0,_b],[698,_b],[0,_b],[659,_b],[0,_b],
  [588,_b],[523,_b],[494,_b],[523,_b],[588,_b],[523,_b],[494,_b],[440,_b],
];

function schedV(tr,wt,st,v,sp){
  const ac=ga();let t=st;sp=sp||1;
  for(const[f,d]of tr){const rd=(d/sp);if(f>0)tone(f,wt,t,rd*.86,v);t+=rd;}
  return t-st;
}

function scheduleBGM(){
  if(!bgmOn)return;
  const ac=ga(),t=ac.currentTime+.04;
  const sp=Math.min(1.7,1+(curLevel-1)*.03);
  let dur=0;

  if(_bgmSection===0){
    // Section A: tense build
    const bl=schedV(BGM_A_BASS,'square',t,.26,sp);
    const ll=schedV(BGM_A_LEAD,'sawtooth',t,.16,sp);
    // Percussion: kick on beats 1&3, snare on 2&4
    const bLen=_q/sp,barLen=_h/sp;
    for(let b=0;b<8;b++){
      if(b%2===0){noise(t+b*barLen,.05/sp,.30,100);tone(55,'sine',t+b*barLen,.12/sp,.28,28);}
      else{noise(t+b*barLen,.04/sp,.18,3500);}
      // hi-hat every 8th
      for(let hh=0;hh<4;hh++)noise(t+b*barLen+hh*bLen,.02/sp,.06,8000);
    }
    dur=Math.max(bl,ll);
  } else if(_bgmSection===1){
    // Section B: epic drive
    const bl=schedV(BGM_B_BASS,'square',t,.30,sp);
    const ll=schedV(BGM_B_LEAD,'sawtooth',t,.18,sp);
    const al=schedV(BGM_B_ARP,'triangle',t,.10,sp);
    // Dense percussion
    const bLen=_q/sp;
    for(let b=0;b<8;b++){
      noise(t+b*bLen*2,.06/sp,.35,120);tone(49,'sine',t+b*bLen*2,.14/sp,.32,22);// kick
      noise(t+b*bLen*2+bLen,.04/sp,.22,4000);// snare
      noise(t+b*bLen*2+bLen*.5,.018/sp,.08,9000);// hi-hat off
      noise(t+b*bLen*2+bLen*1.5,.018/sp,.08,9000);
    }
    dur=Math.max(bl,ll,al);
  } else {
    // Section C: fury
    const bl=schedV(BGM_C_BASS,'sawtooth',t,.28,sp);
    const ll=schedV(BGM_C_LEAD,'sawtooth',t,.15,sp);
    const al=schedV(BGM_B_ARP,'triangle',t,.08,sp);// reuse arp
    // Blast-beat percussion
    const bLen=_b/sp;
    for(let b=0;b<32;b++){
      if(b%4===0){noise(t+b*bLen,.05/sp,.30,90);tone(44,'sine',t+b*bLen,.08/sp,.25,22);}
      noise(t+b*bLen,.015/sp,.05,10000);// continuous hi-hat
      if(b%8===4)noise(t+b*bLen,.04/sp,.20,3800);// snare
    }
    dur=Math.max(bl,ll,al);
  }
  _bgmSection=(_bgmSection+1)%3;
  bgmTO=setTimeout(scheduleBGM,(dur-.06)*1000);
}

function startBGM(){if(bgmOn)return;bgmOn=true;_bgmSection=0;scheduleBGM();}
function stopBGM(){bgmOn=false;if(bgmTO){clearTimeout(bgmTO);bgmTO=null;}if(bossTO){clearTimeout(bossTO);bossTO=null;}sfxLaserStop();}

// ══ 6 UNIQUE BOSS BGM THEMES ══════════════════════════════
// Boss 1 (L5)  — "THE LID KING" — slow heavy march, deep bass
// Boss 2 (L10) — "FROSTLOCK"    — cold arpeggios, icy glitch
// Boss 3 (L15) — "SAUCEPAN SAM" — jazzy chromatic stabs
// Boss 4 (L20) — "CRISPER LORD" — industrial hammer beat
// Boss 5 (L25) — "THERMOS PRIME"— space ambient dread
// Boss 6 (L30) — "THE SEAL"     — final boss, epic full mix

// Boss 1: Heavy stomping march in E minor
const B1_BASS=[[82,_h],[0,_q],[82,_q],[87,_h],[0,_q],[87,_q],[98,_h],[0,_q],[87,_q],[82,_q],[78,_q],[0,_h],[73,_h],[0,_q],[73,_q],[78,_h],[0,_q],[78,_q],[82,_h],[0,_q],[78,_q],[73,_q],[69,_q],[0,_h]];
const B1_LEAD=[[0,_h],[165,_b],[175,_b],[196,_q],[175,_q],[165,_h],[0,_h],[0,_h],[147,_b],[165,_b],[175,_q],[165,_q],[147,_q],[131,_q],[0,_h],[0,_h],[196,_b],[208,_b],[220,_q],[208,_q],[196,_h],[0,_h],[0,_h],[175,_q],[165,_q],[147,_q],[131,_q],[165,_h],[0,_h]];

// Boss 2: Cold icy glitch in C minor (high register)
const B2_BASS=[[65,_q],[0,_q],[65,_q],[0,_q],[69,_q],[0,_q],[78,_q],[0,_q],[65,_q],[0,_q],[65,_q],[0,_q],[62,_q],[0,_q],[58,_q],[0,_q],[65,_q],[0,_q],[65,_q],[0,_q],[73,_q],[0,_q],[78,_q],[0,_q],[65,_q],[0,_q],[58,_q],[0,_q],[65,_h],[0,_h]];
const B2_ARP=[[523,_b],[0,_b],[587,_b],[0,_b],[622,_b],[0,_b],[587,_b],[0,_b],[523,_b],[0,_b],[494,_b],[0,_b],[523,_b],[0,_b],[466,_b],[0,_b],[523,_b],[0,_b],[554,_b],[0,_b],[587,_b],[0,_b],[622,_b],[0,_b],[587,_b],[0,_b],[523,_b],[0,_b],[466,_b],[0,_b],[440,_b],[0,_b]];

// Boss 3: Jazzy chromatic evil swing
const B3_BASS=[[110,_q],[116,_q],[110,_q],[0,_q],[104,_q],[0,_q],[98,_q],[104,_q],[110,_q],[0,_q],[116,_q],[0,_q],[123,_q],[116,_q],[110,_q],[0,_q],[98,_q],[0,_q],[104,_q],[110,_q],[116,_q],[0,_q],[123,_q],[0,_q],[116,_q],[110,_q],[104,_q],[98,_q],[110,_h],[0,_h]];
const B3_STAB=[[440,_b],[0,_b],[0,_b],[0,_b],[466,_b],[0,_b],[0,_b],[0,_b],[440,_b],[0,_b],[415,_b],[0,_b],[0,_b],[0,_b],[0,_b],[0,_b],[466,_b],[0,_b],[0,_b],[0,_b],[494,_b],[0,_b],[0,_b],[0,_b],[466,_b],[0,_b],[440,_b],[0,_b],[0,_b],[0,_b],[0,_b],[0,_b]];

// Boss 4: Industrial hammer — syncopated hard beat
const B4_BASS=[[55,_b],[0,_b],[55,_b],[55,_b],[0,_b],[58,_b],[0,_b],[55,_b],[52,_b],[0,_b],[52,_b],[52,_b],[0,_b],[49,_b],[0,_b],[52,_b],[55,_b],[0,_b],[55,_b],[55,_b],[0,_b],[62,_b],[0,_b],[55,_b],[49,_b],[0,_b],[49,_b],[52,_b],[0,_b],[55,_b],[0,_b],[49,_b]];
const B4_LEAD=[[220,_q],[0,_q],[233,_q],[0,_q],[220,_q],[0,_q],[208,_q],[0,_q],[220,_q],[0,_q],[247,_q],[0,_q],[262,_q],[0,_q],[247,_q],[0,_q],[220,_q],[0,_q],[233,_q],[0,_q],[247,_q],[0,_q],[262,_q],[0,_q],[277,_q],[0,_q],[262,_q],[0,_q],[247,_q],[220,_q],[0,_h],[0,_h]];

// Boss 5: Space ambient dread — slow, vast, menacing
const B5_PAD=[[55,_h],[0,_h],[58,_h],[0,_h],[55,_h],[0,_h],[52,_h],[0,_h],[49,_h],[0,_h],[52,_h],[0,_h],[55,_h],[0,_h],[58,_h],[0,_h]];
const B5_DRONE=[[110,2.0],[0,0.5],[116,1.5],[0,0.5],[110,1.0],[0,0.5],[104,2.0],[0,0.5],[98,1.5],[0,0.5],[104,1.0],[0,0.5],[110,2.0],[0,1.0]];

// Boss 6: THE SEAL — epic final boss, all voices
const B6_BASS=[[82,_h],[0,_q],[87,_q],[98,_h],[0,_q],[87,_q],[82,_q],[78,_q],[0,_h],[73,_h],[0,_q],[78,_q],[82,_h],[0,_h],[87,_h],[0,_q],[87,_q],[98,_h],[0,_q],[104,_q],[98,_q],[87,_q],[0,_h],[82,_h],[78,_h],[0,_h]];
const B6_LEAD=[[0,_q],[165,_b],[196,_b],[220,_q],[196,_q],[220,_h],[0,_h],[0,_q],[208,_b],[220,_b],[247,_q],[220,_q],[208,_h],[0,_h],[0,_q],[196,_b],[208,_b],[220,_q],[247,_q],[262,_h],[0,_h],[0,_q],[294,_b],[262,_b],[247,_q],[220,_q],[196,_h],[0,_h],[0,_q],[220,_b],[196,_b],[175,_q],[165,_q],[196,_h],[0,_h]];
const B6_HARM=[[0,_h],[330,_b],[349,_b],[392,_q],[349,_q],[392,_h],[0,_h],[0,_h],[370,_b],[392,_b],[415,_q],[392,_q],[370,_h],[0,_h]];

function getBossTier(){return Math.ceil(curLevel/5);}// 1-6

function scheduleBoss(){
  if(!bgmOn)return;
  const ac=ga(),t=ac.currentTime+.04;
  const tier=getBossTier();
  const sp=Math.min(1.8,1+(tier-1)*.15);

  if(tier===1){
    let bt=t;for(const[f,d]of B1_BASS){if(f>0)tone(f,'square',bt,(d/sp)*.88,.30);bt+=d/sp;}
    let lt=t;for(const[f,d]of B1_LEAD){if(f>0)tone(f,'square',lt,(d/sp)*.84,.16);lt+=d/sp;}
    // War drums
    const dp=[_h,_q,_q,_h,_h,_q,_q,_h,_h,_q,_q,_h,_h,_q,_q,_h];
    let dt=t;dp.forEach((d,i)=>{if(i%4===0){noise(dt,.09/sp,.35,160);tone(55,'sine',dt,.14/sp,.28,28);}else if(i%4===2)noise(dt,.05/sp,.14,4800);dt+=d/sp;});
    bossTO=setTimeout(scheduleBoss,(Math.max(bt,dt)-t-.08)*1000);
  } else if(tier===2){
    let bt=t;for(const[f,d]of B2_BASS){if(f>0)tone(f,'square',bt,(d/sp)*.9,.28);bt+=d/sp;}
    let at=t;for(const[f,d]of B2_ARP){if(f>0)tone(f,'triangle',at,(d/sp)*.75,.12);at+=d/sp;}
    // Ice clinks
    for(let i=0;i<6;i++)noise(t+i*0.3/sp,.04,.08,8000+i*400);
    bossTO=setTimeout(scheduleBoss,(Math.max(bt,at)-t-.08)*1000);
  } else if(tier===3){
    let bt=t;for(const[f,d]of B3_BASS){if(f>0)tone(f,'sawtooth',bt,(d/sp)*.82,.26);bt+=d/sp;}
    let st=t;for(const[f,d]of B3_STAB){if(f>0){tone(f,'square',st,(d/sp)*.55,.20);tone(f*1.5,'square',st,(d/sp)*.45,.10);}st+=d/sp;}
    // Jazz snare pattern
    const jp=[_q,_q,_b,_b,_q,_q,_b,_b,_q,_q];let jt=t;
    jp.forEach((d,i)=>{if(i%3!==1)noise(jt,0.03/sp,.09,3500+i*200);jt+=d/sp;});
    bossTO=setTimeout(scheduleBoss,(Math.max(bt,st)-t-.08)*1000);
  } else if(tier===4){
    let bt=t;for(const[f,d]of B4_BASS){if(f>0)tone(f,'sawtooth',bt,(d/sp)*.72,.32);bt+=d/sp;}
    let lt=t;for(const[f,d]of B4_LEAD){if(f>0)tone(f,'square',lt,(d/sp)*.80,.18);lt+=d/sp;}
    // Industrial hammer hits
    for(let i=0;i<8;i++){noise(t+i*_q/sp,.06/sp,.28,300+i*50);if(i%2===0)tone(40,'sine',t+i*_q/sp,.1/sp,.22,25);}
    bossTO=setTimeout(scheduleBoss,(Math.max(bt,lt)-t-.08)*1000);
  } else if(tier===5){
    let pt=t;for(const[f,d]of B5_PAD){if(f>0){tone(f,'sine',pt,d*.92,.15);tone(f*2,'triangle',pt,d*.85,.08);}pt+=d;}
    let dr=t;for(const[f,d]of B5_DRONE){if(f>0){tone(f,'sawtooth',dr,d*.95,.20);tone(f*1.02,'sawtooth',dr,d*.95,.10);} dr+=d;}
    // Ambient whooshes
    for(let i=0;i<3;i++)noise(t+i*1.2,.6,.12,180+i*60);
    bossTO=setTimeout(scheduleBoss,(Math.max(pt,dr)-t-.12)*1000);
  } else {
    // TIER 6 — SUPERNOVA TUPPERWARE: xtrullor-inspired massive build
    // Phase 1: ominous intro (bars 1-4)
    const _8=_b*2;
    let bt=t;for(const[f,d]of B6_BASS){if(f>0){tone(f,'sawtooth',bt,(d/sp)*.92,.35);tone(f*0.5,'sine',bt,(d/sp)*.95,.18);}bt+=d/sp;}
    let lt=t;for(const[f,d]of B6_LEAD){if(f>0){tone(f,'sawtooth',lt,(d/sp)*.82,.22);tone(f*2,'square',lt,(d/sp)*.70,.06);}lt+=d/sp;}
    let ht=t;for(const[f,d]of B6_HARM){if(f>0){tone(f,'triangle',ht,(d/sp)*.88,.16);tone(f*1.5,'sine',ht,(d/sp)*.75,.08);}ht+=d/sp;}
    // Epic build percussion — doubled density
    const fp=[_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,
              _8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8];
    let dt=t;fp.forEach((d,i)=>{
      if(i%8===0){noise(dt,.07/sp,.45,80);tone(41,'sine',dt,.16/sp,.38,20);tone(82,'sine',dt,.14/sp,.20,20);}
      else if(i%8===4){noise(dt,.05/sp,.28,4500);}
      else if(i%8===2||i%8===6){noise(dt,.02/sp,.12,9000);}
      // Rising sweep every 16 beats
      if(i%16===15){tone(55+i*2,'sawtooth',dt,.25/sp,.08,880);}
      dt+=d/sp;
    });
    // Supernova "impact" pads — wide chords
    const chords=[[294,370,440,554],[262,330,415,494],[220,277,349,440],[247,311,392,466]];
    chords.forEach((chord,ci)=>{
      const ct=t+ci*(bt-t)/4;
      chord.forEach(f=>tone(f,'triangle',ct,((bt-t)/4)*.90,.07));
    });
    // Rising noise sweep (signature xtrullor build-up feel)
    for(let i=0;i<8;i++){
      const nt=t+i*(bt-t)/8;
      noise(nt,.12/sp,.04+i*.015,400+i*800);
    }
    bossTO=setTimeout(scheduleBoss,(Math.max(bt,lt,ht,dt)-t-.08)*1000);
  }
}
function startBossBGM(){stopBGM();bgmOn=true;scheduleBoss();}

// ═══════════════════════════════════════════════════
//  CANVAS
// ═══════════════════════════════════════════════════
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const GW=900,GH=560;
canvas.width=GW;canvas.height=GH;
function resizeCanvas(){
  const ctrls=document.getElementById('controls');
  const hudBar=document.getElementById('hud-bar');
  const cv=ctrls&&ctrls.style.display==='flex';
  const isP=window.innerHeight>window.innerWidth;
  const lW=isP?window.innerHeight:window.innerWidth;
  const lH=isP?window.innerWidth:window.innerHeight;
  const hudH=(hudBar&&hudBar.style.display==='flex')?hudBar.offsetHeight:0;
  const ctrlH=cv?(ctrls.offsetHeight+8):0;
  const aW=lW-8, aH=lH-hudH-ctrlH-8;
  let cw=Math.min(aW,aH*GW/GH),ch=cw*GH/GW;
  if(ch>aH){ch=aH;cw=ch*GW/GH;}
  canvas.style.width=Math.floor(cw)+'px';canvas.style.height=Math.floor(ch)+'px';
}
window.addEventListener('resize',resizeCanvas);
window.addEventListener('orientationchange',()=>setTimeout(resizeCanvas,120));

// ═══════════════════════════════════════════════════
//  SCORES & PROGRESS
// ═══════════════════════════════════════════════════
let highScores=[];
try{highScores=JSON.parse(localStorage.getItem('tupperScores')||'[]');}catch(_){}
function saveScore(name,sc){highScores.push({name,score:sc});highScores.sort((a,b)=>b.score-a.score);highScores=highScores.slice(0,10);try{localStorage.setItem('tupperScores',JSON.stringify(highScores));}catch(_){}renderSB();}
function renderSB(){
  const el=document.getElementById('sb-list');el.innerHTML='';
  const m=['gold','silver','bronze'];
  highScores.forEach((e,i)=>{const d=document.createElement('div');d.className='sbr'+(m[i]?' '+m[i]:'');d.innerHTML=`<span class="sbr-rank">${i+1}</span><span class="sbr-name">${e.name.replace(/</g,'&lt;')}</span><span class="sbr-score">${e.score}</span>`;el.appendChild(d);});
}
renderSB();

let maxUnlocked=1;
try{maxUnlocked=Math.max(1,parseInt(localStorage.getItem('tupperMaxLvl')||'1'));}catch(_){}
function unlock(lvl){if(lvl>maxUnlocked){maxUnlocked=lvl;try{localStorage.setItem('tupperMaxLvl',String(maxUnlocked));}catch(_){}}}

// ═══════════════════════════════════════════════════
//  LEVEL CONFIG — 30 levels, boss every 5th
// ═══════════════════════════════════════════════════
function lcfg(lvl){
  const boss=(lvl%5===0); // boss spawns AFTER waves on these levels
  const rows=Math.min(2+Math.floor((lvl-1)/4),5);
  const cols=Math.min(6+Math.floor((lvl-1)/5),11);
  const eHp=Math.max(1,Math.floor(1+(lvl-1)/5));
  const bHp=Math.floor(35+lvl*10);
  // Start at 3 waves (level 1), add 1 wave every 3 levels, cap at 8
  const waves=Math.min(3+Math.floor((lvl-1)/3),8);
  const eMov=0.35+lvl*.05;
  const eFire=Math.min(0.22,0.06+lvl*.006);
  const bLaser=lvl>=8;
  const types=Math.min(1+Math.floor(lvl/5),6);
  return{boss,rows,cols,eHp,bHp,waves,eMov,eFire,bLaser,types};
}

// Difficulty multipliers
const DIFFS={
  easy  :{eMov:.75,eFire:.6,bHp:.7,pSpd:1.15,lcdMult:.8},
  medium:{eMov:1,  eFire:1,  bHp:1,  pSpd:1,   lcdMult:1},
  hard  :{eMov:1.4,eFire:1.6,bHp:1.5,pSpd:.9,  lcdMult:1.3},
};
let diff='easy';

// ═══════════════════════════════════════════════════
//  ENEMY TYPE DEFS
// ═══════════════════════════════════════════════════
// Each type has unique visual shape (drawn procedurally) + stats modifier
const ETYPES=[
  // 0: BASIC — standard tupperware box
  {name:'BASIC',  col:'#06d6a0',drk:'#037a58',lit:'#88ffdd',w:52,h:40,hpMult:1,   fireMult:1,  spdMult:1  },
  // 1: ARMORED — grey plated fortress
  {name:'ARMOR',  col:'#9999bb',drk:'#444466',lit:'#ccccee',w:54,h:46,hpMult:2,   fireMult:.7, spdMult:.75},
  // 2: SPEEDY — slim orange racer
  {name:'SPEEDY', col:'#ff9f1c',drk:'#995500',lit:'#ffcc66',w:44,h:36,hpMult:.75, fireMult:1.2,spdMult:1.7},
  // 3: TANK — massive red death tub
  {name:'TANK',   col:'#ef476f',drk:'#880030',lit:'#ff88aa',w:60,h:50,hpMult:3,   fireMult:.6, spdMult:.55},
  // 4: BOMBER — purple grenade, shoots spread
  {name:'BOMBER', col:'#a78bfa',drk:'#5b3aaa',lit:'#ccaaff',w:52,h:44,hpMult:1.2, fireMult:1.4,spdMult:.9 },
  // 5: GHOST — translucent teal, hard to see
  {name:'GHOST',  col:'#55ffee',drk:'#004433',lit:'#aaffee',w:48,h:38,hpMult:.8,  fireMult:1.5,spdMult:1.3},
];

// ═══════════════════════════════════════════════════
//  GAME STATE
// ═══════════════════════════════════════════════════
let score=0,lives=3,shields=0,curWave=1,curLevel=1,waveTarget=1,running=false,paused=false,animId;
let player=null,bullets=[],eBullets=[],enemies=[],particles=[],shootCD=0,eDir=1,eMoveT=0;
const LF=180,LCD_BASE=600;
let _laserCDMax=LCD_BASE;
let lOn=false,lFrames=0,lCD=0,lDmgT=0;
let boss=null,bossUp=false,bossOut=false,bLaserOn=false,bLaserX=0,bLaserT=0,bLaserCD=0;
let bossCountdownTO=null;
let waveTransition=false; // guard: stops wave-complete firing every frame
let waveTO=null; // tracks wave transition timeout so it can be cancelled
let bossSpecialT=0,bossSpecialCD=0;
// Bubble shield state
const BUBBLE_DUR=180,BUBBLE_CD_MAX=600; // 3s active, 10s cooldown at 60fps
let bubbleOn=false,bubbleFrames=0,bubbleCD=0;
// Boss phase 2
let bossPhase=1,cutscenePlaying=false;

// ═══════════════════════════════════════════════════
//  INPUT
// ═══════════════════════════════════════════════════
const K={},TK={left:false,right:false,fire:false,laser:false,shield:false,pause:false};
document.addEventListener('keydown',e=>{
  K[e.code]=true;
  if(e.code==='KeyP'||e.code==='Escape'){e.preventDefault();doPause();return;}
  if(!running||paused)return;
  if(e.code==='Space'){e.preventDefault();doShoot();}
  if(e.code==='KeyX'||e.code==='KeyQ'){e.preventDefault();doLaser();}
  if(e.code==='KeyB'){e.preventDefault();if(running&&!paused)doBubble();}
});
document.addEventListener('keyup',e=>K[e.code]=false);
const BP={};
function mkBtn(id,prop,cb){
  const el=document.getElementById(id);if(!el)return;
  const dn=pid=>{BP[pid]=prop;TK[prop]=true;el.classList.add('tapped');if(cb)cb();};
  const up=pid=>{if(BP[pid]===prop){delete BP[pid];if(!Object.values(BP).includes(prop)){TK[prop]=false;el.classList.remove('tapped');}}};
  el.addEventListener('pointerdown',ev=>{ev.preventDefault();el.setPointerCapture(ev.pointerId);dn(ev.pointerId);},{passive:false});
  el.addEventListener('pointerup',ev=>{ev.preventDefault();up(ev.pointerId);},{passive:false});
  el.addEventListener('pointercancel',ev=>{ev.preventDefault();up(ev.pointerId);},{passive:false});
  el.addEventListener('pointerleave',ev=>{if(!el.hasPointerCapture(ev.pointerId))up(ev.pointerId);});
}
// Canvas buttons are wired via wireCanvasBtn() in the setTimeout below

// ═══════════════════════════════════════════════════
//  PAUSE
// ═══════════════════════════════════════════════════
function doPause(){
  if(!running)return;paused=!paused;
  document.getElementById('pause-ov').classList.toggle('show',paused);
  if(paused)cancelAnimationFrame(animId);else animId=requestAnimationFrame(loop);
}
document.getElementById('resume-btn').addEventListener('click',()=>{if(paused)doPause();});
document.getElementById('quit-btn').addEventListener('click',()=>{
  paused=false;running=false;cancelAnimationFrame(animId);stopBGM();bLaserOn=false;
  document.getElementById('pause-ov').classList.remove('show');
  document.getElementById('controls').style.display='none';
  document.getElementById('hud-bar').style.display='none';
  document.getElementById('main-menu').classList.remove('hidden');
  resizeCanvas();
});
// cb-pause is wired via wireCanvasBtn below
document.getElementById('pause-btn').addEventListener('click',()=>{if(running)doPause();});

// ═══════════════════════════════════════════════════
//  DIFFICULTY
// ═══════════════════════════════════════════════════
document.querySelectorAll('.dbtn').forEach(b=>{
  b.addEventListener('click',()=>{
    diff=b.dataset.d;
    document.querySelectorAll('.dbtn').forEach(x=>x.classList.toggle('sel',x.dataset.d===diff));
  });
});

// ═══════════════════════════════════════════════════
//  LEVELS GRID
// ═══════════════════════════════════════════════════
function buildLvlGrid(){
  const g=document.getElementById('lvl-grid');g.innerHTML='';
  for(let i=1;i<=30;i++){
    const isBoss=(i%5===0);
    const cell=document.createElement('div');
    let cls='lc'+(isBoss?' boss':'')+(i===curLevel?' cur':i<=maxUnlocked?' open':'');
    cell.className=cls;
    cell.textContent=(isBoss?'[B] ':'')+'L'+i;
    if(i<=maxUnlocked){
      cell.addEventListener('click',()=>{
        document.getElementById('levels-modal').classList.remove('show');
        beginLevel(i);
      });
    }
    g.appendChild(cell);
  }
}
document.getElementById('levels-btn').addEventListener('click',()=>{buildLvlGrid();document.getElementById('levels-modal').classList.add('show');});
document.getElementById('lvl-close').addEventListener('click',()=>document.getElementById('levels-modal').classList.remove('show'));

// ═══════════════════════════════════════════════════
//  BEGIN LEVEL
// ═══════════════════════════════════════════════════
function beginLevel(lvl){
  ga();
  // Clear any pending timers from previous game
  if(bossCountdownTO){clearTimeout(bossCountdownTO);bossCountdownTO=null;}
  if(waveTO){clearTimeout(waveTO);waveTO=null;}
  document.getElementById('lvlcomplete-modal').classList.remove('show');
  curLevel=lvl;
  const cfg=lcfg(lvl);
  const dm=DIFFS[diff];
  // score persists across game overs
  lives=5;shields=0;curWave=1;waveTarget=cfg.waves;
  paused=false;bLaserOn=false;bLaserCD=0;bLaserT=0;
  updateHUD();

  player={x:GW/2-32,y:GH-90,w:64,h:55,spd:7*dm.pSpd};
  bullets=[];eBullets=[];enemies=[];particles=[];
  shootCD=0;eDir=1;eMoveT=0;
  lOn=false;lFrames=0;lCD=0;lDmgT=0;_laserCDMax=LCD_BASE;
  bubbleOn=false;bubbleFrames=0;bubbleCD=0;
  bossPhase=1;cutscenePlaying=false;
  boss=null;bossUp=false;bossOut=false;
  waveTransition=false;

  document.getElementById('controls').style.display='flex';
  document.getElementById('hint').style.display='none';
  document.getElementById('hud-bar').style.display='flex';
  document.getElementById('main-menu').classList.add('hidden');
  hideMsg();

  spawnWave(); // always start with enemy waves; boss triggered after all waves clear
  running=true;cancelAnimationFrame(animId);resizeCanvas();
  animId=requestAnimationFrame(loop);
  startBGM();
}

function updateHUD(){
  // Update HUD bar (visible during gameplay)
  const sv=document.getElementById('hud-score-val');if(sv)sv.textContent=score;
  const lv=document.getElementById('hud-level-val');if(lv)lv.textContent=curLevel+'/30';
  const wv=document.getElementById('hud-wave-val');if(wv)wv.textContent=(bossUp?'BOSS':(curWave+'/'+waveTarget));
  // Lives hearts
  const livesEl=document.getElementById('hud-lives');
  if(livesEl){
    livesEl.innerHTML='';
    for(let li=0;li<5;li++){
      const hs=document.createElement('span');
      hs.className='hrt'+(li<lives?' alive':' dead');
      livesEl.appendChild(hs);
    }
  }
  // Bubble shield
  const shEl=document.getElementById('hud-shield-val');
  if(shEl){
    if(bubbleOn){shEl.textContent='ACTIVE';shEl.style.color='#00ffff';}
    else if(bubbleCD>0){shEl.textContent=Math.ceil(bubbleCD/60)+'s';shEl.style.color='#888';}
    else{shEl.textContent='READY';shEl.style.color='#00aaff';}
  }
  // Laser status
  const laserVal=document.getElementById('hud-laser-val');
  const laserBar=document.getElementById('hud-lbar');
  if(laserVal){
    if(lOn){laserVal.textContent='FIRING';laserVal.style.color='#00ffcc';if(laserBar)laserBar.style.width=(lFrames/LF*100)+'%';}
    else if(lCD>0){laserVal.textContent=Math.ceil(lCD/60)+'s';laserVal.style.color='#555';if(laserBar)laserBar.style.width=((1-lCD/_laserCDMax)*100)+'%';}
    else{laserVal.textContent='READY';laserVal.style.color='#06d6a0';if(laserBar)laserBar.style.width='100%';}
  }
  // Also update hidden sidebar elements (laser-box for updateLaserUI compatibility)
  document.getElementById('el-score').textContent=score;
  document.getElementById('el-level').textContent=curLevel+'/30';
  document.getElementById('el-wave').textContent=(bossUp?'BOSS':(curWave+'/'+waveTarget));
}

// ═══════════════════════════════════════════════════
//  SPAWN WAVE / BOSS
// ═══════════════════════════════════════════════════
function spawnWave(){
  if(bossCountdownTO||bossUp||bossOut)return; // no re-spawn during boss
  waveTransition=false; // clear transition lock when new wave actually spawns
  bossUp=false;bossOut=false;boss=null;enemies=[];eBullets=[];
  const cfg=lcfg(curLevel);const dm=DIFFS[diff];
  const{rows,cols,eHp,eMov,eFire,types}=cfg;
  const xGap=Math.floor((GW-80)/cols),yGap=54;

  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      // Assign type: cycle through available types in a pattern
      const ti=Math.min((r*2+Math.floor(c/3))%types, ETYPES.length-1);
      const et=ETYPES[ti];
      const hp=Math.max(1,Math.round(eHp*et.hpMult));
      enemies.push({
        x:40+c*xGap, y:50+r*yGap,
        w:et.w, h:et.h,
        col:et.col, drk:et.drk, lit:et.lit,
        ti, hp, maxHp:hp,
        sT:Math.floor(50+Math.random()*100),
        sMul:et.spdMult, fMul:et.fireMult,
      });
    }
  }
}

// Boss definitions per tier (levels 5,10,15,20,25,30)
const BOSS_DEFS=[
  {name:'THE LID KING',  emoji:'[K]', color:'#cc6600', titleColor:'#ff9900',
   desc:'Ruler of all containers',
   special:'lid_slam', specialName:'LID SLAM', specialCD:280},
  {name:'FROSTLOCK',     emoji:'[F]', color:'#0088cc', titleColor:'#88ddff',
   desc:'Frozen in hatred',
   special:'ice_ring',  specialName:'ICE RING',  specialCD:240},
  {name:'SAUCEPAN SAM',  emoji:'[S]', color:'#884400', titleColor:'#ffaa44',
   desc:'Boiling with rage',
   special:'heat_wave', specialName:'HEAT WAVE', specialCD:200},
  {name:'CRISPER LORD',  emoji:'[C]', color:'#004488', titleColor:'#4499ff',
   desc:'Master of the vegetable drawer',
   special:'laser',     specialName:'TWIN BEAM', specialCD:160},
  {name:'THERMOS PRIME', emoji:'[T]', color:'#880000', titleColor:'#ff4444',
   desc:'Forged in the microwave',
   special:'barrage',   specialName:'BARRAGE',   specialCD:140},
  {name:'SUPERNOVA TUPPERWARE', emoji:'[★]', color:'#0a0015', titleColor:'#ff00ff',
   glowColor:'#aa00ff', textColor:'#ffffff', sparkColor:'#ff88ff',
   desc:'Born from a dying star. Cannot be contained.',
   special:'all', specialName:'ANNIHILATION', specialCD:100},
];

function getTierIdx(){return Math.min(Math.ceil(curLevel/5)-1,5);}

function spawnBoss(){
  // Guard: don't spawn if already spawned
  if(bossUp||boss)return;
  bossUp=true;bossOut=false;boss=null;enemies=[];eBullets=[];
  const cfg=lcfg(curLevel);const dm=DIFFS[diff];
  const hp=Math.floor(cfg.bHp*dm.bHp);
  const tier=getTierIdx();const bd=BOSS_DEFS[tier];
  boss={x:GW/2-95,y:18,w:190,h:130,hp,mHp:hp,sT:60,mDir:1,shk:0,tier,bd};bd.tier=tier;
  bLaserOn=false;bLaserCD=Math.max(80,200-curLevel*6);bLaserT=0;bLaserX=boss.x+boss.w/2;
  bossSpecialT=0;bossSpecialCD=Math.floor(bd.specialCD*(diff==='easy'?1.4:diff==='hard'?0.75:1));
  stopBGM();sfxBossAlarm();setTimeout(startBossBGM,750);
  // Styled boss announcement
  const msgEl=document.getElementById('overlay-msg');
  if(msgEl){
    const tc=bd.titleColor||'#ff4444';
    const gc=bd.glowColor||tc;
    msgEl.style.color=tc;
    msgEl.style.textShadow=`3px 3px 0 #000, 0 0 28px ${gc}, 0 0 56px ${gc}66`;
    msgEl.style.borderColor=gc;
    msgEl.style.background=bd.tier===5?'rgba(10,0,21,0.92)':'rgba(0,0,0,0.75)';
    if(bd.tier===5){
      // SUPERNOVA TUPPERWARE — extra dramatic
      msgEl.style.fontSize='clamp(0.9rem,3.5vw,1.8rem)';
      msgEl.style.letterSpacing='4px';
    } else {
      msgEl.style.fontSize='';msgEl.style.letterSpacing='';
    }
  }
  showMsg('>> '+bd.name+' <<\n"'+bd.desc+'"',2400);
  setTimeout(()=>{if(msgEl){msgEl.style.color='';msgEl.style.textShadow='';msgEl.style.borderColor='';msgEl.style.background='';msgEl.style.fontSize='';msgEl.style.letterSpacing='';}},2500);
}

function triggerBossCountdown(){
  // Called after last enemy wave clears on a boss level
  if(bossCountdownTO)return;
  let secs=5;
  showMsg('!! BOSS INCOMING !!\n'+secs+'...',99999);
  sfxWaveDone();
  function tick(){
    secs--;
    if(secs>0){showMsg('!! BOSS INCOMING !!\n'+secs+'...',99999);bossCountdownTO=setTimeout(tick,1000);}
    else{bossCountdownTO=null;hideMsg();spawnBoss();}
  }
  bossCountdownTO=setTimeout(tick,1000);
}

// ═══════════════════════════════════════════════════
//  SHOOTING
// ═══════════════════════════════════════════════════
function doShoot(){if(shootCD>0)return;bullets.push({x:player.x+player.w/2,y:player.y,vy:-16});shootCD=11;sfxShoot();}
function doLaser(){
  const dm=DIFFS[diff];
  if(lOn||lCD>0)return;lOn=true;lFrames=LF;_laserCDMax=Math.floor(LCD_BASE*dm.lcdMult);lDmgT=0;sfxLaserStart();
}
function doBubble(){
  if(bubbleOn||bubbleCD>0)return;
  bubbleOn=true;bubbleFrames=BUBBLE_DUR;
  sfxBubbleActivate();updateHUD();
}

// ═══════════════════════════════════════════════════
//  LASER UI
// ═══════════════════════════════════════════════════
function updateLaserUI(){
  const box=document.getElementById('laser-box'),st=document.getElementById('laser-status'),bar=document.getElementById('lbar'),cbL=document.getElementById('cb-laser');
  if(lOn){box.className='active';st.textContent='FIRING!';bar.style.width=(lFrames/LF*100)+'%';bar.style.background='linear-gradient(90deg,#fff,#00ffcc)';if(cbL)cbL.classList.add('off');}
  else if(lCD>0){box.className='cooling';st.textContent=Math.ceil(lCD/60)+'s';bar.style.width=((1-lCD/_laserCDMax)*100)+'%';bar.style.background='linear-gradient(90deg,#444,#06d6a0)';if(cbL)cbL.classList.add('off');}
  else{box.className='ready';st.textContent='READY!';bar.style.width='100%';bar.style.background='linear-gradient(90deg,#06d6a0,#00ffcc)';if(cbL)cbL.classList.remove('off');}
}

// ═══════════════════════════════════════════════════
//  DAMAGE
// ═══════════════════════════════════════════════════
function burst(x,y,col,n){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=1.5+Math.random()*5;particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:2+Math.random()*5,al:1,col});}}

function takeDmg(hearts){
  hearts=hearts||1;
  if(bubbleOn)return; // invincible
  if(shields>0){shields=Math.max(0,shields-1);sfxHit();updateHUD();return;}
  lives=Math.max(0,lives-hearts);updateHUD();sfxLoseLife();
  if(lives<=0)doGameOver();
}

// ═══════════════════════════════════════════════════
//  MAIN LOOP
// ═══════════════════════════════════════════════════
function loop(){
  if(!running||paused)return;
  const cfg=lcfg(curLevel);const dm=DIFFS[diff];

  // Player move
  if((K.ArrowLeft||K.KeyA||TK.left)&&player.x>0)player.x-=player.spd;
  if((K.ArrowRight||K.KeyD||TK.right)&&player.x+player.w<GW)player.x+=player.spd;
  if(TK.fire)doShoot();
  if(shootCD>0)shootCD--;

  // Laser
  if(lOn){
    lFrames--;
    laserDmg(player.x+player.w/2); // 1hp every frame
    if(lFrames<=0){lOn=false;lCD=_laserCDMax;sfxLaserStop();}
  }else if(lCD>0)lCD--;
  updateLaserUI();
  // Bubble tick
  if(bubbleOn){bubbleFrames--;if(bubbleFrames<=0){bubbleOn=false;bubbleCD=BUBBLE_CD_MAX;updateHUD();}}
  else if(bubbleCD>0){bubbleCD--;if(bubbleCD%60===0)updateHUD();}

  // Enemy grid
  if(!bossUp){
    eMoveT++;const mE=Math.max(8,28-Math.floor(curLevel/2));
    if(eMoveT>=mE){
      eMoveT=0;let edge=false;
      const spd=cfg.eMov*dm.eMov*mE;
      for(const e of enemies){const es=spd*e.sMul;e.x+=eDir*es;if(e.x+e.w>GW-6||e.x<6)edge=true;}
      if(edge){eDir*=-1;for(const e of enemies)e.y+=14;}
    }
    for(const e of enemies){
      e.sT--;
      if(e.sT<=0){
        e.sT=Math.max(12,Math.floor((50+Math.random()*80)*(1-cfg.eFire*dm.eFire)+12));
        if(Math.random()<cfg.eFire*dm.eFire*e.fMul){
          if(e.ti===4){// Bomber: 3-way spread
            for(let a=-0.28;a<=0.28;a+=0.28)eBullets.push({x:e.x+e.w/2,y:e.y+e.h,vx:Math.sin(a)*4,vy:4+curLevel*.12,col:e.col,r:6});
          }else{
            eBullets.push({x:e.x+e.w/2,y:e.y+e.h,vx:0,vy:4+curLevel*.12,col:e.col,r:5});
          }
        }
      }
      if(e.y+e.h>=player.y+8){takeDmg(1);enemies.splice(enemies.indexOf(e),1);break;}
    }
    if(enemies.length===0&&!bossUp&&!bossOut&&!bossCountdownTO&&!waveTransition){
      waveTransition=true; // lock — prevents re-firing every frame until next wave spawns
      const doneWave=curWave;
      sfxWaveDone();
      if(curWave>=waveTarget){
        if(lcfg(curLevel).boss){
          showMsg('WAVE '+doneWave+' COMPLETE!',900);
          setTimeout(()=>{triggerBossCountdown();},1000);
        } else {
          showMsg('WAVE '+doneWave+' COMPLETE!',800);
          setTimeout(()=>{levelComplete();},950);
        }
      } else {
        curWave++;
        updateHUD();
        showMsg('WAVE '+doneWave+' COMPLETE!',1000);
        waveTO=setTimeout(()=>{waveTO=null;waveTransition=false;spawnWave();},1400);
      }
    }
  }

  // Boss AI
  if(boss){
    if(boss.shk>0)boss.shk--;
    const bspd=(1.5+curLevel*.09)*dm.eMov;
    boss.x+=boss.mDir*bspd;
    if(boss.x+boss.w>GW-8){boss.x=GW-8-boss.w;boss.mDir=-1;}
    if(boss.x<8){boss.x=8;boss.mDir=1;}

    // Normal shooting
    boss.sT--;
    if(boss.sT<=0){
      const pct=boss.hp/boss.mHp;
      boss.sT=pct>.5?55:pct>.25?30:18;
      const n=pct>.5?1:pct>.25?3:5;
      for(let i=0;i<n;i++){const sp=(i-(n-1)/2)*.3;eBullets.push({x:boss.x+boss.w/2,y:boss.y+boss.h,vx:sp*3,vy:5+curLevel*.18,col:'#ff0040',r:8,isBoss:true});}
    }

    // ── Boss laser (all tiers 8+) ──
    if(cfg.bLaser){
      if(!bLaserOn){bLaserCD--;
        if(bLaserCD<=0){bLaserOn=true;bLaserT=100;bLaserX=boss.x+boss.w/2;bLaserCD=Math.max(100,260-curLevel*7);sfxBossLaserSfx();}
      }else{
        bLaserT--;if(bLaserT<=0)bLaserOn=false;
        if(bLaserT%18===0){const cx=bLaserX;if(cx>player.x&&cx<player.x+player.w)takeDmg(1);}
      }
    }

    // ── Special attack per tier ──
    if(boss.bd){
      bossSpecialT--;
      if(bossSpecialT<=0){
        bossSpecialT=bossSpecialCD;
        const sp=boss.bd.special;
        const pct=boss.hp/boss.mHp;
        if(sp==='lid_slam'||sp==='all'){
          // LID SLAM: rapid downward 5-bullet spread from full width
          sfxLidSlam();
          for(let i=0;i<7;i++){const rx=boss.x+20+i*(boss.w-40)/6;eBullets.push({x:rx,y:boss.y+boss.h,vx:0,vy:7+curLevel*.15,col:'#ff6600',r:9,isBoss:true});}
        }
        if(sp==='ice_ring'||sp==='all'){
          // ICE RING: 8-way radial burst from boss center
          sfxIceRing();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h/2;
          for(let a=0;a<8;a++){const ang=(a/8)*Math.PI*2;eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*4.5,vy:Math.sin(ang)*4.5,col:'#88ddff',r:7,isBoss:true});}
        }
        if(sp==='heat_wave'||sp==='all'){
          // HEAT WAVE: sweeping row of fireballs at player height
          sfxHeatWave();
          for(let i=0;i<6;i++){const ry=player.y-60+i*20;eBullets.push({x:boss.x>GW/2?GW:0,y:ry,vx:boss.x>GW/2?-5:5,vy:0,col:'#ff4400',r:8,isBoss:true});}
        }
        if(sp==='laser'||sp==='all'){
          // TWIN BEAM: fire two simultaneous boss lasers
          sfxBossLaserSfx();
          bLaserOn=true;bLaserT=80;
          bLaserX=boss.x+boss.w*0.3; // first beam
          // schedule second beam
          setTimeout(()=>{if(boss){bLaserOn=true;bLaserT=80;bLaserX=boss.x+boss.w*0.7;}},500);
        }
        if(sp==='barrage'||sp==='all'){
          // BARRAGE: 12-bullet aimed stream at player
          sfxBarrage();
          const px=player.x+player.w/2,py=player.y;
          const bx=boss.x+boss.w/2,by=boss.y+boss.h;
          const dist=Math.sqrt((px-bx)**2+(py-by)**2)||1;
          const dvx=(px-bx)/dist*6,dvy=(py-by)/dist*6;
          for(let i=0;i<10;i++){setTimeout(()=>{if(boss)eBullets.push({x:bx+(Math.random()-0.5)*40,y:by,vx:dvx+(Math.random()-0.5)*1.5,vy:dvy,col:'#ff0080',r:7,isBoss:true});},i*80);}
        }
      }
    }
  }

  // Move projectiles
  for(const b of bullets)b.y+=b.vy;
  bullets=bullets.filter(b=>b.y>-20);
  for(const b of eBullets){b.y+=b.vy;b.x+=b.vx||0;}
  eBullets=eBullets.filter(b=>b.y<GH+20&&b.x>-30&&b.x<GW+30);

  // Player bullets hit enemies/boss
  bullets=bullets.filter(b=>{
    for(let i=enemies.length-1;i>=0;i--){const e=enemies[i];if(b.x>e.x&&b.x<e.x+e.w&&b.y>e.y&&b.y<e.y+e.h){hitEnemy(i,1,b.x,b.y);return false;}}
    if(boss&&b.x>boss.x&&b.x<boss.x+boss.w&&b.y>boss.y&&b.y<boss.y+boss.h){hitBoss(1,b.x,b.y);return false;}
    return true;
  });

  // Enemy bullets hit player
  eBullets=eBullets.filter(b=>{
    if(b.x>player.x&&b.x<player.x+player.w&&b.y>player.y&&b.y<player.y+player.h){
      burst(b.x,b.y,'#ff6b35',8);takeDmg(1);return false;
    }
    return true;
  });

  // Particles
  for(const p of particles){p.x+=p.vx;p.y+=p.vy;p.vy+=.09;p.al-=.022;}
  particles=particles.filter(p=>p.al>0);

  draw();
  animId=requestAnimationFrame(loop);
}

// ═══════════════════════════════════════════════════
//  HIT HELPERS
// ═══════════════════════════════════════════════════
function hitEnemy(i,dmg,hx,hy){
  const e=enemies[i];burst(hx,hy,e.col,5);e.hp-=dmg;
  if(e.hp<=0){burst(e.x+e.w/2,e.y+e.h/2,e.col,18);score+=10*curLevel;updateHUD();sfxExplode(false);enemies.splice(i,1);}
}
function hitBoss(dmg,hx,hy){
  burst(hx,hy,'#ff6b35',6);boss.hp-=dmg;boss.shk=6;
  if(boss.hp<=0)bossDefeated();
}
function laserDmg(cx){
  // 1hp per frame (constant damage beam)
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];if(cx>e.x&&cx<e.x+e.w){burst(cx,e.y+e.h/2,e.col,1);e.hp-=1;
      if(e.hp<=0){burst(e.x+e.w/2,e.y+e.h/2,e.col,14);score+=10*curLevel;updateHUD();sfxExplode(false);enemies.splice(i,1);}
    }
  }
  if(boss&&cx>boss.x&&cx<boss.x+boss.w){burst(cx,boss.y+boss.h/2,'#ff6b35',2);boss.hp-=1;boss.shk=1;if(boss.hp<=0)bossDefeated();}
}

function bossDefeated(){
  if(!boss)return; // guard against double-call
  const bx=boss.x,by=boss.y,bw=boss.w,bh=boss.h;
  const bonus=Math.floor(500+curLevel*200);score+=bonus;updateHUD();
  burst(bx+bw/2,by+bh/2,'#ff6b35',55);burst(bx+bw/2,by+bh/2,'#ffd166',40);
  // Kill boss completely before anything else
  boss=null;bossUp=false;bossOut=true;bLaserOn=false;
  if(bossCountdownTO){clearTimeout(bossCountdownTO);bossCountdownTO=null;}
  stopBGM();sfxBossWin();
  // Stop the game loop
  running=false;cancelAnimationFrame(animId);
  const nextLvl=Math.min(30,curLevel+1);
  unlock(nextLvl);
  const isLast=(curLevel>=30);
  showMsg(isLast?'** VICTORY! **':'BOSS SLAIN!\n+'+bonus+' PTS',2200);
  setTimeout(()=>showLevelComplete(isLast),2400);
}

function levelComplete(){
  // Called when all waves clear on a non-boss level
  if(bossOut)return; // guard
  bossOut=true;
  running=false;cancelAnimationFrame(animId);stopBGM();sfxLevelUp();
  const nextLvl=Math.min(30,curLevel+1);unlock(nextLvl);
  setTimeout(()=>showLevelComplete(curLevel>=30),800);
}

function showLevelComplete(isVictory){
  hideMsg();
  document.getElementById('controls').style.display='none';
  document.getElementById('hud-bar').style.display='none';
  document.getElementById('hint').style.display='none';
  const modal=document.getElementById('lvlcomplete-modal');
  if(!modal){return;}
  const titleEl=document.getElementById('lc-title');
  const subEl  =document.getElementById('lc-sub');
  const scoreEl=document.getElementById('lc-score');
  const contBtn=document.getElementById('lc-continue');
  if(isVictory){
    titleEl.textContent='** YOU WIN! **';
    titleEl.style.color='#ffd166';
    subEl.textContent='All 30 levels conquered!';
    contBtn.textContent='▶ PLAY AGAIN';
    contBtn.onclick=()=>{modal.classList.remove('show');beginLevel(1);};
  } else {
    const nl=curLevel+1;
    titleEl.textContent='LEVEL '+curLevel+' DONE!';
    titleEl.style.color='#00ff88';
    subEl.textContent='Next: Level '+nl+(nl%5===0?' [BOSS STAGE]':'');
    contBtn.textContent='▶ LEVEL '+nl;
    contBtn.onclick=()=>{modal.classList.remove('show');beginLevel(nl);};
  }
  scoreEl.textContent='Score: '+score;
  modal.classList.add('show');
  resizeCanvas();
}

// ═══════════════════════════════════════════════════
//  GAME OVER
// ═══════════════════════════════════════════════════
function qualifiesTop10(){
  if(score<=0)return false;
  if(highScores.length<10)return true;
  return score>highScores[highScores.length-1].score;
}
function doGameOver(){
  running=false;cancelAnimationFrame(animId);
  if(bossCountdownTO){clearTimeout(bossCountdownTO);bossCountdownTO=null;}
  bLaserOn=false;hideMsg();sfxGameOver();
  function showGOScreen(){
    document.getElementById('controls').style.display='none';
    document.getElementById('hud-bar').style.display='none';
    running=false;
    setTimeout(()=>{
      document.getElementById('main-menu').classList.remove('hidden');
    },2000);
    showMsg('GAME OVER\nLevel '+curLevel+'\nScore: '+score,2000);
    resizeCanvas();
  }
  setTimeout(()=>{
    if(qualifiesTop10()){
      const modal=document.getElementById('name-modal'),inp=document.getElementById('name-input');
      modal.classList.add('show');inp.value='';
      setTimeout(()=>{try{inp.focus();}catch(_){}},150);
      document.getElementById('name-ok').onclick=()=>{
        const nm=(inp.value.trim()||'Anonymous').slice(0,12);
        saveScore(nm,score);modal.classList.remove('show');showGOScreen();
      };
    } else {
      showGOScreen();
    }
  },800);
}

// ═══════════════════════════════════════════════════
//  OVERLAY
// ═══════════════════════════════════════════════════
let msgTO=null;
function showMsg(t,d){const el=document.getElementById('overlay-msg');el.textContent=t;el.style.display='block';if(msgTO)clearTimeout(msgTO);if(d<99999)msgTO=setTimeout(()=>el.style.display='none',d);}
function hideMsg(){const el=document.getElementById('overlay-msg');el.style.display='none';}

// ═══════════════════════════════════════════════════
//  PLAY BUTTON
// ═══════════════════════════════════════════════════
// Main menu button wiring
document.getElementById('mm-play').addEventListener('click',()=>{beginLevel(curLevel);});
document.getElementById('mm-levels').addEventListener('click',()=>{buildLvlGrid();document.getElementById('levels-modal').classList.add('show');});
document.getElementById('mm-scores').addEventListener('click',()=>{
  document.getElementById('scores-screen').style.display='flex';
});
document.getElementById('scores-back').addEventListener('click',()=>{
  document.getElementById('scores-screen').style.display='none';
});
// Difficulty buttons in main menu
// Difficulty button wiring — single source of truth
function setDiff(d){
  diff=d;
  document.querySelectorAll('.mm-diff-btn').forEach(x=>x.classList.toggle('sel',x.dataset.d===d));
  const dv=document.getElementById('hud-diff-val');
  if(dv){
    dv.textContent=d.toUpperCase();
    dv.style.color=d==='easy'?'#06d6a0':d==='hard'?'#ff4444':'#ff9f1c';
  }
}
document.querySelectorAll('.mm-diff-btn').forEach(b=>{
  b.addEventListener('click',()=>setDiff(b.dataset.d));
});
setDiff('easy'); // ensure initial state is consistent
// HUD pause button
document.getElementById('hud-pause-btn').addEventListener('click',()=>{if(running)doPause();});
// Legacy play-btn (keep for safety)
const _legacyPlay=document.getElementById('play-btn');
if(_legacyPlay)_legacyPlay.addEventListener('click',()=>beginLevel(curLevel));

// Level complete modal buttons
document.getElementById('lc-levels').addEventListener('click',()=>{
  document.getElementById('lvlcomplete-modal').classList.remove('show');
  buildLvlGrid();document.getElementById('levels-modal').classList.add('show');
});
document.getElementById('lc-menu').addEventListener('click',()=>{
  document.getElementById('lvlcomplete-modal').classList.remove('show');
  document.getElementById('controls').style.display='none';
  document.getElementById('hud-bar').style.display='none';
  document.getElementById('main-menu').classList.remove('hidden');
});

// ═══════════════════════════════════════════════════
//  DRAW ENGINE
// ═══════════════════════════════════════════════════
function lc(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgb(${Math.min(255,r+a)},${Math.min(255,g+a)},${Math.min(255,b+a)})`;}
function dc(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgb(${Math.max(0,r-a)},${Math.max(0,g-a)},${Math.max(0,b-a)})`;}

// Rich parallax star field + nebula clouds
const STARS_A=Array.from({length:80},(_,i)=>({x:(i*7919+11111)%GW,y:(i*6173+22222)%GH}));
const STARS_B=Array.from({length:45},(_,i)=>({x:(i*5231+33333)%GW,y:(i*4127+44444)%GH}));
const STARS_C=Array.from({length:14},(_,i)=>({x:(i*3719+55555)%GW,y:(i*2917+66666)%GH}));
// Nebula blobs
const NEBULA=[
  {x:GW*.15,y:GH*.20,rx:110,ry:65,r:14,g:0,b:30,a:.32},
  {x:GW*.75,y:GH*.12,rx:90, ry:55,r:0, g:10,b:25,a:.28},
  {x:GW*.50,y:GH*.55,rx:140,ry:80,r:18,g:0,b:20,a:.38},
  {x:GW*.85,y:GH*.72,rx:80, ry:60,r:0, g:8, b:20,a:.25},
  {x:GW*.08,y:GH*.78,rx:70, ry:50,r:20,g:0,b:22,a:.22},
];
let bgT=0;
function drawBG(){
  ctx.fillStyle='#00000a';ctx.fillRect(0,0,GW,GH);
  // Nebula ellipses
  NEBULA.forEach(n=>{
    const pulse=0.85+0.15*Math.sin(bgT*.003+n.x);
    for(let dy=-n.ry;dy<=n.ry;dy+=3){
      const f=1-(dy/n.ry)**2;const hw=n.rx*Math.sqrt(Math.max(0,f));
      ctx.globalAlpha=n.a*f*pulse;
      ctx.fillStyle=`rgb(${n.r},${n.g},${n.b})`;
      ctx.fillRect(Math.floor(n.x-hw),Math.floor(n.y+dy),Math.ceil(hw*2),3);
    }
  });
  // Far stars (slow scroll)
  const s1=(bgT*.12)%GH;
  ctx.globalAlpha=1;
  for(const s of STARS_A){const sy=(s.y+s1)%GH;ctx.globalAlpha=.3+.15*Math.sin(bgT*.001+s.x);ctx.fillStyle='#334477';ctx.fillRect(s.x,sy,1,1);}
  // Mid stars
  const s2=(bgT*.28)%GH;
  for(const s of STARS_B){const sy=(s.y+s2)%GH;ctx.globalAlpha=.5+.2*Math.sin(bgT*.0015+s.y);ctx.fillStyle='#5577aa';ctx.fillRect(s.x,sy,2,2);}
  // Near stars (twinkle, no scroll)
  for(const s of STARS_C){
    const tw=Math.sin(bgT*.003+s.x*.1);ctx.globalAlpha=.65+.35*tw;
    ctx.fillStyle='#ffffff';ctx.fillRect(s.x,s.y,3,3);
    if(tw>.6){ctx.globalAlpha=.35;ctx.fillStyle='#aaddff';ctx.fillRect(s.x-1,s.y+1,1,3);ctx.fillRect(s.x+3,s.y+1,1,3);}
  }
  ctx.globalAlpha=1;
  // Scanlines
  ctx.fillStyle='rgba(0,0,0,0.07)';for(let sy=0;sy<GH;sy+=4)ctx.fillRect(0,sy,GW,2);
  // Nebula colour tint bands (very faint horizontal gradient)
  const bandA=0.04+0.02*Math.sin(bgT*.002);
  ctx.globalAlpha=bandA;ctx.fillStyle='#110022';ctx.fillRect(0,0,GW,GH*.4);
  ctx.globalAlpha=bandA*.7;ctx.fillStyle='#000c22';ctx.fillRect(0,GH*.6,GW,GH*.4);
  ctx.globalAlpha=1;
  bgT++;
}

// ── Enemy drawing (6 distinct sprite styles) ──────────────
function drawEnemy(e){
  const{x,y,w,h,col,drk,lit,ti,hp,maxHp}=e;

  if(ti===0){
    // BASIC — clean rectangular tupperware
    ctx.fillStyle=col;ctx.fillRect(x+4,y+12,w-8,h-14);
    ctx.fillStyle=drk;ctx.fillRect(x,y+12,4,h-14);ctx.fillRect(x+w-4,y+12,4,h-14);ctx.fillRect(x+4,y+h-4,w-8,4);
    ctx.fillStyle=lit;ctx.fillRect(x,y+4,w,11);ctx.fillRect(x+4,y+13,5,h-22);
    ctx.fillStyle=drk;ctx.fillRect(x,y+4,w,3);ctx.fillRect(x,y+11,w,2);
    // Side clips
    ctx.fillStyle=lit;ctx.fillRect(x-5,y+6,5,8);ctx.fillRect(x+w,y+6,5,8);
    ctx.fillStyle=drk;ctx.fillRect(x-5,y+6,2,8);ctx.fillRect(x+w+3,y+6,2,8);
  } else if(ti===1){
    // ARMORED — heavy plated box
    ctx.fillStyle='#7777aa';ctx.fillRect(x+2,y+10,w-4,h-12);
    ctx.fillStyle='#333355';ctx.fillRect(x,y+10,3,h-12);ctx.fillRect(x+w-3,y+10,3,h-12);ctx.fillRect(x+2,y+h-4,w-4,4);
    ctx.fillStyle='#9999bb';ctx.fillRect(x,y+4,w,10);
    ctx.fillStyle='#111133';ctx.fillRect(x,y+4,w,2);ctx.fillRect(x,y+10,w,2);
    // Armor plate rivets
    ctx.fillStyle='#ffd166';
    for(let bx=7;bx<w;bx+=11)ctx.fillRect(x+bx,y+h-9,4,4);
    // Plating horizontal lines
    ctx.fillStyle='#222244';
    ctx.fillRect(x+4,y+15,w-8,2);ctx.fillRect(x+4,y+25,w-8,2);ctx.fillRect(x+4,y+35,w-8,2);
    // Heavy side reinforcements
    ctx.fillStyle='#555577';ctx.fillRect(x-6,y+8,6,h-10);ctx.fillRect(x+w,y+8,6,h-10);
  } else if(ti===2){
    // SPEEDY — slim aerodynamic can
    ctx.fillStyle=col;ctx.fillRect(x+7,y+8,w-14,h-10);
    ctx.fillStyle=drk;ctx.fillRect(x+3,y+8,4,h-10);ctx.fillRect(x+w-7,y+8,4,h-10);ctx.fillRect(x+7,y+h-3,w-14,3);
    ctx.fillStyle=lit;ctx.fillRect(x+3,y+3,w-6,8);
    ctx.fillStyle=drk;ctx.fillRect(x+3,y+3,w-6,2);ctx.fillRect(x+3,y+8,w-6,2);
    // Speed slash lines
    ctx.fillStyle=drk;
    for(let sl=0;sl<3;sl++)ctx.fillRect(x-10-sl*5,y+h/2-3+sl*6,7,2);
    ctx.fillRect(x+w+2,y+h*.3,7,2);ctx.fillRect(x+w+2,y+h*.5,5,2);
    // Fin wings
    ctx.fillStyle=lit;ctx.fillRect(x+3,y+h-14,6,10);ctx.fillRect(x+w-9,y+h-14,6,10);
  } else if(ti===3){
    // TANK — massive fortress tub
    ctx.fillStyle=col;ctx.fillRect(x+2,y+14,w-4,h-16);
    ctx.fillStyle=drk;ctx.fillRect(x,y+14,2,h-16);ctx.fillRect(x+w-2,y+14,2,h-16);ctx.fillRect(x+2,y+h-4,w-4,4);
    ctx.fillStyle=lit;ctx.fillRect(x,y+6,w,12);
    ctx.fillStyle=drk;ctx.fillRect(x,y+6,w,3);ctx.fillRect(x,y+14,w,3);
    // Crown spikes
    ctx.fillStyle='#ff0040';
    [.12,.28,.5,.72,.88].forEach(p=>{const sx=Math.floor(x+p*w);ctx.fillRect(sx-3,y,6,9);ctx.fillRect(sx-1,y-5,2,5);});
    // Side heavy armor
    ctx.fillStyle=drk;ctx.fillRect(x-10,y+8,10,h-8);ctx.fillRect(x+w,y+8,10,h-8);
    ctx.fillStyle=lit;ctx.fillRect(x-10,y+8,4,h-8);ctx.fillRect(x+w,y+8,4,h-8);
  } else if(ti===4){
    // BOMBER — round-bellied grenade tupperware
    ctx.fillStyle=col;ctx.fillRect(x+8,y+10,w-16,h-12);
    ctx.fillStyle=drk;ctx.fillRect(x+4,y+10,4,h-12);ctx.fillRect(x+w-8,y+10,4,h-12);ctx.fillRect(x+8,y+h-4,w-16,4);
    ctx.fillStyle=lit;ctx.fillRect(x+4,y+4,w-8,10);
    ctx.fillStyle=drk;ctx.fillRect(x+4,y+4,w-8,2);ctx.fillRect(x+4,y+10,w-8,2);
    // Fuse
    ctx.fillStyle='#ffff00';ctx.fillRect(x+w/2-2,y-6,4,9);ctx.fillRect(x+w/2+2,y-10,4,5);
    ctx.fillStyle='#ff6600';ctx.fillRect(x+w/2+1,y-13,5,4);
    // Warning stripes on belly
    ctx.fillStyle='#ff0000';
    for(let s=0;s<4;s++)ctx.fillRect(x+10+s*8,y+h-10,4,6);
  } else {
    // GHOST — ethereal teal, semi-transparent
    ctx.globalAlpha=0.72;
    ctx.fillStyle=col;ctx.fillRect(x+6,y+10,w-12,h-12);
    ctx.fillStyle=drk;ctx.fillRect(x+2,y+10,4,h-12);ctx.fillRect(x+w-6,y+10,4,h-12);
    ctx.fillStyle=lit;ctx.fillRect(x+2,y+4,w-4,10);
    ctx.globalAlpha=1;
    // Shimmer highlight
    ctx.fillStyle='rgba(180,255,240,0.45)';ctx.fillRect(x+8,y+14,5,h-22);
    // Phase flicker effect
    if(Math.floor(Date.now()/300)%3===0){ctx.globalAlpha=0.18;ctx.fillStyle='#88ffee';ctx.fillRect(x,y,w,h);}
    ctx.globalAlpha=1;
  }

  // Universal eyes (all types share these, centered on face area)
  const eyY=y+Math.floor(h*.62);const eyL=x+Math.floor(w*.22);const eyR=x+Math.floor(w*.62);
  ctx.fillStyle='#ff0040';ctx.fillRect(eyL,eyY,9,9);ctx.fillRect(eyR,eyY,9,9);
  ctx.fillStyle='#ff8888';ctx.fillRect(eyL,eyY,3,3);ctx.fillRect(eyR,eyY,3,3);
  // Angry inner brows
  ctx.fillStyle='#aa0020';
  ctx.fillRect(eyL-2,eyY-5,11,3);ctx.fillRect(eyR-2,eyY-5,11,3);
  ctx.fillRect(eyL+9,eyY-8,4,4);ctx.fillRect(eyR-3,eyY-8,4,4);

  // HP bar if multi-hp
  if(maxHp>1){ctx.fillStyle='#111';ctx.fillRect(x,y+h+3,w,5);ctx.fillStyle='#00ff44';ctx.fillRect(x,y+h+3,w*(hp/maxHp),5);}
}

// ═══════════════════════════════════════════════════
//  BOSS DRAWING — 6 UNIQUE BOSSES THAT LOOK THEIR NAME
// ═══════════════════════════════════════════════════

// Shared: boss laser beam renderer
function drawBossLaser(bx,y,w,h){
  if(!bLaserOn)return;
  const cx=Math.floor(bLaserX);
  const a=0.5+0.4*Math.sin(Date.now()*0.06);
  ctx.save();
  ctx.globalAlpha=a*0.18;ctx.fillStyle='#ff0040';ctx.fillRect(cx-28,y+h,56,GH);
  ctx.globalAlpha=a*0.55;ctx.fillStyle='#ff4466';ctx.fillRect(cx-10,y+h,20,GH);
  ctx.globalAlpha=a;
  for(let sy=y+h;sy<GH;sy+=16){ctx.fillStyle='#ff0000';ctx.fillRect(cx-4,sy,8,8);ctx.fillStyle='#ff8888';ctx.fillRect(cx-4,sy+8,8,8);}
  ctx.globalAlpha=1;ctx.restore();
  ctx.fillStyle='#ffff00';ctx.fillRect(cx-16,y+h+2,32,5);ctx.fillRect(cx-10,y+h+7,20,4);ctx.fillRect(cx-4,y+h+11,8,4);
}

// Shared: HP bar + boss name
function drawBossHPBar(bx,y,w,h,hp,mHp,name,nameCol){
  const pct=hp/mHp,bc=pct>0.6?'#00ff44':pct>0.3?'#ffcc00':'#ff0040';
  ctx.fillStyle='#080008';ctx.fillRect(bx,y+h+6,w,14);
  ctx.fillStyle=bc;ctx.fillRect(bx,y+h+6,Math.floor(w*pct),14);
  ctx.fillStyle='#333';ctx.fillRect(bx,y+h+6,w,2);ctx.fillRect(bx,y+h+18,w,2);
  ctx.save();
  ctx.font="6px 'Press Start 2P',monospace";ctx.fillStyle='#fff';ctx.textAlign='center';
  ctx.fillText(hp+' / '+mHp,bx+w/2,y+h+17);
  ctx.font="7px 'Press Start 2P',monospace";ctx.fillStyle=nameCol||'#ff6b35';
  ctx.fillText(name,bx+w/2,y+h+32);
  ctx.restore();
}

// ─── BOSS 0: THE LID KING (Level 5) ─────────────────────────
// A massive golden lid — flat disc body with a jewelled crown on top,
// angry royal face, scepter arms sticking out the sides
function drawLidKing(bx,y,w,h,hp,mHp,shk){
  const pulse=Math.floor(Date.now()/200)%2;
  const shimmer=Math.floor(Date.now()/120)%3;
  const cx=bx+w/2;

  // ── SCEPTER ARMS ──
  // Left scepter: horizontal rod + orb
  ctx.fillStyle='#aa8800';ctx.fillRect(bx-38,y+h/2-4,38,8);
  ctx.fillStyle='#ffdd00';ctx.fillRect(bx-38,y+h/2-4,10,8);
  ctx.fillStyle='#ffcc00';ctx.fillRect(bx-44,y+h/2-12,16,24); // orb body
  ctx.fillStyle='#ffe866';ctx.fillRect(bx-42,y+h/2-12,6,8); // orb shine
  ctx.fillStyle='#884400';ctx.fillRect(bx-44,y+h/2-12,4,24); // orb shadow
  ctx.fillStyle='#ff0000';ctx.fillRect(bx-38,y+h/2-6,8,12); // ruby gem on orb
  // Right scepter
  ctx.fillStyle='#aa8800';ctx.fillRect(bx+w,y+h/2-4,38,8);
  ctx.fillStyle='#ffdd00';ctx.fillRect(bx+w+28,y+h/2-4,10,8);
  ctx.fillStyle='#ffcc00';ctx.fillRect(bx+w+28,y+h/2-12,16,24);
  ctx.fillStyle='#ffe866';ctx.fillRect(bx+w+30,y+h/2-12,6,8);
  ctx.fillStyle='#884400';ctx.fillRect(bx+w+40,y+h/2-12,4,24);
  ctx.fillStyle='#ff0000';ctx.fillRect(bx+w+30,y+h/2-6,8,12);

  // ── THE LID — flat golden disc (main body) ──
  // Shadow/depth layers
  ctx.fillStyle='#664400';ctx.fillRect(bx+4,y+h-30,w-8,34);
  ctx.fillStyle='#885500';ctx.fillRect(bx+2,y+h-38,w-4,38);
  ctx.fillStyle='#aa7700';ctx.fillRect(bx,y+h-52,w,52);
  ctx.fillStyle='#cc9900';ctx.fillRect(bx+4,y+h-68,w-8,18);
  ctx.fillStyle='#ddaa00';ctx.fillRect(bx+8,y+h-74,w-16,10);
  // Lid top surface (dome)
  ctx.fillStyle='#ffcc00';ctx.fillRect(bx+4,y+h-80,w-8,12);
  ctx.fillStyle='#ffdd44';ctx.fillRect(bx+10,y+h-84,w-20,8);
  ctx.fillStyle='#ffe866';ctx.fillRect(bx+20,y+h-86,w-40,6);
  // Lid lip (rim around edge)
  ctx.fillStyle='#cc8800';ctx.fillRect(bx,y+h-56,8,12);ctx.fillRect(bx+w-8,y+h-56,8,12);
  ctx.fillStyle='#ffaa00';ctx.fillRect(bx+2,y+h-56,5,12);ctx.fillRect(bx+w-7,y+h-56,5,12);
  // Engraved ring lines
  ctx.fillStyle='#aa7700';
  ctx.fillRect(bx+12,y+h-70,w-24,3);ctx.fillRect(bx+20,y+h-76,w-40,3);

  // ── ROYAL FACE on the lid ──
  // Eyes: angry brows
  ctx.fillStyle='#553300';ctx.fillRect(bx+30,y+h-64,40,6); // left brow
  ctx.fillRect(bx+w-70,y+h-64,40,6);                       // right brow
  ctx.fillStyle='#220000';ctx.fillRect(bx+30,y+h-64,10,6); // brow shadow
  ctx.fillRect(bx+w-40,y+h-64,10,6);
  // Eye sockets
  ctx.fillStyle='#000000';ctx.fillRect(bx+32,y+h-58,34,22);ctx.fillRect(bx+w-66,y+h-58,34,22);
  // Pupils — golden royal eyes
  ctx.fillStyle=pulse?'#ffcc00':'#ff9900';
  ctx.fillRect(bx+36,y+h-54,26,14);ctx.fillRect(bx+w-62,y+h-54,26,14);
  ctx.fillStyle='#ffe866';ctx.fillRect(bx+38,y+h-54,8,6);ctx.fillRect(bx+w-60,y+h-54,8,6);
  ctx.fillStyle='#000000';ctx.fillRect(bx+46,y+h-54,8,8);ctx.fillRect(bx+w-50,y+h-54,8,8);
  // Regal nose
  ctx.fillStyle='#aa7700';ctx.fillRect(cx-8,y+h-44,16,10);ctx.fillRect(cx-12,y+h-36,24,8);
  // Stern royal mouth
  ctx.fillStyle='#553300';ctx.fillRect(bx+28,y+h-28,w-56,6);
  ctx.fillStyle='#000000';ctx.fillRect(bx+30,y+h-26,w-60,4);

  // ── JEWELLED CROWN on top ──
  ctx.fillStyle='#ffcc00';
  ctx.fillRect(bx+8,y-22,w-16,24); // crown band base
  ctx.fillStyle='#ffee44';ctx.fillRect(bx+8,y-22,w-16,8); // shine strip
  ctx.fillStyle='#cc9900';ctx.fillRect(bx+8,y-2,w-16,4);  // bottom rim
  // Crown points (5 tall points)
  const crownPts=[0.1,0.28,0.5,0.72,0.9];
  const crownH=[28,22,34,22,28];
  crownPts.forEach((p,i)=>{
    const px=Math.floor(bx+p*w);const ph=crownH[i];
    ctx.fillStyle='#ffcc00';ctx.fillRect(px-8,y-22-ph,16,ph+2);
    ctx.fillStyle='#ffee44';ctx.fillRect(px-5,y-22-ph,6,ph);
    ctx.fillStyle='#cc9900';ctx.fillRect(px+4,y-22-ph,4,ph);
    // Gem on each crown point
    const gemCol=['#ff0000','#00ff44','#0088ff','#ff00ff','#ff8800'][i];
    ctx.fillStyle=gemCol;ctx.fillRect(px-5,y-22-ph+2,10,12);
    ctx.fillStyle='#ffffff';ctx.fillRect(px-3,y-22-ph+3,4,4);
  });
  // Crown jewels in band
  ['#ff0000','#00ff88','#ff0000','#0088ff','#ff0000'].forEach((gc,i)=>{
    const gx=bx+24+i*Math.floor((w-48)/4);
    ctx.fillStyle=gc;ctx.fillRect(gx,y-20,14,14);
    ctx.fillStyle='#ffffff';ctx.fillRect(gx,y-20,5,5);
    if(shimmer===i%3){ctx.save();ctx.globalAlpha=0.6;ctx.fillStyle='#ffffff';ctx.fillRect(gx,y-20,14,14);ctx.restore();}
  });

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'THE LID KING','#ffcc00');
}

// ─── BOSS 1: FROSTLOCK (Level 10) ────────────────────────────
// A giant ice cube / frozen container — translucent blue-white cuboid,
// sharp ice crystal spikes growing out of it, frozen angry face
function drawFrostlock(bx,y,w,h,hp,mHp,shk){
  const tk=Math.floor(Date.now()/100);
  const iceShimmer=Math.floor(Date.now()/300)%4;

  // ── ICE CRYSTAL SPIKES (before body so body overlaps base) ──
  const spikePositions=[
    {x:0.08,topH:42,baseW:16},{x:0.22,topH:28,baseW:12},{x:0.38,topH:52,baseW:18},
    {x:0.5, topH:60,baseW:20},{x:0.62,topH:52,baseW:18},{x:0.78,topH:28,baseW:12},{x:0.92,topH:42,baseW:16}
  ];
  spikePositions.forEach(sp=>{
    const sx=Math.floor(bx+sp.x*w);
    // Shadow spike
    ctx.fillStyle='#002255';ctx.fillRect(sx-sp.baseW/2+4,y-sp.topH+4,sp.baseW,sp.topH);
    ctx.fillRect(sx-sp.baseW/4+4,y-sp.topH-8+4,sp.baseW/2,10);
    // Main spike
    ctx.fillStyle='#aaddff';ctx.fillRect(sx-sp.baseW/2,y-sp.topH,sp.baseW,sp.topH);
    ctx.fillStyle='#ddf0ff';ctx.fillRect(sx-sp.baseW/2,y-sp.topH,sp.baseW/3,sp.topH);
    // Tip
    ctx.fillStyle='#eef8ff';ctx.fillRect(sx-sp.baseW/4,y-sp.topH-10,sp.baseW/2,12);
    ctx.fillRect(sx-2,y-sp.topH-18,4,10);
    // Facet lines (ice geometry)
    ctx.fillStyle='#4499cc';ctx.fillRect(sx+sp.baseW/4,y-sp.topH,4,sp.topH);
  });

  // ── BODY: frozen tupperware container ──
  // Outer frost shadow
  ctx.fillStyle='#002244';ctx.fillRect(bx,y,w,h);
  // Main ice body
  ctx.fillStyle='#1155aa';ctx.fillRect(bx+4,y+4,w-8,h-4);
  ctx.fillStyle='#2277cc';ctx.fillRect(bx+8,y+8,w-16,h-12);
  // Ice interior glow
  ctx.fillStyle='#3399ee';ctx.fillRect(bx+14,y+14,w-28,h-22);
  ctx.fillStyle='#44aaff';ctx.fillRect(bx+20,y+20,w-40,h-34);
  // Translucent inner core
  ctx.save();ctx.globalAlpha=0.5;ctx.fillStyle='#88ccff';ctx.fillRect(bx+28,y+28,w-56,h-50);ctx.restore();

  // ── FROST TEXTURE (cracked ice lines) ──
  ctx.fillStyle='#aaccee';
  // Crack lines across body
  [[0,0.3,0.4,0.7],[0.2,0.1,0.6,0.5],[0.5,0.0,0.8,0.4],[0.1,0.5,0.3,0.8],[0.7,0.2,0.9,0.6]].forEach(([x1,y1,x2,y2])=>{
    const lx1=Math.floor(bx+x1*w),ly1=Math.floor(y+y1*h),lx2=Math.floor(bx+x2*w),ly2=Math.floor(y+y2*h);
    ctx.fillRect(Math.min(lx1,lx2),ly1,Math.abs(lx2-lx1)+2,2);
    ctx.fillRect(lx1,Math.min(ly1,ly2),2,Math.abs(ly2-ly1)+2);
  });

  // ── FROZEN FACE ──
  // Frost over eyes = pale blue sockets
  ctx.fillStyle='#000a22';ctx.fillRect(bx+20,y+22,44,28);ctx.fillRect(bx+w-64,y+22,44,28);
  ctx.fillStyle='#0044aa';ctx.fillRect(bx+24,y+26,36,20);ctx.fillRect(bx+w-60,y+26,36,20);
  ctx.fillStyle='#55aaff';ctx.fillRect(bx+28,y+30,28,12);ctx.fillRect(bx+w-56,y+30,28,12);
  ctx.fillStyle='#aaddff';ctx.fillRect(bx+30,y+30,10,8);ctx.fillRect(bx+w-54,y+30,10,8);
  // Frozen pupil — black dot encased in ice
  ctx.fillStyle='#000000';ctx.fillRect(bx+38,y+33,10,8);ctx.fillRect(bx+w-48,y+33,10,8);
  ctx.fillStyle='#ffffff';ctx.fillRect(bx+38,y+33,4,4);ctx.fillRect(bx+w-48,y+33,4,4);
  // Frowning frozen mouth
  ctx.fillStyle='#000a22';ctx.fillRect(bx+24,y+h-38,w-48,10);
  ctx.fillStyle='#0033aa';ctx.fillRect(bx+26,y+h-36,w-52,6);
  // Icicle teeth hanging from lid
  ctx.fillStyle='#aaddff';
  for(let it=0;it<8;it++){ctx.fillRect(bx+22+it*18,y+h-38,8,12+it%3*4);ctx.fillRect(bx+24+it*18,y+h-38,4,16+it%2*4);}

  // ── LID: flat top rim ──
  ctx.fillStyle='#003388';ctx.fillRect(bx-4,y-2,w+8,12);
  ctx.fillStyle='#1166cc';ctx.fillRect(bx+2,y-2,w-4,8);
  ctx.fillStyle='#66aaee';ctx.fillRect(bx+8,y-2,w-16,4);
  // Side clips (frozen solid)
  ctx.fillStyle='#0044aa';ctx.fillRect(bx-10,y+h/3-8,10,20);ctx.fillRect(bx+w,y+h/3-8,10,20);
  ctx.fillStyle='#3377cc';ctx.fillRect(bx-10,y+h/3-8,5,20);ctx.fillRect(bx+w,y+h/3-8,5,20);

  // ── SHIMMER sparkle ──
  if(iceShimmer<3){
    ctx.save();ctx.globalAlpha=0.7;ctx.fillStyle='#ffffff';
    const sparkleX=[bx+30,bx+w-40,bx+w/2,bx+50,bx+w-60];
    const sparkleY=[y+30,y+50,y+20,y+h-40,y+h-30];
    ctx.fillRect(sparkleX[iceShimmer]-4,sparkleY[iceShimmer],8,2);
    ctx.fillRect(sparkleX[iceShimmer],sparkleY[iceShimmer]-4,2,8);
    ctx.restore();
  }

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'FROSTLOCK','#88ddff');
}

// ─── BOSS 2: SAUCEPAN SAM (Level 15) ─────────────────────────
// A big round saucepan — circular pot body, long handle on the side,
// bubbling lid on top with steam holes, angry red-faced chef expression
function drawSaucepanSam(bx,y,w,h,hp,mHp,shk){
  const tk=Math.floor(Date.now()/80);
  const bubble=Math.floor(Date.now()/250)%4;
  const steam=Math.floor(Date.now()/150)%3;
  const cx=bx+w/2;
  const boil=hp/mHp<0.5; // boiling rage below half HP

  // ── HANDLE (sticking out right side) ──
  ctx.fillStyle='#333333';ctx.fillRect(bx+w,y+h/2-8,52,16);
  ctx.fillStyle='#555555';ctx.fillRect(bx+w,y+h/2-8,50,8);
  ctx.fillStyle='#222222';ctx.fillRect(bx+w,y+h/2,50,8);
  // Handle grip (wood-style)
  ctx.fillStyle='#884422';ctx.fillRect(bx+w+16,y+h/2-10,30,20);
  ctx.fillStyle='#aa5533';ctx.fillRect(bx+w+16,y+h/2-10,30,9);
  ctx.fillStyle='#663311';ctx.fillRect(bx+w+16,y+h/2,30,10);
  // Grip lines
  ctx.fillStyle='#552211';
  for(let g=0;g<4;g++)ctx.fillRect(bx+w+20+g*6,y+h/2-10,3,20);
  // Small stub handle left
  ctx.fillStyle='#333333';ctx.fillRect(bx-20,y+h/2-6,20,12);
  ctx.fillStyle='#555555';ctx.fillRect(bx-20,y+h/2-6,20,5);

  // ── POT BODY (wide rounded barrel) ──
  // Dark shadow/base
  ctx.fillStyle='#111111';ctx.fillRect(bx+2,y+10,w-4,h-10);
  // Main body - dark steel
  ctx.fillStyle='#2a2a2a';ctx.fillRect(bx+4,y+6,w-8,h-6);
  ctx.fillStyle='#383838';ctx.fillRect(bx+8,y+4,w-16,h-4);
  ctx.fillStyle='#424242';ctx.fillRect(bx+12,y+6,w-24,h-8);
  // Hot glow from bottom (boiling)
  if(boil){
    ctx.save();ctx.globalAlpha=0.35+0.15*Math.sin(Date.now()*0.01);
    ctx.fillStyle='#ff4400';ctx.fillRect(bx+12,y+h-28,w-24,28);
    ctx.globalAlpha=0.2;ctx.fillStyle='#ff8800';ctx.fillRect(bx+8,y+h-20,w-16,20);
    ctx.restore();
  }
  // Highlight stripe
  ctx.fillStyle='#555555';ctx.fillRect(bx+12,y+6,20,h-8);
  ctx.fillStyle='#666666';ctx.fillRect(bx+14,y+6,8,h-8);
  // Pot rim (thick lip at top)
  ctx.fillStyle='#555555';ctx.fillRect(bx+2,y+2,w-4,8);
  ctx.fillStyle='#666666';ctx.fillRect(bx+4,y+2,w-8,5);
  ctx.fillStyle='#888888';ctx.fillRect(bx+6,y+2,w-12,3);
  // Pot base ring
  ctx.fillStyle='#111111';ctx.fillRect(bx+8,y+h-6,w-16,8);
  ctx.fillStyle='#333333';ctx.fillRect(bx+12,y+h-4,w-24,6);

  // ── BUBBLING LID on top ──
  ctx.fillStyle='#111111';ctx.fillRect(bx-2,y-12,w+4,14);
  ctx.fillStyle='#2a2a2a';ctx.fillRect(bx,y-10,w,12);
  ctx.fillStyle='#333333';ctx.fillRect(bx+4,y-12,w-8,10);
  ctx.fillStyle='#444444';ctx.fillRect(bx+8,y-14,w-16,8);
  ctx.fillStyle='#555555';ctx.fillRect(bx+16,y-15,w-32,6);
  // Lid knob
  ctx.fillStyle='#333333';ctx.fillRect(cx-12,y-22,24,10);
  ctx.fillStyle='#555555';ctx.fillRect(cx-10,y-22,20,6);
  ctx.fillStyle='#666666';ctx.fillRect(cx-8,y-22,12,4);
  // Steam holes in lid
  const holes=[cx-50,cx-20,cx,cx+20,cx+50];
  holes.forEach(hx=>{
    ctx.fillStyle='#000000';ctx.fillRect(hx-4,y-12,8,8);
    ctx.fillStyle='#1a1a1a';ctx.fillRect(hx-3,y-12,6,6);
  });
  // Steam wisps rising from holes
  holes.forEach((hx,i)=>{
    const sw=(steam+i)%3;
    ctx.save();ctx.globalAlpha=0.6-sw*0.15;ctx.fillStyle='#ccccaa';
    ctx.fillRect(hx-3,y-12-sw*10,6,8);
    ctx.fillRect(hx-5,y-20-sw*10,10,6);
    ctx.fillRect(hx-7,y-26-sw*10,14,5);
    ctx.restore();
  });

  // ── ANGRY FACE on pot body ──
  // Angry red glow around face area when boiling
  if(boil){ctx.save();ctx.globalAlpha=0.25;ctx.fillStyle='#ff0000';ctx.fillRect(bx+14,y+22,w-28,65);ctx.restore();}
  // Eyebrows (deep angry V shape)
  ctx.fillStyle='#000000';
  // Left brow: inner high, outer low
  ctx.fillRect(bx+22,y+28,12,6);ctx.fillRect(bx+32,y+24,10,6);ctx.fillRect(bx+40,y+20,8,6);
  // Right brow: mirror
  ctx.fillRect(bx+w-34,y+28,12,6);ctx.fillRect(bx+w-42,y+24,10,6);ctx.fillRect(bx+w-48,y+20,8,6);
  // Eyes
  ctx.fillStyle='#111111';ctx.fillRect(bx+24,y+34,36,24);ctx.fillRect(bx+w-60,y+34,36,24);
  ctx.fillStyle=boil?'#ff3300':'#cc2200';ctx.fillRect(bx+28,y+38,28,16);ctx.fillRect(bx+w-56,y+38,28,16);
  ctx.fillStyle=boil?'#ff8800':'#ff4400';ctx.fillRect(bx+32,y+40,18,10);ctx.fillRect(bx+w-50,y+40,18,10);
  ctx.fillStyle='#ffffff';ctx.fillRect(bx+34,y+40,7,7);ctx.fillRect(bx+w-48,y+40,7,7);
  ctx.fillStyle='#000000';ctx.fillRect(bx+40,y+42,6,6);ctx.fillRect(bx+w-42,y+42,6,6);
  // Boiling nose drip
  ctx.fillStyle='#cc3300';ctx.fillRect(cx-8,y+60,16,12);
  ctx.fillStyle='#ff4400';ctx.fillRect(cx-10,y+68,20,10);
  // Grumpy downturned mouth
  ctx.fillStyle='#000000';ctx.fillRect(bx+22,y+h-36,w-44,14);
  // Teeth showing (gritted)
  ctx.fillStyle='#eeeeee';
  for(let t2=0;t2<7;t2++)ctx.fillRect(bx+26+t2*19,y+h-34,14,10);
  ctx.fillStyle='#888888';
  for(let t2=0;t2<7;t2++)ctx.fillRect(bx+26+t2*19,y+h-34,3,10);
  // Bubble counter - boiling liquid splashes near bottom
  if(boil){
    ctx.fillStyle='#ff6600';
    const bx2=[cx-60,cx-20,cx+20,cx+50];
    bx2.forEach((bxb,i)=>{if((bubble+i)%4<2){ctx.fillRect(bxb,y+h-14,10,10);ctx.fillRect(bxb-3,y+h-20,6,8);}});
  }

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'SAUCEPAN SAM','#ffaa44');
}

// ─── BOSS 3: CRISPER LORD (Level 20) ─────────────────────────
// A wide, flat rectangular crisper drawer — the kind from a fridge.
// Long horizontal body, transparent window showing frozen vegetables,
// blue-lit face, cold vapour vents
function drawCrisperLord(bx,y,w,h,hp,mHp,shk){
  const tk=Math.floor(Date.now()/100);
  const vapour=Math.floor(Date.now()/200)%5;
  const pulse=Math.floor(Date.now()/300)%2;

  // ── DRAWER RAILS (sides sticking out) ──
  ctx.fillStyle='#112233';ctx.fillRect(bx-14,y+h/2-5,14,10);ctx.fillRect(bx+w,y+h/2-5,14,10);
  ctx.fillStyle='#224466';ctx.fillRect(bx-14,y+h/2-5,14,5);ctx.fillRect(bx+w,y+h/2-5,14,5);

  // ── MAIN DRAWER BODY (wide & flat) ──
  // Outer frame (fridge plastic - grey-white)
  ctx.fillStyle='#223344';ctx.fillRect(bx,y,w,h);
  ctx.fillStyle='#2a4466';ctx.fillRect(bx+2,y+2,w-4,h-4);
  ctx.fillStyle='#334455';ctx.fillRect(bx+4,y+4,w-8,h-8);
  // Inner compartment (darker)
  ctx.fillStyle='#0a1a2a';ctx.fillRect(bx+8,y+10,w-16,h-20);
  // Cold blue interior glow
  ctx.save();ctx.globalAlpha=0.4+0.15*Math.sin(Date.now()*0.003);
  ctx.fillStyle='#0066aa';ctx.fillRect(bx+10,y+12,w-20,h-24);ctx.restore();
  // Frost condensation around edges
  ctx.fillStyle='#558899';
  ctx.fillRect(bx+8,y+10,4,h-20);ctx.fillRect(bx+w-12,y+10,4,h-20);
  ctx.fillRect(bx+8,y+10,w-16,4);ctx.fillRect(bx+8,y+h-14,w-16,4);

  // ── TRANSPARENT WINDOW (showing vegetables inside) ──
  ctx.fillStyle='#001122';ctx.fillRect(bx+16,y+18,w-32,h/2);
  ctx.save();ctx.globalAlpha=0.7;ctx.fillStyle='#003355';ctx.fillRect(bx+18,y+20,w-36,h/2-4);ctx.restore();
  // Frozen veggies: broccoli, carrot, pea shapes
  // Broccoli (green cluster)
  ctx.fillStyle='#005500';ctx.fillRect(bx+26,y+26,18,12);
  ctx.fillStyle='#008800';ctx.fillRect(bx+22,y+22,10,10);ctx.fillRect(bx+32,y+20,10,12);ctx.fillRect(bx+40,y+24,8,10);
  ctx.fillStyle='#00aa00';ctx.fillRect(bx+24,y+22,6,6);ctx.fillRect(bx+34,y+20,6,8);
  // Carrot (orange)
  ctx.fillStyle='#cc5500';ctx.fillRect(bx+60,y+24,8,18);
  ctx.fillStyle='#ff7700';ctx.fillRect(bx+60,y+24,8,10);
  ctx.fillStyle='#006600';ctx.fillRect(bx+62,y+18,4,8); // carrot top
  // Peas (dots)
  ctx.fillStyle='#339933';
  [78,88,94,82,72].forEach((px,i)=>ctx.fillRect(px+bx-50,y+22+i%2*8,8,8));
  // Frost glaze overlay on window
  ctx.save();ctx.globalAlpha=0.25;ctx.fillStyle='#88ccee';ctx.fillRect(bx+18,y+20,w-36,h/2-4);ctx.restore();
  // Window border
  ctx.fillStyle='#2266aa';ctx.fillRect(bx+14,y+16,w-28,4);ctx.fillRect(bx+14,y+h/2+18,w-28,4);
  ctx.fillRect(bx+14,y+16,4,h/2+6);ctx.fillRect(bx+w-18,y+16,4,h/2+6);

  // ── FACE in lower half of drawer ──
  const fy=y+h/2+6;
  // Cold blue eyes
  ctx.fillStyle='#001122';ctx.fillRect(bx+24,fy,36,22);ctx.fillRect(bx+w-60,fy,36,22);
  ctx.fillStyle='#0055aa';ctx.fillRect(bx+28,fy+4,28,14);ctx.fillRect(bx+w-56,fy+4,28,14);
  ctx.fillStyle=pulse?'#00aaff':'#0066cc';ctx.fillRect(bx+32,fy+6,20,10);ctx.fillRect(bx+w-52,fy+6,20,10);
  ctx.fillStyle='#66ddff';ctx.fillRect(bx+32,fy+6,7,5);ctx.fillRect(bx+w-52,fy+6,7,5);
  ctx.fillStyle='#000000';ctx.fillRect(bx+40,fy+8,6,6);ctx.fillRect(bx+w-46,fy+8,6,6);
  // Snide smirk (thinks he's better than you)
  ctx.fillStyle='#000000';ctx.fillRect(bx+30,y+h-20,w-60,8);
  ctx.fillStyle='#001a33';ctx.fillRect(bx+32,y+h-18,w-64,4);
  ctx.fillStyle='#334455';ctx.fillRect(bx+30,y+h-22,14,4);// one corner up = smirk
  // Frost vapour venting from sides
  const ventH=[y+h*0.2,y+h*0.5,y+h*0.75];
  ventH.forEach((vy,i)=>{
    if((vapour+i)%5<3){
      ctx.save();ctx.globalAlpha=0.4-((vapour+i)%5)*0.1;ctx.fillStyle='#aaccdd';
      ctx.fillRect(bx-18-(vapour+i)%5*4,vy-4,10,8);
      ctx.fillRect(bx+w+8+(vapour+i)%5*4,vy-4,10,8);ctx.restore();
    }
  });
  // Cold temp badge
  ctx.fillStyle='#0055aa';ctx.fillRect(cx-20,y+4,40,12);
  ctx.fillStyle='#aaddff';ctx.fillRect(cx-18,y+5,36,10);
  ctx.save();ctx.font="6px 'Press Start 2P',monospace";ctx.fillStyle='#003366';ctx.textAlign='center';
  ctx.fillText('-18°C',cx,y+13);ctx.restore();

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'CRISPER LORD','#4499ff');
}

// ─── BOSS 4: THERMOS PRIME (Level 25) ────────────────────────
// A tall cylindrical thermos — matte black body with metallic bands,
// a screw-top cap, built-in temperature gauge, robotic arms/vents
// on the sides that look like weaponized exhaust pipes
function drawThermosPrime(bx,y,w,h,hp,mHp,shk){
  const tk=Math.floor(Date.now()/60);
  const ventPulse=Math.floor(Date.now()/120)%2;
  const rage=1-hp/mHp;
  const cx=bx+w/2;

  // ── EXHAUST PIPES / WEAPON ARMS ──
  // Left side pipes
  ctx.fillStyle='#111111';
  ctx.fillRect(bx-28,y+h*0.2,28,12);  // pipe 1
  ctx.fillRect(bx-32,y+h*0.4,32,12);  // pipe 2
  ctx.fillRect(bx-28,y+h*0.6,28,12);  // pipe 3
  ctx.fillStyle='#333333';
  ctx.fillRect(bx-28,y+h*0.2,28,5);ctx.fillRect(bx-32,y+h*0.4,32,5);ctx.fillRect(bx-28,y+h*0.6,28,5);
  // Exhaust glow from pipes
  const exhaustCol=ventPulse?'#ff4400':'#ff8800';
  ctx.fillStyle=exhaustCol;
  ctx.fillRect(bx-36,y+h*0.2+2,8,8);ctx.fillRect(bx-40,y+h*0.4+2,8,8);ctx.fillRect(bx-36,y+h*0.6+2,8,8);
  if(rage>0.3){ctx.save();ctx.globalAlpha=rage*0.5;ctx.fillStyle='#ff4400';
    ctx.fillRect(bx-52,y+h*0.2,16,8);ctx.fillRect(bx-52,y+h*0.4,16,8);ctx.fillRect(bx-52,y+h*0.6,16,8);
    ctx.restore();}
  // Right side pipes
  ctx.fillStyle='#111111';
  ctx.fillRect(bx+w,y+h*0.2,28,12);ctx.fillRect(bx+w,y+h*0.4,32,12);ctx.fillRect(bx+w,y+h*0.6,28,12);
  ctx.fillStyle='#333333';
  ctx.fillRect(bx+w,y+h*0.2,28,5);ctx.fillRect(bx+w,y+h*0.4,32,5);ctx.fillRect(bx+w,y+h*0.6,28,5);
  ctx.fillStyle=exhaustCol;
  ctx.fillRect(bx+w+28,y+h*0.2+2,8,8);ctx.fillRect(bx+w+32,y+h*0.4+2,8,8);ctx.fillRect(bx+w+28,y+h*0.6+2,8,8);

  // ── THERMOS MAIN BODY ──
  // Outer body: matte black with shine
  ctx.fillStyle='#0a0a0a';ctx.fillRect(bx+2,y+20,w-4,h-20);
  ctx.fillStyle='#141414';ctx.fillRect(bx+4,y+18,w-8,h-18);
  ctx.fillStyle='#1a1a1a';ctx.fillRect(bx+8,y+16,w-16,h-16);
  ctx.fillStyle='#222222';ctx.fillRect(bx+12,y+16,w-24,h-16);
  // Metallic shine strip
  ctx.fillStyle='#2a2a2a';ctx.fillRect(bx+12,y+16,12,h-16);
  ctx.fillStyle='#333333';ctx.fillRect(bx+14,y+16,5,h-16);
  // Horizontal metallic bands
  ctx.fillStyle='#3a3a3a';
  [0.2,0.4,0.6,0.8].forEach(bp=>{ctx.fillRect(bx+4,y+h*bp,w-8,6);});
  ctx.fillStyle='#555555';
  [0.2,0.4,0.6,0.8].forEach(bp=>{ctx.fillRect(bx+4,y+h*bp,w-8,2);});
  // Red DANGER stripe
  ctx.fillStyle='#cc0000';ctx.fillRect(bx+4,y+h*0.72,w-8,8);
  ctx.fillStyle='#ff0000';ctx.fillRect(bx+4,y+h*0.72,w-8,3);
  // Warning text
  ctx.save();ctx.font="5px 'Press Start 2P',monospace";ctx.fillStyle='#000000';ctx.textAlign='center';
  ctx.fillText('DANGER',cx,y+h*0.72+6);ctx.restore();

  // ── SCREW-TOP CAP ──
  // Cap base
  ctx.fillStyle='#111111';ctx.fillRect(bx-2,y+4,w+4,16);
  ctx.fillStyle='#222222';ctx.fillRect(bx,y+4,w,14);
  ctx.fillStyle='#333333';ctx.fillRect(bx+4,y+4,w-8,12);
  // Screw thread lines
  ctx.fillStyle='#111111';
  for(let sc=0;sc<6;sc++)ctx.fillRect(bx+4+sc*(w-8)/6,y+6,(w-8)/12,10);
  // Cap top dome
  ctx.fillStyle='#1a1a1a';ctx.fillRect(bx+6,y-2,w-12,8);
  ctx.fillStyle='#282828';ctx.fillRect(bx+14,y-6,w-28,8);
  ctx.fillStyle='#333333';ctx.fillRect(bx+22,y-8,w-44,6);
  // Drink spout
  ctx.fillStyle='#111111';ctx.fillRect(cx-10,y-14,20,12);
  ctx.fillStyle='#222222';ctx.fillRect(cx-8,y-14,16,10);
  ctx.fillStyle='#000000';ctx.fillRect(cx-5,y-14,10,8);

  // ── TEMPERATURE GAUGE (glows with HP) ──
  const gaugeX=bx+14,gaugeY=y+h*0.3,gaugeH=h*0.25;
  ctx.fillStyle='#000000';ctx.fillRect(gaugeX,gaugeY,16,gaugeH);
  ctx.fillStyle='#1a1a1a';ctx.fillRect(gaugeX+2,gaugeY+2,12,gaugeH-4);
  // Fill based on HP (hot = full HP, empty = dying)
  const fillAmt=hp/mHp;
  const heatCol=fillAmt>0.6?'#ff0000':fillAmt>0.3?'#ff8800':'#ff4400';
  ctx.fillStyle=heatCol;ctx.fillRect(gaugeX+2,gaugeY+2+Math.floor(gaugeH*0.85*(1-fillAmt)),12,Math.floor(gaugeH*0.85*fillAmt));
  // Gauge glow
  ctx.save();ctx.globalAlpha=fillAmt*0.4;ctx.fillStyle=heatCol;ctx.fillRect(gaugeX-4,gaugeY,24,gaugeH);ctx.restore();
  // Gauge scale marks
  ctx.fillStyle='#555555';for(let gm=0;gm<5;gm++)ctx.fillRect(gaugeX+12,gaugeY+4+gm*gaugeH*0.2,4,2);

  // ── ROBOTIC FACE ──
  const fy=y+h*0.3+gaugeH+8;
  // Visor band (horizontal scanner line)
  ctx.fillStyle='#000000';ctx.fillRect(bx+10,fy,w-20,24);
  ctx.fillStyle=ventPulse?'#ff0000':'#cc2200';ctx.fillRect(bx+14,fy+4,w-28,16);
  ctx.fillStyle='#ff4400';ctx.fillRect(bx+14,fy+4,w-28,6);
  // Scanner line moving across
  ctx.fillStyle='#ff8800';ctx.fillRect(bx+14+(tk*3%(w-28)),fy+4,8,16);
  // Nostril vents
  ctx.fillStyle='#000000';ctx.fillRect(cx-14,fy+26,10,8);ctx.fillRect(cx+4,fy+26,10,8);
  ctx.fillStyle='#330000';ctx.fillRect(cx-12,fy+28,6,4);ctx.fillRect(cx+6,fy+28,6,4);
  // Mouth: speaker grille
  ctx.fillStyle='#000000';ctx.fillRect(bx+20,fy+36,w-40,10);
  ctx.fillStyle='#111111';for(let sg=0;sg<8;sg++)ctx.fillRect(bx+24+sg*(w-48)/8,fy+37,5,8);

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'THERMOS PRIME','#ff4444');
}

// ─── BOSS 5: THE SEAL (Level 30 Phase 1) ─────────────────────
// A giant wax-sealed container — round body with a massive
// embossed wax seal on the front, regal/ancient looking,
// glowing seal symbol, melting wax drips, old ornate container design
function drawTheSeal(bx,y,w,h,hp,mHp,shk){
  const tk=Math.floor(Date.now()/80);
  const waxDrip=Math.floor(Date.now()/400)%4;
  const sealGlow=0.7+0.3*Math.sin(Date.now()*0.004);
  const cx=bx+w/2;
  const pulse=Math.floor(Date.now()/150)%2;

  // ── ORNATE SIDE SCROLLWORK ──
  ctx.fillStyle='#550000';
  // Left scroll
  [y+h*0.15,y+h*0.4,y+h*0.65].forEach(sy=>{
    ctx.fillRect(bx-18,sy-5,18,10);ctx.fillRect(bx-22,sy-8,8,16);
    ctx.fillStyle='#880000';ctx.fillRect(bx-20,sy-5,6,10);ctx.fillStyle='#550000';
  });
  // Right scroll
  [y+h*0.15,y+h*0.4,y+h*0.65].forEach(sy=>{
    ctx.fillRect(bx+w,sy-5,18,10);ctx.fillRect(bx+w+14,sy-8,8,16);
    ctx.fillStyle='#880000';ctx.fillRect(bx+w+14,sy-5,6,10);ctx.fillStyle='#550000';
  });

  // ── MAIN CONTAINER BODY (deep crimson ancient vessel) ──
  ctx.fillStyle='#1a0000';ctx.fillRect(bx,y,w,h);
  ctx.fillStyle='#220000';ctx.fillRect(bx+4,y+4,w-8,h-4);
  ctx.fillStyle='#2a0000';ctx.fillRect(bx+8,y+8,w-16,h-8);
  ctx.fillStyle='#330000';ctx.fillRect(bx+12,y+12,w-24,h-12);
  // Embossed panel lines (ornate)
  ctx.fillStyle='#440000';
  ctx.fillRect(bx+8,y+8,4,h-16);ctx.fillRect(bx+w-12,y+8,4,h-16);
  ctx.fillRect(bx+8,y+8,w-16,4);ctx.fillRect(bx+8,y+h-12,w-16,4);
  ctx.fillRect(bx+16,y+16,2,h-32);ctx.fillRect(bx+w-18,y+16,2,h-32);
  // Gold trim accents
  ctx.fillStyle='#884400';
  ctx.fillRect(bx+2,y+2,w-4,4);ctx.fillRect(bx+2,y+h-6,w-4,4);
  ctx.fillRect(bx+2,y+2,4,h-4);ctx.fillRect(bx+w-6,y+2,4,h-4);
  ctx.fillStyle='#aa6600';
  ctx.fillRect(bx+4,y+2,w-8,2);ctx.fillRect(bx+2,y+4,2,h-8);

  // ── MASSIVE WAX SEAL (central emblem) ──
  const sr=52; // seal radius
  // Outer seal ring (embossed)
  ctx.fillStyle='#660000';ctx.fillRect(cx-sr,y+h/2-sr,sr*2,sr*2);
  ctx.fillStyle='#880000';ctx.fillRect(cx-sr+4,y+h/2-sr+4,sr*2-8,sr*2-8);
  ctx.fillStyle='#aa0000';ctx.fillRect(cx-sr+8,y+h/2-sr+8,sr*2-16,sr*2-16);
  // Seal glow aura
  ctx.save();ctx.globalAlpha=sealGlow*0.4;ctx.fillStyle='#ff0000';
  ctx.fillRect(cx-sr-8,y+h/2-sr-8,sr*2+16,sr*2+16);ctx.restore();
  // Wax seal center
  ctx.fillStyle='#cc2200';ctx.fillRect(cx-sr+12,y+h/2-sr+12,sr*2-24,sr*2-24);
  ctx.fillStyle='#dd3300';ctx.fillRect(cx-sr+16,y+h/2-sr+16,sr*2-32,sr*2-32);
  // Seal star pattern (5-pointed)
  ctx.fillStyle='#ff4400';
  const sealCX=cx,sealCY=y+h/2;
  [[0,1],[0.59,0.31],[0.95,-0.81],[-.95,-0.81],[-.59,.31]].forEach(([sx2,sy2])=>{
    ctx.fillRect(sealCX+sx2*30-6,sealCY+sy2*30-6,12,12);
    ctx.fillRect(sealCX+sx2*16-4,sealCY+sy2*16-4,8,8);
  });
  // Center crown symbol
  ctx.fillStyle='#ffcc00';ctx.fillRect(sealCX-12,sealCY-16,24,6);
  ctx.fillRect(sealCX-10,sealCY-22,6,8);ctx.fillRect(sealCX-3,sealCY-26,6,12);ctx.fillRect(sealCX+4,sealCY-22,6,8);
  ctx.fillRect(sealCX-12,sealCY-12,24,16);
  ctx.fillStyle='#ffe866';ctx.fillRect(sealCX-10,sealCY-12,8,6);
  // S lettering on seal
  ctx.save();ctx.font="bold 14px 'Press Start 2P',monospace";ctx.fillStyle='#ffee88';ctx.textAlign='center';
  ctx.fillText('S',sealCX,sealCY+32);ctx.restore();
  // Seal ring sunburst
  ctx.fillStyle='#770000';
  for(let sr2=0;sr2<12;sr2++){
    const a=sr2/12*Math.PI*2;
    const rx=Math.round(sealCX+Math.cos(a)*44),ry=Math.round(sealCY+Math.sin(a)*44);
    ctx.fillRect(rx-3,ry-3,6,6);
  }

  // ── WAX DRIPS flowing down from seal ──
  ctx.fillStyle='#cc0000';
  const drips=[cx-30,cx-8,cx+10,cx+28];
  drips.forEach((dx,i)=>{
    const dripLen=12+(waxDrip+i)%4*6;
    ctx.fillRect(dx-4,y+h/2+sr-4,8,dripLen);
    ctx.fillRect(dx-6,y+h/2+sr+dripLen-8,12,8); // drip blob end
    ctx.fillStyle='#dd2200';ctx.fillRect(dx-3,y+h/2+sr-4,4,dripLen);ctx.fillStyle='#cc0000';
  });

  // ── ANCIENT FACE (barely visible, etched into vessel) ──
  const fy=y+h*0.68;
  ctx.fillStyle='#550000';ctx.fillRect(bx+22,fy,36,20);ctx.fillRect(bx+w-58,fy,36,20);
  ctx.fillStyle=pulse?'#ff0000':'#aa0000';ctx.fillRect(bx+26,fy+4,28,12);ctx.fillRect(bx+w-54,fy+4,28,12);
  ctx.fillStyle='#ff3300';ctx.fillRect(bx+30,fy+6,18,8);ctx.fillRect(bx+w-50,fy+6,18,8);
  ctx.fillStyle='#ffffff';ctx.fillRect(bx+32,fy+7,5,5);ctx.fillRect(bx+w-48,fy+7,5,5);
  ctx.fillStyle='#000000';ctx.fillRect(bx+36,fy+9,5,4);ctx.fillRect(bx+w-44,fy+9,5,4);
  // Curved frown (ancient displeasure)
  ctx.fillStyle='#440000';ctx.fillRect(bx+28,fy+22,w-56,6);
  ctx.fillStyle='#000000';ctx.fillRect(bx+30,fy+24,w-60,3);
  ctx.fillStyle='#440000';ctx.fillRect(bx+28,fy+22,12,3);ctx.fillRect(bx+w-40,fy+22,12,3);

  // ── CONTAINER LID ──
  ctx.fillStyle='#110000';ctx.fillRect(bx-2,y-6,w+4,10);
  ctx.fillStyle='#220000';ctx.fillRect(bx,y-4,w,8);
  ctx.fillStyle='#440000';ctx.fillRect(bx+6,y-4,w-12,6);
  ctx.fillStyle='#664400';ctx.fillRect(bx+4,y-6,w-8,3);
  // Lid wax seal drop
  ctx.fillStyle='#aa0000';ctx.fillRect(cx-8,y-10,16,8);
  ctx.fillStyle='#cc2200';ctx.fillRect(cx-6,y-10,12,5);

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'SUPERNOVA','#ff00ff');
}

// ─── DISPATCHER ──────────────────────────────────────────────
function drawBoss(){
  if(!boss)return;
  const{x,y,w,h,hp,mHp,shk,tier}=boss;
  const ox=shk>0?(Math.floor(Math.random()*3)*4-4):0;
  const bx=x+ox;
  if(tier===0) drawLidKing(bx,y,w,h,hp,mHp,shk);
  else if(tier===1) drawFrostlock(bx,y,w,h,hp,mHp,shk);
  else if(tier===2) drawSaucepanSam(bx,y,w,h,hp,mHp,shk);
  else if(tier===3) drawCrisperLord(bx,y,w,h,hp,mHp,shk);
  else if(tier===4) drawThermosPrime(bx,y,w,h,hp,mHp,shk);
  else              drawTheSeal(bx,y,w,h,hp,mHp,shk);
}

// ── Player spaceship ─────────────────────────────────────
function drawPlayer(){
  const{x,y,w,h}=player;
  const hc=lOn?'#44ffff':'#8844ff';
  const dc2=lOn?'#006688':'#330077';
  const ac=lOn?'#00ccee':'#aa55ff';

  // ── Thrusters / Engine flames ──
  const fT=Math.floor(Date.now()/55)%4;
  const fC=['#ff3300','#ff7700','#ffaa00','#ff5500'];
  const flH=10+fT*3;
  // Left engine
  ctx.fillStyle=fC[fT];ctx.fillRect(x+9,y+h,10,flH);ctx.fillStyle=fC[(fT+1)%4];ctx.fillRect(x+11,y+h+3,6,flH-3);ctx.fillStyle='#ffff88';ctx.fillRect(x+13,y+h,3,4);
  // Center engine
  ctx.fillStyle=fC[fT];ctx.fillRect(x+w/2-6,y+h,12,flH+5);ctx.fillStyle=fC[(fT+2)%4];ctx.fillRect(x+w/2-3,y+h,6,flH+2);ctx.fillStyle='#ffffff';ctx.fillRect(x+w/2-2,y+h,4,5);
  // Right engine
  ctx.fillStyle=fC[fT];ctx.fillRect(x+w-19,y+h,10,flH);ctx.fillStyle=fC[(fT+1)%4];ctx.fillRect(x+w-17,y+h+3,6,flH-3);ctx.fillStyle='#ffff88';ctx.fillRect(x+w-16,y+h,3,4);

  // ── Left wing assembly ──
  ctx.fillStyle=dc2;
  ctx.fillRect(x,y+h-22,12,22);      // main wing body
  ctx.fillRect(x-10,y+h-14,10,14);   // outer wing
  ctx.fillRect(x+8,y+h-32,10,12);    // inner strake
  ctx.fillStyle=hc;ctx.fillRect(x+2,y+h-22,6,16);// wing top stripe

  // ── Right wing assembly ──
  ctx.fillStyle=dc2;
  ctx.fillRect(x+w-12,y+h-22,12,22);
  ctx.fillRect(x+w,y+h-14,10,14);
  ctx.fillRect(x+w-18,y+h-32,10,12);
  ctx.fillStyle=hc;ctx.fillRect(x+w-8,y+h-22,6,16);

  // ── Engine nacelles ──
  ctx.fillStyle='#444466';
  ctx.fillRect(x+5,y+h-10,14,12);ctx.fillRect(x+w-19,y+h-10,14,12);
  ctx.fillStyle='#8888aa';ctx.fillRect(x+7,y+h-10,10,5);ctx.fillRect(x+w-17,y+h-10,10,5);

  // ── Main hull (tapered body) ──
  ctx.fillStyle=hc;
  ctx.fillRect(x+12,y+h-38,w-24,38);   // lower body
  ctx.fillRect(x+18,y+h-54,w-36,18);   // mid section
  ctx.fillRect(x+24,y+h-68,w-48,16);   // upper section
  ctx.fillRect(x+29,y+h-80,w-58,14);   // nose cone base
  ctx.fillRect(x+34,y+h-92,w-68,14);   // nose cone
  ctx.fillRect(x+38,y+h-103,w-76,13);  // tip

  // Hull shading panels
  ctx.fillStyle=dc2;
  ctx.fillRect(x+12,y+h-38,5,38);ctx.fillRect(x+w-17,y+h-38,5,38);
  ctx.fillRect(x+18,y+h-54,4,16);ctx.fillRect(x+w-22,y+h-54,4,16);
  // Panel lines
  ctx.fillStyle=dc2;
  ctx.fillRect(x+18,y+h-30,w-36,2);ctx.fillRect(x+18,y+h-18,w-36,2);

  // ── Accent stripes ──
  ctx.fillStyle=ac;
  ctx.fillRect(x+16,y+h-38,4,34);ctx.fillRect(x+w-20,y+h-38,4,34);

  // ── Cockpit ──
  ctx.fillStyle=lOn?'#00ffff':'#0099ff';
  ctx.fillRect(x+w/2-13,y+h-80,26,22);
  ctx.fillStyle=lOn?'#88ffff':'#55aaff';
  ctx.fillRect(x+w/2-13,y+h-80,9,9);
  ctx.fillStyle='#001133';ctx.fillRect(x+w/2-1,y+h-62,3,5);

  // ── Main cannon ──
  ctx.fillStyle='#777799';ctx.fillRect(x+w/2-5,y+h-112,10,22);
  ctx.fillStyle='#aaaacc';ctx.fillRect(x+w/2-4,y+h-115,8,5);
  ctx.fillStyle='#555566';ctx.fillRect(x+w/2-5,y+h-112,3,14);ctx.fillRect(x+w/2+2,y+h-112,3,14);
  // Cannon tip glow
  ctx.fillStyle=lOn?'#00ffcc':'#aaaaff';ctx.fillRect(x+w/2-3,y+h-116,6,4);

  // ── Side cannons ──
  ctx.fillStyle='#555577';
  ctx.fillRect(x+8,y+h-48,7,16);ctx.fillRect(x+w-15,y+h-48,7,16);
  ctx.fillStyle='#8888aa';ctx.fillRect(x+9,y+h-50,5,5);ctx.fillRect(x+w-14,y+h-50,5,5);
  ctx.fillStyle='#aaaacc';ctx.fillRect(x+10,y+h-51,3,3);ctx.fillRect(x+w-13,y+h-51,3,3);

  // ── Shield aura ──
  // Bubble shield aura
  if(typeof bubbleOn!=='undefined'&&bubbleOn){
    const flicker=bubbleFrames<60&&Math.floor(Date.now()/80)%2===0;
    const bA=flicker?.05:(.30+.18*Math.sin(Date.now()*.005));
    ctx.strokeStyle=`rgba(0,220,255,${bA})`;ctx.lineWidth=6;
    ctx.strokeRect(x-14,y+h-126,w+28,142);
    ctx.strokeStyle=`rgba(100,240,255,${bA*.5})`;ctx.lineWidth=2;
    ctx.strokeRect(x-20,y+h-132,w+40,154);
    ctx.lineWidth=1;
  } else if(shields>0){
    ctx.strokeStyle=`rgba(0,160,255,${.28+.16*Math.sin(Date.now()*.003)})`;
    ctx.lineWidth=5;ctx.strokeRect(x-8,y+h-118,w+16,134);ctx.lineWidth=1;
  }
  // ── Laser charge aura ──
  if(lOn){
    ctx.strokeStyle='#00ffcc';ctx.lineWidth=3;ctx.strokeRect(x-5,y+h-118,w+10,130);ctx.lineWidth=1;
  }
}

// ── Laser beams ──────────────────────────────────────────
function drawPlayerLaser(){
  if(!lOn)return;
  const cx=Math.floor(player.x+player.w/2);
  const alpha=Math.min(1,lFrames/24);
  ctx.save();
  ctx.globalAlpha=alpha*.18;ctx.fillStyle='#00ffcc';ctx.fillRect(cx-26,0,52,player.y+14);
  ctx.globalAlpha=alpha*.5;ctx.fillStyle='#44ffdd';ctx.fillRect(cx-10,0,20,player.y+14);
  ctx.globalAlpha=alpha;
  for(let sy=0;sy<player.y;sy+=16){ctx.fillStyle='#ffffff';ctx.fillRect(cx-4,sy,8,8);ctx.fillStyle='#00ffcc';ctx.fillRect(cx-4,sy+8,8,8);}
  const tk=Math.floor(Date.now()/50);
  for(let i=0;i<6;i++){const sy=((tk*37+i*113)%(player.y||1));const sx=cx+((tk*19+i*71)%30)-15;ctx.globalAlpha=((i+tk)%3===0)?alpha:alpha*.5;ctx.fillStyle='#ffffff';ctx.fillRect(Math.floor(sx),Math.floor(sy),6,6);}
  ctx.globalAlpha=1;ctx.restore();
}

// ── Main draw call ────────────────────────────────────────
function draw(){
  drawBG();
  if(lOn)drawPlayerLaser();
  if(!bossUp)for(const e of enemies)drawEnemy(e);
  if(boss)drawBoss();
  drawPlayer();

  // Bullets — player
  for(const b of bullets){
    ctx.fillStyle='#ffff00';ctx.fillRect(b.x-4,b.y-10,8,13);
    ctx.fillStyle='#ffffff';ctx.fillRect(b.x-2,b.y-10,4,5);
  }
  // Bullets — enemy
  for(const b of eBullets){
    ctx.fillStyle=b.col;
    ctx.fillRect(b.x-4,b.y,8,4);ctx.fillRect(b.x-2,b.y-4,4,4);ctx.fillRect(b.x-2,b.y+4,4,4);
    ctx.fillStyle='#ffffff';ctx.fillRect(b.x-1,b.y,2,2);
  }
  // Particles
  for(const p of particles){ctx.globalAlpha=p.al;ctx.fillStyle=p.col;const s=Math.max(2,p.r|0);ctx.fillRect(Math.round(p.x),Math.round(p.y),s,s);}
  ctx.globalAlpha=1;
  // Ground dashes
  ctx.fillStyle='rgba(100,80,180,0.32)';for(let gx=0;gx<GW;gx+=12)ctx.fillRect(gx,GH-6,8,3);
  // Laser screen tint
  if(lOn){ctx.save();ctx.globalAlpha=.05;ctx.fillStyle='#00ffcc';ctx.fillRect(0,0,GW,GH);ctx.restore();}
}

// ═══════════════════════════════════════════════════
//  SPLASH
// ═══════════════════════════════════════════════════
(function splash(){
  ctx.fillStyle='#00000a';ctx.fillRect(0,0,GW,GH);
  // Draw stars from new arrays
  for(const s of STARS_A){ctx.globalAlpha=.35;ctx.fillStyle='#334477';ctx.fillRect(s.x,s.y,1,1);}
  for(const s of STARS_B){ctx.globalAlpha=.55;ctx.fillStyle='#5577aa';ctx.fillRect(s.x,s.y,2,2);}
  for(const s of STARS_C){ctx.globalAlpha=.8; ctx.fillStyle='#ffffff';ctx.fillRect(s.x,s.y,3,3);}
  ctx.globalAlpha=1;ctx.textAlign='center';ctx.imageSmoothingEnabled=false;
  ctx.font="28px 'Press Start 2P',monospace";ctx.fillStyle='#ff2200';ctx.fillText('TUPPER',GW/2,GH/2-62);
  ctx.fillStyle='#ff6600';ctx.fillText('WARS',GW/2,GH/2-26);
  ctx.font="9px 'Press Start 2P',monospace";ctx.fillStyle='#aaaaff';
  ctx.fillText('30 LEVELS  6 ENEMY TYPES  6 BOSSES',GW/2,GH/2+14);
  ctx.fillText('LASER  BUBBLE SHIELD  DIFFICULTY SELECT',GW/2,GH/2+34);
  ctx.font="7px 'Press Start 2P',monospace";ctx.fillStyle='#445566';
  ctx.fillText('MOVE:A/D  FIRE:Space  LASER:X  SHIELD:B  PAUSE:P',GW/2,GH/2+62);
})();

resizeCanvas();

// ═══════════════════════════════════════════════════
//  PIXEL-ART ICONS (canvas buttons + logo + app icon)
// ═══════════════════════════════════════════════════
function drawPixelGrid(cv,grid,bw,bh,palette,bgCol){
  const c=cv.getContext('2d');
  if(bgCol){c.fillStyle=bgCol;c.fillRect(0,0,cv.width,cv.height);}
  const ox=Math.floor((cv.width-bw*grid[0].length)/2);
  const oy=Math.floor((cv.height-bh*grid.length)/2);
  grid.forEach((row,r)=>row.forEach((v,pc)=>{
    if(v&&palette[v]){c.fillStyle=palette[v];c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}
  }));
}

function drawArrowLeft(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#0b0b1e';c.fillRect(0,0,s,s);
  const G=[
    [0,0,0,1,0,0,0,0,0,0],
    [0,0,1,1,0,0,0,0,0,0],
    [0,1,1,1,1,1,1,1,0,0],
    [1,1,1,1,1,1,1,1,1,0],
    [1,1,1,1,1,1,1,1,1,0],
    [0,1,1,1,1,1,1,1,0,0],
    [0,0,1,1,0,0,0,0,0,0],
    [0,0,0,1,0,0,0,0,0,0],
  ];
  const bw=Math.floor(s/11),bh=Math.floor(s/9);
  const ox=Math.floor((s-bw*10)/2),oy=Math.floor((s-bh*8)/2);
  G.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){c.fillStyle=pc<2?'#ccaaff':pc>7?'#7755bb':'#a78bfa';c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}
  }));
}

function drawArrowRight(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#0b0b1e';c.fillRect(0,0,s,s);
  const G=[
    [0,0,0,0,0,0,0,1,0,0],
    [0,0,0,0,0,0,1,1,0,0],
    [0,0,1,1,1,1,1,1,1,0],
    [0,1,1,1,1,1,1,1,1,1],
    [0,1,1,1,1,1,1,1,1,1],
    [0,0,1,1,1,1,1,1,1,0],
    [0,0,0,0,0,0,1,1,0,0],
    [0,0,0,0,0,0,0,1,0,0],
  ];
  const bw=Math.floor(s/11),bh=Math.floor(s/9);
  const ox=Math.floor((s-bw*10)/2),oy=Math.floor((s-bh*8)/2);
  G.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){c.fillStyle=pc>7?'#ccaaff':pc<2?'#7755bb':'#a78bfa';c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}
  }));
}

function drawFireBtn(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#160800';c.fillRect(0,0,s,s);
  // Rocket bullet shape
  const G=[
    [0,0,1,1,0,0],
    [0,1,1,1,1,0],
    [0,1,2,2,1,0],
    [0,1,1,1,1,0],
    [0,0,1,1,0,0],
    [0,0,1,1,0,0],
    [0,0,1,1,0,0],
    [0,3,3,3,3,0],
    [3,3,0,0,3,3],
    [3,0,0,0,0,3],
  ];
  const bw=Math.floor(s/8),bh=Math.floor(s/11);
  const ox=Math.floor((s-bw*6)/2),oy=Math.floor((s-bh*10)/2);
  const pal={1:'#ff9900',2:'#ffffff',3:'#ff4400'};
  G.forEach((row,r)=>row.forEach((v,pc)=>{if(pal[v]){c.fillStyle=pal[v];c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}}));
}

function drawLaserBtn(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#001510';c.fillRect(0,0,s,s);
  // Lightning bolt
  const G=[
    [0,0,1,1,1,0,0],
    [0,1,1,1,0,0,0],
    [1,1,1,0,0,0,0],
    [1,1,1,1,1,0,0],
    [0,1,1,1,1,1,0],
    [0,0,0,1,1,1,0],
    [0,0,0,0,1,1,0],
    [0,0,0,0,0,1,0],
  ];
  const bw=Math.floor(s/9),bh=Math.floor(s/9);
  const ox=Math.floor((s-bw*7)/2),oy=Math.floor((s-bh*8)/2);
  G.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){c.fillStyle=r<2?'#ffffff':r<4?'#aaffee':'#06d6a0';c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}
  }));
}

function drawShieldBtn(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#00101a';c.fillRect(0,0,s,s);
  // Hexagonal bubble shield
  const G=[
    [0,0,1,1,1,1,0,0],
    [0,1,0,0,0,0,1,0],
    [1,0,0,2,2,0,0,1],
    [1,0,2,0,0,0,0,1],
    [1,0,0,0,0,0,0,1],
    [1,0,0,0,0,2,0,1],
    [0,1,0,0,0,0,1,0],
    [0,0,1,1,1,1,0,0],
  ];
  const bw=Math.floor(s/10),bh=Math.floor(s/10);
  const ox=Math.floor((s-bw*8)/2),oy=Math.floor((s-bh*8)/2);
  const pal={1:'#00aaff',2:'#88ddff'};
  G.forEach((row,r)=>row.forEach((v,pc)=>{if(pal[v]){c.fillStyle=pal[v];c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}}));
}

function drawPauseBtn(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#080814';c.fillRect(0,0,s,s);
  const bw=Math.floor(s*.2),bh=Math.floor(s*.54),oy=Math.floor(s*.23);
  // Left bar
  c.fillStyle='#aaaaff';c.fillRect(Math.floor(s*.18),oy,bw,bh);
  c.fillStyle='#8888cc';c.fillRect(Math.floor(s*.18),oy,2,bh);
  // Right bar
  c.fillStyle='#aaaaff';c.fillRect(Math.floor(s*.62),oy,bw,bh);
  c.fillStyle='#8888cc';c.fillRect(Math.floor(s*.62),oy,2,bh);
}

function drawSidebarLogo(cv){
  const c=cv.getContext('2d'),w=cv.width,h=cv.height;
  c.clearRect(0,0,w,h);
  // Tiny 5x6 skull pixel art
  const G=[[0,1,1,1,0],[1,0,0,0,1],[1,1,0,1,1],[1,1,1,1,1],[0,1,0,1,0],[0,1,1,1,0]];
  const ps=Math.floor(Math.min(w/5,h/6)*0.8);
  const ox=Math.floor((w-5*ps)/2),oy=Math.floor((h-6*ps)/2);
  G.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){
      c.fillStyle=r<2?'#ff6b35':r===2?'#ff4400':'#cc3300';
      c.fillRect(ox+pc*ps,oy+r*ps,ps,ps);
    }
  }));
}

function generateAppIcon(){
  const ic=document.createElement('canvas');ic.width=512;ic.height=512;
  const c=ic.getContext('2d');
  // Background
  const bg=c.createRadialGradient(256,180,20,256,256,300);
  bg.addColorStop(0,'#1a0000');bg.addColorStop(0.6,'#0a0008');bg.addColorStop(1,'#000000');
  c.fillStyle=bg;c.fillRect(0,0,512,512);
  // Red frame
  c.strokeStyle='#cc2200';c.lineWidth=20;c.strokeRect(10,10,492,492);
  c.strokeStyle='#ff440044';c.lineWidth=8;c.strokeRect(22,22,468,468);
  // Title text
  c.fillStyle='#ff2200';c.font="bold 60px monospace";c.textAlign='center';c.fillText('TUPPER',256,130);
  c.fillStyle='#ff8800';c.fillText('WARS',256,200);
  // Big pixel skull (12x10 grid at 32px each)
  const SK=[
    [0,0,1,1,1,1,1,1,0,0,0,0],
    [0,1,1,1,1,1,1,1,1,0,0,0],
    [1,1,1,1,1,1,1,1,1,1,0,0],
    [1,1,0,0,1,1,1,0,0,1,1,0],
    [1,1,0,0,1,1,1,0,0,1,1,0],
    [1,1,1,1,1,1,1,1,1,1,0,0],
    [1,1,1,0,1,1,1,0,1,1,1,0],
    [0,1,1,1,1,1,1,1,1,1,0,0],
    [0,0,1,0,0,1,0,0,1,0,0,0],
    [0,0,1,1,0,1,0,1,1,0,0,0],
  ];
  const PS2=30,sw2=12*PS2,sh2=10*PS2,sx=(512-sw2)/2,sy=240;
  SK.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){
      c.fillStyle=r<3?'#ffffff':r<6?'#dddddd':'#bb0000';
      c.fillRect(Math.floor(sx+pc*PS2),Math.floor(sy+r*PS2),PS2,PS2);
      c.fillStyle='rgba(255,255,255,0.2)';c.fillRect(Math.floor(sx+pc*PS2),Math.floor(sy+r*PS2),8,8);
    }
  }));
  // Glow under skull
  const gl=c.createRadialGradient(256,490,10,256,440,100);
  gl.addColorStop(0,'rgba(255,80,0,0.5)');gl.addColorStop(1,'rgba(0,0,0,0)');
  c.fillStyle=gl;c.fillRect(100,380,312,132);
  // Stars in background
  for(let i=0;i<40;i++){
    const sx2=(i*7919+12345)%480+16,sy2=(i*6173+54321)%200+16;
    c.fillStyle='rgba(255,255,255,0.6)';c.fillRect(sx2,sy2,3,3);
  }
  const lnk=document.querySelector("link[rel='icon']")||document.createElement('link');
  lnk.rel='icon';lnk.href=ic.toDataURL();
  if(!lnk.parentNode)document.head.appendChild(lnk);
}

function wireCanvasBtn(id,prop,cb){
  const el=document.getElementById(id);if(!el)return;
  const dn=pid=>{BP[pid]=prop;TK[prop]=true;el.classList.add('tapped');if(cb)cb();};
  const up=pid=>{if(BP[pid]===prop){delete BP[pid];if(!Object.values(BP).includes(prop)){TK[prop]=false;el.classList.remove('tapped');}}};
  el.addEventListener('pointerdown',ev=>{ev.preventDefault();el.setPointerCapture(ev.pointerId);dn(ev.pointerId);},{passive:false});
  el.addEventListener('pointerup',ev=>{ev.preventDefault();up(ev.pointerId);},{passive:false});
  el.addEventListener('pointercancel',ev=>{ev.preventDefault();up(ev.pointerId);},{passive:false});
  el.addEventListener('pointerleave',ev=>{if(!el.hasPointerCapture(ev.pointerId))up(ev.pointerId);});
}

setTimeout(()=>{
  const cvL=document.getElementById('cb-left');   if(cvL)drawArrowLeft(cvL);
  const cvR=document.getElementById('cb-right');  if(cvR)drawArrowRight(cvR);
  const cvF=document.getElementById('cb-fire');   if(cvF)drawFireBtn(cvF);
  const cvLa=document.getElementById('cb-laser'); if(cvLa)drawLaserBtn(cvLa);
  const cvSh=document.getElementById('cb-shield');if(cvSh)drawShieldBtn(cvSh);
  const cvPa=document.getElementById('cb-pause'); if(cvPa)drawPauseBtn(cvPa);
  try{generateAppIcon();}catch(e){}
  wireCanvasBtn('cb-left','left');
  wireCanvasBtn('cb-right','right');
  wireCanvasBtn('cb-fire','fire',()=>{if(running&&!paused)doShoot();});
  wireCanvasBtn('cb-laser','laser',()=>{if(running&&!paused)doLaser();});
  wireCanvasBtn('cb-shield','shield',()=>{if(running&&!paused)doBubble();});
  wireCanvasBtn('cb-pause','pause',()=>{if(running)doPause();});

  // Draw main menu title canvas
  const mmCv=document.getElementById('mm-canvas');
  if(mmCv){
    const c=mmCv.getContext('2d'),w=mmCv.width,h=mmCv.height;
    c.clearRect(0,0,w,h);
    c.font="bold 52px 'Press Start 2P',monospace";
    c.textAlign='center';
    // deep shadow
    c.fillStyle='#1a0000';c.fillText('TUPPER',w/2+5,56);c.fillText('WARS',w/2+5,105);
    c.fillStyle='#550000';c.fillText('TUPPER',w/2+2,53);c.fillText('WARS',w/2+2,102);
    // fiery gradient
    const grd=c.createLinearGradient(0,0,0,h);
    grd.addColorStop(0,'#ffaa00');grd.addColorStop(0.35,'#ff4400');
    grd.addColorStop(0.7,'#cc0000');grd.addColorStop(1,'#880000');
    c.fillStyle=grd;
    c.fillText('TUPPER',w/2,50);c.fillText('WARS',w/2,99);
    // scanline sheen
    c.globalAlpha=0.10;c.fillStyle='#ffffff';
    for(let sy=0;sy<h;sy+=4)c.fillRect(0,sy,w,2);
    c.globalAlpha=1;
  }

  // Animated menu background
  const mmBg=document.getElementById('mm-bg-canvas');
  if(mmBg){
    mmBg.width=window.innerWidth;mmBg.height=window.innerHeight;
    const bc=mmBg.getContext('2d');
    // Generate star field for menu
    const menuStars=Array.from({length:180},()=>({
      x:Math.random()*mmBg.width,y:Math.random()*mmBg.height,
      r:Math.random()*1.8+0.3,spd:Math.random()*0.4+0.05,
      br:Math.random(),phase:Math.random()*Math.PI*2,
    }));
    let mmT=0;
    function animMenuBg(){
      if(!document.getElementById('main-menu').classList.contains('hidden')){
        const bw=mmBg.width,bh=mmBg.height;
        // Deep space bg
        bc.fillStyle='#00000a';bc.fillRect(0,0,bw,bh);
        // Nebula hint
        const ng=bc.createRadialGradient(bw*.3,bh*.4,20,bw*.3,bh*.4,bh*.6);
        ng.addColorStop(0,'rgba(80,0,120,0.12)');ng.addColorStop(1,'transparent');
        bc.fillStyle=ng;bc.fillRect(0,0,bw,bh);
        const ng2=bc.createRadialGradient(bw*.75,bh*.6,10,bw*.75,bh*.6,bh*.5);
        ng2.addColorStop(0,'rgba(120,30,0,0.10)');ng2.addColorStop(1,'transparent');
        bc.fillStyle=ng2;bc.fillRect(0,0,bw,bh);
        // Animate stars
        for(const s of menuStars){
          s.y-=s.spd;if(s.y<0)s.y=bh;
          const tw=0.4+0.6*Math.sin(mmT*0.03+s.phase);
          bc.globalAlpha=tw*(0.4+s.br*0.5);
          bc.fillStyle=s.br>0.8?'#ffddaa':s.br>0.5?'#aabbff':'#ffffff';
          bc.fillRect(s.x,s.y,s.r,s.r);
          if(s.br>0.85&&tw>0.8){
            bc.globalAlpha=tw*0.3;bc.fillStyle='#ffffff';
            bc.fillRect(s.x-2,s.y,5,1);bc.fillRect(s.x,s.y-2,1,5);
          }
        }
        bc.globalAlpha=1;
        mmT++;
      }
      requestAnimationFrame(animMenuBg);
    }
    function resizeMenuBg(){mmBg.width=window.innerWidth;mmBg.height=window.innerHeight;}
  window.addEventListener('resize',resizeMenuBg);resizeMenuBg();
    animMenuBg();
  }
},100);

</script>
</body>
</html>
