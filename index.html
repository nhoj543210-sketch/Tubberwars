<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TUPPER WARS">
<meta name="theme-color" content="#000011">
<link rel="apple-touch-icon" id="ati-link" href="">
<link rel="manifest" href="data:application/json,{%22name%22:%22TUPPER%20WARS%22,%22short_name%22:%22TUPPER%20WARS%22,%22start_url%22:%22./%22,%22display%22:%22fullscreen%22,%22background_color%22:%22%23000011%22,%22theme_color%22:%22%23ff6b35%22,%22icons%22:[{%22src%22:%22data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJgAAAA%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">
<title>TUPPER WARS</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent!important;image-rendering:pixelated;outline:none!important;-webkit-user-select:none;user-select:none;}
html,body{width:100%;height:100%;overflow:hidden;background:#000011;font-family:'Press Start 2P',monospace;user-select:none;touch-action:none;}
button,canvas,a,div,span,input{-webkit-tap-highlight-color:transparent!important;outline:none!important;-webkit-user-select:none;user-select:none;}
button:focus,button:active,button:focus-visible,
canvas:focus,canvas:active,
.c-btn-cv,.c-btn-cv:focus,.c-btn-cv:active,.c-btn-cv:hover{
  outline:none!important;box-shadow:none!important;
  -webkit-tap-highlight-color:transparent!important;
  -webkit-touch-callout:none!important;
  background-color:rgba(0,0,14,0.55); /* prevent iOS blue flash */
}
button:focus,button:focus-visible{outline:none;box-shadow:none;}
*:focus{outline:none;}

/* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
#app{display:flex;flex-direction:column;width:100vw;height:100vh;height:100dvh;overflow:hidden;background:#000011;}
#game-col{display:flex;flex-direction:column;width:100%;flex:1 1 0;min-height:0;overflow:hidden;}
#canvas-wrap{flex:1 1 0;min-height:0;display:flex;align-items:center;justify-content:center;}
canvas{display:block;touch-action:none;}
#overlay-msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Press Start 2P',monospace;font-size:clamp(0.75rem,3vw,1.5rem);color:#fff;letter-spacing:2px;text-shadow:3px 3px 0 #000,0 0 18px #ff6b35;pointer-events:none;display:none;text-align:center;white-space:pre-line;line-height:1.6;background:rgba(0,0,0,0.55);padding:14px 22px;border:2px solid transparent;transition:color .3s,text-shadow .3s,border-color .3s,background .3s;}

/* ‚îÄ‚îÄ LEVEL INTRO SCREEN ‚îÄ‚îÄ */
#level-intro{position:fixed;top:0;left:0;width:100%;height:100%;z-index:600;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;pointer-events:none;}
#level-intro.show{display:flex;}
#level-intro-bg{position:absolute;inset:0;background:#000011;opacity:0;transition:opacity .3s;}
#li-section{color:#a78bfa;font-size:clamp(0.28rem,1.5vw,0.5rem);letter-spacing:4px;text-align:center;position:relative;z-index:1;opacity:0;transform:translateY(-12px);transition:opacity .4s .1s,transform .4s .1s;}
#li-level{color:#ffd166;font-size:clamp(0.7rem,4vw,1.6rem);letter-spacing:3px;text-align:center;position:relative;z-index:1;text-shadow:0 0 20px #ff6b3599;opacity:0;transform:scale(.8);transition:opacity .3s .25s,transform .3s .25s;}
#li-name{color:#fff;font-size:clamp(0.4rem,2.5vw,0.9rem);letter-spacing:2px;text-align:center;position:relative;z-index:1;opacity:0;transition:opacity .3s .4s;}
#li-countdown{color:#ff6b35;font-size:clamp(1.5rem,8vw,4rem);text-align:center;position:relative;z-index:1;text-shadow:0 0 30px #ff6b35;opacity:0;transition:opacity .15s;}
#li-scanlines{position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,30,0.18) 3px,rgba(0,0,30,0.18) 4px);pointer-events:none;z-index:2;}

/* ‚îÄ‚îÄ IN-GAME HUD BAR ‚îÄ‚îÄ */
#hud-bar{display:none;width:100%;background:rgba(0,0,10,0.95);border-bottom:2px solid #ff6b35;padding:3px 10px;flex-direction:row;align-items:center;gap:8px;flex-shrink:0;flex-wrap:nowrap;overflow:hidden;box-sizing:border-box;}
.hud-cell{display:flex;flex-direction:column;align-items:center;min-width:0;padding:0 2px;}
.hud-lbl{color:#a78bfa;font-size:clamp(0.2rem,1.5vw,0.28rem);letter-spacing:1px;text-transform:uppercase;margin-bottom:1px;white-space:nowrap;}
.hud-val{color:#ffd166;font-size:clamp(0.28rem,1.8vw,0.48rem);white-space:nowrap;}
#hud-shield-val{color:#00aaff;font-size:clamp(0.22rem,1.4vw,0.38rem);white-space:nowrap;}
#hud-laser-wrap{display:flex;flex-direction:column;align-items:center;min-width:0;}
#hud-lbar-bg{width:clamp(30px,8vw,60px);height:3px;background:#222;margin-top:1px;}
#hud-lbar{height:100%;width:100%;background:linear-gradient(90deg,#06d6a0,#00ffcc);}
#hud-lives{display:flex;gap:2px;align-items:center;}
#hud-score{color:#ffd166;font-size:0.6rem;}
#hud-pause-btn{margin-left:auto;flex-shrink:0;padding:3px 8px;background:#1a1a40;border:2px solid #4444aa;color:#aaaaff;font-family:'Press Start 2P',monospace;font-size:clamp(0.22rem,1.2vw,0.32rem);cursor:pointer;white-space:nowrap;}

/* ‚îÄ‚îÄ MAIN MENU OVERLAY ‚îÄ‚îÄ */
#main-menu{position:fixed;top:0;left:0;width:100vw;height:100vh;height:100dvh;background:#00000a;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500;overflow:hidden;}
#main-menu.hidden{display:none;}
#mm-bg-canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:block;}
#mm-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:space-evenly;width:100%;max-width:100%;height:100%;padding:clamp(8px,2vh,20px) 16px;gap:0;box-sizing:border-box;}
#mm-canvas{display:block;margin:0;width:min(480px,88vw);max-width:88vw;height:auto;}
#mm-sub{font-size:clamp(0.28rem,1.5vw,0.62rem);color:#ff6600;letter-spacing:1px;text-align:center;text-shadow:0 0 12px #ff440055;margin:0;}
#mm-buttons{display:flex;flex-direction:column;align-items:center;gap:clamp(4px,0.9vh,9px);width:min(340px,92vw);}
.mm-btn{width:100%;padding:clamp(6px,1.3vh,11px) 12px;border:2px solid;font-family:'Press Start 2P',monospace;font-size:clamp(0.36rem,1.4vw,0.62rem);cursor:pointer;letter-spacing:2px;text-align:center;position:relative;overflow:hidden;transition:transform .08s,box-shadow .08s,filter .08s;display:flex;align-items:center;justify-content:center;gap:8px;}
.mm-btn::before{content:'';position:absolute;left:-100%;top:0;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12),transparent);transition:left .35s;}
.mm-btn:hover::before{left:120%;}
.mm-btn:hover{transform:translateY(-2px);filter:brightness(1.15);}
.mm-btn:active{transform:translateY(1px) scale(0.97);filter:brightness(0.9);}
.mm-btn.pressed{animation:btnPress .15s ease-out;}
@keyframes btnPress{0%{transform:scale(1)}40%{transform:scale(0.93)}100%{transform:scale(1)}}
#mm-play{background:linear-gradient(180deg,#dd3300,#aa2200);border-color:#ff6b35;color:#fff;box-shadow:0 4px 0 #550000,0 0 18px #ff440044;text-shadow:0 1px 0 #000;}
#mm-levels{background:linear-gradient(180deg,#3a1070,#2a0850);border-color:#a78bfa;color:#ddd;box-shadow:0 4px 0 #1a0040,0 0 14px #8844cc33;}
#mm-scores{background:linear-gradient(180deg,#001a10,#000e08);border-color:#06d6a0;color:#06d6a0;box-shadow:0 4px 0 #001a08,0 0 12px #06d6a022;}
#mm-diff{display:flex;gap:6px;justify-content:center;margin-top:4px;}
.mm-diff-btn{padding:clamp(4px,1vh,7px) clamp(8px,2vw,14px);border:2px solid #333;color:#555;font-family:'Press Start 2P',monospace;font-size:clamp(0.3rem,1.2vw,0.38rem);cursor:pointer;background:#0a0a0a;transition:all .15s;}
.mm-diff-btn.sel{color:#ff9f1c;border-color:#ff9f1c;background:rgba(255,159,28,0.12);box-shadow:0 0 8px #ff9f1c44;}
#mm-footer{color:#2a2a2a;font-size:clamp(0.2rem,0.9vw,0.3rem);text-align:center;line-height:2;margin:0;}

/* ‚îÄ‚îÄ SETTINGS SCREEN ‚îÄ‚îÄ */
#settings-screen{position:fixed;top:0;left:0;width:100vw;height:100vh;height:100dvh;background:#000011;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:700;gap:clamp(10px,2.5vh,22px);}
.set-ttl{color:#a78bfa;font-size:clamp(0.5rem,2.5vw,0.9rem);letter-spacing:4px;text-align:center;}
.set-row{display:flex;flex-direction:column;align-items:center;gap:8px;width:min(340px,88vw);}
.set-lbl{color:#888;font-size:clamp(0.28rem,1.1vw,0.38rem);letter-spacing:2px;text-transform:uppercase;}
.vol-wrap{display:flex;align-items:center;gap:10px;width:100%;}
#vol-slider{flex:1;height:8px;-webkit-appearance:none;appearance:none;background:#222;border:2px solid #444;cursor:pointer;outline:none;}
#vol-slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;background:#a78bfa;border:2px solid #fff;cursor:pointer;}
#vol-slider::-moz-range-thumb{width:18px;height:18px;background:#a78bfa;border:2px solid #fff;cursor:pointer;}
#vol-val{color:#ffd166;font-size:0.38rem;min-width:28px;text-align:right;}
#mute-btn{padding:8px 18px;border:2px solid #555;color:#888;font-family:'Press Start 2P',monospace;font-size:clamp(0.3rem,1.1vw,0.4rem);cursor:pointer;background:#111;transition:all .15s;width:min(200px,80vw);}
#mute-btn.muted{color:#ff4444;border-color:#ff4444;background:rgba(255,68,68,0.1);}
#settings-back{padding:10px 24px;background:#1a0030;border:2px solid #a78bfa;color:#a78bfa;font-family:'Press Start 2P',monospace;font-size:0.45rem;cursor:pointer;}
.set-sep{width:min(340px,88vw);height:1px;background:#1a1a40;}

/* ‚îÄ‚îÄ CHEAT CODE SCREEN ‚îÄ‚îÄ */
#cheat-screen{position:fixed;top:0;left:0;width:100vw;height:100vh;height:100dvh;background:#00000f;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:800;gap:clamp(8px,2vh,16px);}
#cheat-screen.locked{background:#00000f;}
#cheat-title{font-size:clamp(0.5rem,2.5vw,0.85rem);color:#ff2200;letter-spacing:3px;text-shadow:0 0 20px #ff220066;text-align:center;}
#cheat-lock-msg{color:#333;font-size:clamp(0.28rem,1vw,0.38rem);text-align:center;line-height:1.8;}
#cheat-input-display{font-size:clamp(0.6rem,2.5vw,1.1rem);color:#ff6600;letter-spacing:10px;text-align:center;min-height:1.5em;text-shadow:0 0 10px #ff660066;}
#cheat-options{display:none;flex-direction:column;gap:10px;width:min(360px,90vw);}
.cheat-opt{display:flex;align-items:center;gap:12px;padding:10px 14px;border:2px solid #222;background:#0a0a0a;cursor:pointer;transition:all .15s;}
.cheat-opt:hover{border-color:#ff6600;background:rgba(255,102,0,0.08);}
.cheat-opt.on{border-color:#ff6600;background:rgba(255,102,0,0.12);}
.cheat-tog{width:18px;height:18px;border:2px solid #444;background:#111;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.cheat-opt.on .cheat-tog{background:#ff6600;border-color:#ffaa00;}
.cheat-tog-inner{width:10px;height:10px;background:#fff;display:none;}
.cheat-opt.on .cheat-tog-inner{display:block;}
.cheat-opt-label{color:#ccc;font-size:clamp(0.28rem,1.1vw,0.38rem);flex:1;}
.cheat-opt.on .cheat-opt-label{color:#ff9900;}
#cheat-warn{color:#ff2200;font-size:clamp(0.24rem,0.9vw,0.32rem);text-align:center;line-height:1.8;display:none;}
#cheat-back{padding:10px 24px;background:#1a0000;border:2px solid #ff2200;color:#ff4444;font-family:'Press Start 2P',monospace;font-size:0.42rem;cursor:pointer;}

/* ‚îÄ‚îÄ STATS SCREEN ‚îÄ‚îÄ */
#stats-screen{position:fixed;top:0;left:0;width:100vw;height:100vh;height:100dvh;background:#000011;display:none;flex-direction:column;align-items:center;justify-content:flex-start;z-index:700;padding:16px 8px;gap:8px;overflow-y:auto;}
.stats-ttl{color:#06d6a0;font-size:clamp(0.5rem,2.5vw,0.85rem);letter-spacing:4px;text-align:center;flex-shrink:0;}
#stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;width:100%;max-width:700px;}
.stat-card{display:flex;flex-direction:column;align-items:center;gap:5px;padding:12px 8px;border:2px solid #1a3a28;background:#040e08;border-radius:2px;}
.stat-icon{font-size:1.2rem;}
.stat-label{color:#888;font-size:clamp(0.2rem,0.9vw,0.3rem);letter-spacing:2px;text-align:center;}
.stat-value{color:#06d6a0;font-size:clamp(0.35rem,1.5vw,0.6rem);text-align:center;}
#stats-back{padding:10px 24px;background:#001a10;border:2px solid #06d6a0;color:#06d6a0;font-family:'Press Start 2P',monospace;font-size:0.45rem;cursor:pointer;flex-shrink:0;margin-top:8px;}

/* ‚îÄ‚îÄ RESET CONFIRM STYLES ‚îÄ‚îÄ */
#reset-confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:1000;display:none;align-items:center;justify-content:center;}
#reset-confirm-box{border:3px solid #ff0000;background:#0a0000;padding:24px;display:flex;flex-direction:column;align-items:center;gap:14px;max-width:380px;width:90vw;}
.reset-ttl{color:#ff0000;font-size:0.55rem;letter-spacing:3px;text-align:center;text-shadow:0 0 14px #ff000088;}
.reset-desc{color:#ff6666;font-size:0.28rem;text-align:center;line-height:1.8;}
#reset-confirm-btn{padding:10px 20px;border:2px solid #ff0000;background:#2a0000;color:#ff4444;font-family:'Press Start 2P',monospace;font-size:0.38rem;cursor:pointer;letter-spacing:2px;}
#reset-cancel-btn{padding:8px 20px;border:2px solid #444;background:#111;color:#888;font-family:'Press Start 2P',monospace;font-size:0.32rem;cursor:pointer;}
#reset-step2{display:none;flex-direction:column;align-items:center;gap:12px;}
#reset-step1{display:flex;flex-direction:column;align-items:center;gap:12px;}

/* ‚îÄ‚îÄ ACHIEVEMENTS ‚îÄ‚îÄ */
#achievements-screen{position:fixed;top:0;left:0;width:100vw;height:100vh;height:100dvh;background:#000011;display:none;flex-direction:column;align-items:center;justify-content:flex-start;z-index:700;padding:16px 8px;gap:8px;overflow-y:auto;}
.ach-ttl{color:#ffd166;font-size:clamp(0.5rem,2.5vw,0.85rem);letter-spacing:4px;text-align:center;flex-shrink:0;}
#ach-progress{color:#a78bfa;font-size:clamp(0.25rem,1vw,0.38rem);text-align:center;flex-shrink:0;}
#ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;width:100%;max-width:800px;}
.ach-card{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 8px;border:2px solid #222;background:#080018;border-radius:4px;transition:border-color .2s;}
.ach-card.unlocked{border-color:#ffd166;background:rgba(255,209,102,0.07);}
.ach-card.locked{opacity:0.45;filter:grayscale(0.6);}
.ach-icon{font-size:1.4rem;line-height:1;}
.ach-name{color:#ffd166;font-size:clamp(0.22rem,1vw,0.35rem);text-align:center;letter-spacing:1px;}
.ach-card.locked .ach-name{color:#555;}
.ach-desc{color:#a78bfa;font-size:clamp(0.18rem,0.8vw,0.28rem);text-align:center;line-height:1.4;}
.ach-card.locked .ach-desc{color:#333;}
.ach-date{color:#555;font-size:0.2rem;text-align:center;}
.ach-card.unlocked .ach-date{color:#888;}
/* Achievement toast popup */
#ach-toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-120%);z-index:900;
  background:#0a000f;border:2px solid #ffd166;padding:10px 18px;
  display:flex;align-items:center;gap:10px;min-width:260px;max-width:90vw;
  transition:transform .35s cubic-bezier(.22,1,.36,1),opacity .35s;opacity:0;pointer-events:none;}
#ach-toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
#ach-toast-icon{font-size:1.3rem;}
#ach-toast-text{display:flex;flex-direction:column;gap:2px;}
#ach-toast-label{color:#ffd166;font-size:0.32rem;letter-spacing:2px;}
#ach-toast-name{color:#fff;font-size:0.38rem;}
#scores-back-ach{padding:10px 24px;background:#222;border:2px solid #ffd166;color:#ffd166;font-family:'Press Start 2P',monospace;font-size:0.45rem;cursor:pointer;flex-shrink:0;}

/* ‚îÄ‚îÄ SCOREBOARD SCREEN ‚îÄ‚îÄ */
#scores-screen{position:fixed;top:0;left:0;width:100vw;height:100vh;height:100dvh;background:#000011;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:700;gap:12px;}
.sb-ttl{color:#ff6b35;font-size:0.6rem;letter-spacing:4px;text-align:center;}
#sb-list{display:flex;flex-direction:column;gap:4px;width:min(400px,90vw);}
.sbr{display:flex;align-items:center;gap:6px;padding:5px 8px;font-size:0.4rem;background:rgba(255,255,255,0.03);border:1px solid #222;}
.sbr.gold{background:rgba(255,209,102,0.11);border-color:rgba(255,209,102,0.4);}
.sbr.silver{background:rgba(180,180,180,0.07);border-color:#444;}
.sbr.bronze{background:rgba(200,120,50,0.08);border-color:#553311;}
.sbr-rank{color:#a78bfa;width:20px;flex-shrink:0;}
.sbr-name{color:#fff;flex:1;}
.sbr-score{color:#ffd166;flex-shrink:0;}
#scores-back{padding:10px 24px;background:#222;border:2px solid #555;color:#aaa;font-family:'Press Start 2P',monospace;font-size:0.5rem;cursor:pointer;}

/* ‚îÄ‚îÄ SHARED BOXES ‚îÄ‚îÄ */
.sbox{background:rgba(255,255,255,0.04);border:2px solid #a78bfa;padding:4px 6px;text-align:center;}
.slbl{color:#a78bfa;font-size:0.38rem;letter-spacing:1px;text-transform:uppercase;}
.sval{color:#ffd166;font-size:0.65rem;line-height:1.4;}

/* Legacy sidebar (hidden, keep for HUD IDs) */
#sidebar{display:none;}
#play-btn{display:none;}
#levels-btn{display:none;}
#pause-btn{display:none;}

/* TOUCH CONTROLS ‚Äî in normal document flow below canvas */
/* TOUCH CONTROLS ‚Äî truly flat single row, ~90px max height */
#controls{
  display:none;flex-direction:row;justify-content:space-between;align-items:center;
  width:100%;padding:4px 12px 6px;gap:0;box-sizing:border-box;flex-shrink:0;
  background:rgba(0,0,14,0.92);border-top:1px solid #1a1a40;
}
/* three zones: move | powerups | fire */
.ctrl-zone{display:flex;flex-direction:row;align-items:center;gap:4px;}
.c-btn-cv{
  display:block;border-radius:8px;border:2.5px solid #555;
  cursor:pointer;touch-action:none;flex-shrink:0;
  transition:transform .05s,opacity .05s;
  image-rendering:pixelated;background:rgba(0,0,14,0.55);
  -webkit-tap-highlight-color:transparent!important;
  -webkit-touch-callout:none;
  outline:none!important;user-select:none;-webkit-user-select:none;
}
.c-btn-cv.tapped{transform:scale(0.88);opacity:0.55;}
/* movement ‚Äî all 4 in a row, left/right bigger since most-used */
#cb-left, #cb-right{border-color:#a78bfa;width:72px;height:72px;}
#cb-up,   #cb-down {border-color:#a78bfa;width:58px;height:58px;}
/* power-ups */
#cb-laser {border-color:#06d6a0;width:66px;height:66px;}
#cb-shield{border-color:#00aaff;width:66px;height:66px;}
#cb-pause {border-color:#aaaaff;width:50px;height:50px;}
/* fire ‚Äî biggest, rightmost */
#cb-fire  {border-color:#ff6b35;width:80px;height:80px;}
#hint{color:rgba(167,139,250,0.35);font-size:0.45rem;text-align:center;padding:1px 0 2px;flex-shrink:0;}
/* Portrait: controls are rotated with the app ‚Äî same layout works */

/* MODALS */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.88);display:none;align-items:center;justify-content:center;z-index:600;}
.modal-bg.show{display:flex;}
.mbox{background:#0d001a;border:4px solid #ff6b35;padding:18px 24px;display:flex;flex-direction:column;gap:10px;text-align:center;min-width:240px;max-width:94vw;max-height:90vh;overflow-y:auto;}
.mbox h2{color:#ff6b35;font-size:0.9rem;letter-spacing:2px;}
.mbox p{color:#a78bfa;font-size:0.42rem;line-height:1.6;}
#name-input{background:#000011;border:3px solid #a78bfa;color:#fff;font-family:'Press Start 2P',monospace;font-size:0.75rem;padding:7px 10px;outline:none;text-align:center;touch-action:auto;}
#name-input:focus{border-color:#ffd166;}
.mbtn{padding:8px;border:3px solid #fff;color:#fff;font-family:'Press Start 2P',monospace;font-size:0.65rem;cursor:pointer;transition:opacity .15s;}
.mbtn:hover{opacity:0.8;}
.mbtn.primary{background:#ff6b35;}
.mbtn.secondary{background:#7c3aed;border-color:#a78bfa;}

/* LEVELS GRID */
#lvl-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;padding:4px;}
.lc{padding:7px 2px;font-size:0.42rem;text-align:center;border:2px solid #222;color:#333;font-family:'Press Start 2P',monospace;}
.lc.open{color:#ffd166;border-color:#555;cursor:pointer;}
.lc.open:hover{background:rgba(167,139,250,0.15);border-color:#a78bfa;}
.lc.cur{color:#ff6b35;border-color:#ff6b35;background:rgba(255,107,53,0.1);}
.lc.boss{color:#ff4444;}
.lc.boss.open{border-color:#ff0040;}
.lc.boss.cur{border-color:#ff0040;background:rgba(255,0,64,0.1);}

/* PAUSE OVERLAY */
#pause-ov{position:fixed;inset:0;background:rgba(0,0,0,0.78);display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px;z-index:600;}
#pause-ov.show{display:flex;}
#pause-ov h2{font-size:1.4rem;color:#fff;text-shadow:3px 3px 0 #000;}
#pause-ov .mbtn{min-width:160px;}

/* PIXEL HEART LIVES */
.hrt{display:inline-block;width:13px;height:13px;margin:1px;image-rendering:pixelated;position:relative;}
.hrt.alive::before{content:'';position:absolute;inset:0;
  background:#ff2244;
  clip-path:polygon(25% 0%,50% 15%,75% 0%,100% 25%,100% 50%,50% 100%,0% 50%,0% 25%);}
.hrt.dead::before{content:'';position:absolute;inset:0;
  background:#333;
  clip-path:polygon(25% 0%,50% 15%,75% 0%,100% 25%,100% 50%,50% 100%,0% 50%,0% 25%);}
/* canvas button styles unified above */
/* RESPONSIVE */
@media(max-width:560px) and (orientation:landscape){#sidebar{width:118px;}.sval{font-size:0.56rem;}}
@media(max-width:360px) and (orientation:landscape){#sidebar{display:none;}}
@media(orientation:portrait){
  body{overflow:hidden;}
  #app{transform-origin:top left;transform:rotate(90deg) translateY(-100%);width:100vh;height:100vw;position:fixed;top:0;left:0;}
  #sidebar{width:128px;}
  .sval{font-size:0.55rem;}
  #name-modal,#levels-modal,#pause-ov,#lvlcomplete-modal{transform:rotate(-90deg) translateX(-100%);transform-origin:top left;width:100vw;height:100vh;top:0;left:0;}
  #main-menu,#scores-screen{transform:none !important;width:100vw !important;height:100vh !important;top:0 !important;left:0 !important;}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN MENU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="main-menu">
  <canvas id="mm-bg-canvas"></canvas>
  <div id="mm-content">
    <canvas id="mm-canvas" width="560" height="120"></canvas>
    <div id="mm-sub">150 LEVELS &nbsp;¬∑&nbsp; 30 BOSSES &nbsp;¬∑&nbsp; UNLIMITED CHAOS</div>
    <div id="mm-buttons">
      <button class="mm-btn" id="mm-play">‚ñ∂ &nbsp; PLAY</button>
      <button class="mm-btn" id="mm-levels">LEVEL SELECT</button>
      <button class="mm-btn" id="mm-scores">HIGH SCORES</button>
      <button class="mm-btn" id="mm-achievements" style="background:#1a1000;border-color:#ffd166;color:#ffd166;box-shadow:0 4px 0 #3a2a00;">üèÜ ACHIEVEMENTS</button>
      <button class="mm-btn" id="mm-settings">‚öô SETTINGS</button>

    </div>
    <div id="mm-footer">A/D MOVE &nbsp;¬∑&nbsp; SPACE FIRE &nbsp;¬∑&nbsp; X LASER &nbsp;¬∑&nbsp; E SHIELD &nbsp;¬∑&nbsp; P PAUSE</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="settings-screen">
  <div class="set-ttl">‚öô SETTINGS</div>
  <div class="set-sep"></div>
  <div class="set-row">
    <div class="set-lbl">MASTER VOLUME</div>
    <div class="vol-wrap">
      <input type="range" id="vol-slider" min="0" max="100" value="30">
      <span id="vol-val">30</span>
    </div>
  </div>
  <div class="set-row">
    <div class="set-lbl">MUTE</div>
    <button id="mute-btn">üîä SOUND ON</button>
  </div>
  <div class="set-sep"></div>
  <div class="set-row">
    <div class="set-lbl">DIFFICULTY</div>
    <div id="set-diff">
      <button class="mm-diff-btn sel" data-d="easy">EASY</button>
      <button class="mm-diff-btn" data-d="medium">MEDIUM</button>
      <button class="mm-diff-btn" data-d="hard">HARD</button>
    </div>
  </div>
  <div class="set-sep"></div>
  <button id="set-cheats-btn" style="padding:clamp(7px,1.5vh,12px) 0;width:min(300px,88vw);border:2px solid #ff4400;color:#ff6600;font-family:'Press Start 2P',monospace;font-size:clamp(0.38rem,1.4vw,0.55rem);cursor:pointer;background:#1a0800;letter-spacing:2px;">‚ò† CHEAT CODES</button>
  <div class="set-sep"></div>
  <button id="set-stats-btn" style="padding:clamp(7px,1.5vh,12px) 0;width:min(300px,88vw);border:2px solid #06d6a0;color:#06d6a0;font-family:'Press Start 2P',monospace;font-size:clamp(0.38rem,1.4vw,0.55rem);cursor:pointer;background:#001a10;letter-spacing:2px;">üìä STATISTICS</button>
  <button id="set-reset-btn" style="padding:clamp(7px,1.5vh,12px) 0;width:min(300px,88vw);border:2px solid #440000;color:#ff2222;font-family:'Press Start 2P',monospace;font-size:clamp(0.38rem,1.4vw,0.55rem);cursor:pointer;background:#0a0000;letter-spacing:2px;">üíÄ RESET PROGRESS</button>
  <div class="set-sep"></div>
  <button id="settings-back">BACK</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHEAT CODE SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="cheat-screen">
  <div id="cheat-title">// CHEAT CODES //</div>
  <div id="cheat-lock-msg">TYPE THE SECRET CODE TO UNLOCK</div>
  <div id="cheat-input-display">_ _ _ _</div>
  <div id="cheat-options">
    <div class="cheat-opt" id="cheat-unlockall">
      <div class="cheat-tog"><div class="cheat-tog-inner"></div></div>
      <div class="cheat-opt-label">UNLOCK ALL LEVELS</div>
    </div>
    <div class="cheat-opt" id="cheat-infhealth">
      <div class="cheat-tog"><div class="cheat-tog-inner"></div></div>
      <div class="cheat-opt-label">INFINITE HEALTH</div>
    </div>
    <div class="cheat-opt" id="cheat-infpower">
      <div class="cheat-tog"><div class="cheat-tog-inner"></div></div>
      <div class="cheat-opt-label">UNLIMITED POWER-UPS</div>
    </div>
    <div class="cheat-opt" id="cheat-megadmg">
      <div class="cheat-tog"><div class="cheat-tog-inner"></div></div>
      <div class="cheat-opt-label">MEGA DAMAGE (300x)</div>
    </div>
  </div>
  <div id="cheat-warn">‚ö† CHEATS ACTIVE ‚Äî SCORING DISABLED ‚ö†</div>
  <button id="cheat-back">BACK</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCORES SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="scores-screen">
  <div class="sb-ttl">TOP SCORES</div>
  <div id="sb-list"></div>
  <button id="scores-back">BACK</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">
  <!-- Hidden sidebar kept for HUD element IDs used by JS -->
  <div id="sidebar" style="display:none;">
    <div id="sb-logo"></div>
    <div class="sbox"><div class="slbl">Score</div><div class="sval" id="el-score">0</div></div>
    <div class="sbox"><div class="slbl">Level</div><div class="sval" id="el-level">1/30</div></div>
    <div class="sbox"><div class="slbl">Wave</div><div class="sval" id="el-wave">-</div></div>
    <div class="sbox"><div class="slbl">Lives</div><div class="sval" id="el-lives"></div></div>
    <div id="shield-box"><div id="shield-lbl"></div><div id="shield-val">READY</div></div>
    <div id="laser-box" class="ready"><div class="llbl"></div><div id="laser-status">READY!</div><div id="lbar-bg"><div id="lbar"></div></div></div>
    <div id="diff-box"><div id="diff-lbl"></div></div>
    <div id="scoreboard"><div class="sb-ttl"></div></div>
    <button id="play-btn" style="display:none;"></button>
    <button id="levels-btn" style="display:none;"></button>
    <button id="pause-btn" style="display:none;"></button>
  </div>

  <div id="game-col">
    <!-- HUD BAR shown during gameplay -->
    <div id="hud-bar">
      <div class="hud-cell">
        <div class="hud-lbl">SCORE</div>
        <div class="hud-val" id="hud-score-val">0</div>
      </div>
      <div class="hud-cell">
        <div class="hud-lbl">LEVEL</div>
        <div class="hud-val" id="hud-level-val">1/30</div>
      </div>
      <div class="hud-cell">
        <div class="hud-lbl">WAVE</div>
        <div class="hud-val" id="hud-wave-val">1</div>
      </div>
      <div class="hud-cell">
        <div class="hud-lbl">LIVES</div>
        <div id="hud-lives"></div>
      </div>
      <div id="hud-laser-wrap">
        <div class="hud-lbl">LASER</div>
        <div class="hud-val" id="hud-laser-val">READY</div>
        <div id="hud-lbar-bg"><div id="hud-lbar"></div></div>
      </div>
      <div class="hud-cell">
        <div class="hud-lbl">SHIELD</div>
        <div id="hud-shield-val">READY</div>
      </div>
      <div class="hud-cell" id="hud-diff-cell" style="margin-left:auto;">
        <div class="hud-lbl">MODE</div>
        <div class="hud-val" id="hud-diff-val" style="color:#ff9f1c;font-size:0.38rem;">EASY</div>
      </div>
      <button id="hud-pause-btn">PAUSE</button>
    </div>

    <div id="canvas-wrap">
      <canvas id="gameCanvas"></canvas>
      <div id="overlay-msg"></div>
    </div>
    <div id="controls">
      <!-- LEFT ZONE: ‚Üê ‚Üë ‚Üì ‚Üí all in one row -->
      <div class="ctrl-zone">
        <canvas class="c-btn-cv" id="cb-left"  width="72" height="72"></canvas>
        <canvas class="c-btn-cv" id="cb-up"    width="58" height="58"></canvas>
        <canvas class="c-btn-cv" id="cb-down"  width="58" height="58"></canvas>
        <canvas class="c-btn-cv" id="cb-right" width="72" height="72"></canvas>
      </div>
      <!-- MIDDLE ZONE: pause ¬∑ laser ¬∑ shield -->
      <div class="ctrl-zone" style="gap:6px;">
        <canvas class="c-btn-cv" id="cb-pause"  width="50" height="50"></canvas>
        <canvas class="c-btn-cv" id="cb-laser"  width="66" height="66"></canvas>
        <canvas class="c-btn-cv" id="cb-shield" width="66" height="66"></canvas>
      </div>
      <!-- RIGHT ZONE: fire -->
      <div class="ctrl-zone">
        <canvas class="c-btn-cv" id="cb-fire" width="80" height="80"></canvas>
      </div>
    </div>
    <div id="hint" style="display:none;">A/D Move ¬∑ Space Fire ¬∑ X Laser ¬∑ E Shield ¬∑ P Pause</div>
  </div>
</div>

<!-- ACHIEVEMENTS SCREEN -->
<div id="achievements-screen">
  <div class="ach-ttl">üèÜ ACHIEVEMENTS</div>
  <div id="ach-progress"></div>
  <div id="ach-grid"></div>
  <button class="mbtn secondary" id="scores-back-ach" style="margin-top:8px;">‚Üê BACK</button>
</div>
<!-- ACHIEVEMENT TOAST -->
<div id="ach-toast">
  <div id="ach-toast-icon">üèÜ</div>
  <div id="ach-toast-text">
    <div id="ach-toast-label">ACHIEVEMENT UNLOCKED</div>
    <div id="ach-toast-name"></div>
  </div>
</div>

<!-- LEVEL INTRO OVERLAY -->
<div id="level-intro">
  <div id="level-intro-bg"></div>
  <div id="li-scanlines"></div>
  <div id="li-section">‚Äî SECTION ‚Äî</div>
  <div id="li-level">LEVEL 1</div>
  <div id="li-name">THE BEGINNING</div>
  <div id="li-countdown">3</div>
</div>

<!-- STATS SCREEN -->
<div id="stats-screen">
  <div class="stats-ttl">üìä STATISTICS</div>
  <div id="stats-grid"></div>
  <button id="stats-back">‚Üê BACK</button>
</div>

<!-- RESET CONFIRM OVERLAY -->
<div id="reset-confirm-overlay">
  <div id="reset-confirm-box">
    <div class="reset-ttl">‚ö† RESET ALL PROGRESS ‚ö†</div>
    <div id="reset-step1">
      <div class="reset-desc">This will erase ALL progress:<br>levels, scores, achievements,<br>and statistics. Forever.</div>
      <button id="reset-confirm-btn">YES, ERASE EVERYTHING</button>
      <button id="reset-cancel-btn">CANCEL</button>
    </div>
    <div id="reset-step2">
      <div class="reset-desc" style="color:#ff2222;">ARE YOU ABSOLUTELY SURE?<br>This CANNOT be undone.</div>
      <button id="reset-confirm-btn2" style="padding:10px 20px;border:2px solid #ff0000;background:#3a0000;color:#ff2222;font-family:'Press Start 2P',monospace;font-size:0.38rem;cursor:pointer;">‚ò† CONFIRM TOTAL WIPE ‚ò†</button>
      <button id="reset-cancel-btn2" style="padding:8px 20px;border:2px solid #444;background:#111;color:#888;font-family:'Press Start 2P',monospace;font-size:0.32rem;cursor:pointer;">CANCEL</button>
    </div>
  </div>
</div>

<!-- NAME MODAL -->
<div class="modal-bg" id="name-modal">
  <div class="mbox">
    <h2>GAME OVER</h2>
    <p>Enter your name for the leaderboard</p>
    <input id="name-input" maxlength="12" placeholder="Your name‚Ä¶" autocomplete="off"/>
    <button class="mbtn primary" id="name-ok">SUBMIT</button>
  </div>
</div>

<!-- LEVELS MODAL -->
<div class="modal-bg" id="levels-modal">
  <div class="mbox">
    <h2>SELECT LEVEL</h2>
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;width:100%;">
      <button class="mbtn secondary" id="lvl-page-prev" style="padding:4px 10px;font-size:0.5rem;">‚óÄ</button>
      <span id="lvl-page-indicator" style="color:#a78bfa;font-size:0.3rem;text-align:center;flex:1;">PAGE 1/3 ¬∑ LEVELS 1-30</span>
      <button class="mbtn secondary" id="lvl-page-next" style="padding:4px 10px;font-size:0.5rem;">‚ñ∂</button>
    </div>
    <p style="font-size:0.3rem;">‚òÖ = Boss level</p>
    <div id="lvl-grid"></div>
    <button class="mbtn secondary" id="lvl-close">CLOSE</button>
  </div>
</div>

<!-- PAUSE -->
<div id="pause-ov">
  <h2>PAUSED</h2>
  <button class="mbtn primary" id="resume-btn">RESUME</button>
  <button class="mbtn secondary" id="quit-btn">QUIT</button>
</div>

<!-- LEVEL COMPLETE MODAL -->
<div class="modal-bg" id="lvlcomplete-modal">
  <div class="mbox" style="gap:12px;">
    <h2 id="lc-title" style="color:#ffd166;">LEVEL COMPLETE!</h2>
    <p id="lc-sub" style="font-size:0.55rem;color:#fff;">Stage cleared!</p>
    <p id="lc-score" style="font-size:0.55rem;color:#ffd166;"></p>
    <button class="mbtn primary" id="lc-continue">‚ñ∂ NEXT LEVEL</button>
    <button class="mbtn secondary" id="lc-levels">LEVEL SELECT</button>
    <button class="mbtn" style="background:#222;border-color:#555;" id="lc-menu">MAIN MENU</button>
  </div>
</div>

<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUDIO ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let AC=null,MG=null,bgmOn=false,laserNodes=[],bgmTO=null,bossTO=null,_bgmSection=0;
function ga(){
  if(!AC){AC=new(window.AudioContext||window.webkitAudioContext)();MG=AC.createGain();MG.gain.value=audioVol;MG.connect(AC.destination);}
  if(AC.state==='suspended')AC.resume();return AC;
}
function setVolume(v){
  audioVol=v/100;
  if(MG)MG.gain.value=audioMuted?0:audioVol;
}
function setMute(m){
  audioMuted=m;
  if(MG)MG.gain.value=audioMuted?0:audioVol;
  const mb=document.getElementById('mute-btn');
  if(mb){mb.textContent=audioMuted?'üîá MUTED':'üîä SOUND ON';mb.className=audioMuted?'muted':'';}
}
function tone(f,tp,t,dur,v,sl){
  const ac=ga(),o=ac.createOscillator(),g=ac.createGain();
  o.connect(g);g.connect(MG);o.type=tp||'square';o.frequency.setValueAtTime(f,t);
  if(sl!==undefined)o.frequency.linearRampToValueAtTime(sl,t+dur);
  g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  o.start(t);o.stop(t+dur+0.02);return o;
}
function noise(t,dur,v,ff){
  const ac=ga(),len=Math.ceil(ac.sampleRate*dur),buf=ac.createBuffer(1,len,ac.sampleRate);
  const d=buf.getChannelData(0);for(let i=0;i<len;i++)d[i]=Math.random()*2-1;
  const s=ac.createBufferSource();s.buffer=buf;
  const fl=ac.createBiquadFilter();fl.type='bandpass';fl.frequency.value=ff||800;fl.Q.value=0.5;
  const g=ac.createGain();g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  s.connect(fl);fl.connect(g);g.connect(MG);s.start(t);s.stop(t+dur+0.02);
}

function sfxShoot(){const ac=ga(),t=ac.currentTime;tone(1800,'sawtooth',t,0.17,0.26,180);tone(900,'sawtooth',t,0.13,0.13,280);tone(3000,'square',t,0.02,0.16,80);tone(120,'sine',t,0.07,0.26,120);}
function sfxLaserStart(){
  sfxLaserStop();const ac=ga(),t=ac.currentTime;
  const w=ac.createOscillator(),wg=ac.createGain();w.connect(wg);wg.connect(MG);w.type='sawtooth';
  w.frequency.setValueAtTime(200,t);w.frequency.exponentialRampToValueAtTime(6000,t+0.6);
  wg.gain.setValueAtTime(0,t);wg.gain.linearRampToValueAtTime(0.38,t+0.3);wg.gain.linearRampToValueAtTime(0.55,t+0.58);wg.gain.linearRampToValueAtTime(0,t+0.62);
  w.start(t);w.stop(t+0.65);laserNodes.push(w);
  const bT=t+0.60;
  const sub=ac.createOscillator(),sg=ac.createGain();sub.connect(sg);sg.connect(MG);sub.type='sine';
  sub.frequency.setValueAtTime(80,bT);sub.frequency.exponentialRampToValueAtTime(20,bT+1.4);
  sg.gain.setValueAtTime(0.8,bT);sg.gain.exponentialRampToValueAtTime(0.0001,bT+1.4);sub.start(bT);sub.stop(bT+1.5);laserNodes.push(sub);
  noise(bT,0.06,0.9,300);noise(bT+0.05,0.15,0.7,200);noise(bT+0.18,0.4,0.5,120);noise(bT+0.55,0.6,0.3,80);
  const hum=ac.createOscillator(),hg=ac.createGain(),lfo=ac.createOscillator(),lg=ac.createGain();
  lfo.frequency.value=14;lg.gain.value=60;lfo.connect(lg);lg.connect(hum.frequency);hum.connect(hg);hg.connect(MG);
  hum.type='sawtooth';hum.frequency.setValueAtTime(55,bT+0.05);hg.gain.setValueAtTime(0,bT);hg.gain.linearRampToValueAtTime(0.22,bT+0.3);
  hum.start(bT);lfo.start(bT);laserNodes.push(hum);laserNodes.push(lfo);laserNodes._hg=hg;
}
function sfxLaserStop(){
  if(!laserNodes.length)return;const ac=ga();
  if(laserNodes._hg){try{laserNodes._hg.gain.setValueAtTime(laserNodes._hg.gain.value,ac.currentTime);laserNodes._hg.gain.linearRampToValueAtTime(0,ac.currentTime+0.25);}catch(e){}}
  laserNodes.forEach(n=>{try{n.stop(ac.currentTime+0.28);}catch(e){}});laserNodes=[];
}
function sfxExplode(big){
  const ac=ga(),t=ac.currentTime,fs=big?[55,40,70,35,90]:[140,110,180];
  fs.forEach((f,i)=>{tone(f,'sawtooth',t+i*0.025,big?.5:.22,big?.28:.18,f*0.25);tone(f*2,'square',t+i*0.025,big?.35:.16,big?.14:.09,f*0.18);});
  noise(t,big?.5:.22,big?.55:.28,big?200:500);
}
function sfxBossAlarm(){const ac=ga(),t=ac.currentTime;for(let i=0;i<5;i++){tone(180,'square',t+i*.2,.12,.3,360);tone(360,'square',t+i*.2+.1,.1,.2,180);}}
function sfxBossWin(){const ac=ga(),t=ac.currentTime;[523,659,784,1047,784,1047,1319,1047,1319,1568].forEach((f,i)=>tone(f,'square',t+i*.075,.09,.28,f*1.04));sfxExplode(true);noise(t+.1,.8,.4,150);}
function sfxHit(){const ac=ga(),t=ac.currentTime;tone(800,'square',t,.05,.22,400);tone(400,'square',t+.04,.08,.16,200);noise(t,.07,.14,2000);}
function sfxLoseLife(){const ac=ga(),t=ac.currentTime;tone(440,'square',t,.12,.3,220);tone(330,'square',t+.1,.12,.25,165);tone(220,'sawtooth',t+.22,.22,.35,80);noise(t+.22,.25,.12,300);}
function sfxMenuClick(){const ac=ga(),t=ac.currentTime;tone(660,'square',t,.005,.07,1.08);tone(880,'square',t+.04,.003,.05,1);}
function sfxMenuHover(){const ac=ga(),t=ac.currentTime;tone(440,'square',t,.003,.04,1);}
function sfxMenuBack(){const ac=ga(),t=ac.currentTime;tone(330,'square',t,.005,.07,0.92);}
function sfxGameOver(){sfxLaserStop();stopBGM();const ac=ga(),t=ac.currentTime;[440,349,294,220,196,165,147,110].forEach((f,i)=>tone(f,'square',t+i*.16,.20,.28-i*.02));}
function sfxWaveDone(){const ac=ga(),t=ac.currentTime;[523,659,784,659,784,1047].forEach((f,i)=>tone(f,'square',t+i*.1,.12,.22));}
function sfxLevelUp(){const ac=ga(),t=ac.currentTime;[392,494,587,784,1047,1319].forEach((f,i)=>tone(f,'square',t+i*.09,.13,.28));}
function sfxBossLaserSfx(){const ac=ga(),t=ac.currentTime;tone(400,'sawtooth',t,.05,.28,2200);noise(t+.04,.09,.22,3200);}
function sfxLidSlam(){const ac=ga(),t=ac.currentTime;noise(t,.08,.6,120);tone(60,'sine',t,.15,.45,30);tone(180,'square',t,.06,.22,80);}
function sfxIceRing(){const ac=ga(),t=ac.currentTime;for(let i=0;i<8;i++){tone(2000+i*200,'triangle',t+i*.04,.06,.12,1000+i*100);noise(t+i*.04,.03,.06,6000);}
}
function sfxHeatWave(){const ac=ga(),t=ac.currentTime;for(let i=0;i<5;i++){tone(200-i*20,'sawtooth',t+i*.06,.1,.20,80);noise(t+i*.06,.08,.14,500+i*100);}}
function sfxBarrage(){const ac=ga(),t=ac.currentTime;for(let i=0;i<6;i++){tone(1600,'sawtooth',t+i*.05,.04,.18,200);tone(800,'square',t+i*.05,.03,.10,100);}}

function sfxBubbleActivate(){
  const ac=ga(),t=ac.currentTime;
  tone(1000,'sine',t,.03,.12,2000);tone(1500,'triangle',t+.06,.04,.10,3000);
  tone(500,'sine',t+.1,.05,.08,1000);noise(t,.04,.06,5000);
}

// BGM ‚Äî "TUPPER WARS EPIC" theme  (D-minor, 160bpm feel)
// Beat grid: _b=1/16 note, _q=1/4, _h=1/2  at 160bpm‚Üí _q‚âà0.1875s
const _b=0.09375,_q=0.1875,_h=0.375;

// ‚îÄ‚îÄ SECTION A: Tense build ‚Äî heavy bass ostinato + sparse lead ‚îÄ‚îÄ
const BGM_A_BASS=[
  [147,_h],[0,_b],[147,_b],[175,_q],[0,_q],
  [147,_h],[0,_b],[131,_b],[147,_q],[0,_q],
  [175,_h],[0,_b],[175,_b],[196,_q],[0,_q],
  [175,_h],[0,_b],[165,_b],[147,_q],[0,_q],
  [131,_h],[0,_b],[131,_b],[147,_q],[0,_q],
  [131,_h],[0,_b],[117,_b],[131,_q],[0,_q],
  [110,_h],[0,_b],[110,_b],[117,_q],[0,_q],
  [147,_h],[165,_q],[175,_h],[0,_h],
];
const BGM_A_LEAD=[
  [0,_h],[0,_h],[294,_b],[330,_b],[349,_q],[330,_q],
  [294,_h],[262,_q],[294,_q],[0,_h],
  [0,_h],[0,_h],[392,_b],[440,_b],[494,_q],[440,_q],
  [392,_h],[349,_q],[330,_q],[0,_h],
  [0,_h],[0,_h],[523,_b],[494,_b],[466,_q],[440,_q],
  [415,_h],[392,_q],[349,_q],[0,_h],
  [0,_h],[294,_q],[349,_q],[392,_q],[440,_q],
  [494,_h],[523,_h],[0,_h],[0,_h],
];

// ‚îÄ‚îÄ SECTION B: Epic drive ‚Äî galloping arp + triumphant lead ‚îÄ‚îÄ
const BGM_B_BASS=[
  [147,_b],[0,_b],[147,_b],[0,_b],[175,_b],[0,_b],[175,_b],[0,_b],
  [196,_b],[0,_b],[175,_b],[0,_b],[165,_b],[0,_b],[147,_b],[0,_b],
  [131,_b],[0,_b],[131,_b],[0,_b],[147,_b],[0,_b],[147,_b],[0,_b],
  [117,_b],[0,_b],[131,_b],[0,_b],[147,_b],[0,_b],[165,_b],[0,_b],
  [175,_b],[0,_b],[175,_b],[0,_b],[196,_b],[0,_b],[196,_b],[0,_b],
  [208,_b],[0,_b],[196,_b],[0,_b],[175,_b],[0,_b],[165,_b],[0,_b],
  [147,_b],[0,_b],[165,_b],[0,_b],[175,_b],[0,_b],[196,_b],[0,_b],
  [220,_b],[0,_b],[196,_b],[0,_b],[175,_b],[165,_b],[147,_b],[0,_b],
];
const BGM_B_LEAD=[
  [0,_q],[588,_b],[659,_b],[698,_q],[659,_q],[588,_h],
  [0,_q],[523,_b],[588,_b],[659,_q],[698,_q],[784,_h],
  [0,_q],[698,_b],[784,_b],[880,_q],[784,_q],[698,_h],
  [0,_q],[659,_b],[698,_b],[784,_q],[698,_q],[659,_h],
  [0,_q],[523,_b],[588,_b],[659,_q],[588,_q],[523,_h],
  [0,_q],[494,_b],[523,_b],[588,_q],[523,_q],[494,_h],
  [0,_q],[440,_b],[494,_b],[523,_q],[588,_q],[659,_h],
  [0,_q],[784,_b],[880,_b],[988,_q],[880,_q],[784,_h],
];
const BGM_B_ARP=[
  [294,_b],[349,_b],[440,_b],[523,_b],[294,_b],[349,_b],[440,_b],[523,_b],
  [392,_b],[466,_b],[523,_b],[587,_b],[392,_b],[466,_b],[523,_b],[587,_b],
  [349,_b],[440,_b],[523,_b],[659,_b],[349,_b],[440,_b],[523,_b],[659,_b],
  [330,_b],[415,_b],[494,_b],[587,_b],[330,_b],[415,_b],[494,_b],[587,_b],
  [262,_b],[330,_b],[392,_b],[494,_b],[262,_b],[330,_b],[392,_b],[494,_b],
  [247,_b],[311,_b],[370,_b],[466,_b],[247,_b],[311,_b],[370,_b],[466,_b],
  [220,_b],[277,_b],[330,_b],[415,_b],[220,_b],[277,_b],[330,_b],[415,_b],
  [294,_b],[370,_b],[440,_b],[554,_b],[659,_b],[554,_b],[440,_b],[370,_b],
];

// ‚îÄ‚îÄ SECTION C: Fury ‚Äî fast chromatic runs, dense texture ‚îÄ‚îÄ
const BGM_C_BASS=[
  [147,_b],[155,_b],[165,_b],[175,_b],[0,_b],[175,_b],[165,_b],[0,_b],
  [155,_b],[147,_b],[0,_b],[147,_b],[131,_b],[0,_b],[131,_b],[0,_b],
  [196,_b],[208,_b],[220,_b],[233,_b],[0,_b],[220,_b],[208,_b],[0,_b],
  [196,_b],[175,_b],[0,_b],[165,_b],[147,_b],[0,_b],[131,_b],[0,_b],
  [110,_b],[117,_b],[131,_b],[147,_b],[0,_b],[147,_b],[131,_b],[0,_b],
  [117,_b],[110,_b],[0,_b],[110,_b],[98,_b],[0,_b],[98,_b],[0,_b],
  [131,_b],[147,_b],[165,_b],[175,_b],[196,_b],[175,_b],[165,_b],[147,_b],
  [131,_b],[147,_b],[165,_b],[175,_b],[196,_b],[220,_b],[247,_b],[294,_b],
];
const BGM_C_LEAD=[
  [588,_b],[659,_b],[698,_b],[784,_b],[0,_b],[784,_b],[698,_b],[659,_b],
  [588,_b],[523,_b],[0,_b],[523,_b],[494,_b],[0,_b],[523,_b],[0,_b],
  [784,_b],[880,_b],[988,_b],[1047,_b],[0,_b],[988,_b],[880,_b],[784,_b],
  [698,_b],[659,_b],[0,_b],[588,_b],[523,_b],[0,_b],[466,_b],[0,_b],
  [523,_b],[494,_b],[466,_b],[440,_b],[0,_b],[440,_b],[466,_b],[494,_b],
  [523,_b],[587,_b],[0,_b],[659,_b],[698,_b],[0,_b],[784,_b],[0,_b],
  [880,_b],[0,_b],[784,_b],[0,_b],[698,_b],[0,_b],[659,_b],[0,_b],
  [588,_b],[523,_b],[494,_b],[523,_b],[588,_b],[523,_b],[494,_b],[440,_b],
];

function schedV(tr,wt,st,v,sp){
  const ac=ga();let t=st;sp=sp||1;
  for(const[f,d]of tr){const rd=(d/sp);if(f>0)tone(f,wt,t,rd*.86,v);t+=rd;}
  return t-st;
}

function scheduleBGM(){
  if(!bgmOn)return;
  const ac=ga(),t=ac.currentTime+.04;
  const sp=Math.min(1.7,1+(curLevel-1)*.03);
  let dur=0;

  if(_bgmSection===0){
    // Section A: tense build
    const bl=schedV(BGM_A_BASS,'square',t,.26,sp);
    const ll=schedV(BGM_A_LEAD,'sawtooth',t,.16,sp);
    // Percussion: kick on beats 1&3, snare on 2&4
    const bLen=_q/sp,barLen=_h/sp;
    for(let b=0;b<8;b++){
      if(b%2===0){noise(t+b*barLen,.05/sp,.30,100);tone(55,'sine',t+b*barLen,.12/sp,.28,28);}
      else{noise(t+b*barLen,.04/sp,.18,3500);}
      // hi-hat every 8th
      for(let hh=0;hh<4;hh++)noise(t+b*barLen+hh*bLen,.02/sp,.06,8000);
    }
    dur=Math.max(bl,ll);
  } else if(_bgmSection===1){
    // Section B: epic drive
    const bl=schedV(BGM_B_BASS,'square',t,.30,sp);
    const ll=schedV(BGM_B_LEAD,'sawtooth',t,.18,sp);
    const al=schedV(BGM_B_ARP,'triangle',t,.10,sp);
    // Dense percussion
    const bLen=_q/sp;
    for(let b=0;b<8;b++){
      noise(t+b*bLen*2,.06/sp,.35,120);tone(49,'sine',t+b*bLen*2,.14/sp,.32,22);// kick
      noise(t+b*bLen*2+bLen,.04/sp,.22,4000);// snare
      noise(t+b*bLen*2+bLen*.5,.018/sp,.08,9000);// hi-hat off
      noise(t+b*bLen*2+bLen*1.5,.018/sp,.08,9000);
    }
    dur=Math.max(bl,ll,al);
  } else {
    // Section C: fury
    const bl=schedV(BGM_C_BASS,'sawtooth',t,.28,sp);
    const ll=schedV(BGM_C_LEAD,'sawtooth',t,.15,sp);
    const al=schedV(BGM_B_ARP,'triangle',t,.08,sp);// reuse arp
    // Blast-beat percussion
    const bLen=_b/sp;
    for(let b=0;b<32;b++){
      if(b%4===0){noise(t+b*bLen,.05/sp,.30,90);tone(44,'sine',t+b*bLen,.08/sp,.25,22);}
      noise(t+b*bLen,.015/sp,.05,10000);// continuous hi-hat
      if(b%8===4)noise(t+b*bLen,.04/sp,.20,3800);// snare
    }
    dur=Math.max(bl,ll,al);
  }
  _bgmSection=(_bgmSection+1)%3;
  bgmTO=setTimeout(scheduleBGM,Math.max(10,(dur-.12)*1000));
}

// ‚ïê‚ïê MAIN MENU MUSIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Catchy 8-bit theme: C major feel, bouncy & upbeat
let mmMusicOn=false,mmMusicTO=null,mmMusicSection=0;
const _mq=0.12,_mh=0.24,_me=0.06;
const MM_BASS=[
  [131,_mh],[0,_me],[131,_me],[165,_mh],[0,_me],[165,_me],
  [196,_mh],[0,_me],[196,_me],[165,_mh],[0,_mh],
  [131,_mh],[0,_me],[131,_me],[147,_mh],[0,_me],[147,_me],
  [131,_mh],[0,_me],[98,_me],[110,_mh],[0,_mh],
];
const MM_LEAD=[
  [523,_me],[587,_me],[659,_me],[523,_me],[659,_me],[784,_me],[659,_me],[523,_me],
  [587,_me],[659,_me],[784,_me],[880,_me],[784,_me],[659,_me],[587,_me],[523,_me],
  [659,_me],[523,_me],[587,_me],[494,_me],[523,_me],[440,_me],[494,_me],[523,_me],
  [587,_me],[523,_me],[494,_me],[440,_me],[392,_me],[440,_me],[523,_me],[659,_me],
];
const MM_ARP=[
  [262,_me],[330,_me],[392,_me],[330,_me],[262,_me],[330,_me],[392,_me],[523,_me],
  [294,_me],[370,_me],[440,_me],[370,_me],[294,_me],[370,_me],[440,_me],[587,_me],
  [247,_me],[330,_me],[392,_me],[330,_me],[247,_me],[330,_me],[392,_me],[494,_me],
  [220,_me],[294,_me],[370,_me],[294,_me],[220,_me],[294,_me],[370,_me],[440,_me],
];
function scheduleMMMusic(){
  if(!mmMusicOn)return;
  const ac=ga(),t=ac.currentTime+.04;
  // Bass
  let dur=0;
  let tBass=t;for(const[f,d]of MM_BASS){if(f>0)tone(f,'square',tBass,.22,d*.9);tBass+=d;}
  // Lead melody
  let tLead=t;for(const[f,d]of MM_LEAD){if(f>0)tone(f,'square',tLead,.12,d*.85);tLead+=d;}
  dur=tLead-t;
  // Arp harmony
  let tArp=t;for(const[f,d]of MM_ARP){if(f>0)tone(f,'triangle',tArp,.07,d*.8);tArp+=d;}
  // Percussion
  const bt=_mh;
  for(let b=0;b<8;b++){
    noise(t+b*bt*.5,.025,.18,120);// kick
    if(b%2===1)noise(t+b*bt*.5,.02,.14,3800);// snare
    noise(t+b*bt*.5+bt*.25,.012,.06,9000);// hat
  }
  mmMusicTO=setTimeout(scheduleMMMusic,Math.max(10,(dur-.1)*1000));
}
function startMMMusic(){if(mmMusicOn)return;mmMusicOn=true;scheduleMMMusic();}
function stopMMMusic(){mmMusicOn=false;if(mmMusicTO){clearTimeout(mmMusicTO);mmMusicTO=null;}}

function startBGM(){if(bgmOn)return;bgmOn=true;_bgmSection=0;scheduleBGM();}
function stopBGM(){bgmOn=false;if(bgmTO){clearTimeout(bgmTO);bgmTO=null;}if(bossTO){clearTimeout(bossTO);bossTO=null;}sfxLaserStop();}

// ‚ïê‚ïê 6 UNIQUE BOSS BGM THEMES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Boss 1 (L5)  ‚Äî "THE LID KING" ‚Äî slow heavy march, deep bass
// Boss 2 (L10) ‚Äî "FROSTLOCK"    ‚Äî cold arpeggios, icy glitch
// Boss 3 (L15) ‚Äî "SAUCEPAN SAM" ‚Äî jazzy chromatic stabs
// Boss 4 (L20) ‚Äî "CRISPER LORD" ‚Äî industrial hammer beat
// Boss 5 (L25) ‚Äî "THERMOS PRIME"‚Äî space ambient dread
// Boss 6 (L30) ‚Äî "THE SEAL"     ‚Äî final boss, epic full mix

// Boss 1: Heavy stomping march in E minor
const B1_BASS=[[82,_h],[0,_q],[82,_q],[87,_h],[0,_q],[87,_q],[98,_h],[0,_q],[87,_q],[82,_q],[78,_q],[0,_h],[73,_h],[0,_q],[73,_q],[78,_h],[0,_q],[78,_q],[82,_h],[0,_q],[78,_q],[73,_q],[69,_q],[0,_h]];
const B1_LEAD=[[0,_h],[165,_b],[175,_b],[196,_q],[175,_q],[165,_h],[0,_h],[0,_h],[147,_b],[165,_b],[175,_q],[165,_q],[147,_q],[131,_q],[0,_h],[0,_h],[196,_b],[208,_b],[220,_q],[208,_q],[196,_h],[0,_h],[0,_h],[175,_q],[165,_q],[147,_q],[131,_q],[165,_h],[0,_h]];

// Boss 2: Cold icy glitch in C minor (high register)
const B2_BASS=[[65,_q],[0,_q],[65,_q],[0,_q],[69,_q],[0,_q],[78,_q],[0,_q],[65,_q],[0,_q],[65,_q],[0,_q],[62,_q],[0,_q],[58,_q],[0,_q],[65,_q],[0,_q],[65,_q],[0,_q],[73,_q],[0,_q],[78,_q],[0,_q],[65,_q],[0,_q],[58,_q],[0,_q],[65,_h],[0,_h]];
const B2_ARP=[[523,_b],[0,_b],[587,_b],[0,_b],[622,_b],[0,_b],[587,_b],[0,_b],[523,_b],[0,_b],[494,_b],[0,_b],[523,_b],[0,_b],[466,_b],[0,_b],[523,_b],[0,_b],[554,_b],[0,_b],[587,_b],[0,_b],[622,_b],[0,_b],[587,_b],[0,_b],[523,_b],[0,_b],[466,_b],[0,_b],[440,_b],[0,_b]];

// Boss 3: Jazzy chromatic evil swing
const B3_BASS=[[110,_q],[116,_q],[110,_q],[0,_q],[104,_q],[0,_q],[98,_q],[104,_q],[110,_q],[0,_q],[116,_q],[0,_q],[123,_q],[116,_q],[110,_q],[0,_q],[98,_q],[0,_q],[104,_q],[110,_q],[116,_q],[0,_q],[123,_q],[0,_q],[116,_q],[110,_q],[104,_q],[98,_q],[110,_h],[0,_h]];
const B3_STAB=[[440,_b],[0,_b],[0,_b],[0,_b],[466,_b],[0,_b],[0,_b],[0,_b],[440,_b],[0,_b],[415,_b],[0,_b],[0,_b],[0,_b],[0,_b],[0,_b],[466,_b],[0,_b],[0,_b],[0,_b],[494,_b],[0,_b],[0,_b],[0,_b],[466,_b],[0,_b],[440,_b],[0,_b],[0,_b],[0,_b],[0,_b],[0,_b]];

// Boss 4: Industrial hammer ‚Äî syncopated hard beat
const B4_BASS=[[55,_b],[0,_b],[55,_b],[55,_b],[0,_b],[58,_b],[0,_b],[55,_b],[52,_b],[0,_b],[52,_b],[52,_b],[0,_b],[49,_b],[0,_b],[52,_b],[55,_b],[0,_b],[55,_b],[55,_b],[0,_b],[62,_b],[0,_b],[55,_b],[49,_b],[0,_b],[49,_b],[52,_b],[0,_b],[55,_b],[0,_b],[49,_b]];
const B4_LEAD=[[220,_q],[0,_q],[233,_q],[0,_q],[220,_q],[0,_q],[208,_q],[0,_q],[220,_q],[0,_q],[247,_q],[0,_q],[262,_q],[0,_q],[247,_q],[0,_q],[220,_q],[0,_q],[233,_q],[0,_q],[247,_q],[0,_q],[262,_q],[0,_q],[277,_q],[0,_q],[262,_q],[0,_q],[247,_q],[220,_q],[0,_h],[0,_h]];

// Boss 5: Space ambient dread ‚Äî slow, vast, menacing
const B5_PAD=[[55,_h],[0,_h],[58,_h],[0,_h],[55,_h],[0,_h],[52,_h],[0,_h],[49,_h],[0,_h],[52,_h],[0,_h],[55,_h],[0,_h],[58,_h],[0,_h]];
const B5_DRONE=[[110,2.0],[0,0.5],[116,1.5],[0,0.5],[110,1.0],[0,0.5],[104,2.0],[0,0.5],[98,1.5],[0,0.5],[104,1.0],[0,0.5],[110,2.0],[0,1.0]];

// Boss 6: THE SEAL ‚Äî epic final boss, all voices
const B6_BASS=[[82,_h],[0,_q],[87,_q],[98,_h],[0,_q],[87,_q],[82,_q],[78,_q],[0,_h],[73,_h],[0,_q],[78,_q],[82,_h],[0,_h],[87,_h],[0,_q],[87,_q],[98,_h],[0,_q],[104,_q],[98,_q],[87,_q],[0,_h],[82,_h],[78,_h],[0,_h]];
const B6_LEAD=[[0,_q],[165,_b],[196,_b],[220,_q],[196,_q],[220,_h],[0,_h],[0,_q],[208,_b],[220,_b],[247,_q],[220,_q],[208,_h],[0,_h],[0,_q],[196,_b],[208,_b],[220,_q],[247,_q],[262,_h],[0,_h],[0,_q],[294,_b],[262,_b],[247,_q],[220,_q],[196,_h],[0,_h],[0,_q],[220,_b],[196,_b],[175,_q],[165,_q],[196,_h],[0,_h]];
const B6_HARM=[[0,_h],[330,_b],[349,_b],[392,_q],[349,_q],[392,_h],[0,_h],[0,_h],[370,_b],[392,_b],[415,_q],[392,_q],[370,_h],[0,_h]];

function getBossTier(){return Math.ceil(curLevel/5);}// 1-6

function scheduleBoss(){
  if(!bgmOn)return;
  const ac=ga(),t=ac.currentTime+.04;
  const tier=getBossTier();
  const sp=Math.min(1.8,1+(tier-1)*.15);

  if(tier===1){
    let bt=t;for(const[f,d]of B1_BASS){if(f>0)tone(f,'square',bt,(d/sp)*.88,.30);bt+=d/sp;}
    let lt=t;for(const[f,d]of B1_LEAD){if(f>0)tone(f,'square',lt,(d/sp)*.84,.16);lt+=d/sp;}
    // War drums
    const dp=[_h,_q,_q,_h,_h,_q,_q,_h,_h,_q,_q,_h,_h,_q,_q,_h];
    let dt=t;dp.forEach((d,i)=>{if(i%4===0){noise(dt,.09/sp,.35,160);tone(55,'sine',dt,.14/sp,.28,28);}else if(i%4===2)noise(dt,.05/sp,.14,4800);dt+=d/sp;});
    bossTO=setTimeout(scheduleBoss,(Math.max(bt,dt)-t-.08)*1000);
  } else if(tier===2){
    let bt=t;for(const[f,d]of B2_BASS){if(f>0)tone(f,'square',bt,(d/sp)*.9,.28);bt+=d/sp;}
    let at=t;for(const[f,d]of B2_ARP){if(f>0)tone(f,'triangle',at,(d/sp)*.75,.12);at+=d/sp;}
    // Ice clinks
    for(let i=0;i<6;i++)noise(t+i*0.3/sp,.04,.08,8000+i*400);
    bossTO=setTimeout(scheduleBoss,(Math.max(bt,at)-t-.08)*1000);
  } else if(tier===3){
    let bt=t;for(const[f,d]of B3_BASS){if(f>0)tone(f,'sawtooth',bt,(d/sp)*.82,.26);bt+=d/sp;}
    let st=t;for(const[f,d]of B3_STAB){if(f>0){tone(f,'square',st,(d/sp)*.55,.20);tone(f*1.5,'square',st,(d/sp)*.45,.10);}st+=d/sp;}
    // Jazz snare pattern
    const jp=[_q,_q,_b,_b,_q,_q,_b,_b,_q,_q];let jt=t;
    jp.forEach((d,i)=>{if(i%3!==1)noise(jt,0.03/sp,.09,3500+i*200);jt+=d/sp;});
    bossTO=setTimeout(scheduleBoss,(Math.max(bt,st)-t-.08)*1000);
  } else if(tier===4){
    let bt=t;for(const[f,d]of B4_BASS){if(f>0)tone(f,'sawtooth',bt,(d/sp)*.72,.32);bt+=d/sp;}
    let lt=t;for(const[f,d]of B4_LEAD){if(f>0)tone(f,'square',lt,(d/sp)*.80,.18);lt+=d/sp;}
    // Industrial hammer hits
    for(let i=0;i<8;i++){noise(t+i*_q/sp,.06/sp,.28,300+i*50);if(i%2===0)tone(40,'sine',t+i*_q/sp,.1/sp,.22,25);}
    bossTO=setTimeout(scheduleBoss,(Math.max(bt,lt)-t-.08)*1000);
  } else if(tier===5){
    let pt=t;for(const[f,d]of B5_PAD){if(f>0){tone(f,'sine',pt,d*.92,.15);tone(f*2,'triangle',pt,d*.85,.08);}pt+=d;}
    let dr=t;for(const[f,d]of B5_DRONE){if(f>0){tone(f,'sawtooth',dr,d*.95,.20);tone(f*1.02,'sawtooth',dr,d*.95,.10);} dr+=d;}
    // Ambient whooshes
    for(let i=0;i<3;i++)noise(t+i*1.2,.6,.12,180+i*60);
    bossTO=setTimeout(scheduleBoss,(Math.max(pt,dr)-t-.12)*1000);
  } else {
    // TIER 6 ‚Äî SUPERNOVA TUPPERWARE: xtrullor-inspired massive build
    // Phase 1: ominous intro (bars 1-4)
    const _8=_b*2;
    let bt=t;for(const[f,d]of B6_BASS){if(f>0){tone(f,'sawtooth',bt,(d/sp)*.92,.35);tone(f*0.5,'sine',bt,(d/sp)*.95,.18);}bt+=d/sp;}
    let lt=t;for(const[f,d]of B6_LEAD){if(f>0){tone(f,'sawtooth',lt,(d/sp)*.82,.22);tone(f*2,'square',lt,(d/sp)*.70,.06);}lt+=d/sp;}
    let ht=t;for(const[f,d]of B6_HARM){if(f>0){tone(f,'triangle',ht,(d/sp)*.88,.16);tone(f*1.5,'sine',ht,(d/sp)*.75,.08);}ht+=d/sp;}
    // Epic build percussion ‚Äî doubled density
    const fp=[_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,
              _8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8,_8];
    let dt=t;fp.forEach((d,i)=>{
      if(i%8===0){noise(dt,.07/sp,.45,80);tone(41,'sine',dt,.16/sp,.38,20);tone(82,'sine',dt,.14/sp,.20,20);}
      else if(i%8===4){noise(dt,.05/sp,.28,4500);}
      else if(i%8===2||i%8===6){noise(dt,.02/sp,.12,9000);}
      // Rising sweep every 16 beats
      if(i%16===15){tone(55+i*2,'sawtooth',dt,.25/sp,.08,880);}
      dt+=d/sp;
    });
    // Supernova "impact" pads ‚Äî wide chords
    const chords=[[294,370,440,554],[262,330,415,494],[220,277,349,440],[247,311,392,466]];
    chords.forEach((chord,ci)=>{
      const ct=t+ci*(bt-t)/4;
      chord.forEach(f=>tone(f,'triangle',ct,((bt-t)/4)*.90,.07));
    });
    // Rising noise sweep (signature xtrullor build-up feel)
    for(let i=0;i<8;i++){
      const nt=t+i*(bt-t)/8;
      noise(nt,.12/sp,.04+i*.015,400+i*800);
    }
    bossTO=setTimeout(scheduleBoss,(Math.max(bt,lt,ht,dt)-t-.08)*1000);
  }
}
function startBossBGM(){stopBGM();bgmOn=true;scheduleBoss();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const GW=900,GH=560;
canvas.width=GW;canvas.height=GH;
function resizeCanvas(){
  const hudBar=document.getElementById('hud-bar');
  const ctrls=document.getElementById('controls');
  const hudVisible=hudBar&&hudBar.style.display==='flex';
  const ctrlVisible=ctrls&&ctrls.style.display==='flex';
  // Portrait: #app is CSS-rotated 90¬∞, so viewport dims are swapped
  const isPortrait=window.innerHeight>window.innerWidth;
  const vW=isPortrait?window.innerHeight:window.innerWidth;
  const vH=isPortrait?window.innerWidth:window.innerHeight;
  // Subtract actual heights of HUD and controls bars
  const hudH=hudVisible?hudBar.offsetHeight:0;
  const ctrlH=ctrlVisible?ctrls.offsetHeight:0;
  const availW=vW;
  const availH=vH-hudH-ctrlH;
  // Fit 900:560 aspect ratio into available space
  const ratio=GW/GH;
  let cw=availW;
  let ch=cw/ratio;
  if(ch>availH){ch=availH;cw=ch*ratio;}
  canvas.style.width=Math.floor(cw)+'px';
  canvas.style.height=Math.floor(ch)+'px';
}
window.addEventListener('resize',()=>requestAnimationFrame(resizeCanvas));
// Auto-pause when window loses focus
window.addEventListener('blur',()=>{if(running&&!paused)doPause();});
document.addEventListener('visibilitychange',()=>{if(document.hidden&&running&&!paused)doPause();});
window.addEventListener('orientationchange',()=>setTimeout(resizeCanvas,150));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCORES & PROGRESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let highScores=[];
try{highScores=JSON.parse(localStorage.getItem('tupperScores')||'[]');}catch(_){}
function saveScore(name,sc){highScores.push({name,score:sc});highScores.sort((a,b)=>b.score-a.score);highScores=highScores.slice(0,10);try{localStorage.setItem('tupperScores',JSON.stringify(highScores));}catch(_){}renderSB();}
function renderSB(){
  const el=document.getElementById('sb-list');el.innerHTML='';
  const m=['gold','silver','bronze'];
  highScores.forEach((e,i)=>{const d=document.createElement('div');d.className='sbr'+(m[i]?' '+m[i]:'');d.innerHTML=`<span class="sbr-rank">${i+1}</span><span class="sbr-name">${e.name.replace(/</g,'&lt;')}</span><span class="sbr-score">${e.score}</span>`;el.appendChild(d);});
}
renderSB();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACHIEVEMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ACH_DEFS=[
  // Progress milestones
  {id:'first_blood',  icon:'üéØ', name:'First Blood',        desc:'Destroy your first enemy'},
  {id:'boss1',        icon:'üëë', name:'Lid Lifted',          desc:'Defeat The Lid King (Level 5)'},
  {id:'boss2',        icon:'üßä', name:'Frost Broken',        desc:'Defeat Frostlock (Level 10)'},
  {id:'boss3',        icon:'üç≥', name:'Heat Off',            desc:'Defeat Saucepan Sam (Level 15)'},
  {id:'boss4',        icon:'ü•¶', name:'Crisper Crushed',     desc:'Defeat Crisper Lord (Level 20)'},
  {id:'boss5',        icon:'‚òï', name:'Thermos Smashed',     desc:'Defeat Thermos Prime (Level 25)'},
  {id:'boss6',        icon:'üåü', name:'Supernova Stopped',   desc:'Defeat Supernova Tupperware (Level 30)'},
  {id:'page2',        icon:'üåÄ', name:'Into The Void',       desc:'Reach Level 31'},
  {id:'boss12',       icon:'üï≥Ô∏è', name:'Void Slain',          desc:'Defeat Void Lunchbox (Level 35)'},
  {id:'boss18',       icon:'üî¥', name:'Necro Purged',        desc:'Defeat The Necroplastic (Level 95)'},
  {id:'page3',        icon:'‚ö°', name:'Beyond The Storm',    desc:'Reach Level 61'},
  {id:'page4',        icon:'üíÄ', name:'Deaths Doorstep',   desc:'Reach Level 91'},
  {id:'page5',        icon:'‚àû',  name:'True Challenger',     desc:'Reach Level 121'},
  {id:'boss_final',   icon:'üî•', name:'Primordial Purified', desc:'Defeat The Primordial Tupperware (Level 150)'},
  // Skill achievements
  {id:'no_dmg_boss',  icon:'üõ°Ô∏è', name:'Untouchable',         desc:'Defeat any boss without taking damage'},
  {id:'laser_kill10', icon:'‚ö°', name:'Laser Lord',          desc:'Kill 10 enemies with laser in one level'},
  {id:'shield_save',  icon:'üí´', name:'Close Call',          desc:'Block a hit with shield active'},
  {id:'score_10k',    icon:'üí∞', name:'Ten Grand',           desc:'Reach 10,000 points'},
  {id:'score_100k',   icon:'üíé', name:'Hundred Thousand',    desc:'Reach 100,000 points'},
  {id:'score_1m',     icon:'üëæ', name:'One Million',         desc:'Reach 1,000,000 points'},
  {id:'wave5',        icon:'üåä', name:'Wave Surfer',         desc:'Complete 5 waves in one level'},
  {id:'no_miss_wave', icon:'‚ú®', name:'Perfect Wave',        desc:'Clear a wave without taking damage'},
  {id:'heart_grab',   icon:'‚ù§Ô∏è', name:'Life Saver',          desc:'Collect a heart drop'},
  {id:'speed_kill',   icon:'üí®', name:'Blitz',               desc:'Kill 20 enemies in under 10 seconds'},
  {id:'level_10',     icon:'üéÆ', name:'Getting Serious',     desc:'Complete Level 10'},
  {id:'level_30',     icon:'üéñÔ∏è', name:'First Chapter Done', desc:'Complete Level 30'},
  {id:'level_60',     icon:'üéóÔ∏è', name:'Halfway There',      desc:'Complete Level 60'},
  {id:'level_90',     icon:'üèÖ', name:'Three Chapters',      desc:'Complete Level 90'},
  {id:'level_120',    icon:'ü•á', name:'Four Chapters',       desc:'Complete Level 120'},
  {id:'cheat_user',   icon:'üòà', name:'Dirty Cheater',       desc:'Activate any cheat code'},
  {id:'die_10',       icon:'üíÄ', name:'Never Give Up',       desc:'Die 10 times (you got this)'},
  {id:'fresh_start',  icon:'üîÑ', name:'Fresh Start',          desc:'Reset all progress (brave soul)'},
];

let achUnlocked={};
try{achUnlocked=JSON.parse(localStorage.getItem('tupperAch')||'{}');}catch(_){}
function saveAch(){try{localStorage.setItem('tupperAch',JSON.stringify(achUnlocked));}catch(_){}}

let _achToastTO=null;
function unlockAch(id){
  if(achUnlocked[id])return; // already have it
  const def=ACH_DEFS.find(a=>a.id===id);
  if(!def)return;
  achUnlocked[id]=Date.now();
  saveAch();
  // Show toast
  const toast=document.getElementById('ach-toast');
  const icon=document.getElementById('ach-toast-icon');
  const name=document.getElementById('ach-toast-name');
  if(toast&&icon&&name){
    icon.textContent=def.icon;
    name.textContent=def.name;
    toast.classList.add('show');
    if(_achToastTO)clearTimeout(_achToastTO);
    _achToastTO=setTimeout(()=>toast.classList.remove('show'),3200);
  }
}

function buildAchGrid(){
  const grid=document.getElementById('ach-grid');
  const prog=document.getElementById('ach-progress');
  if(!grid)return;
  grid.innerHTML='';
  const total=ACH_DEFS.length;
  const earned=ACH_DEFS.filter(a=>achUnlocked[a.id]).length;
  if(prog)prog.textContent=earned+' / '+total+' UNLOCKED';
  for(const def of ACH_DEFS){
    const unlocked=!!achUnlocked[def.id];
    const card=document.createElement('div');
    card.className='ach-card'+(unlocked?' unlocked':' locked');
    const dateStr=unlocked?new Date(achUnlocked[def.id]).toLocaleDateString():'';
    card.innerHTML=
      '<div class="ach-icon">'+def.icon+'</div>'+
      '<div class="ach-name">'+(unlocked?def.name:'???')+'</div>'+
      '<div class="ach-desc">'+(unlocked?def.desc:'Keep playing to unlock')+'</div>'+
      (unlocked?'<div class="ach-date">'+dateStr+'</div>':'');
    grid.appendChild(card);
  }
}

// Achievement tracking state
let _achKillTimer=0,_achKillCount=0;
let _achBossDmgTaken=false;
let _achWaveDmgTaken=false;
let _achLaserKills=0;
let _achDeaths=0;
let _achShieldBlocked=false;

function achOnKill(){
  unlockAch('first_blood');
  // Speed kill: 20 in 10 seconds
  const now=Date.now();
  if(now-_achKillTimer<10000){
    _achKillCount++;
    if(_achKillCount>=20)unlockAch('speed_kill');
  } else {
    _achKillTimer=now;_achKillCount=1;
  }
}
function achOnLaserKill(){_achLaserKills++;if(_achLaserKills>=10)unlockAch('laser_kill10');}
function achOnHeart(){unlockAch('heart_grab');}
function achOnShieldBlock(){if(!_achShieldBlocked){_achShieldBlocked=true;unlockAch('shield_save');}}
function achOnDamage(){_achBossDmgTaken=true;_achWaveDmgTaken=true;}
function achOnDeath(){
  _achDeaths++;
  if(_achDeaths>=10)unlockAch('die_10');
}
function achOnWaveComplete(){
  if(!_achWaveDmgTaken)unlockAch('no_miss_wave');
  _achWaveDmgTaken=false;
  const waveNum=curWave||1;
  if(waveNum>=5)unlockAch('wave5');
}
function achOnLevelComplete(lvl){
  if(lvl>=10) unlockAch('level_10');
  if(lvl>=30) unlockAch('level_30');
  if(lvl>=60) unlockAch('level_60');
  if(lvl>=90) unlockAch('level_90');
  if(lvl>=120)unlockAch('level_120');
  if(lvl>=31) unlockAch('page2');
  if(lvl>=61) unlockAch('page3');
  if(lvl>=91) unlockAch('page4');
  if(lvl>=121)unlockAch('page5');
}
function achOnBossDefeated(tier){
  _achBossDmgTaken=false; // reset for checking
  // Map tiers to boss achievements
  const tierMap={0:'boss1',1:'boss2',2:'boss3',3:'boss4',4:'boss5',5:'boss6',6:'boss12',17:'boss_final'};
  // Check necroplastic (tier 18)
  if(tier===18)unlockAch('boss18');
  if(tier===29)unlockAch('boss_final');
  const achId=tierMap[tier];
  if(achId)unlockAch(achId);
  if(!_achBossDmgTaken)unlockAch('no_dmg_boss');
}
function achOnScore(s){
  if(s>=10000)  unlockAch('score_10k');
  if(s>=100000) unlockAch('score_100k');
  if(s>=1000000)unlockAch('score_1m');
}
function achOnCheat(){unlockAch('cheat_user');}
function doResetProgress(){
  // Unlock the fresh start achievement FIRST before wiping
  unlockAch('fresh_start');
  const freshAch={fresh_start:achUnlocked['fresh_start']};
  achUnlocked=freshAch;saveAch();
  STATS={...DEFAULT_STATS,killsByType:{...DEFAULT_STATS.killsByType}};
  saveStats();
  maxUnlocked=1;
  try{localStorage.setItem('tupperMaxLvl','1');}catch(_){}
  try{localStorage.setItem('tupperScores','[]');}catch(_){}
  highScores=[];renderSB();
  curLevel=1;
  buildLvlGrid();
  // Hide reset overlay
  document.getElementById('reset-confirm-overlay').style.display='none';
  document.getElementById('reset-step1').style.display='flex';
  document.getElementById('reset-step2').style.display='none';
  // Show a brief confirmation flash
  const toast=document.getElementById('ach-toast');
  const icon=document.getElementById('ach-toast-icon');
  const name=document.getElementById('ach-toast-name');
  if(toast&&icon&&name){
    icon.textContent='üîÑ';name.textContent='Progress Reset!';
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'),2500);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_STATS={
  totalKills:0, totalDeaths:0, totalShots:0, totalDamageDealt:0,
  totalLevelsCompleted:0, totalBossesDefeated:0, totalLaserKills:0,
  totalHeartsCollected:0, highestLevel:1, highestScore:0,
  killsByType:{basic:0,armor:0,speedy:0,tank:0,bomber:0,ghost:0},
  totalPlayTime:0, // seconds
  totalWavesCleared:0, totalShieldsBlocked:0,
};
let STATS={...DEFAULT_STATS,killsByType:{...DEFAULT_STATS.killsByType}};
try{
  const s=JSON.parse(localStorage.getItem('tupperStats')||'{}');
  STATS={...DEFAULT_STATS,...s,killsByType:{...DEFAULT_STATS.killsByType,...(s.killsByType||{})}};
}catch(_){}
let _statsPlayStart=Date.now();
function saveStats(){
  STATS.totalPlayTime+=Math.floor((Date.now()-_statsPlayStart)/1000);
  _statsPlayStart=Date.now();
  try{localStorage.setItem('tupperStats',JSON.stringify(STATS));}catch(_){}
}
function buildStatsGrid(){
  const g=document.getElementById('stats-grid');if(!g)return;
  const kt=STATS.killsByType;
  const rows=[
    ['‚öîÔ∏è','Total Kills',STATS.totalKills.toLocaleString()],
    ['üíÄ','Total Deaths',STATS.totalDeaths.toLocaleString()],
    ['üí•','Total Damage Dealt',STATS.totalDamageDealt.toLocaleString()],
    ['üî´','Total Shots Fired',STATS.totalShots.toLocaleString()],
    ['‚ö°','Laser Kills',STATS.totalLaserKills.toLocaleString()],
    ['üèÜ','Bosses Defeated',STATS.totalBossesDefeated],
    ['üåä','Waves Cleared',STATS.totalWavesCleared],
    ['üéØ','Levels Completed',STATS.totalLevelsCompleted],
    ['üíé','Highest Level',STATS.highestLevel],
    ['üí∞','Highest Score',STATS.highestScore.toLocaleString()],
    ['‚ù§Ô∏è','Hearts Collected',STATS.totalHeartsCollected],
    ['üõ°Ô∏è','Shield Blocks',STATS.totalShieldsBlocked],
    ['üü¢','Basic Kills',kt.basic.toLocaleString()],
    ['‚öôÔ∏è','Armor Kills',kt.armor.toLocaleString()],
    ['üü†','Speedy Kills',kt.speedy.toLocaleString()],
    ['üî¥','Tank Kills',kt.tank.toLocaleString()],
    ['üí£','Bomber Kills',kt.bomber.toLocaleString()],
    ['üëª','Ghost Kills',kt.ghost.toLocaleString()],
    ['‚è±Ô∏è','Total Play Time',Math.floor(STATS.totalPlayTime/60)+'m '+STATS.totalPlayTime%60+'s'],
  ];
  g.innerHTML=rows.map(([icon,label,val])=>
    `<div class="stat-card"><div class="stat-icon">${icon}</div><div class="stat-label">${label}</div><div class="stat-value">${val}</div></div>`
  ).join('');
}

let maxUnlocked=1;
try{maxUnlocked=Math.max(1,parseInt(localStorage.getItem('tupperMaxLvl')||'1'));}catch(_){}
function unlock(lvl){if(lvl>maxUnlocked){maxUnlocked=lvl;try{localStorage.setItem('tupperMaxLvl',String(maxUnlocked));}catch(_){}}}
function applyCheatUnlockAll(){if(CHEATS.unlockAll)maxUnlocked=150;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEVEL CONFIG ‚Äî 90 levels, boss every 5th
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MAX_LEVEL=150;
// Section names for each page of 30 levels
const SECTION_NAMES=[
  'THE PLASTIC WARS',      // levels  1-30
  'VOID SECTOR',           // levels 31-60
  'ANTIMATTER DIMENSION',  // levels 61-90
  'REALM OF THE DEAD',     // levels 91-120
  'THE PRIMORDIAL ABYSS',  // levels 121-150
];
// Individual level flavor names (catchy, 5 for each group of 5 levels before a boss)
const LEVEL_NAMES=[
  // Page 1: levels 1-30
  'Lid Wars','Seal Patrol','Container Chaos','Tupperware Terror','LID KING RISES',
  'Arctic Assault','Ice Storm','Frozen Front','Blizzard Brigade','FROSTLOCK FALLS',
  'Heat Seekers','Steam Brigade','Boiling Point','Burn Patrol','SAUCEPAN SAM STRIKES',
  'Cold Storage','Chill Division','Frost Patrol','Ice Barrage','CRISPER LORD COMMANDS',
  'Thermos Corps','Flask Front','Heat Flask','Burn Unit','THERMOS PRIME ATTACKS',
  'Star Spawn','Nova Guard','Supernova Eve','Final Seal','SUPERNOVA TUPPERWARE',
  // Page 2: levels 31-60
  'Void Scouts','Dark Matter Recon','Shadow Patrol','Abyss Crawlers','VOID LUNCHBOX OPENS',
  'Colander Corps','Hole Division','Drain Squad','Leak Force','COLANDER OF DOOM RISES',
  'Blade Runners','Razor Edge','Spin Cycle','Slice Division','BLENDER KING REIGNS',
  'Pyrex Force','Inferno Rank','Heatproof Guard','Flame Core','PYREX OVERLORD BURNS',
  'Lock Down','Sealed Squad','Omega Guard','Pressurized','TUPPERLOCK OMEGA SEALS',
  'Depth Charge','Abyss Patrol','Filter Force','Drain Guard','ABYSS STRAINER FILTERS',
  // Page 3: levels 61-90
  'Antimatter Scouts','Dark Wave','Matter Rift','Dimension Breach','ANTIMATTER CASSEROLE',
  'Gravity Corps','Warp Division','Crush Patrol','Singularity Guard','GRAVITON FLASK BENDS',
  'Pressure Corps','Steam Core','Explosion Eve','Critical Mass','OMEGA PRESSURE COOKER',
  'Event Horizon','Collapse Zone','Singularity Eve','Zero Point','THE SINGULARITY POT',
  'Dark Patrol','Void Matter','Shadow Corps','Obsidian Guard','DARK MATTER DECANTER',
  'Eternal Scout','Forever Front','Timeless Guard','Undying Corps','THE ETERNAL TUPPERWARE',
  // Page 4: levels 91-120
  'Necro Scouts','Dead Parade','Undead Corps','Bone Brigade','THE NECROPLASTIC RISES',
  'Century Guard','Milestone Division','Legacy Corps','Veteran Squad','CENTENNIAL CANISTER',
  'Plasma Scouts','Ion Division','Charge Corps','Bolt Brigade','THE PLASMA PITCHER',
  'Depth Divers','Abyssal Guard','Deep Patrol','Trench Corps','ABYSSAL LUNCH PAIL',
  'Fractal Guard','Pattern Corps','Infinite Scout','Repeat Division','THE FRACTAL FLASK',
  'Final Meal Corps','Last Supper Guard','Oblivion Eve','Oblivion Patrol','OBLIVION BENTO',
  // Page 5: levels 121-150
  'Dread Division','Terror Corps','Fear Patrol','Horror Guard','THE DREAD DECANTER',
  'Cosmic Corps','Star Patrol','Universe Guard','Galaxy Division','COSMIC CRISPER',
  'Void Cage Division','Dimensional Trap','Infinite Prison','Void Warden','VOID CASSEROLE',
  'Entropy Scouts','Decay Division','Collapse Corp','Ruin Guard','ENTROPY ENGINE',
  'Omega Division','Final Holes','All Vents','Last Barrage','THE OMEGA COLANDER',
  'Ancient Scout','Primeval Division','Before Time Guard','Genesis Corps','THE PRIMORDIAL TUPPERWARE',
];
function getLevelName(lvl){return LEVEL_NAMES[Math.min(lvl-1,LEVEL_NAMES.length-1)]||'LEVEL '+lvl;}
function getSectionName(lvl){return SECTION_NAMES[Math.floor((lvl-1)/30)]||'BEYOND';}
function lcfg(lvl){
  const boss=(lvl%5===0);
  const rows=Math.min(2+Math.floor((lvl-1)/4),6);
  const cols=Math.min(6+Math.floor((lvl-1)/5),12);
  const eHp=Math.max(1,Math.floor(1+(lvl-1)/5));
  const bHp=Math.floor(35+lvl*12);
  const waves=Math.min(3+Math.floor((lvl-1)/3),10);
  const eMov=0.35+lvl*.04;
  const eFire=Math.min(0.28,0.06+lvl*.005);
  const bLaser=lvl>=8;
  const types=Math.min(1+Math.floor(lvl/5),6);
  return{boss,rows,cols,eHp,bHp,waves,eMov,eFire,bLaser,types};
}

// Difficulty multipliers
const DIFFS={
  easy  :{eMov:.75,eFire:.6,bHp:.7,pSpd:1.15,lcdMult:.8},
  medium:{eMov:1,  eFire:1,  bHp:1,  pSpd:1,   lcdMult:1},
  hard  :{eMov:1.4,eFire:1.6,bHp:1.5,pSpd:.9,  lcdMult:1.3},
};
let diff='easy';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ENEMY TYPE DEFS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Each type has unique visual shape (drawn procedurally) + stats modifier
const ETYPES=[
  // 0: BASIC ‚Äî standard tupperware box
  {name:'BASIC',  col:'#06d6a0',drk:'#037a58',lit:'#88ffdd',w:52,h:40,hpMult:1,   fireMult:1,  spdMult:1  },
  // 1: ARMORED ‚Äî grey plated fortress
  {name:'ARMOR',  col:'#9999bb',drk:'#444466',lit:'#ccccee',w:54,h:46,hpMult:2,   fireMult:.7, spdMult:.75},
  // 2: SPEEDY ‚Äî slim orange racer
  {name:'SPEEDY', col:'#ff9f1c',drk:'#995500',lit:'#ffcc66',w:44,h:36,hpMult:.75, fireMult:1.2,spdMult:1.7},
  // 3: TANK ‚Äî massive red death tub
  {name:'TANK',   col:'#ef476f',drk:'#880030',lit:'#ff88aa',w:60,h:50,hpMult:3,   fireMult:.6, spdMult:.55},
  // 4: BOMBER ‚Äî purple grenade, shoots spread
  {name:'BOMBER', col:'#a78bfa',drk:'#5b3aaa',lit:'#ccaaff',w:52,h:44,hpMult:1.2, fireMult:1.4,spdMult:.9 },
  // 5: GHOST ‚Äî translucent teal, hard to see
  {name:'GHOST',  col:'#55ffee',drk:'#004433',lit:'#aaffee',w:48,h:38,hpMult:.8,  fireMult:1.5,spdMult:1.3},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let score=0,levelStartScore=0,lives=3,shields=0,curWave=1,curLevel=1,waveTarget=1,running=false,paused=false,animId;
let player=null,bullets=[],eBullets=[],enemies=[],particles=[],shootCD=0,eDir=1,eMoveT=0;
const LF=180,LCD_BASE=600;
let _laserCDMax=LCD_BASE;
let lOn=false,lFrames=0,lCD=0,lDmgT=0;
let boss=null,bossUp=false,bossOut=false,bLaserOn=false,bLaserX=0,bLaserT=0,bLaserCD=0;
let heartDrops=[]; // {x,y,vy,r} collectible hearts
let floatTexts=[]; // {x,y,vy,al,txt,col} floating score numbers
let bossCountdownTO=null;
let waveTransition=false; // guard: stops wave-complete firing every frame
let waveTO=null; // tracks wave transition timeout so it can be cancelled
let bossSpecialT=0,bossSpecialCD=0;
// Bubble shield state
const BUBBLE_DUR=180,BUBBLE_CD_MAX=600; // 3s active, 10s cooldown at 60fps
let bubbleOn=false,bubbleFrames=0,bubbleCD=0;
// Boss phase 2
let bossPhase=1,cutscenePlaying=false;
let _lastTime=0; // for delta-time
// ‚îÄ‚îÄ CHEAT STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let cheatUnlocked=false; // has code 5529 been entered
const CHEATS={unlockAll:false,infHealth:false,infPower:false,megaDmg:false};
function anyCheatsOn(){return CHEATS.unlockAll||CHEATS.infHealth||CHEATS.infPower||CHEATS.megaDmg;}
// ‚îÄ‚îÄ AUDIO SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioMuted=false;
let audioVol=0.30;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const K={},TK={left:false,right:false,up:false,down:false,fire:false,laser:false,shield:false,pause:false};
document.addEventListener('keydown',e=>{
  K[e.code]=true;
  if(e.code==='KeyP'||e.code==='Escape'){e.preventDefault();doPause();return;}
  if(!running||paused)return;
  if(e.code==='Space'){e.preventDefault();doShoot();}
  if(e.code==='ArrowUp'||e.code==='KeyW'){e.preventDefault();K.up=true;}
  if(e.code==='ArrowDown'||e.code==='KeyS'){e.preventDefault();K.down=true;}
  if(e.code==='KeyX'||e.code==='KeyQ'){e.preventDefault();doLaser();}
  if(e.code==='KeyE'){e.preventDefault();if(running&&!paused)doBubble();}
});
document.addEventListener('keyup',e=>{K[e.code]=false;if(e.code==='ArrowUp'||e.code==='KeyW')K.up=false;if(e.code==='ArrowDown'||e.code==='KeyS')K.down=false;});
const BP={};
function mkBtn(id,prop,cb){
  const el=document.getElementById(id);if(!el)return;
  const dn=pid=>{BP[pid]=prop;TK[prop]=true;el.classList.add('tapped');if(cb)cb();};
  const up=pid=>{if(BP[pid]===prop){delete BP[pid];if(!Object.values(BP).includes(prop)){TK[prop]=false;el.classList.remove('tapped');}}};
  el.addEventListener('pointerdown',ev=>{ev.preventDefault();el.setPointerCapture(ev.pointerId);dn(ev.pointerId);},{passive:false});
  el.addEventListener('pointerup',ev=>{ev.preventDefault();up(ev.pointerId);},{passive:false});
  el.addEventListener('pointercancel',ev=>{ev.preventDefault();up(ev.pointerId);},{passive:false});
  el.addEventListener('pointerleave',ev=>{if(!el.hasPointerCapture(ev.pointerId))up(ev.pointerId);});
}
// Canvas buttons are wired via wireCanvasBtn() in the setTimeout below

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAUSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doPause(){
  if(!running)return;paused=!paused;
  document.getElementById('pause-ov').classList.toggle('show',paused);
  if(paused)cancelAnimationFrame(animId);else animId=requestAnimationFrame(loop);
}
document.getElementById('resume-btn').addEventListener('click',()=>{if(paused)doPause();});
document.getElementById('quit-btn').addEventListener('click',()=>{
  paused=false;running=false;cancelAnimationFrame(animId);stopBGM();bLaserOn=false;
  document.getElementById('pause-ov').classList.remove('show');
  document.getElementById('controls').style.display='none';
  document.getElementById('hud-bar').style.display='none';
  document.getElementById('main-menu').classList.remove('hidden');
  resizeCanvas();
  setTimeout(startMMMusic,300);
});
// cb-pause is wired via wireCanvasBtn below
document.getElementById('pause-btn').addEventListener('click',()=>{if(running)doPause();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DIFFICULTY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.dbtn').forEach(b=>{
  b.addEventListener('click',()=>{
    diff=b.dataset.d;
    document.querySelectorAll('.dbtn').forEach(x=>x.classList.toggle('sel',x.dataset.d===diff));
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEVELS GRID ‚Äî 3 pages √ó 30 levels
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lvlPage=0; // 0=1-30 ‚Ä¶ 4=121-150
function buildLvlGrid(){
  applyCheatUnlockAll();
  const g=document.getElementById('lvl-grid');g.innerHTML='';
  const start=lvlPage*30+1;
  const end=start+29;
  for(let i=start;i<=end;i++){
    const isBoss=(i%5===0);
    const cell=document.createElement('div');
    let cls='lc'+(isBoss?' boss':'')+(i===curLevel?' cur':i<=maxUnlocked?' open':'');
    cell.className=cls;
    // Page label: show tier for boss levels
    const bossNum=isBoss?Math.ceil(i/5):0;
    cell.textContent=(isBoss?'‚òÖ':'')+'L'+i;
    if(i<=maxUnlocked){
      cell.addEventListener('click',()=>{
        document.getElementById('levels-modal').classList.remove('show');
        beginLevel(i);
      });
    }
    g.appendChild(cell);
  }
  // Update page indicator
  const pi=document.getElementById('lvl-page-indicator');
  if(pi)pi.textContent='PAGE '+(lvlPage+1)+'/5  ¬∑  LEVELS '+(lvlPage*30+1)+'-'+(lvlPage*30+30);
  const pb=document.getElementById('lvl-page-prev');
  const pf=document.getElementById('lvl-page-next');
  if(pb)pb.disabled=lvlPage===0;
  if(pf)pf.disabled=lvlPage===4;
}
document.getElementById('levels-btn').addEventListener('click',()=>{buildLvlGrid();document.getElementById('levels-modal').classList.add('show');});
// Auto-jump to the page containing curLevel
function openLevelSelectAtCurrent(){
  lvlPage=Math.floor((curLevel-1)/30);
  buildLvlGrid();
  document.getElementById('levels-modal').classList.add('show');
}
// Pagination wiring (buttons added in HTML)
document.addEventListener('click',e=>{
  if(e.target.id==='lvl-page-prev'&&lvlPage>0){lvlPage--;buildLvlGrid();}
  if(e.target.id==='lvl-page-next'&&lvlPage<4){lvlPage++;buildLvlGrid();}
});
document.getElementById('lvl-close').addEventListener('click',()=>{sfxMenuBack();
  document.getElementById('levels-modal').classList.remove('show');
  // If game isn't running and main menu is hidden, show main menu
  if(!running && document.getElementById('main-menu').classList.contains('hidden')){
    document.getElementById('main-menu').classList.remove('hidden');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BEGIN LEVEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function beginLevel(lvl){
  ga();stopMMMusic();
  // Clear any pending timers from previous game
  if(bossCountdownTO){clearTimeout(bossCountdownTO);bossCountdownTO=null;}
  if(waveTO){clearTimeout(waveTO);waveTO=null;}
  document.getElementById('lvlcomplete-modal').classList.remove('show');
  curLevel=lvl;
  const cfg=lcfg(lvl);
  const dm=DIFFS[diff];
  // score persists across game overs
  levelStartScore=score; // remember score when level begins
  lives=5;shields=0;curWave=1;waveTarget=cfg.waves;
  paused=false;bLaserOn=false;bLaserCD=0;bLaserT=0;
  updateHUD();

  player={x:GW/2-32,y:GH-90,w:64,h:55,spd:7*dm.pSpd};
  bullets=[];eBullets=[];enemies=[];particles=[];heartDrops=[];floatTexts=[];
  shootCD=0;eDir=1;eMoveT=0;
  lOn=false;lFrames=0;lCD=0;lDmgT=0;_laserCDMax=LCD_BASE;
  bubbleOn=false;bubbleFrames=0;bubbleCD=0;
  bossPhase=1;cutscenePlaying=false;
  boss=null;bossUp=false;bossOut=false;
  waveTransition=false;
  _lastTime=0; // reset dt timer on new level

  document.getElementById('controls').style.display='flex';
  document.getElementById('hint').style.display='none';
  document.getElementById('hud-bar').style.display='flex';
  document.getElementById('main-menu').classList.add('hidden');
  hideMsg();

  // Show level intro countdown
  showLevelIntro(lvl, ()=>{
    spawnWave();
    running=true;cancelAnimationFrame(animId);
    requestAnimationFrame(()=>requestAnimationFrame(resizeCanvas));
    animId=requestAnimationFrame(loop);
    startBGM();
  });
}

function showLevelIntro(lvl, onDone){
  const el=document.getElementById('level-intro');
  const bg=document.getElementById('level-intro-bg');
  const secEl=document.getElementById('li-section');
  const lvlEl=document.getElementById('li-level');
  const nameEl=document.getElementById('li-name');
  const cdEl=document.getElementById('li-countdown');
  if(!el){onDone();return;}

  // Set text
  secEl.textContent='‚Äî '+getSectionName(lvl)+' ‚Äî';
  lvlEl.textContent='LEVEL '+lvl;
  nameEl.textContent=getLevelName(lvl);

  // Show overlay
  el.classList.add('show');
  bg.style.opacity='0.92';

  // Animate in
  setTimeout(()=>{
    secEl.style.opacity='1';secEl.style.transform='translateY(0)';
  },50);
  setTimeout(()=>{
    lvlEl.style.opacity='1';lvlEl.style.transform='scale(1)';
  },180);
  setTimeout(()=>{nameEl.style.opacity='1';},350);

  // Countdown 3-2-1
  let cd=3;
  cdEl.textContent=cd;
  setTimeout(()=>cdEl.style.opacity='1',500);

  function tick(){
    cd--;
    if(cd>0){
      cdEl.style.opacity='0';
      setTimeout(()=>{cdEl.textContent=cd;cdEl.style.opacity='1';},150);
      setTimeout(tick,1000);
    } else {
      cdEl.style.opacity='0';
      // Quick flash white then out
      setTimeout(()=>{
        cdEl.textContent='GO!';cdEl.style.opacity='1';
        cdEl.style.color='#00ff88';cdEl.style.textShadow='0 0 30px #00ff88';
      },150);
      setTimeout(()=>{
        // Fade out overlay
        bg.style.transition='opacity .3s';bg.style.opacity='0';
        secEl.style.opacity='0';lvlEl.style.opacity='0';nameEl.style.opacity='0';cdEl.style.opacity='0';
        setTimeout(()=>{
          el.classList.remove('show');
          cdEl.style.color='';cdEl.style.textShadow='';
          secEl.style.transform='translateY(-12px)';lvlEl.style.transform='scale(.8)';
          bg.style.transition='';
          onDone();
        },350);
      },700);
    }
  }
  setTimeout(tick,1500);
}

function updateHUD(){
  // Update HUD bar (visible during gameplay)
  const sv=document.getElementById('hud-score-val');if(sv)sv.textContent=score;
  const lv=document.getElementById('hud-level-val');if(lv)lv.textContent=curLevel+'/30';
  const wv=document.getElementById('hud-wave-val');if(wv)wv.textContent=(bossUp?'BOSS':(curWave+'/'+waveTarget));
  // Lives hearts
  const livesEl=document.getElementById('hud-lives');
  if(livesEl){
    livesEl.innerHTML='';
    for(let li=0;li<5;li++){
      const hs=document.createElement('span');
      hs.className='hrt'+(li<lives?' alive':' dead');
      livesEl.appendChild(hs);
    }
  }
  // Bubble shield
  const shEl=document.getElementById('hud-shield-val');
  if(shEl){
    if(bubbleOn){shEl.textContent='ACTIVE';shEl.style.color='#00ffff';}
    else if(bubbleCD>0){shEl.textContent=Math.ceil(bubbleCD/60)+'s';shEl.style.color='#888';}
    else{shEl.textContent='READY';shEl.style.color='#00aaff';}
  }
  // Laser status
  const laserVal=document.getElementById('hud-laser-val');
  const laserBar=document.getElementById('hud-lbar');
  if(laserVal){
    if(lOn){laserVal.textContent='FIRING';laserVal.style.color='#00ffcc';if(laserBar)laserBar.style.width=(lFrames/LF*100)+'%';}
    else if(lCD>0){laserVal.textContent=Math.ceil(lCD/60)+'s';laserVal.style.color='#555';if(laserBar)laserBar.style.width=((1-lCD/_laserCDMax)*100)+'%';}
    else{laserVal.textContent='READY';laserVal.style.color='#06d6a0';if(laserBar)laserBar.style.width='100%';}
  }
  // Also update hidden sidebar elements (laser-box for updateLaserUI compatibility)
  document.getElementById('el-score').textContent=score;
  document.getElementById('el-level').textContent=curLevel+'/30';
  document.getElementById('el-wave').textContent=(bossUp?'BOSS':(curWave+'/'+waveTarget));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPAWN WAVE / BOSS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnWave(){
  if(bossCountdownTO||bossUp||bossOut)return;
  waveTransition=false;
  bossUp=false;bossOut=false;boss=null;enemies=[];eBullets=[];heartDrops=[];floatTexts=[];
  const cfg=lcfg(curLevel);const dm=DIFFS[diff];
  const{rows,cols,eHp,eMov,eFire,types}=cfg;
  const xGap=Math.floor((GW-80)/cols),yGap=54;

  // Determine boss theme for pre-boss levels (levels N-4..N-1 before boss at N)
  // nextBossLevel = next multiple of 5 >= curLevel
  const nextBoss=curLevel%5===0?curLevel:curLevel+5-(curLevel%5);
  const bTier=Math.min(Math.ceil(nextBoss/5)-1,BOSS_DEFS.length-1);
  const bd=BOSS_DEFS[bTier];
  // Only theme if within 4 levels of a boss
  const preBoss=(curLevel%5!==0)&&(nextBoss-curLevel<=4)&&bd.themeCol;

  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const ti=Math.min((r*2+Math.floor(c/3))%types, ETYPES.length-1);
      const et=ETYPES[ti];
      const hp=Math.max(1,Math.round(eHp*et.hpMult));

      // Apply boss theme tinting: blend base color toward boss theme
      // Row 0 = fully themed, deeper rows = less themed (variety)
      let col=et.col,drk=et.drk,lit=et.lit;
      if(preBoss){
        // Each row gets its own shade of the boss palette for visual variety
        const shades=[bd.themeCol,bd.themeDrk,bd.themeLit,bd.themeCol,bd.themeDrk,bd.themeLit];
        const drkShades=[bd.themeDrk,bd.themeCol,bd.themeDrk,bd.themeDrk,bd.themeCol,bd.themeDrk];
        const litShades=[bd.themeLit,bd.themeLit,bd.themeCol,bd.themeLit,bd.themeLit,bd.themeCol];
        col=shades[r%shades.length];
        drk=drkShades[r%drkShades.length];
        lit=litShades[r%litShades.length];
      }

      // Compute non-overlapping position using grid layout + jitter
      let ex=40+c*xGap, ey=50+r*yGap;
      // Ensure no overlap with existing enemies
      let tries=0;
      while(tries<8){
        let ok=true;
        for(const oe of enemies){
          if(Math.abs(ex-oe.x)<et.w+2&&Math.abs(ey-oe.y)<et.h+2){ok=false;ex=40+c*xGap+(Math.random()*6-3);break;}
        }
        if(ok)break;tries++;
      }
      enemies.push({
        x:ex, y:ey,
        w:et.w, h:et.h,
        col, drk, lit,
        ti, hp, maxHp:hp,
        sT:Math.floor(50+Math.random()*100),
        sMul:et.spdMult, fMul:et.fireMult,
      });
    }
  }
}

// Boss definitions per tier (levels 5,10,15,20,25,30)
const BOSS_DEFS=[
  {name:'THE LID KING',  emoji:'[K]', color:'#cc6600', titleColor:'#ff9900',
   desc:'Ruler of all containers',
   special:'lid_slam', specialName:'LID SLAM', specialCD:280, themeCol:'#ff8800',themeDrk:'#884400',themeLit:'#ffcc44'},
  {name:'FROSTLOCK',     emoji:'[F]', color:'#0088cc', titleColor:'#88ddff',
   desc:'Frozen in hatred',
   special:'ice_ring',  specialName:'ICE RING',  specialCD:240, themeCol:'#44ddff',themeDrk:'#005577',themeLit:'#aaffff'},
  {name:'SAUCEPAN SAM',  emoji:'[S]', color:'#884400', titleColor:'#ffaa44',
   desc:'Boiling with rage',
   special:'heat_wave', specialName:'HEAT WAVE', specialCD:200, themeCol:'#ff5500',themeDrk:'#662200',themeLit:'#ffaa44'},
  {name:'CRISPER LORD',  emoji:'[C]', color:'#004488', titleColor:'#4499ff',
   desc:'Master of the vegetable drawer',
   special:'laser',     specialName:'TWIN BEAM', specialCD:160, themeCol:'#4499ff',themeDrk:'#002266',themeLit:'#aaccff'},
  {name:'THERMOS PRIME', emoji:'[T]', color:'#880000', titleColor:'#ff4444',
   desc:'Forged in the microwave',
   special:'barrage',   specialName:'BARRAGE',   specialCD:140, themeCol:'#ff2244',themeDrk:'#660011',themeLit:'#ff88aa'},
  {name:'SUPERNOVA TUPPERWARE', emoji:'[‚òÖ]', color:'#0a0015', titleColor:'#ff00ff',
   glowColor:'#aa00ff', textColor:'#ffffff', sparkColor:'#ff88ff',
   desc:'Born from a dying star. Cannot be contained.',
   special:'all', specialName:'ANNIHILATION', specialCD:100, themeCol:'#cc00ff',themeDrk:'#440077',themeLit:'#ff88ff'},

  // ‚îÄ‚îÄ TIER 6 ‚Äî Level 35 ‚îÄ‚îÄ
  {name:'VOID LUNCHBOX',    emoji:'[V]', color:'#050010', titleColor:'#8800ff',
   glowColor:'#6600cc', desc:'It devours light itself.',
   special:'void_pull',  specialName:'VOID PULL',    specialCD:180, themeCol:'#8800ff',themeDrk:'#330066',themeLit:'#cc88ff'},
  // ‚îÄ‚îÄ TIER 7 ‚Äî Level 40 ‚îÄ‚îÄ
  {name:'COLANDER OF DOOM', emoji:'[D]', color:'#1a0000', titleColor:'#ff2200',
   glowColor:'#cc1100', desc:'Every hole fires.',
   special:'hole_burst', specialName:'HOLE BURST',   specialCD:160, themeCol:'#ff2200',themeDrk:'#770000',themeLit:'#ff8866'},
  // ‚îÄ‚îÄ TIER 8 ‚Äî Level 45 ‚îÄ‚îÄ
  {name:'THE BLENDER KING', emoji:'[B]', color:'#001520', titleColor:'#00ddff',
   glowColor:'#0088cc', desc:'It will liquefy your soul.',
   special:'blade_spin',  specialName:'BLADE SPIN',   specialCD:150, themeCol:'#00ddff',themeDrk:'#004466',themeLit:'#88eeff'},
  // ‚îÄ‚îÄ TIER 9 ‚Äî Level 50 ‚îÄ‚îÄ
  {name:'PYREX OVERLORD',   emoji:'[P]', color:'#100000', titleColor:'#ff6600',
   glowColor:'#ff3300', desc:'Survived every oven. Every time.',
   special:'heat_cage',  specialName:'HEAT CAGE',    specialCD:140, themeCol:'#ff6600',themeDrk:'#662200',themeLit:'#ffaa55'},
  // ‚îÄ‚îÄ TIER 10 ‚Äî Level 55 ‚îÄ‚îÄ
  {name:'TUPPERLOCK OMEGA', emoji:'[Œ©]', color:'#000a00', titleColor:'#00ff44',
   glowColor:'#00cc33', desc:'Sealed beyond all reason.',
   special:'seal_burst', specialName:'SEAL BURST',   specialCD:130, themeCol:'#00ff44',themeDrk:'#004422',themeLit:'#88ffaa'},
  // ‚îÄ‚îÄ TIER 11 ‚Äî Level 60 ‚îÄ‚îÄ
  {name:'THE ABYSS STRAINER',emoji:'[A]', color:'#000018', titleColor:'#4444ff',
   glowColor:'#2222cc', desc:'It filters out hope.',
   special:'abyss_rain', specialName:'ABYSS RAIN',   specialCD:120, themeCol:'#4444ff',themeDrk:'#111155',themeLit:'#8888ff'},

  // ‚îÄ‚îÄ TIER 12 ‚Äî Level 65 ‚îÄ‚îÄ
  {name:'ANTIMATTER CASSEROLE',emoji:'[X]', color:'#0a000a', titleColor:'#ff00aa',
   glowColor:'#cc0088', desc:'It exists between dimensions.',
   special:'matter_wave',specialName:'MATTER WAVE',  specialCD:115, themeCol:'#ff00aa',themeDrk:'#550044',themeLit:'#ff88dd'},
  // ‚îÄ‚îÄ TIER 13 ‚Äî Level 70 ‚îÄ‚îÄ
  {name:'GRAVITON FLASK',   emoji:'[G]', color:'#00000a', titleColor:'#aaffff',
   glowColor:'#55eeee', desc:'Bends space around itself.',
   special:'grav_crush', specialName:'GRAV CRUSH',   specialCD:110, themeCol:'#aaffff',themeDrk:'#004455',themeLit:'#ddffff'},
  // ‚îÄ‚îÄ TIER 14 ‚Äî Level 75 ‚îÄ‚îÄ
  {name:'OMEGA PRESSURE COOKER',emoji:'[O]',color:'#100005',titleColor:'#ff5500',
   glowColor:'#dd3300', desc:'Built up pressure for 1000 years.',
   special:'pressure_burst',specialName:'PRESSURE BURST',specialCD:105, themeCol:'#ff5500',themeDrk:'#551100',themeLit:'#ffaa55'},
  // ‚îÄ‚îÄ TIER 15 ‚Äî Level 80 ‚îÄ‚îÄ
  {name:'THE SINGULARITY POT',emoji:'[S2]',color:'#000008',titleColor:'#ffffff',
   glowColor:'#aaaaff', desc:'All matter ends here.',
   special:'singularity',specialName:'SINGULARITY',  specialCD:100, themeCol:'#ffffff',themeDrk:'#333366',themeLit:'#ccccff'},
  // ‚îÄ‚îÄ TIER 16 ‚Äî Level 85 ‚îÄ‚îÄ
  {name:'DARK MATTER DECANTER',emoji:'[DM]',color:'#030003',titleColor:'#ff44ff',
   glowColor:'#cc00cc', desc:'Contains the end of everything.',
   special:'dark_storm', specialName:'DARK STORM',   specialCD:95,  themeCol:'#ff44ff',themeDrk:'#550055',themeLit:'#ffaaff'},
  // ‚îÄ‚îÄ TIER 17 ‚Äî Level 90 ‚îÄ‚îÄ
  {name:'THE ETERNAL TUPPERWARE',emoji:'[‚àû]',color:'#000000',titleColor:'#ffff00',
   glowColor:'#ffaa00', textColor:'#ffffff', sparkColor:'#ffff88',
   desc:'It was here before the universe. It will be here after.',
   special:'eternal',    specialName:'ETERNAL WRATH', specialCD:85,  themeCol:'#ffff00',themeDrk:'#555500',themeLit:'#ffff88'},

  // ‚ïê‚ïê PAGE 4: LEVELS 91-120 ‚ïê‚ïê  (tiers 18-23)

  // TIER 18 ‚Äî Level 95
  {name:'THE NECROPLASTIC',    emoji:'[N]',  color:'#050000', titleColor:'#ff0000',
   glowColor:'#cc0000', desc:'Dead and unbreakable.',
   special:'necro_grid',   specialName:'NECRO GRID',      specialCD:80,  themeCol:'#ff0000',themeDrk:'#550000',themeLit:'#ff6666'},
  // TIER 19 ‚Äî Level 100
  {name:'CENTENNIAL CANISTER', emoji:'[C2]', color:'#000000', titleColor:'#ffaa00',
   glowColor:'#ff8800', desc:'100 years of hatred. Freshness sealed in.',
   special:'century_rage', specialName:'CENTURY RAGE',    specialCD:78,  themeCol:'#ffaa00',themeDrk:'#553300',themeLit:'#ffdd88'},
  // TIER 20 ‚Äî Level 105
  {name:'THE PLASMA PITCHER',  emoji:'[PP]', color:'#00000a', titleColor:'#ff66ff',
   glowColor:'#dd00dd', desc:'Contains only pure destruction.',
   special:'plasma_burst', specialName:'PLASMA BURST',    specialCD:75,  themeCol:'#ff66ff',themeDrk:'#550055',themeLit:'#ffbbff'},
  // TIER 21 ‚Äî Level 110
  {name:'ABYSSAL LUNCH PAIL',  emoji:'[AL]', color:'#000008', titleColor:'#00ffff',
   glowColor:'#00cccc', desc:'Depths unknown. Contents lethal.',
   special:'abyssal_wave', specialName:'ABYSSAL WAVE',    specialCD:72,  themeCol:'#00ffff',themeDrk:'#004444',themeLit:'#88ffff'},
  // TIER 22 ‚Äî Level 115
  {name:'THE FRACTAL FLASK',   emoji:'[FF]', color:'#080008', titleColor:'#88ff88',
   glowColor:'#44cc44', desc:'Every pattern repeats. Every shot is final.',
   special:'fractal_ring', specialName:'FRACTAL RING',    specialCD:70,  themeCol:'#88ff88',themeDrk:'#224422',themeLit:'#ccffcc'},
  // TIER 23 ‚Äî Level 120
  {name:'OBLIVION BENTO',      emoji:'[OB]', color:'#020002', titleColor:'#ff8800',
   glowColor:'#cc6600', textColor:'#ffffff', sparkColor:'#ffbb44',
   desc:'The last meal. Ever.',
   special:'oblivion',     specialName:'OBLIVION BLAST',  specialCD:65,  themeCol:'#ff8800',themeDrk:'#442200',themeLit:'#ffcc66'},

  // ‚ïê‚ïê PAGE 5: LEVELS 121-150 ‚ïê‚ïê  (tiers 24-29)

  // TIER 24 ‚Äî Level 125
  {name:'THE DREAD DECANTER',  emoji:'[DD]', color:'#040000', titleColor:'#ff3333',
   glowColor:'#bb0000', desc:'Poured from the edge of reality.',
   special:'dread_rain',   specialName:'DREAD RAIN',      specialCD:62,  themeCol:'#ff3333',themeDrk:'#551111',themeLit:'#ff9999'},
  // TIER 25 ‚Äî Level 130
  {name:'COSMIC CRISPER',      emoji:'[CC]', color:'#000404', titleColor:'#44ffdd',
   glowColor:'#00ccaa', desc:'Keeps the cosmos fresh. Keeps you dead.',
   special:'cosmic_cross', specialName:'COSMIC CROSS',    specialCD:60,  themeCol:'#44ffdd',themeDrk:'#004433',themeLit:'#aaffee'},
  // TIER 26 ‚Äî Level 135
  {name:'THE VOID CASSEROLE',  emoji:'[VC]', color:'#030006', titleColor:'#aa88ff',
   glowColor:'#7744cc', desc:'Baked at absolute zero.',
   special:'void_cage',    specialName:'VOID CAGE',       specialCD:58,  themeCol:'#aa88ff',themeDrk:'#331155',themeLit:'#ddccff'},
  // TIER 27 ‚Äî Level 140
  {name:'ENTROPY ENGINE',      emoji:'[EE]', color:'#060000', titleColor:'#ff6644',
   glowColor:'#cc3300', desc:'Everything decays. You first.',
   special:'entropy_storm',specialName:'ENTROPY STORM',   specialCD:55,  themeCol:'#ff6644',themeDrk:'#441100',themeLit:'#ffaa88'},
  // TIER 28 ‚Äî Level 145
  {name:'THE OMEGA COLANDER',  emoji:'[OC]', color:'#000000', titleColor:'#ffffff',
   glowColor:'#cccccc', desc:'Every hole in existence fires at once.',
   special:'omega_holes',  specialName:'OMEGA HOLES',     specialCD:52,  themeCol:'#ffffff',themeDrk:'#222244',themeLit:'#ddddff'},
  // TIER 29 ‚Äî Level 150  *** THE TRUE FINAL BOSS ***
  {name:'THE PRIMORDIAL TUPPERWARE', emoji:'[‚àû‚àû]', color:'#000000', titleColor:'#ff0000',
   glowColor:'#ff0000', textColor:'#ffffff', sparkColor:'#ff8888',
   desc:'Before the Big Bang, there was this. There is no after.',
   special:'primordial',   specialName:'PRIMORDIAL FURY', specialCD:45,  themeCol:'#ff0000',themeDrk:'#330000',themeLit:'#ff4444'},
];

function getTierIdx(){return Math.min(Math.ceil(curLevel/5)-1,29);}

function spawnBoss(){
  // Guard: don't spawn if already spawned
  if(bossUp||boss)return;
  bossUp=true;bossOut=false;boss=null;enemies=[];eBullets=[];
  const cfg=lcfg(curLevel);const dm=DIFFS[diff];
  const hp=Math.floor(cfg.bHp*dm.bHp);
  const tier=getTierIdx();const bd=BOSS_DEFS[tier];
  boss={x:GW/2-95,y:18,w:190,h:130,hp,mHp:hp,sT:60,mDir:1,shk:0,tier,bd};bd.tier=tier;
  bLaserOn=false;bLaserCD=Math.max(80,200-curLevel*6);bLaserT=0;bLaserX=boss.x+boss.w/2;
  bossSpecialT=0;bossSpecialCD=Math.floor(bd.specialCD*(diff==='easy'?1.4:diff==='hard'?0.75:1));
  stopBGM();sfxBossAlarm();setTimeout(startBossBGM,750);
  // Styled boss announcement
  const msgEl=document.getElementById('overlay-msg');
  if(msgEl){
    const tc=bd.titleColor||'#ff4444';
    const gc=bd.glowColor||tc;
    msgEl.style.color=tc;
    msgEl.style.textShadow=`3px 3px 0 #000, 0 0 28px ${gc}, 0 0 56px ${gc}66`;
    msgEl.style.borderColor=gc;
    msgEl.style.background=(bd.tier>=5)?'rgba(10,0,21,0.92)':'rgba(0,0,0,0.75)';
    if(bd.tier===5){
      // SUPERNOVA TUPPERWARE ‚Äî extra dramatic
      msgEl.style.fontSize='clamp(0.9rem,3.5vw,1.8rem)';
      msgEl.style.letterSpacing='4px';
    } else {
      msgEl.style.fontSize='';msgEl.style.letterSpacing='';
    }
  }
  showMsg('>> '+bd.name+' <<\n"'+bd.desc+'"',2400);
  setTimeout(()=>{if(msgEl){msgEl.style.color='';msgEl.style.textShadow='';msgEl.style.borderColor='';msgEl.style.background='';msgEl.style.fontSize='';msgEl.style.letterSpacing='';}},2500);
}

function triggerBossCountdown(){
  // Called after last enemy wave clears on a boss level
  if(bossCountdownTO)return;
  let secs=5;
  showMsg('!! BOSS INCOMING !!\n'+secs+'...',99999);
  sfxWaveDone();
  function tick(){
    secs--;
    if(secs>0){showMsg('!! BOSS INCOMING !!\n'+secs+'...',99999);bossCountdownTO=setTimeout(tick,1000);}
    else{bossCountdownTO=null;hideMsg();spawnBoss();}
  }
  bossCountdownTO=setTimeout(tick,1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHOOTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doShoot(){if(shootCD>0)return;bullets.push({x:player.x+player.w/2,y:player.y,vy:-16});shootCD=11;STATS.totalShots++;sfxShoot();}
function doLaser(){
  const dm=DIFFS[diff];
  if(lOn)return;
  if(!CHEATS.infPower&&lCD>0)return; // skip CD check if cheat on
  lOn=true;lFrames=LF;_laserCDMax=Math.floor(LCD_BASE*dm.lcdMult);lDmgT=0;sfxLaserStart();
}
function doBubble(){
  if(bubbleOn)return;
  if(!CHEATS.infPower&&bubbleCD>0)return; // skip CD if cheat on
  bubbleOn=true;bubbleFrames=BUBBLE_DUR;
  sfxBubbleActivate();updateHUD();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LASER UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateLaserUI(){
  const box=document.getElementById('laser-box'),st=document.getElementById('laser-status'),bar=document.getElementById('lbar'),cbL=document.getElementById('cb-laser');
  if(lOn){box.className='active';st.textContent='FIRING!';bar.style.width=(lFrames/LF*100)+'%';bar.style.background='linear-gradient(90deg,#fff,#00ffcc)';if(cbL)cbL.classList.add('off');}
  else if(lCD>0){box.className='cooling';st.textContent=Math.ceil(lCD/60)+'s';bar.style.width=((1-lCD/_laserCDMax)*100)+'%';bar.style.background='linear-gradient(90deg,#444,#06d6a0)';if(cbL)cbL.classList.add('off');}
  else{box.className='ready';st.textContent='READY!';bar.style.width='100%';bar.style.background='linear-gradient(90deg,#06d6a0,#00ffcc)';if(cbL)cbL.classList.remove('off');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DAMAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function burst(x,y,col,n){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=1.5+Math.random()*5;particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:2+Math.random()*5,al:1,col});}}

function takeDmg(hearts){
  hearts=hearts||1;
  if(bubbleOn){achOnDamage();achOnShieldBlock();STATS.totalShieldsBlocked++;return;} // invincible - shield block!
  if(CHEATS.infHealth)return;
  if(shields>0){shields=Math.max(0,shields-1);sfxHit();updateHUD();achOnDamage();return;}
  achOnDamage();
  lives=Math.max(0,lives-hearts);updateHUD();sfxLoseLife();
  if(lives<=0)doGameOver();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loop(now){
  if(!running||paused)return;
  // ‚îÄ‚îÄ Delta-time ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!_lastTime)_lastTime=now;
  const rawDt=Math.min((now-_lastTime)/1000,0.05); // seconds, capped at 50ms
  const dt=rawDt*60; // scale to "60fps units" so existing speed values work
  _lastTime=now;
  const cfg=lcfg(curLevel);const dm=DIFFS[diff];

  // Player move  (dt-scaled)
  if((K.ArrowLeft||K.KeyA||TK.left)&&player.x>0)player.x-=player.spd*dt;
  if((K.ArrowRight||K.KeyD||TK.right)&&player.x+player.w<GW)player.x+=player.spd*dt;
  player.x=Math.max(0,Math.min(GW-player.w,player.x));
  // Vertical movement: during boss fights player can move in bottom 55% of screen
  const _yMin=bossUp?Math.floor(GH*0.45):Math.floor(GH*0.75);
  const _yMax=GH-player.h-6;
  if((K.up||K['ArrowUp']||K['KeyW']||TK.up)&&player.y>_yMin)player.y-=player.spd*dt;
  if((K.down||K['ArrowDown']||K['KeyS']||TK.down)&&player.y<_yMax)player.y+=player.spd*dt;
  player.y=Math.max(_yMin,Math.min(_yMax,player.y));
  if(TK.fire)doShoot();
  if(shootCD>0)shootCD-=dt;

  // Laser
  if(lOn){
    lFrames-=dt;
    laserDmg(player.x+player.w/2);
    if(lFrames<=0){lOn=false;lCD=CHEATS.infPower?0:_laserCDMax;sfxLaserStop();}
  }else if(lCD>0)lCD-=dt;
  updateLaserUI();
  // Bubble tick
  if(bubbleOn){bubbleFrames-=dt;if(bubbleFrames<=0){bubbleOn=false;bubbleCD=CHEATS.infPower?0:BUBBLE_CD_MAX;updateHUD();}}
  else if(bubbleCD>0){bubbleCD-=dt;if(Math.floor(bubbleCD/60)!==Math.floor((bubbleCD+dt)/60))updateHUD();}

  // Enemy grid
  if(!bossUp){
    eMoveT+=dt;const mE=Math.max(8,28-Math.floor(curLevel/2));
    if(eMoveT>=mE){
      eMoveT=0;let edge=false;
      const spd=cfg.eMov*dm.eMov*mE;
      for(const e of enemies){const es=spd*e.sMul;e.x+=eDir*es;if(e.x+e.w>GW-6||e.x<6)edge=true;}
      if(edge){eDir*=-1;for(const e of enemies)e.y+=14;}
    }
    for(const e of enemies){
      e.sT-=dt;
      if(e.sT<=0){
        e.sT=Math.max(12,Math.floor((50+Math.random()*80)*(1-cfg.eFire*dm.eFire)+12));
        if(Math.random()<cfg.eFire*dm.eFire*e.fMul){
          if(e.ti===4){// Bomber: 3-way spread
            for(let a=-0.28;a<=0.28;a+=0.28)eBullets.push({x:e.x+e.w/2,y:e.y+e.h,vx:Math.sin(a)*4*dt,vy:(4+curLevel*.12)*dt,col:e.col,r:6});
          }else{
            eBullets.push({x:e.x+e.w/2,y:e.y+e.h,vx:0,vy:(4+curLevel*.12),col:e.col,r:5});
          }
        }
      }
      if(e.y+e.h>=player.y+8){takeDmg(1);enemies.splice(enemies.indexOf(e),1);break;}
    }
    if(enemies.length===0&&!bossUp&&!bossOut&&!bossCountdownTO&&!waveTransition){
      waveTransition=true; // lock ‚Äî prevents re-firing every frame until next wave spawns
      const doneWave=curWave;
      sfxWaveDone();
      if(curWave>=waveTarget){
        if(lcfg(curLevel).boss){
          showMsg('WAVE '+doneWave+' COMPLETE!',900);
          setTimeout(()=>{triggerBossCountdown();},1000);
        } else {
          showMsg('WAVE '+doneWave+' COMPLETE!',800);
          setTimeout(()=>{levelComplete();},950);
        }
      } else {
        curWave++;
        updateHUD();
        showMsg('WAVE '+doneWave+' COMPLETE!',1000);
        waveTO=setTimeout(()=>{waveTO=null;waveTransition=false;spawnWave();},1400);
      }
    }
  }

  // Boss AI
  if(boss){
    if(boss.shk>0)boss.shk--;
    const bspd=(1.5+curLevel*.09)*dm.eMov;
    boss.x+=boss.mDir*bspd*dt;
    if(boss.x+boss.w>GW-8){boss.x=GW-8-boss.w;boss.mDir=-1;}
    if(boss.x<8){boss.x=8;boss.mDir=1;}

    // Normal shooting
    boss.sT-=dt;
    if(boss.sT<=0){
      const pct=boss.hp/boss.mHp;
      // Normal shots: max 3 bullets, moderate speed ‚Äî player can dodge these
      boss.sT=pct>.5?70:pct>.25?45:28;
      const n=pct>.5?1:pct>.25?2:3;
      const bspread=0.25;
      for(let i=0;i<n;i++){const sp=(i-(n-1)/2)*bspread;eBullets.push({x:boss.x+boss.w/2,y:boss.y+boss.h,vx:sp*4,vy:3.5+curLevel*.08,col:'#ff0040',r:8,isBoss:true});}
    }

    // ‚îÄ‚îÄ SPECIAL ATTACKS: Telegraphed, per-boss, always dodgeable ‚îÄ‚îÄ
    if(boss.bd){
      bossSpecialT-=dt;
      if(bossSpecialT<=0){
        bossSpecialT=bossSpecialCD;
        const sp=boss.bd.special;
        const tier=boss.tier;

        // ‚îÄ‚îÄ‚îÄ BOSS 0: THE LID KING ‚Äî Column Crash ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Golden lids slam down in all but 2 adjacent safe columns.
        // Safe columns shown by green sparks for 1 second before lids fall.
        if(sp==='lid_slam'){
          sfxLidSlam();
          const cols=8;
          const safeCol=Math.floor(Math.random()*(cols-1));
          const cw=Math.floor(GW/cols);
          // Green telegraph sparks on safe columns
          for(let gy=boss.y+boss.h+20;gy<GH;gy+=40){
            particles.push({x:safeCol*cw+cw/2,y:gy,vx:0,vy:-1,r:6,al:0.9,col:'#00ff44'});
            particles.push({x:(safeCol+1)*cw+cw/2,y:gy,vx:0,vy:-1,r:6,al:0.9,col:'#00ff44'});
          }
          for(let c=0;c<cols;c++){
            if(c===safeCol||c===safeCol+1)continue;
            const rx=c*cw+cw/2;
            // Start stationary at top, then accelerate down after 65 frames
            eBullets.push({x:rx,y:boss.y+boss.h+8,vx:0,vy:0,col:'#ffaa00',r:11,isBoss:true,
              _tT:65,_aVy:5});
          }
        }

        // ‚îÄ‚îÄ‚îÄ BOSS 1: FROSTLOCK ‚Äî Ice Wall with Gap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // A solid wall of ice slides down with one wide gap.
        // Gap position telegraphed with blue glow column for 1 second.
        if(sp==='ice_ring'){
          sfxIceRing();
          const gapCenter=120+Math.floor(Math.random()*(GW-240));
          const gapHalf=90; // 180px total gap ‚Äî very generous
          // Telegraph: cyan glow in safe gap
          for(let gy=boss.y+boss.h+10;gy<GH;gy+=25){
            particles.push({x:gapCenter+Math.random()*60-30,y:gy,vx:0,vy:0,r:5,al:0.7,col:'#00ffff'});
          }
          // Ice bullets spaced across screen, skipping gap
          for(let bx2=0;bx2<GW+20;bx2+=20){
            if(bx2>=gapCenter-gapHalf&&bx2<=gapCenter+gapHalf)continue;
            eBullets.push({x:bx2,y:boss.y+boss.h+5,vx:0,vy:0,col:'#aaddff',r:9,isBoss:true,
              _tT:70,_aVy:3.5});
          }
        }

        // ‚îÄ‚îÄ‚îÄ BOSS 2: SAUCEPAN SAM ‚Äî Heat Column ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // A column of fire jets up from the bottom. One side is always safe.
        // The safe side (left or right half) is shown with green flash first.
        if(sp==='heat_wave'){
          sfxHeatWave();
          boss._hwSide=(boss._hwSide||0)+1;
          const dangerLeft=(boss._hwSide%2===0);
          // Green safe-zone flash (RIGHT side safe if danger on left, vice versa)
          const safeX=dangerLeft?GW/2:0;
          for(let sy=GH-20;sy>boss.y+boss.h;sy-=30){
            particles.push({x:safeX+Math.random()*(GW/2),y:sy,vx:0,vy:-2,r:5,al:0.8,col:'#00ff88'});
          }
          // Fire jets rise from bottom on danger side, staggered timing
          const numJets=7;
          for(let j=0;j<numJets;j++){
            const jx=(dangerLeft?0:GW/2)+j*((GW/2)/numJets)+20;
            // Stagger: jets fire in sequence so player can see pattern
            const delay=j*12; // frames apart
            eBullets.push({x:jx,y:GH+5,vx:0,vy:0,col:'#ff4400',r:10,isBoss:true,
              _tT:55+delay,_aVy:-6});
          }
        }

        // ‚îÄ‚îÄ‚îÄ BOSS 3: CRISPER LORD ‚Äî Laser Columns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // 3 laser beams fire from boss, aiming at fixed columns.
        // One column is always left open (clear of beams).
        // Beams telegraph as thin lines for 1.5s before dealing damage.
        if(sp==='laser'){
          sfxBossLaserSfx();
          // Pick 3 beam X positions out of 5 possible columns, leave 2 open
          const cols5=[GW*0.1,GW*0.3,GW*0.5,GW*0.7,GW*0.9];
          const shuffled=[...cols5].sort(()=>Math.random()-0.5);
          const beamXs=shuffled.slice(0,3); // 3 beams, 2 open columns
          const safeCols=shuffled.slice(3);
          // Green safe column sparks
          for(const sx of safeCols){
            for(let gy=boss.y+boss.h+10;gy<GH;gy+=35){
              particles.push({x:sx+Math.random()*20-10,y:gy,vx:0,vy:0,r:5,al:0.8,col:'#44ff88'});
            }
          }
          // Beam warning then damage shots
          for(const bx3 of beamXs){
            // Warning particles (thin line)
            for(let gy2=boss.y+boss.h+10;gy2<GH;gy2+=18){
              particles.push({x:bx3,y:gy2,vx:0,vy:0,r:3,al:0.6,col:'#ff4466'});
            }
            // After delay, fire bullet column
            eBullets.push({x:bx3,y:boss.y+boss.h+10,vx:0,vy:0,col:'#ff0066',r:8,isBoss:true,
              _tT:90,_aVy:7});
          }
        }

        // ‚îÄ‚îÄ‚îÄ BOSS 4: THERMOS PRIME ‚Äî Spiral With Gaps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Bullets fire outward in a slow spiral. Every 4th bullet skipped
        // leaving clear escape lanes. Player can orbit the gaps.
        if(sp==='barrage'){
          sfxBarrage();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          const total=24;
          for(let i=0;i<total;i++){
            if(i%4===2)continue; // every 4th position is a gap
            const ang=(i/total)*Math.PI*2+(boss._spiralOff||0);
            const spd=2.2+Math.random()*0.4;
            eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
              col:'#ff0088',r:9,isBoss:true});
            // Yellow gap markers
            if(i%4===1||i%4===3){
              const gAng=((i+1)/total)*Math.PI*2+(boss._spiralOff||0);
              particles.push({x:cx+Math.cos(gAng)*50,y:cy+Math.sin(gAng)*50,
                vx:0,vy:0,r:7,al:0.8,col:'#ffff00'});
            }
          }
          boss._spiralOff=((boss._spiralOff||0)+0.4)%(Math.PI*2);
        }

        // ‚îÄ‚îÄ‚îÄ BOSS 5: SUPERNOVA ‚Äî Rotating Burst with 3 Gaps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Huge ring of bullets with 3 large clear arcs (120¬∞ apart).
        // Ring rotates slowly so player must track the gaps.
        if(sp==='all'){
          if(!boss._snovAtk)boss._snovAtk=0;
          boss._snovAtk=(boss._snovAtk+1)%3;
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;

          if(boss._snovAtk===0){
            // Attack A: Rotating ring with 3 large gaps
            sfxBossLaserSfx();
            const offset=boss._snovRot||0;
            boss._snovRot=(offset+Math.PI/4)%(Math.PI*2);
            const numB=30;
            const gapArcs=[offset,offset+Math.PI*2/3,offset+Math.PI*4/3];
            const gapSize=Math.PI*0.35;
            for(let i=0;i<numB;i++){
              const ang=(i/numB)*Math.PI*2;
              const inGap=gapArcs.some(g=>{
                const d=Math.abs(((ang-g+Math.PI*3)%(Math.PI*2))-Math.PI);
                return d<gapSize;
              });
              if(inGap)continue;
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*2.5,vy:Math.sin(ang)*2.5,
                col:'#ff00ff',r:9,isBoss:true});
            }
            // Show gaps with magenta sparks
            for(const ga of gapArcs){
              for(let rd=20;rd<140;rd+=25){
                particles.push({x:cx+Math.cos(ga)*rd,y:cy+Math.sin(ga)*rd,
                  vx:0,vy:0,r:7,al:0.9,col:'#ff88ff'});
              }
            }

          } else if(boss._snovAtk===1){
            // Attack B: Twin sweeping laser beams with clear center lane
            sfxBossLaserSfx();
            // Left and right beams, center 200px always safe
            const safeZone=120;
            for(let bx4=0;bx4<GW;bx4+=18){
              const distFromCenter=Math.abs(bx4-GW/2);
              if(distFromCenter<safeZone)continue; // center is safe
              eBullets.push({x:bx4,y:boss.y+boss.h+10,vx:0,vy:0,
                col:'#aa44ff',r:8,isBoss:true,_tT:80,_aVy:4.5});
            }
            // Green center lane telegraph
            for(let gy=boss.y+boss.h+10;gy<GH;gy+=28){
              particles.push({x:GW/2+Math.random()*safeZone*2-safeZone,y:gy,
                vx:0,vy:0,r:5,al:0.7,col:'#ff88ff'});
            }

          } else {
            // Attack C: 4-way cross with diagonal escape lanes
            sfxLidSlam();
            const numPerArm=8;
            const armAngles=[Math.PI/2,Math.PI*3/2]; // only down and sideways
            // Diagonal gaps at 45¬∞/135¬∞/225¬∞/315¬∞ ‚Äî always safe
            for(const armA of armAngles){
              for(let s=0;s<numPerArm;s++){
                const spread=(s-(numPerArm-1)/2)*0.12;
                eBullets.push({x:cx,y:cy,
                  vx:Math.sin(armA+spread)*2.8,vy:Math.cos(armA+spread)*2.8,
                  col:'#ff00ff',r:10,isBoss:true});
              }
            }
            // Show diagonal safe lanes
            const diagAngles=[Math.PI/4,Math.PI*3/4,Math.PI*5/4,Math.PI*7/4];
            for(const da of diagAngles){
              for(let rd=30;rd<160;rd+=28){
                particles.push({x:cx+Math.cos(da)*rd,y:cy+Math.sin(da)*rd,
                  vx:0,vy:0,r:7,al:0.9,col:'#ff88ff'});
              }
            }
          }
        }

        // ‚ïê‚ïê‚ïê TIER 6: VOID LUNCHBOX ‚Äî void_pull ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Gravity wells appear across screen, pulling bullets toward them
        // Two safe zones always exist at screen edges
        if(sp==='void_pull'){
          sfxBossLaserSfx();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          // 3 gravity-pull rings: bullets orbit inward, leaving 2 edge corridors safe
          const safeX1=80,safeX2=GW-80;
          for(let a=0;a<36;a++){
            const ang=(a/36)*Math.PI*2;
            if(Math.abs(Math.cos(ang)*GW/2+GW/2-safeX1)<90)continue;
            if(Math.abs(Math.cos(ang)*GW/2+GW/2-safeX2)<90)continue;
            const r2=80+Math.random()*60;
            eBullets.push({x:cx+Math.cos(ang)*r2,y:cy+Math.sin(ang)*r2,
              vx:-Math.cos(ang)*1.8,vy:-Math.sin(ang)*1.8,
              col:'#8800ff',r:10,isBoss:true});
          }
          for(let gy=cy+20;gy<GH;gy+=30){
            particles.push({x:safeX1,y:gy,vx:0,vy:0,r:5,al:0.8,col:'#00ff88'});
            particles.push({x:safeX2,y:gy,vx:0,vy:0,r:5,al:0.8,col:'#00ff88'});
          }
        }

        // ‚ïê‚ïê‚ïê TIER 7: COLANDER OF DOOM ‚Äî hole_burst ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 8 burst streams from fixed hole positions, wide gaps between each
        if(sp==='hole_burst'){
          sfxLidSlam();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          const holeAngles=[0,Math.PI/4,Math.PI/2,Math.PI*3/4,
                            Math.PI,Math.PI*5/4,Math.PI*3/2,Math.PI*7/4];
          // Only fire 4 of 8 holes, leaving 4 gaps
          const activeHoles=holeAngles.filter((_,i)=>i%2===0);
          for(const ha of activeHoles){
            for(let burst2=0;burst2<4;burst2++){
              const spread=ha+(burst2-1.5)*0.15;
              eBullets.push({x:cx,y:cy,vx:Math.cos(spread)*4,vy:Math.sin(spread)*4,
                col:'#ff2200',r:9,isBoss:true});
            }
          }
          // Mark gap angles in green
          const gapHoles=holeAngles.filter((_,i)=>i%2===1);
          for(const gh of gapHoles){
            for(let rd=30;rd<150;rd+=25)
              particles.push({x:cx+Math.cos(gh)*rd,y:cy+Math.sin(gh)*rd,
                vx:0,vy:0,r:7,al:0.9,col:'#44ff88'});
          }
        }

        // ‚ïê‚ïê‚ïê TIER 8: BLENDER KING ‚Äî blade_spin ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Spinning blades (tight spiral) with wide visible gaps
        // Rotates each fire, player must track the gap rotation
        if(sp==='blade_spin'){
          sfxBossLaserSfx();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          boss._bladeRot=(boss._bladeRot||0)+Math.PI/6;
          const blades=5,gapSize=Math.PI*0.32;
          for(let b2=0;b2<24;b2++){
            const ang=(b2/24)*Math.PI*2;
            // Check gap: every 5th sector is open
            let inGap=false;
            for(let k=0;k<blades;k++){
              const gapCenter=boss._bladeRot+k*(Math.PI*2/blades);
              const diff=Math.abs(((ang-gapCenter+Math.PI*3)%(Math.PI*2))-Math.PI);
              if(diff<gapSize){inGap=true;break;}
            }
            if(inGap)continue;
            const spd=3+Math.random()*0.5;
            eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
              col:'#00ddff',r:9,isBoss:true});
          }
          // Show gap positions
          for(let k=0;k<blades;k++){
            const gc=boss._bladeRot+k*(Math.PI*2/blades);
            for(let rd=25;rd<130;rd+=22)
              particles.push({x:cx+Math.cos(gc)*rd,y:cy+Math.sin(gc)*rd,
                vx:0,vy:0,r:6,al:0.9,col:'#88ffff'});
          }
        }

        // ‚ïê‚ïê‚ïê TIER 9: PYREX OVERLORD ‚Äî heat_cage ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Walls of fire on both sides narrow toward center.
        // A safe zone of 180px runs down the center at all times.
        if(sp==='heat_cage'){
          sfxHeatWave();
          const safeW=160,cx=GW/2;
          // Left wall, right wall ‚Äî bullets rush inward
          for(let gy=boss.y+boss.h+10;gy<GH;gy+=22){
            // Left
            eBullets.push({x:0,y:gy,vx:0,vy:0,col:'#ff4400',r:9,isBoss:true,
              _tT:70,_aVy:0,_aVx:4.8});
            // Right
            eBullets.push({x:GW,y:gy,vx:0,vy:0,col:'#ff4400',r:9,isBoss:true,
              _tT:70,_aVy:0,_aVx:-4.8});
          }
          // Center safe zone telegraph
          for(let gy=boss.y+boss.h+10;gy<GH;gy+=28){
            particles.push({x:cx-safeW/2+Math.random()*safeW,y:gy,
              vx:0,vy:0,r:5,al:0.7,col:'#ffaa00'});
          }
        }

        // ‚ïê‚ïê‚ïê TIER 10: TUPPERLOCK OMEGA ‚Äî seal_burst ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Expanding concentric rings with alternating gaps.
        // Ring 1 gaps at 0¬∞/120¬∞/240¬∞, ring 2 gaps at 60¬∞/180¬∞/300¬∞
        if(sp==='seal_burst'){
          sfxIceRing();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          [0,Math.PI/3].forEach((offset,ring)=>{
            const ringGaps=[offset,offset+Math.PI*2/3,offset+Math.PI*4/3];
            const gapSz=Math.PI*0.28;
            const spd=1.8+ring*0.8;
            for(let b2=0;b2<32;b2++){
              const ang=(b2/32)*Math.PI*2;
              const inGap=ringGaps.some(g=>{
                const d=Math.abs(((ang-g+Math.PI*3)%(Math.PI*2))-Math.PI);
                return d<gapSz;
              });
              if(inGap)continue;
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                col:ring===0?'#00ff44':'#88ff44',r:8,isBoss:true});
            }
            for(const ga of ringGaps)
              for(let rd=20;rd<110;rd+=20)
                particles.push({x:cx+Math.cos(ga)*rd,y:cy+Math.sin(ga)*rd,
                  vx:0,vy:0,r:6,al:0.9,col:'#aaffaa'});
          });
        }

        // ‚ïê‚ïê‚ïê TIER 11: ABYSS STRAINER ‚Äî abyss_rain ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Dense rain of bullets with zigzag safe corridors telegraphed
        // by a chain of cyan sparks. Player must follow the corridor.
        if(sp==='abyss_rain'){
          sfxBarrage();
          const corridorX=100+Math.floor(Math.random()*(GW-200));
          const corridorW=130;
          for(let bx3=10;bx3<GW;bx3+=18){
            if(bx3>=corridorX&&bx3<=corridorX+corridorW)continue;
            eBullets.push({x:bx3,y:boss.y+boss.h+10,vx:0,vy:0,
              col:'#4444ff',r:8,isBoss:true,_tT:65,_aVy:4.2});
          }
          // Corridor sparks
          for(let gy=boss.y+boss.h+10;gy<GH;gy+=22)
            particles.push({x:corridorX+Math.random()*corridorW,y:gy,
              vx:0,vy:0,r:5,al:0.85,col:'#44aaff'});
        }

        // ‚ïê‚ïê‚ïê TIER 12: ANTIMATTER CASSEROLE ‚Äî matter_wave ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 3 sweeping walls of bullets cross from alternating directions
        // Each wave has a 160px gap at a different X.
        if(sp==='matter_wave'){
          sfxHeatWave();
          boss._mwaveCount=(boss._mwaveCount||0)+1;
          const fromLeft=(boss._mwaveCount%2===0);
          for(let wave=0;wave<3;wave++){
            const gapX=80+wave*220+Math.floor(Math.random()*80);
            const delay=wave*40;
            for(let bx3=0;bx3<GW;bx3+=16){
              if(bx3>=gapX&&bx3<=gapX+160)continue;
              eBullets.push({x:fromLeft?-20:GW+20,y:boss.y+boss.h+30+wave*60,
                vx:0,vy:0,col:'#ff00aa',r:9,isBoss:true,
                _tT:50+delay,_aVy:0,_aVx:fromLeft?5:-5});
            }
            for(let gy=boss.y+boss.h+20+wave*60;gy<boss.y+boss.h+80+wave*60;gy+=20)
              particles.push({x:gapX+Math.random()*160,y:gy,
                vx:0,vy:0,r:6,al:0.9,col:'#ff88dd'});
          }
        }

        // ‚ïê‚ïê‚ïê TIER 13: GRAVITON FLASK ‚Äî grav_crush ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Bullets spawn at edges and curve toward player ‚Äî but are slow.
        // There is always a safe "blind spot" directly above the player.
        if(sp==='grav_crush'){
          sfxBossLaserSfx();
          const px=player.x+player.w/2,py=player.y;
          const blindW=100;
          // Bullets from top edge, left edge, right edge
          for(let bx3=0;bx3<GW;bx3+=22){
            if(Math.abs(bx3-px)<blindW)continue; // blind spot above player
            eBullets.push({x:bx3,y:boss.y+boss.h+10,vx:0,vy:2.5,
              col:'#aaffff',r:9,isBoss:true});
          }
          // Safe zone sparks above player
          for(let gy=py-60;gy<py;gy+=18)
            particles.push({x:px-blindW/2+Math.random()*blindW,y:gy,
              vx:0,vy:0,r:6,al:0.9,col:'#aaffff'});
        }

        // ‚ïê‚ïê‚ïê TIER 14: OMEGA PRESSURE COOKER ‚Äî pressure_burst ‚ïê‚ïê‚ïê‚ïê
        // Steam jets shoot from 6 fixed vents. Vents show warning steam
        // for 1 second, then fire. 2 vents always stay cold (safe).
        if(sp==='pressure_burst'){
          sfxLidSlam();
          const ventX=[GW*.1,GW*.25,GW*.4,GW*.55,GW*.7,GW*.85];
          const safeIdxs=new Set([Math.floor(Math.random()*6),Math.floor(Math.random()*6)+1].map(v=>v%6));
          ventX.forEach((vx,i)=>{
            if(safeIdxs.has(i)){
              // Cold vent telegraph (blue = safe)
              for(let gy=boss.y+boss.h+10;gy<GH;gy+=30)
                particles.push({x:vx,y:gy,vx:(Math.random()-0.5)*0.5,vy:0,r:5,al:0.7,col:'#44ffaa'});
            } else {
              // Hot vent ‚Äî shoots after telegraph
              for(let gy=boss.y+boss.h+10;gy<GH;gy+=30)
                particles.push({x:vx,y:gy,vx:0,vy:0,r:4,al:0.5,col:'#ff4400'});
              eBullets.push({x:vx,y:boss.y+boss.h+10,vx:0,vy:0,
                col:'#ff5500',r:11,isBoss:true,_tT:90,_aVy:5.5});
            }
          });
        }

        // ‚ïê‚ïê‚ïê TIER 15: SINGULARITY POT ‚Äî singularity ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // A black hole forms at center top, warping all bullets outward
        // in a dense ring. 4 wide safe gaps at N/S/E/W.
        if(sp==='singularity'){
          sfxBossLaserSfx();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          const safeAngles=[Math.PI/2,Math.PI,Math.PI*3/2,Math.PI*2];
          const safeArc=Math.PI*0.25;
          const rings=2;
          for(let ring=0;ring<rings;ring++){
            const spd=2.2+ring*1.2;
            const total=38;
            for(let b2=0;b2<total;b2++){
              const ang=(b2/total)*Math.PI*2;
              const safe=safeAngles.some(sa=>{
                const d=Math.abs(((ang-sa+Math.PI*3)%(Math.PI*2))-Math.PI);
                return d<safeArc;
              });
              if(safe)continue;
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                col:ring===0?'#ffffff':'#aaaaff',r:9,isBoss:true});
            }
          }
          for(const sa of safeAngles)
            for(let rd=25;rd<160;rd+=22)
              particles.push({x:cx+Math.cos(sa)*rd,y:cy+Math.sin(sa)*rd,
                vx:0,vy:0,r:7,al:0.9,col:'#ffffff'});
        }

        // ‚ïê‚ïê‚ïê TIER 16: DARK MATTER DECANTER ‚Äî dark_storm ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Phase 1: column rain with 2 corridors
        // Phase 2: ring burst with 3 gaps
        // Phase 3: cross fire with diagonal escapes
        if(sp==='dark_storm'){
          if(!boss._dsAtk)boss._dsAtk=0;
          boss._dsAtk=(boss._dsAtk+1)%3;
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          if(boss._dsAtk===0){
            // Column rain, 2 corridors
            const c1=100+Math.floor(Math.random()*200);
            const c2=GW-c1-120;
            for(let bx3=0;bx3<GW;bx3+=16){
              if(bx3>=c1&&bx3<=c1+120)continue;
              if(bx3>=c2&&bx3<=c2+120)continue;
              eBullets.push({x:bx3,y:boss.y+boss.h+10,vx:0,vy:0,
                col:'#ff44ff',r:9,isBoss:true,_tT:60,_aVy:4.8});
            }
            [[c1,120],[c2,120]].forEach(([cx2,cw])=>{
              for(let gy=boss.y+boss.h+10;gy<GH;gy+=25)
                particles.push({x:cx2+Math.random()*cw,y:gy,
                  vx:0,vy:0,r:5,al:0.8,col:'#ff88ff'});
            });
          } else if(boss._dsAtk===1){
            // Ring burst 3 gaps
            const gOff=boss._dsOff||0;boss._dsOff=(gOff+Math.PI/3)%(Math.PI*2);
            const gapAngles=[gOff,gOff+Math.PI*2/3,gOff+Math.PI*4/3];
            const gapSz=Math.PI*0.28;
            for(let b2=0;b2<32;b2++){
              const ang=(b2/32)*Math.PI*2;
              const safe=gapAngles.some(g=>{
                const d=Math.abs(((ang-g+Math.PI*3)%(Math.PI*2))-Math.PI);
                return d<gapSz;
              });
              if(safe)continue;
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*3,vy:Math.sin(ang)*3,
                col:'#cc00ff',r:10,isBoss:true});
            }
            for(const ga of gapAngles)
              for(let rd=25;rd<150;rd+=25)
                particles.push({x:cx+Math.cos(ga)*rd,y:cy+Math.sin(ga)*rd,
                  vx:0,vy:0,r:7,al:0.9,col:'#dd88ff'});
          } else {
            // Cross fire, diagonal escapes
            [Math.PI/2,Math.PI*3/2].forEach(armA=>{
              for(let s=0;s<10;s++){
                const spread=armA+(s-4.5)*0.11;
                eBullets.push({x:cx,y:cy,
                  vx:Math.sin(spread)*3.2,vy:Math.cos(spread)*3.2,
                  col:'#ff00ff',r:10,isBoss:true});
              }
            });
            [Math.PI/4,Math.PI*3/4,Math.PI*5/4,Math.PI*7/4].forEach(da=>{
              for(let rd=30;rd<170;rd+=28)
                particles.push({x:cx+Math.cos(da)*rd,y:cy+Math.sin(da)*rd,
                  vx:0,vy:0,r:7,al:0.9,col:'#ff88ff'});
            });
          }
        }

        // ‚ïê‚ïê‚ïê TIER 17: ETERNAL TUPPERWARE ‚Äî eternal ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // All 4 attacks rotate each use. Each is devastating but readable.
        if(sp==='eternal'){
          if(!boss._etAtk)boss._etAtk=0;
          boss._etAtk=(boss._etAtk+1)%4;
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;

          if(boss._etAtk===0){
            // WRATH OF VOID: dense ring 6 gaps
            const gOff=boss._etRot||0;boss._etRot=(gOff+Math.PI/5)%(Math.PI*2);
            const gaps=6,gSz=Math.PI*0.22;
            const gAngles=Array.from({length:gaps},(_,i)=>gOff+i*(Math.PI*2/gaps));
            for(let b2=0;b2<44;b2++){
              const ang=(b2/44)*Math.PI*2;
              if(gAngles.some(g=>Math.abs(((ang-g+Math.PI*3)%(Math.PI*2))-Math.PI)<gSz))continue;
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*3,vy:Math.sin(ang)*3,
                col:'#ffff00',r:10,isBoss:true});
            }
            gAngles.forEach(ga=>{
              for(let rd=20;rd<160;rd+=22)
                particles.push({x:cx+Math.cos(ga)*rd,y:cy+Math.sin(ga)*rd,
                  vx:0,vy:0,r:7,al:0.95,col:'#ffffaa'});
            });
          } else if(boss._etAtk===1){
            // ETERNAL COLUMNS: full-screen column rain, 3 safe corridors
            const cors=[[GW*.12,100],[GW*.46,100],[GW*.78,100]];
            for(let bx3=0;bx3<GW;bx3+=14){
              if(cors.some(([cx3,cw])=>bx3>=cx3&&bx3<=cx3+cw))continue;
              eBullets.push({x:bx3,y:boss.y+boss.h+10,vx:0,vy:0,
                col:'#ffdd00',r:10,isBoss:true,_tT:55,_aVy:5.5});
            }
            cors.forEach(([cx3,cw])=>{
              for(let gy=boss.y+boss.h+10;gy<GH;gy+=22)
                particles.push({x:cx3+Math.random()*cw,y:gy,
                  vx:0,vy:0,r:6,al:0.9,col:'#ffffaa'});
            });
          } else if(boss._etAtk===2){
            // UNDYING JETS: jets from both sides, safe 200px center corridor
            const safe=100;
            for(let gy=boss.y+boss.h+10;gy<GH;gy+=18){
              eBullets.push({x:0,y:gy,vx:0,vy:0,col:'#ffaa00',r:10,isBoss:true,_tT:65,_aVy:0,_aVx:5.5});
              eBullets.push({x:GW,y:gy,vx:0,vy:0,col:'#ffaa00',r:10,isBoss:true,_tT:65,_aVy:0,_aVx:-5.5});
            }
            for(let gy=boss.y+boss.h+10;gy<GH;gy+=25)
              particles.push({x:GW/2-safe+Math.random()*safe*2,y:gy,
                vx:0,vy:0,r:6,al:0.9,col:'#ffff88'});
          } else {
            // OMEGA SPIRAL: massive spiral with 4 clear lanes
            boss._etSpiral=(boss._etSpiral||0)+Math.PI/8;
            const lanes=4;
            for(let b2=0;b2<48;b2++){
              const ang=(b2/48)*Math.PI*2+boss._etSpiral;
              let inLane=false;
              for(let k=0;k<lanes;k++){
                const la=boss._etSpiral+k*(Math.PI*2/lanes);
                const d=Math.abs(((ang-la+Math.PI*3)%(Math.PI*2))-Math.PI);
                if(d<Math.PI*0.2){inLane=true;break;}
              }
              if(inLane)continue;
              const spd=2.8+Math.random()*0.5;
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                col:'#ffff44',r:10,isBoss:true});
            }
            for(let k=0;k<lanes;k++){
              const la=boss._etSpiral+k*(Math.PI*2/lanes);
              for(let rd=20;rd<180;rd+=25)
                particles.push({x:cx+Math.cos(la)*rd,y:cy+Math.sin(la)*rd,
                  vx:0,vy:0,r:8,al:0.95,col:'#ffff88'});
            }
          }
        }
      }
    }

    // ‚îÄ‚îÄ Normal boss shots: reduce volume at high levels to stay fair ‚îÄ‚îÄ

        // ‚ïê‚ïê‚ïê‚ïê TIER 18: NECROPLASTIC ‚Äî necro_grid ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // A 5√ó3 grid of bullet nodes materialise above player.
        // Every other row is offset, creating a zig-zag maze.
        // Two full vertical columns always left empty (the escape lanes).
        if(sp==='necro_grid'){
          sfxBossLaserSfx();
          const cols=7,rows=3;
          const safeC=new Set([Math.floor(Math.random()*cols),Math.floor(Math.random()*cols)]);
          for(let r=0;r<rows;r++){for(let c=0;c<cols;c++){
            if(safeC.has(c))continue;
            const ox=(r%2)*30; // zig-zag offset
            const bx=(GW/(cols+1))*(c+1)+ox;
            const by=boss.y+boss.h+20+r*50;
            eBullets.push({x:bx,y:by,vx:0,vy:0,col:'#ff0000',r:10,isBoss:true,
              _tT:75,_aVy:4+r*0.4});
          }}
          for(const sc of safeC)
            for(let gy=boss.y+boss.h;gy<GH;gy+=28)
              particles.push({x:(GW/(cols+1))*(sc+1),y:gy,
                vx:0,vy:0,r:5,al:0.8,col:'#ff4444'});
        }

        // ‚ïê‚ïê‚ïê‚ïê TIER 19: CENTENNIAL CANISTER ‚Äî century_rage ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 4 rotating arms of bullets (like a death propeller).
        // Each arm fires a stream; the gaps between arms are safe.
        // Arms rotate each use so the safe angle shifts.
        if(sp==='century_rage'){
          sfxLidSlam();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          boss._centRot=(boss._centRot||0)+Math.PI/5;
          const arms=4,gapFrac=0.35; // gap is 35% of each sector
          for(let b2=0;b2<48;b2++){
            const ang=(b2/48)*Math.PI*2;
            const norm=((ang-boss._centRot)%(Math.PI*2/arms)+Math.PI*2/arms)%(Math.PI*2/arms);
            const sectorFrac=norm/(Math.PI*2/arms);
            if(sectorFrac>0.5-gapFrac/2&&sectorFrac<0.5+gapFrac/2)continue; // gap center
            const spd=3.2+Math.random()*0.4;
            eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
              col:'#ffaa00',r:10,isBoss:true});
          }
          // Show arm midpoints (danger) and gap centres (safe)
          for(let a=0;a<arms;a++){
            const gapAng=boss._centRot+a*(Math.PI*2/arms)+Math.PI/arms;
            for(let rd=25;rd<160;rd+=24)
              particles.push({x:cx+Math.cos(gapAng)*rd,y:cy+Math.sin(gapAng)*rd,
                vx:0,vy:0,r:7,al:0.9,col:'#ffdd88'});
          }
        }

        // ‚ïê‚ïê‚ïê‚ïê TIER 20: PLASMA PITCHER ‚Äî plasma_burst ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Two expanding plasma rings fire simultaneously with staggered gaps.
        // Ring 1 gap at 0¬∞, ring 2 gap at 180¬∞ ‚Äî player must be in ONE gap.
        // Rings grow outward so player has a brief window to find safety.
        if(sp==='plasma_burst'){
          sfxIceRing();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          [[0,1.5],[Math.PI,2.2]].forEach(([gapAng,spd])=>{
            const gapSz=Math.PI*0.32;
            for(let b2=0;b2<36;b2++){
              const ang=(b2/36)*Math.PI*2;
              const d=Math.abs(((ang-gapAng+Math.PI*3)%(Math.PI*2))-Math.PI);
              if(d<gapSz)continue;
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                col:'#ff66ff',r:9,isBoss:true});
            }
            for(let rd=20;rd<150;rd+=22)
              particles.push({x:cx+Math.cos(gapAng)*rd,y:cy+Math.sin(gapAng)*rd,
                vx:0,vy:0,r:7,al:0.9,col:'#ffaaff'});
          });
        }

        // ‚ïê‚ïê‚ïê‚ïê TIER 21: ABYSSAL LUNCH PAIL ‚Äî abyssal_wave ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Three horizontal waves sweep downward in staggered timing.
        // Each wave has one clear corridor 140px wide, corridors shift each wave.
        if(sp==='abyssal_wave'){
          sfxBarrage();
          const shifts=[GW*0.15,GW*0.48,GW*0.75];
          shifts.forEach((corX,wi)=>{
            const corW=140;
            for(let bx3=0;bx3<GW;bx3+=15){
              if(bx3>=corX&&bx3<=corX+corW)continue;
              eBullets.push({x:bx3,y:boss.y+boss.h+10+wi*25,vx:0,vy:0,
                col:'#00ffff',r:9,isBoss:true,_tT:45+wi*25,_aVy:4.5+wi*0.5});
            }
            for(let gy=boss.y+boss.h+10+wi*25;gy<GH;gy+=24)
              particles.push({x:corX+Math.random()*corW,y:gy,
                vx:0,vy:0,r:5,al:0.85,col:'#88ffff'});
          });
        }

        // ‚ïê‚ïê‚ïê‚ïê TIER 22: FRACTAL FLASK ‚Äî fractal_ring ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Nested rings of bullets ‚Äî inner ring slow+big gaps, outer ring fast+small gaps.
        // Player can always shelter in inner ring gaps.
        if(sp==='fractal_ring'){
          sfxBossLaserSfx();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          boss._fracRot=(boss._fracRot||0)+Math.PI/7;
          // Inner ring: 4 large gaps
          [[24,2.0,Math.PI*0.32,0],[36,3.2,Math.PI*0.18,Math.PI/4]].forEach(([n,spd,gSz,rotOff],ri)=>{
            const numGaps=ri===0?4:3;
            for(let b2=0;b2<n;b2++){
              const ang=(b2/n)*Math.PI*2;
              let safe=false;
              for(let g=0;g<numGaps;g++){
                const ga=boss._fracRot+rotOff+g*(Math.PI*2/numGaps);
                const d=Math.abs(((ang-ga+Math.PI*3)%(Math.PI*2))-Math.PI);
                if(d<gSz){safe=true;break;}
              }
              if(safe)continue;
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                col:ri===0?'#88ff88':'#44cc44',r:ri===0?10:8,isBoss:true});
            }
            if(ri===0){
              for(let g=0;g<4;g++){
                const ga=boss._fracRot+g*(Math.PI*2/4);
                for(let rd=20;rd<140;rd+=22)
                  particles.push({x:cx+Math.cos(ga)*rd,y:cy+Math.sin(ga)*rd,
                    vx:0,vy:0,r:6,al:0.9,col:'#aaffaa'});
              }
            }
          });
        }

        // ‚ïê‚ïê‚ïê‚ïê TIER 23: OBLIVION BENTO ‚Äî oblivion ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Rotates through 4 phases each use. All phases deadly but each
        // has exactly ONE clear escape zone shown in gold sparks.
        if(sp==='oblivion'){
          if(!boss._oblAtk)boss._oblAtk=0;
          boss._oblAtk=(boss._oblAtk+1)%4;
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          if(boss._oblAtk===0){
            // Phase A: Column storm, 3 corridors
            const cors=[[GW*.1,90],[GW*.45,90],[GW*.78,90]];
            for(let bx3=0;bx3<GW;bx3+=13){
              if(cors.some(([cx2,cw])=>bx3>=cx2&&bx3<=cx2+cw))continue;
              eBullets.push({x:bx3,y:boss.y+boss.h+10,vx:0,vy:0,
                col:'#ff8800',r:10,isBoss:true,_tT:50,_aVy:5.8});
            }
            cors.forEach(([cx2,cw])=>{
              for(let gy=boss.y+boss.h+10;gy<GH;gy+=22)
                particles.push({x:cx2+Math.random()*cw,y:gy,vx:0,vy:0,r:5,al:0.9,col:'#ffcc44'});
            });
          } else if(boss._oblAtk===1){
            // Phase B: 5-arm spinner, big gaps
            boss._oblRot=(boss._oblRot||0)+Math.PI/4;
            const arms=5,gSz=Math.PI*0.28;
            for(let b2=0;b2<50;b2++){
              const ang=(b2/50)*Math.PI*2;
              const norm=((ang-boss._oblRot)%(Math.PI*2/arms)+Math.PI*2/arms)%(Math.PI*2/arms);
              if(norm/(Math.PI*2/arms)>0.5-gSz/(2*Math.PI/arms)&&
                 norm/(Math.PI*2/arms)<0.5+gSz/(2*Math.PI/arms))continue;
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*3.5,vy:Math.sin(ang)*3.5,
                col:'#ffaa00',r:10,isBoss:true});
            }
            for(let a=0;a<arms;a++){
              const ga=boss._oblRot+a*(Math.PI*2/arms)+Math.PI/arms;
              for(let rd=25;rd<170;rd+=26)
                particles.push({x:cx+Math.cos(ga)*rd,y:cy+Math.sin(ga)*rd,
                  vx:0,vy:0,r:8,al:0.9,col:'#ffdd88'});
            }
          } else if(boss._oblAtk===2){
            // Phase C: Side jets, 220px center safe
            const safe=110;
            for(let gy=boss.y+boss.h+10;gy<GH;gy+=16){
              eBullets.push({x:0,y:gy,vx:0,vy:0,col:'#ff6600',r:10,isBoss:true,_tT:60,_aVy:0,_aVx:5.8});
              eBullets.push({x:GW,y:gy,vx:0,vy:0,col:'#ff6600',r:10,isBoss:true,_tT:60,_aVy:0,_aVx:-5.8});
            }
            for(let gy=boss.y+boss.h+10;gy<GH;gy+=24)
              particles.push({x:GW/2-safe+Math.random()*safe*2,y:gy,vx:0,vy:0,r:6,al:0.9,col:'#ffdd44'});
          } else {
            // Phase D: Double ring 4 gaps each offset 45¬∞
            [[2.0,0],[3.0,Math.PI/4]].forEach(([spd,off])=>{
              const gaps=4,gSz=Math.PI*0.24;
              for(let b2=0;b2<40;b2++){
                const ang=(b2/40)*Math.PI*2;
                let safe=false;
                for(let g=0;g<gaps;g++){
                  const ga=(boss._oblRot||0)+off+g*(Math.PI*2/gaps);
                  const d=Math.abs(((ang-ga+Math.PI*3)%(Math.PI*2))-Math.PI);
                  if(d<gSz){safe=true;break;}
                }
                if(safe)continue;
                eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                  col:'#ffaa44',r:9,isBoss:true});
              }
            });
            const gaps=4;
            for(let g=0;g<gaps;g++){
              const ga=(boss._oblRot||0)+g*(Math.PI*2/gaps);
              for(let rd=22;rd<160;rd+=24)
                particles.push({x:cx+Math.cos(ga)*rd,y:cy+Math.sin(ga)*rd,
                  vx:0,vy:0,r:7,al:0.9,col:'#ffcc88'});
            }
          }
        }

        // ‚ïê‚ïê‚ïê‚ïê TIER 24: DREAD DECANTER ‚Äî dread_rain ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Thick diagonal rain from top-left AND top-right simultaneously.
        // Safe zone is a narrow V-shape in the centre bottom.
        if(sp==='dread_rain'){
          sfxHeatWave();
          const safeBase=GW/2,safeW=140;
          for(let bx3=0;bx3<GW;bx3+=14){
            const dy=Math.abs(bx3-safeBase);
            if(dy<safeW/2)continue; // V-safe zone
            eBullets.push({x:bx3,y:boss.y+boss.h+10,vx:(bx3<GW/2)?0.8:-0.8,vy:0,
              col:'#ff3333',r:10,isBoss:true,_tT:55,_aVy:4.8});
          }
          for(let bx3=safeBase-safeW/2;bx3<safeBase+safeW/2;bx3+=22)
            for(let gy=boss.y+boss.h+10;gy<GH;gy+=28)
              particles.push({x:bx3+Math.random()*22,y:gy,vx:0,vy:0,r:6,al:0.8,col:'#ff8888'});
        }

        // ‚ïê‚ïê‚ïê‚ïê TIER 25: COSMIC CRISPER ‚Äî cosmic_cross ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // A rotating plus-sign of dense bullet walls.
        // The 4 diagonal sectors are ALWAYS clear ‚Äî 45¬∞/135¬∞/225¬∞/315¬∞.
        if(sp==='cosmic_cross'){
          sfxBossLaserSfx();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          boss._ccRot=(boss._ccRot||0)+Math.PI/6;
          // Arms at 0¬∞/90¬∞/180¬∞/270¬∞ rotated by _ccRot, diagonals always safe
          for(let b2=0;b2<52;b2++){
            const ang=(b2/52)*Math.PI*2;
            const rel=((ang-boss._ccRot)%(Math.PI/2)+Math.PI/2)%(Math.PI/2);
            // Safe if within 30¬∞ of diagonal (rel near PI/4)
            const dDiag=Math.abs(rel-Math.PI/4);
            if(dDiag<Math.PI*0.22)continue;
            const spd=3.0+Math.random()*0.5;
            eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
              col:'#44ffdd',r:10,isBoss:true});
          }
          for(let d=0;d<4;d++){
            const da=boss._ccRot+Math.PI/4+d*(Math.PI/2);
            for(let rd=22;rd<170;rd+=24)
              particles.push({x:cx+Math.cos(da)*rd,y:cy+Math.sin(da)*rd,
                vx:0,vy:0,r:7,al:0.95,col:'#88ffee'});
          }
        }

        // ‚ïê‚ïê‚ïê‚ïê TIER 26: VOID CASSEROLE ‚Äî void_cage ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Shrinking cage of bullets closes in from all 4 sides.
        // Centre safe zone shrinks slowly ‚Äî player must dodge out
        // through ONE side that's left open (telegraphed in purple).
        if(sp==='void_cage'){
          sfxIceRing();
          const openSide=Math.floor(Math.random()*4); // 0=top,1=bot,2=left,3=right
          const sideColors=['#aa88ff','#aa88ff','#aa88ff','#aa88ff'];
          // Horizontal walls (top and bottom)
          for(let bx3=30;bx3<GW-30;bx3+=16){
            // Top wall ‚Äî open if openSide===0
            if(openSide!==0)
              eBullets.push({x:bx3,y:boss.y+boss.h+15,vx:0,vy:0,
                col:'#aa88ff',r:9,isBoss:true,_tT:70,_aVy:3.5});
            // Bottom of screen flowing upward ‚Äî not used; instead use slow top wall
          }
          // Vertical walls (left and right)
          for(let gy=boss.y+boss.h+30;gy<GH-30;gy+=16){
            if(openSide!==2) // left
              eBullets.push({x:20,y:gy,vx:0,vy:0,col:'#aa88ff',r:9,isBoss:true,_tT:70,_aVy:0,_aVx:3.5});
            if(openSide!==3) // right
              eBullets.push({x:GW-20,y:gy,vx:0,vy:0,col:'#aa88ff',r:9,isBoss:true,_tT:70,_aVy:0,_aVx:-3.5});
          }
          // Show open side in green
          const openLabel=['TOP','BOTTOM','LEFT','RIGHT'][openSide];
          const openX=openSide===2?40:(openSide===3?GW-40:GW/2);
          const openY=openSide===0?boss.y+boss.h+30:GH-50;
          for(let i=0;i<8;i++)
            particles.push({x:openX+Math.random()*60-30,y:openY+Math.random()*40-20,
              vx:0,vy:0,r:9,al:0.95,col:'#88ff88'});
        }

        // ‚ïê‚ïê‚ïê‚ïê TIER 27: ENTROPY ENGINE ‚Äî entropy_storm ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 5-phase rotating chaos. Gets faster each phase.
        // Always at least one clearly marked safe corridor.
        if(sp==='entropy_storm'){
          if(!boss._entAtk)boss._entAtk=0;
          boss._entAtk=(boss._entAtk+1)%5;
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          boss._entRot=(boss._entRot||0)+Math.PI/6;

          const phase=boss._entAtk;
          if(phase<3){
            // Phases 0-2: rotating ring with (3-phase) gaps
            const numGaps=3-phase; // 3,2,1 gaps
            const gSz=Math.PI/(numGaps+1.5);
            const gAngles=Array.from({length:numGaps},(_,i)=>boss._entRot+i*(Math.PI*2/numGaps));
            const spd=2.8+phase*0.6;
            for(let b2=0;b2<44;b2++){
              const ang=(b2/44)*Math.PI*2;
              if(gAngles.some(g=>Math.abs(((ang-g+Math.PI*3)%(Math.PI*2))-Math.PI)<gSz))continue;
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                col:'#ff6644',r:10,isBoss:true});
            }
            gAngles.forEach(ga=>{
              for(let rd=22;rd<165;rd+=24)
                particles.push({x:cx+Math.cos(ga)*rd,y:cy+Math.sin(ga)*rd,
                  vx:0,vy:0,r:7,al:0.9,col:'#ffaa88'});
            });
          } else if(phase===3){
            // Phase 3: Column rain 2 corridors
            const c1=80+Math.floor(Math.random()*200);
            const c2=c1+240;
            for(let bx3=0;bx3<GW;bx3+=13){
              if((bx3>=c1&&bx3<=c1+100)||(bx3>=c2&&bx3<=c2+100))continue;
              eBullets.push({x:bx3,y:boss.y+boss.h+10,vx:0,vy:0,
                col:'#ff6644',r:10,isBoss:true,_tT:52,_aVy:5.8});
            }
            [[c1,100],[c2,100]].forEach(([cx2,cw])=>{
              for(let gy=boss.y+boss.h+10;gy<GH;gy+=24)
                particles.push({x:cx2+Math.random()*cw,y:gy,vx:0,vy:0,r:5,al:0.85,col:'#ffaa88'});
            });
          } else {
            // Phase 4: Side walls, centre 160px safe
            const safe=80;
            for(let gy=boss.y+boss.h+10;gy<GH;gy+=15){
              eBullets.push({x:0,y:gy,vx:0,vy:0,col:'#ff6644',r:10,isBoss:true,_tT:60,_aVy:0,_aVx:6.0});
              eBullets.push({x:GW,y:gy,vx:0,vy:0,col:'#ff6644',r:10,isBoss:true,_tT:60,_aVy:0,_aVx:-6.0});
            }
            for(let gy=boss.y+boss.h+10;gy<GH;gy+=22)
              particles.push({x:GW/2-safe+Math.random()*safe*2,y:gy,vx:0,vy:0,r:6,al:0.9,col:'#ffaa88'});
          }
        }

        // ‚ïê‚ïê‚ïê‚ïê TIER 28: OMEGA COLANDER ‚Äî omega_holes ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 12 spinning bullet streams (like a clock face).
        // Every other stream has a gap ‚Äî 6 safe lanes always present.
        // Streams rotate between uses so lanes shift.
        if(sp==='omega_holes'){
          sfxBossLaserSfx();
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          boss._ohRot=(boss._ohRot||0)+Math.PI/8;
          const streams=12;
          for(let s=0;s<streams;s++){
            if(s%2===0)continue; // every other stream is a gap
            const ang=boss._ohRot+s*(Math.PI*2/streams);
            for(let dist=0;dist<4;dist++){
              const a=ang+(dist-1.5)*0.12;
              eBullets.push({x:cx,y:cy,vx:Math.cos(a)*3.5,vy:Math.sin(a)*3.5,
                col:'#ffffff',r:10,isBoss:true});
            }
          }
          // Show safe stream angles
          for(let s=0;s<streams;s+=2){
            const sAng=boss._ohRot+s*(Math.PI*2/streams);
            for(let rd=22;rd<175;rd+=26)
              particles.push({x:cx+Math.cos(sAng)*rd,y:cy+Math.sin(sAng)*rd,
                vx:0,vy:0,r:8,al:0.95,col:'#cccccc'});
          }
        }

        // ‚ïê‚ïê‚ïê‚ïê TIER 29: PRIMORDIAL TUPPERWARE ‚Äî primordial ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // THE FINAL BOSS. Cycles through 5 devastating attacks.
        // Each is unique and escalates. All have a fair escape.
        if(sp==='primordial'){
          if(!boss._primAtk)boss._primAtk=0;
          boss._primAtk=(boss._primAtk+1)%5;
          const cx=boss.x+boss.w/2,cy=boss.y+boss.h;
          boss._primRot=(boss._primRot||0)+Math.PI/7;

          if(boss._primAtk===0){
            // GENESIS: 8-gap ring expanding from boss ‚Äî biggest ring yet
            const gaps=8,gSz=Math.PI*0.18;
            const gAs=Array.from({length:gaps},(_,i)=>boss._primRot+i*(Math.PI*2/gaps));
            for(let b2=0;b2<60;b2++){
              const ang=(b2/60)*Math.PI*2;
              if(gAs.some(g=>Math.abs(((ang-g+Math.PI*3)%(Math.PI*2))-Math.PI)<gSz))continue;
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*3.5,vy:Math.sin(ang)*3.5,
                col:'#ff0000',r:11,isBoss:true});
            }
            gAs.forEach(ga=>{
              for(let rd=20;rd<180;rd+=22)
                particles.push({x:cx+Math.cos(ga)*rd,y:cy+Math.sin(ga)*rd,
                  vx:0,vy:0,r:8,al:1.0,col:'#ff8888'});
            });
          } else if(boss._primAtk===1){
            // APOCALYPSE COLUMNS: full-width rain, 4 narrow corridors
            const cors=[[GW*0.06,70],[GW*0.31,70],[GW*0.58,70],[GW*0.82,70]];
            for(let bx3=0;bx3<GW;bx3+=12){
              if(cors.some(([cx2,cw])=>bx3>=cx2&&bx3<=cx2+cw))continue;
              eBullets.push({x:bx3,y:boss.y+boss.h+10,vx:0,vy:0,
                col:'#ff0000',r:11,isBoss:true,_tT:45,_aVy:6.2});
            }
            cors.forEach(([cx2,cw])=>{
              for(let gy=boss.y+boss.h+10;gy<GH;gy+=22)
                particles.push({x:cx2+Math.random()*cw,y:gy,vx:0,vy:0,r:6,al:0.95,col:'#ff8888'});
            });
          } else if(boss._primAtk===2){
            // PRIMEVAL JETS: walls from all 3 sides (L+R+top), bottom safe
            for(let gy=boss.y+boss.h+10;gy<GH*0.6;gy+=14){
              eBullets.push({x:0,y:gy,vx:0,vy:0,col:'#ff0000',r:11,isBoss:true,_tT:55,_aVy:0,_aVx:6.0});
              eBullets.push({x:GW,y:gy,vx:0,vy:0,col:'#ff0000',r:11,isBoss:true,_tT:55,_aVy:0,_aVx:-6.0});
            }
            for(let bx3=0;bx3<GW;bx3+=14)
              eBullets.push({x:bx3,y:boss.y+boss.h+10,vx:0,vy:0,
                col:'#ff0000',r:11,isBoss:true,_tT:55,_aVy:5.5});
            // Safe zone: bottom quarter of screen
            for(let gy=GH*0.7;gy<GH;gy+=24)
              for(let bx3=50;bx3<GW-50;bx3+=50)
                particles.push({x:bx3+Math.random()*50,y:gy,vx:0,vy:0,r:6,al:0.9,col:'#ff6666'});
          } else if(boss._primAtk===3){
            // EXTINCTION SPIRAL: 6-armed fast spiral, 6 clear lanes
            const lanes=6;
            for(let b2=0;b2<60;b2++){
              const ang=(b2/60)*Math.PI*2+boss._primRot;
              const norm=((ang-boss._primRot)%(Math.PI*2/lanes)+Math.PI*2/lanes)%(Math.PI*2/lanes);
              const frac=norm/(Math.PI*2/lanes);
              if(frac>0.35&&frac<0.65)continue; // centre 30% of each sector is safe
              eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*3.8,vy:Math.sin(ang)*3.8,
                col:'#ff0000',r:11,isBoss:true});
            }
            for(let l=0;l<lanes;l++){
              const la=boss._primRot+l*(Math.PI*2/lanes)+Math.PI/lanes;
              for(let rd=20;rd<185;rd+=25)
                particles.push({x:cx+Math.cos(la)*rd,y:cy+Math.sin(la)*rd,
                  vx:0,vy:0,r:8,al:1.0,col:'#ff6666'});
            }
          } else {
            // THE END: Triple concentric rings, each offset, 3 gaps each
            [[2.2,0,Math.PI*0.25],[3.0,Math.PI/3,Math.PI*0.22],[3.8,Math.PI*2/3,Math.PI*0.20]].forEach(([spd,off,gSz])=>{
              const gaps=3;
              const gAs=Array.from({length:gaps},(_,i)=>boss._primRot+off+i*(Math.PI*2/gaps));
              for(let b2=0;b2<44;b2++){
                const ang=(b2/44)*Math.PI*2;
                if(gAs.some(g=>Math.abs(((ang-g+Math.PI*3)%(Math.PI*2))-Math.PI)<gSz))continue;
                eBullets.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,
                  col:'#ff0000',r:11,isBoss:true});
              }
            });
            // Safe angles (intersections of all 3 rings)
            for(let g=0;g<3;g++){
              const ga=boss._primRot+g*(Math.PI*2/3);
              for(let rd=20;rd<190;rd+=24)
                particles.push({x:cx+Math.cos(ga)*rd,y:cy+Math.sin(ga)*rd,
                  vx:0,vy:0,r:9,al:1.0,col:'#ff4444'});
            }
          }
        }

    // ‚îÄ‚îÄ Normal boss shots: reduce volume at high levels to stay fair ‚îÄ‚îÄ
    // (already handled above, nothing extra needed)
  }

  // Move projectiles (dt-scaled)
  for(const b of bullets)b.y+=b.vy*dt;
  bullets=bullets.filter(b=>b.y>-20);
  for(const b of eBullets){
    // Telegraph system: _tT = warning frames (stationary), then _aVy/_aVx kick in
    if(b._tT!==undefined&&b._tT>0){
      b._tT-=dt;
      if(b._tT<=0){
        if(b._aVy!==undefined)b.vy=b._aVy;
        if(b._aVx!==undefined)b.vx=b._aVx;
        b._tT=undefined; // done telegraphing
      }
    }
    b.y+=b.vy*dt;b.x+=(b.vx||0)*dt;
  }
  eBullets=eBullets.filter(b=>b.y<GH+20&&b.x>-30&&b.x<GW+30);

  // Player bullets hit enemies/boss
  bullets=bullets.filter(b=>{
    for(let i=enemies.length-1;i>=0;i--){const e=enemies[i];if(b.x>e.x&&b.x<e.x+e.w&&b.y>e.y&&b.y<e.y+e.h){hitEnemy(i,1,b.x,b.y);return false;}}
    if(boss&&b.x>boss.x&&b.x<boss.x+boss.w&&b.y>boss.y&&b.y<boss.y+boss.h){hitBoss(1,b.x,b.y);return false;}
    return true;
  });

  // Enemy bullets hit player
  eBullets=eBullets.filter(b=>{
    if(b.x>player.x&&b.x<player.x+player.w&&b.y>player.y&&b.y<player.y+player.h){
      burst(b.x,b.y,'#ff6b35',8);takeDmg(1);return false;
    }
    return true;
  });

  // Particles
  for(const p of particles){p.x+=p.vx*dt;p.y+=p.vy*dt;p.vy+=.09*dt;p.al-=.022*dt;}
  particles=particles.filter(p=>p.al>0);

  // Heart drops
  for(const h of heartDrops)h.y+=h.vy*dt;
  heartDrops=heartDrops.filter(h=>h.y<GH+20);
  // Player collects hearts
  heartDrops=heartDrops.filter(h=>{
    if(player&&h.x+h.r>player.x&&h.x<player.x+player.w&&h.y+h.r>player.y&&h.y<player.y+player.h){
      lives=Math.min(5,lives+1);updateHUD();sfxBubbleActivate();achOnHeart();STATS.totalHeartsCollected++;
      floatTexts.push({x:h.x,y:h.y,vy:-2,al:1.5,txt:'‚ô• +1',col:'#ff2244'});
      return false;
    }
    return true;
  });

  // Floating score texts
  for(const f of floatTexts){f.y+=f.vy*dt;f.al-=0.025*dt;}
  floatTexts=floatTexts.filter(f=>f.al>0);

  draw();
  animId=requestAnimationFrame(loop);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HIT HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hitEnemy(i,dmg,hx,hy){
  const e=enemies[i];burst(hx,hy,e.col,5);e.hp-=dmg;
  if(e.hp<=0){
    const pts=10*curLevel;
    burst(e.x+e.w/2,e.y+e.h/2,e.col,18);
    if(!anyCheatsOn()){score+=pts;updateHUD();achOnScore(score);}
    STATS.totalKills++;STATS.totalDamageDealt+=pts;
    const _tkn=['basic','armor','speedy','tank','bomber','ghost'];
    if(e.ti!==undefined&&_tkn[e.ti])STATS.killsByType[_tkn[e.ti]]++;
    achOnKill();
    sfxExplode(false);
    // Floating score text (show CHEAT if scoring disabled)
    floatTexts.push({x:e.x+e.w/2,y:e.y,vy:-1.2,al:1,
      txt:anyCheatsOn()?'CHEAT':'+'+pts,
      col:anyCheatsOn()?'#ff4444':'#ffd166'});
    // Rare heart drop ~3%
    if(lives<5&&Math.random()<0.03){
      heartDrops.push({x:e.x+e.w/2-6,y:e.y,vy:1.5,r:12});
    }
    enemies.splice(i,1);
  }
}
function hitBoss(dmg,hx,hy){
  const d=CHEATS.megaDmg?300:dmg;
  burst(hx,hy,'#ff6b35',6);boss.hp-=d;boss.shk=6;
  if(boss.hp<=0)bossDefeated();
}
function laserDmg(cx){
  // 1hp per frame (constant damage beam)
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];if(cx>e.x&&cx<e.x+e.w){burst(cx,e.y+e.h/2,e.col,1);e.hp-=1;
      if(e.hp<=0){
        const pts=10*curLevel;
        burst(e.x+e.w/2,e.y+e.h/2,e.col,14);
        if(!anyCheatsOn()){score+=pts;updateHUD();achOnScore(score);}
        STATS.totalKills++;STATS.totalLaserKills++;STATS.totalDamageDealt+=10*curLevel;
        const _tN=['basic','armor','speedy','tank','bomber','ghost'];
        if(e.ti!==undefined&&_tN[e.ti])STATS.killsByType[_tN[e.ti]]++;
        achOnKill();achOnLaserKill();
        sfxExplode(false);
        floatTexts.push({x:e.x+e.w/2,y:e.y,vy:-1.2,al:1,
          txt:anyCheatsOn()?'CHEAT':'+'+pts,
          col:anyCheatsOn()?'#ff4444':'#ffd166'});
        if(lives<5&&Math.random()<0.03)heartDrops.push({x:e.x+e.w/2-6,y:e.y,vy:1.5,r:12});
        enemies.splice(i,1);
      }
    }
  }
  if(boss&&cx>boss.x&&cx<boss.x+boss.w){const _ld=CHEATS.megaDmg?300:1;burst(cx,boss.y+boss.h/2,'#ff6b35',2);boss.hp-=_ld;boss.shk=1;if(boss.hp<=0)bossDefeated();}
}

function bossDefeated(){
  if(!boss)return; // guard against double-call
  const bx=boss.x,by=boss.y,bw=boss.w,bh=boss.h;
  const bonus=Math.floor(500+curLevel*200);if(!anyCheatsOn()){score+=bonus;updateHUD();achOnScore(score);}
  burst(bx+bw/2,by+bh/2,'#ff6b35',55);burst(bx+bw/2,by+bh/2,'#ffd166',40);
  // Kill boss completely before anything else
  achOnBossDefeated(getTierIdx());STATS.totalBossesDefeated++;
  boss=null;bossUp=false;bossOut=true;bLaserOn=false;
  if(bossCountdownTO){clearTimeout(bossCountdownTO);bossCountdownTO=null;}
  stopBGM();sfxBossWin();
  // Stop the game loop
  running=false;cancelAnimationFrame(animId);
  const nextLvl=Math.min(MAX_LEVEL,curLevel+1);
  unlock(nextLvl);
  const isLast=(curLevel>=MAX_LEVEL);
  showMsg(isLast?'** VICTORY! **':'BOSS SLAIN!\n+'+bonus+' PTS',2200);
  setTimeout(()=>showLevelComplete(isLast),2400);
}

function levelComplete(){
  // Called when all waves clear on a non-boss level
  if(bossOut)return; // guard
  bossOut=true;
  running=false;cancelAnimationFrame(animId);stopBGM();sfxLevelUp();
  const nextLvl=Math.min(MAX_LEVEL,curLevel+1);unlock(nextLvl);achOnLevelComplete(curLevel);achOnWaveComplete();
  STATS.totalLevelsCompleted++;STATS.highestLevel=Math.max(STATS.highestLevel,curLevel);
  if(!anyCheatsOn())STATS.highestScore=Math.max(STATS.highestScore,score);
  STATS.totalWavesCleared++;saveStats();
  setTimeout(()=>showLevelComplete(curLevel>=MAX_LEVEL),800);
}

function showLevelComplete(isVictory){
  hideMsg();
  document.getElementById('controls').style.display='none';
  document.getElementById('hud-bar').style.display='none';
  document.getElementById('hint').style.display='none';
  const modal=document.getElementById('lvlcomplete-modal');
  if(!modal){return;}
  const titleEl=document.getElementById('lc-title');
  const subEl  =document.getElementById('lc-sub');
  const scoreEl=document.getElementById('lc-score');
  const contBtn=document.getElementById('lc-continue');
  if(isVictory){
    titleEl.textContent='** YOU WIN! **';
    titleEl.style.color='#ffd166';
    subEl.textContent='All 150 levels conquered!';
    contBtn.textContent='‚ñ∂ PLAY AGAIN';
    contBtn.onclick=()=>{modal.classList.remove('show');beginLevel(1);};
  } else {
    const nl=curLevel+1;
    titleEl.textContent='LEVEL '+curLevel+' DONE!';
    titleEl.style.color='#00ff88';
    subEl.textContent='Next: Level '+nl+(nl%5===0?' [BOSS STAGE]':'');
    contBtn.textContent='‚ñ∂ LEVEL '+nl;
    contBtn.onclick=()=>{modal.classList.remove('show');beginLevel(nl);};
  }
  scoreEl.textContent='Score: '+score;
  modal.classList.add('show');
  resizeCanvas();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME OVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function qualifiesTop10(){
  if(score<=0)return false;
  if(highScores.length<10)return true;
  return score>highScores[highScores.length-1].score;
}
function doGameOver(){achOnDeath();STATS.totalDeaths++;saveStats();
  score=levelStartScore; // reset score to what it was at level start
  running=false;cancelAnimationFrame(animId);
  if(bossCountdownTO){clearTimeout(bossCountdownTO);bossCountdownTO=null;}
  bLaserOn=false;hideMsg();sfxGameOver();
  function showGOScreen(){
    document.getElementById('controls').style.display='none';
    document.getElementById('hud-bar').style.display='none';
    running=false;
    setTimeout(()=>{
      document.getElementById('main-menu').classList.remove('hidden');
    },2000);
    showMsg('GAME OVER\nLevel '+curLevel+'\nScore: '+score,2000);
    resizeCanvas();
  }
  setTimeout(()=>{
    if(qualifiesTop10()){
      const modal=document.getElementById('name-modal'),inp=document.getElementById('name-input');
      modal.classList.add('show');inp.value='';
      setTimeout(()=>{try{inp.focus();}catch(_){}},150);
      document.getElementById('name-ok').onclick=()=>{
        const nm=(inp.value.trim()||'Anonymous').slice(0,12);
        saveScore(nm,score);modal.classList.remove('show');showGOScreen();
      };
    } else {
      showGOScreen();
    }
  },800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OVERLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let msgTO=null;
function showMsg(t,d){const el=document.getElementById('overlay-msg');el.textContent=t;el.style.display='block';if(msgTO)clearTimeout(msgTO);if(d<99999)msgTO=setTimeout(()=>el.style.display='none',d);}
function hideMsg(){const el=document.getElementById('overlay-msg');el.style.display='none';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLAY BUTTON
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Main menu button wiring
document.getElementById('mm-play').addEventListener('click',()=>{sfxMenuClick();stopMMMusic();beginLevel(curLevel);});
document.getElementById('mm-levels').addEventListener('click',()=>{sfxMenuClick();document.getElementById('mm-levels').classList.add('pressed');lvlPage=Math.floor((curLevel-1)/30);buildLvlGrid();document.getElementById('levels-modal').classList.add('show');});
document.getElementById('mm-achievements').addEventListener('click',()=>{sfxMenuClick();
  buildAchGrid();
  document.getElementById('achievements-screen').style.display='flex';
  document.getElementById('main-menu').classList.add('hidden');
});
document.getElementById('scores-back-ach').addEventListener('click',()=>{
  document.getElementById('achievements-screen').style.display='none';
  document.getElementById('main-menu').classList.remove('hidden');
});
document.getElementById('mm-scores').addEventListener('click',()=>{sfxMenuClick();
  document.getElementById('scores-screen').style.display='flex';
});
document.getElementById('scores-back').addEventListener('click',()=>{
  document.getElementById('scores-screen').style.display='none';
});

// ‚îÄ‚îÄ SETTINGS WIRING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('mm-settings').addEventListener('click',()=>{sfxMenuClick();
  document.getElementById('settings-screen').style.display='flex';
});
document.getElementById('settings-back').addEventListener('click',()=>{sfxMenuBack();
  document.getElementById('settings-screen').style.display='none';
  if(!running)setTimeout(startMMMusic,100);
});
const volSlider=document.getElementById('vol-slider');
volSlider.addEventListener('input',()=>{
  const v=parseInt(volSlider.value);
  document.getElementById('vol-val').textContent=v;
  if(!audioMuted)setVolume(v);
  else audioVol=v/100;
});
document.getElementById('mute-btn').addEventListener('click',()=>setMute(!audioMuted));

// ‚îÄ‚îÄ CHEAT CODE WIRING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CHEAT_CODE='5529';
let cheatScreenOpen=false;
let cheatEntry='';

// Opens cheat screen FROM settings ‚Äî hides settings first
document.getElementById('set-cheats-btn').addEventListener('click',()=>{
  document.getElementById('settings-screen').style.display='none';
  openCheatScreen();
});

function openCheatScreen(){
  cheatScreenOpen=true;
  cheatEntry='';
  const scr=document.getElementById('cheat-screen');
  scr.style.display='flex';
  if(cheatUnlocked){
    document.getElementById('cheat-options').style.display='flex';
    document.getElementById('cheat-warn').style.display=anyCheatsOn()?'block':'none';
    document.getElementById('cheat-lock-msg').style.display='none';
    document.getElementById('cheat-input-display').style.display='none';
    if(window._cheatPad)window._cheatPad.style.display='none';
  } else {
    document.getElementById('cheat-options').style.display='none';
    document.getElementById('cheat-warn').style.display='none';
    document.getElementById('cheat-lock-msg').style.display='block';
    document.getElementById('cheat-input-display').style.display='block';
    if(window._cheatPad)window._cheatPad.style.display='grid';
    updateCheatDisplay('');
  }
}

// Cheat back ‚Üí return to settings
document.getElementById('cheat-back').addEventListener('click',()=>{
  cheatScreenOpen=false;
  document.getElementById('cheat-screen').style.display='none';
  document.getElementById('settings-screen').style.display='flex';
});

function updateCheatDisplay(str){
  const disp=document.getElementById('cheat-input-display');
  const pad=str.padEnd(4,'_');
  disp.textContent=pad.split('').join(' ');
}

// Keyboard digit entry on cheat screen
document.addEventListener('keydown',ev=>{
  if(!cheatScreenOpen||cheatUnlocked)return;
  if('0123456789'.includes(ev.key)){
    cheatEntry=(cheatEntry+ev.key).slice(-4);
    updateCheatDisplay(cheatEntry);
    if(cheatEntry===CHEAT_CODE){
      cheatUnlocked=true;
      cheatEntry='';
      const disp=document.getElementById('cheat-input-display');
      disp.style.color='#00ff88';
      disp.textContent='‚úì UNLOCKED';
      setTimeout(()=>{
        document.getElementById('cheat-options').style.display='flex';
        document.getElementById('cheat-lock-msg').style.display='none';
        disp.style.display='none';
      },600);
      sfxBossWin&&sfxBossWin();
    }
  } else if(ev.code==='Backspace'){
    cheatEntry=cheatEntry.slice(0,-1);
    updateCheatDisplay(cheatEntry);
  }
});

// On-screen digit pad for mobile (inject buttons into cheat screen)
(function buildCheatPad(){
  const scr=document.getElementById('cheat-screen');
  const pad=document.createElement('div');
  pad.id='cheat-pad';
  pad.style.cssText='display:grid;grid-template-columns:repeat(3,1fr);gap:6px;width:min(220px,80vw);margin-top:4px;';
  [1,2,3,4,5,6,7,8,9,'‚Üê',0,''].forEach(k=>{
    const btn=document.createElement('button');
    btn.textContent=k===''?'':String(k);
    btn.style.cssText="padding:10px 0;font-family:'Press Start 2P',monospace;font-size:0.55rem;background:#111;border:2px solid #333;color:"+(k==='‚Üê'?'#ff6600':'#ffd166')+";cursor:pointer;";
    if(k==='')btn.style.visibility='hidden';
    btn.addEventListener('click',()=>{
      if(!cheatScreenOpen||cheatUnlocked)return;
      if(k==='‚Üê'){cheatEntry=cheatEntry.slice(0,-1);}
      else if(k!==''){cheatEntry=(cheatEntry+String(k)).slice(-4);}
      updateCheatDisplay(cheatEntry);
      if(cheatEntry===CHEAT_CODE){
        cheatUnlocked=true;cheatEntry='';
        const disp=document.getElementById('cheat-input-display');
        disp.style.color='#00ff88';disp.textContent='‚úì UNLOCKED';
        setTimeout(()=>{
          document.getElementById('cheat-options').style.display='flex';
          document.getElementById('cheat-lock-msg').style.display='none';
          disp.style.display='none';
          pad.style.display='none';
        },600);
        sfxBossWin&&sfxBossWin();
      }
    });
    pad.appendChild(btn);
  });
  // Insert pad before back button
  const backBtn=document.getElementById('cheat-back');
  scr.insertBefore(pad,backBtn);
  // Hide pad when unlocked
  const _origOpen=openCheatScreen;
  // patch openCheatScreen to also toggle pad visibility
  window._cheatPad=pad;
})();

// _cheatPad visibility is handled inside openCheatScreen via window._cheatPad set above

// Cheat toggle buttons
function toggleCheat(id,key){
  CHEATS[key]=!CHEATS[key];
  if(CHEATS[key])achOnCheat();
  document.getElementById(id).classList.toggle('on',CHEATS[key]);
  document.getElementById('cheat-warn').style.display=anyCheatsOn()?'block':'none';
  if(key==='unlockAll'&&CHEATS.unlockAll)applyCheatUnlockAll();
}
document.getElementById('cheat-unlockall').addEventListener('click',()=>toggleCheat('cheat-unlockall','unlockAll'));
document.getElementById('cheat-infhealth').addEventListener('click',()=>toggleCheat('cheat-infhealth','infHealth'));
document.getElementById('cheat-infpower').addEventListener('click',()=>toggleCheat('cheat-infpower','infPower'));
document.getElementById('cheat-megadmg').addEventListener('click',()=>toggleCheat('cheat-megadmg','megaDmg'));
// Difficulty buttons in main menu
// Difficulty button wiring ‚Äî single source of truth
function setDiff(d){
  diff=d;
  document.querySelectorAll('.mm-diff-btn').forEach(x=>x.classList.toggle('sel',x.dataset.d===d));
  const dv=document.getElementById('hud-diff-val');
  if(dv){
    dv.textContent=d.toUpperCase();
    dv.style.color=d==='easy'?'#06d6a0':d==='hard'?'#ff4444':'#ff9f1c';
  }
}
// Wire difficulty buttons (now inside settings screen only)
document.querySelectorAll('#set-diff .mm-diff-btn').forEach(b=>{
  b.addEventListener('click',()=>setDiff(b.dataset.d));
});
setDiff('easy'); // ensure initial state is consistent
// HUD pause button
document.getElementById('hud-pause-btn').addEventListener('click',()=>{if(running)doPause();});
// Legacy play-btn (keep for safety)
const _legacyPlay=document.getElementById('play-btn');
if(_legacyPlay)_legacyPlay.addEventListener('click',()=>beginLevel(curLevel));

// Level complete modal buttons
document.getElementById('lc-levels').addEventListener('click',()=>{
  document.getElementById('lvlcomplete-modal').classList.remove('show');
  buildLvlGrid();document.getElementById('levels-modal').classList.add('show');
});
document.getElementById('lc-menu').addEventListener('click',()=>{
  document.getElementById('lvlcomplete-modal').classList.remove('show');
  document.getElementById('controls').style.display='none';
  document.getElementById('hud-bar').style.display='none';
  document.getElementById('main-menu').classList.remove('hidden');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAW ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function lc(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgb(${Math.min(255,r+a)},${Math.min(255,g+a)},${Math.min(255,b+a)})`;}
function dc(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgb(${Math.max(0,r-a)},${Math.max(0,g-a)},${Math.max(0,b-a)})`;}

// Rich parallax star field + nebula clouds
const STARS_A=Array.from({length:80},(_,i)=>({x:(i*7919+11111)%GW,y:(i*6173+22222)%GH}));
const STARS_B=Array.from({length:45},(_,i)=>({x:(i*5231+33333)%GW,y:(i*4127+44444)%GH}));
const STARS_C=Array.from({length:14},(_,i)=>({x:(i*3719+55555)%GW,y:(i*2917+66666)%GH}));
// Nebula blobs
const NEBULA=[
  {x:GW*.15,y:GH*.20,rx:110,ry:65,r:14,g:0,b:30,a:.32},
  {x:GW*.75,y:GH*.12,rx:90, ry:55,r:0, g:10,b:25,a:.28},
  {x:GW*.50,y:GH*.55,rx:140,ry:80,r:18,g:0,b:20,a:.38},
  {x:GW*.85,y:GH*.72,rx:80, ry:60,r:0, g:8, b:20,a:.25},
  {x:GW*.08,y:GH*.78,rx:70, ry:50,r:20,g:0,b:22,a:.22},
];
let bgT=0;
function drawBG(){
  ctx.fillStyle='#00000a';ctx.fillRect(0,0,GW,GH);
  // Nebula ellipses
  NEBULA.forEach(n=>{
    const pulse=0.85+0.15*Math.sin(bgT*.003+n.x);
    for(let dy=-n.ry;dy<=n.ry;dy+=3){
      const f=1-(dy/n.ry)**2;const hw=n.rx*Math.sqrt(Math.max(0,f));
      ctx.globalAlpha=n.a*f*pulse;
      ctx.fillStyle=`rgb(${n.r},${n.g},${n.b})`;
      ctx.fillRect(Math.floor(n.x-hw),Math.floor(n.y+dy),Math.ceil(hw*2),3);
    }
  });
  // Far stars (slow scroll)
  const s1=(bgT*.12)%GH;
  ctx.globalAlpha=1;
  for(const s of STARS_A){const sy=(s.y+s1)%GH;ctx.globalAlpha=.3+.15*Math.sin(bgT*.001+s.x);ctx.fillStyle='#334477';ctx.fillRect(s.x,sy,1,1);}
  // Mid stars
  const s2=(bgT*.28)%GH;
  for(const s of STARS_B){const sy=(s.y+s2)%GH;ctx.globalAlpha=.5+.2*Math.sin(bgT*.0015+s.y);ctx.fillStyle='#5577aa';ctx.fillRect(s.x,sy,2,2);}
  // Near stars (twinkle, no scroll)
  for(const s of STARS_C){
    const tw=Math.sin(bgT*.003+s.x*.1);ctx.globalAlpha=.65+.35*tw;
    ctx.fillStyle='#ffffff';ctx.fillRect(s.x,s.y,3,3);
    if(tw>.6){ctx.globalAlpha=.35;ctx.fillStyle='#aaddff';ctx.fillRect(s.x-1,s.y+1,1,3);ctx.fillRect(s.x+3,s.y+1,1,3);}
  }
  ctx.globalAlpha=1;
  // Scanlines
  ctx.fillStyle='rgba(0,0,0,0.07)';for(let sy=0;sy<GH;sy+=4)ctx.fillRect(0,sy,GW,2);
  // Nebula colour tint bands (very faint horizontal gradient)
  const bandA=0.04+0.02*Math.sin(bgT*.002);
  ctx.globalAlpha=bandA;ctx.fillStyle='#110022';ctx.fillRect(0,0,GW,GH*.4);
  ctx.globalAlpha=bandA*.7;ctx.fillStyle='#000c22';ctx.fillRect(0,GH*.6,GW,GH*.4);
  ctx.globalAlpha=1;
  bgT++;
}

// ‚îÄ‚îÄ Enemy drawing (6 distinct sprite styles) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawEnemy(e){
  const{x,y,w,h,col,drk,lit,ti,hp,maxHp}=e;

  if(ti===0){
    // BASIC ‚Äî clean rectangular tupperware
    ctx.fillStyle=col;ctx.fillRect(x+4,y+12,w-8,h-14);
    ctx.fillStyle=drk;ctx.fillRect(x,y+12,4,h-14);ctx.fillRect(x+w-4,y+12,4,h-14);ctx.fillRect(x+4,y+h-4,w-8,4);
    ctx.fillStyle=lit;ctx.fillRect(x,y+4,w,11);ctx.fillRect(x+4,y+13,5,h-22);
    ctx.fillStyle=drk;ctx.fillRect(x,y+4,w,3);ctx.fillRect(x,y+11,w,2);
    // Side clips
    ctx.fillStyle=lit;ctx.fillRect(x-5,y+6,5,8);ctx.fillRect(x+w,y+6,5,8);
    ctx.fillStyle=drk;ctx.fillRect(x-5,y+6,2,8);ctx.fillRect(x+w+3,y+6,2,8);
  } else if(ti===1){
    // ARMORED ‚Äî heavy plated box
    ctx.fillStyle='#7777aa';ctx.fillRect(x+2,y+10,w-4,h-12);
    ctx.fillStyle='#333355';ctx.fillRect(x,y+10,3,h-12);ctx.fillRect(x+w-3,y+10,3,h-12);ctx.fillRect(x+2,y+h-4,w-4,4);
    ctx.fillStyle='#9999bb';ctx.fillRect(x,y+4,w,10);
    ctx.fillStyle='#111133';ctx.fillRect(x,y+4,w,2);ctx.fillRect(x,y+10,w,2);
    // Armor plate rivets
    ctx.fillStyle='#ffd166';
    for(let bx=7;bx<w;bx+=11)ctx.fillRect(x+bx,y+h-9,4,4);
    // Plating horizontal lines
    ctx.fillStyle='#222244';
    ctx.fillRect(x+4,y+15,w-8,2);ctx.fillRect(x+4,y+25,w-8,2);ctx.fillRect(x+4,y+35,w-8,2);
    // Heavy side reinforcements
    ctx.fillStyle='#555577';ctx.fillRect(x-6,y+8,6,h-10);ctx.fillRect(x+w,y+8,6,h-10);
  } else if(ti===2){
    // SPEEDY ‚Äî slim aerodynamic can
    ctx.fillStyle=col;ctx.fillRect(x+7,y+8,w-14,h-10);
    ctx.fillStyle=drk;ctx.fillRect(x+3,y+8,4,h-10);ctx.fillRect(x+w-7,y+8,4,h-10);ctx.fillRect(x+7,y+h-3,w-14,3);
    ctx.fillStyle=lit;ctx.fillRect(x+3,y+3,w-6,8);
    ctx.fillStyle=drk;ctx.fillRect(x+3,y+3,w-6,2);ctx.fillRect(x+3,y+8,w-6,2);
    // Speed slash lines
    ctx.fillStyle=drk;
    for(let sl=0;sl<3;sl++)ctx.fillRect(x-10-sl*5,y+h/2-3+sl*6,7,2);
    ctx.fillRect(x+w+2,y+h*.3,7,2);ctx.fillRect(x+w+2,y+h*.5,5,2);
    // Fin wings
    ctx.fillStyle=lit;ctx.fillRect(x+3,y+h-14,6,10);ctx.fillRect(x+w-9,y+h-14,6,10);
  } else if(ti===3){
    // TANK ‚Äî massive fortress tub
    ctx.fillStyle=col;ctx.fillRect(x+2,y+14,w-4,h-16);
    ctx.fillStyle=drk;ctx.fillRect(x,y+14,2,h-16);ctx.fillRect(x+w-2,y+14,2,h-16);ctx.fillRect(x+2,y+h-4,w-4,4);
    ctx.fillStyle=lit;ctx.fillRect(x,y+6,w,12);
    ctx.fillStyle=drk;ctx.fillRect(x,y+6,w,3);ctx.fillRect(x,y+14,w,3);
    // Crown spikes
    ctx.fillStyle='#ff0040';
    [.12,.28,.5,.72,.88].forEach(p=>{const sx=Math.floor(x+p*w);ctx.fillRect(sx-3,y,6,9);ctx.fillRect(sx-1,y-5,2,5);});
    // Side heavy armor
    ctx.fillStyle=drk;ctx.fillRect(x-10,y+8,10,h-8);ctx.fillRect(x+w,y+8,10,h-8);
    ctx.fillStyle=lit;ctx.fillRect(x-10,y+8,4,h-8);ctx.fillRect(x+w,y+8,4,h-8);
  } else if(ti===4){
    // BOMBER ‚Äî round-bellied grenade tupperware
    ctx.fillStyle=col;ctx.fillRect(x+8,y+10,w-16,h-12);
    ctx.fillStyle=drk;ctx.fillRect(x+4,y+10,4,h-12);ctx.fillRect(x+w-8,y+10,4,h-12);ctx.fillRect(x+8,y+h-4,w-16,4);
    ctx.fillStyle=lit;ctx.fillRect(x+4,y+4,w-8,10);
    ctx.fillStyle=drk;ctx.fillRect(x+4,y+4,w-8,2);ctx.fillRect(x+4,y+10,w-8,2);
    // Fuse
    ctx.fillStyle='#ffff00';ctx.fillRect(x+w/2-2,y-6,4,9);ctx.fillRect(x+w/2+2,y-10,4,5);
    ctx.fillStyle='#ff6600';ctx.fillRect(x+w/2+1,y-13,5,4);
    // Warning stripes on belly
    ctx.fillStyle='#ff0000';
    for(let s=0;s<4;s++)ctx.fillRect(x+10+s*8,y+h-10,4,6);
  } else {
    // GHOST ‚Äî ethereal teal, semi-transparent
    ctx.globalAlpha=0.72;
    ctx.fillStyle=col;ctx.fillRect(x+6,y+10,w-12,h-12);
    ctx.fillStyle=drk;ctx.fillRect(x+2,y+10,4,h-12);ctx.fillRect(x+w-6,y+10,4,h-12);
    ctx.fillStyle=lit;ctx.fillRect(x+2,y+4,w-4,10);
    ctx.globalAlpha=1;
    // Shimmer highlight
    ctx.fillStyle='rgba(180,255,240,0.45)';ctx.fillRect(x+8,y+14,5,h-22);
    // Phase flicker effect
    if(Math.floor(Date.now()/300)%3===0){ctx.globalAlpha=0.18;ctx.fillStyle='#88ffee';ctx.fillRect(x,y,w,h);}
    ctx.globalAlpha=1;
  }

  // Universal eyes (all types share these, centered on face area)
  const eyY=y+Math.floor(h*.62);const eyL=x+Math.floor(w*.22);const eyR=x+Math.floor(w*.62);
  ctx.fillStyle='#ff0040';ctx.fillRect(eyL,eyY,9,9);ctx.fillRect(eyR,eyY,9,9);
  ctx.fillStyle='#ff8888';ctx.fillRect(eyL,eyY,3,3);ctx.fillRect(eyR,eyY,3,3);
  // Angry inner brows
  ctx.fillStyle='#aa0020';
  ctx.fillRect(eyL-2,eyY-5,11,3);ctx.fillRect(eyR-2,eyY-5,11,3);
  ctx.fillRect(eyL+9,eyY-8,4,4);ctx.fillRect(eyR-3,eyY-8,4,4);

  // HP bar if multi-hp
  if(maxHp>1){ctx.fillStyle='#111';ctx.fillRect(x,y+h+3,w,5);ctx.fillStyle='#00ff44';ctx.fillRect(x,y+h+3,w*(hp/maxHp),5);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOSS DRAWING ‚Äî 6 UNIQUE BOSSES THAT LOOK THEIR NAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Shared: boss laser beam renderer
function drawBossLaser(bx,y,w,h){
  if(!bLaserOn)return;
  const cx=Math.floor(bLaserX);
  const a=0.5+0.4*Math.sin(Date.now()*0.06);
  ctx.save();
  ctx.globalAlpha=a*0.18;ctx.fillStyle='#ff0040';ctx.fillRect(cx-28,y+h,56,GH);
  ctx.globalAlpha=a*0.55;ctx.fillStyle='#ff4466';ctx.fillRect(cx-10,y+h,20,GH);
  ctx.globalAlpha=a;
  for(let sy=y+h;sy<GH;sy+=16){ctx.fillStyle='#ff0000';ctx.fillRect(cx-4,sy,8,8);ctx.fillStyle='#ff8888';ctx.fillRect(cx-4,sy+8,8,8);}
  ctx.globalAlpha=1;ctx.restore();
  ctx.fillStyle='#ffff00';ctx.fillRect(cx-16,y+h+2,32,5);ctx.fillRect(cx-10,y+h+7,20,4);ctx.fillRect(cx-4,y+h+11,8,4);
}

// Shared: HP bar + boss name
function drawBossHPBar(bx,y,w,h,hp,mHp,name,nameCol){
  const pct=hp/mHp,bc=pct>0.6?'#00ff44':pct>0.3?'#ffcc00':'#ff0040';
  ctx.fillStyle='#080008';ctx.fillRect(bx,y+h+6,w,14);
  ctx.fillStyle=bc;ctx.fillRect(bx,y+h+6,Math.floor(w*pct),14);
  ctx.fillStyle='#333';ctx.fillRect(bx,y+h+6,w,2);ctx.fillRect(bx,y+h+18,w,2);
  ctx.save();
  ctx.font="6px 'Press Start 2P',monospace";ctx.fillStyle='#fff';ctx.textAlign='center';
  ctx.fillText(hp+' / '+mHp,bx+w/2,y+h+17);
  ctx.font="7px 'Press Start 2P',monospace";ctx.fillStyle=nameCol||'#ff6b35';
  ctx.fillText(name,bx+w/2,y+h+32);
  ctx.restore();
}

// ‚îÄ‚îÄ‚îÄ BOSS 0: THE LID KING (Level 5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// A massive golden lid ‚Äî flat disc body with a jewelled crown on top,
// angry royal face, scepter arms sticking out the sides
function drawLidKing(bx,y,w,h,hp,mHp,shk){
  const pulse=Math.floor(Date.now()/200)%2;
  const shimmer=Math.floor(Date.now()/120)%3;
  const cx=bx+w/2;

  // ‚îÄ‚îÄ SCEPTER ARMS ‚îÄ‚îÄ
  // Left scepter: horizontal rod + orb
  ctx.fillStyle='#aa8800';ctx.fillRect(bx-38,y+h/2-4,38,8);
  ctx.fillStyle='#ffdd00';ctx.fillRect(bx-38,y+h/2-4,10,8);
  ctx.fillStyle='#ffcc00';ctx.fillRect(bx-44,y+h/2-12,16,24); // orb body
  ctx.fillStyle='#ffe866';ctx.fillRect(bx-42,y+h/2-12,6,8); // orb shine
  ctx.fillStyle='#884400';ctx.fillRect(bx-44,y+h/2-12,4,24); // orb shadow
  ctx.fillStyle='#ff0000';ctx.fillRect(bx-38,y+h/2-6,8,12); // ruby gem on orb
  // Right scepter
  ctx.fillStyle='#aa8800';ctx.fillRect(bx+w,y+h/2-4,38,8);
  ctx.fillStyle='#ffdd00';ctx.fillRect(bx+w+28,y+h/2-4,10,8);
  ctx.fillStyle='#ffcc00';ctx.fillRect(bx+w+28,y+h/2-12,16,24);
  ctx.fillStyle='#ffe866';ctx.fillRect(bx+w+30,y+h/2-12,6,8);
  ctx.fillStyle='#884400';ctx.fillRect(bx+w+40,y+h/2-12,4,24);
  ctx.fillStyle='#ff0000';ctx.fillRect(bx+w+30,y+h/2-6,8,12);

  // ‚îÄ‚îÄ THE LID ‚Äî flat golden disc (main body) ‚îÄ‚îÄ
  // Shadow/depth layers
  ctx.fillStyle='#664400';ctx.fillRect(bx+4,y+h-30,w-8,34);
  ctx.fillStyle='#885500';ctx.fillRect(bx+2,y+h-38,w-4,38);
  ctx.fillStyle='#aa7700';ctx.fillRect(bx,y+h-52,w,52);
  ctx.fillStyle='#cc9900';ctx.fillRect(bx+4,y+h-68,w-8,18);
  ctx.fillStyle='#ddaa00';ctx.fillRect(bx+8,y+h-74,w-16,10);
  // Lid top surface (dome)
  ctx.fillStyle='#ffcc00';ctx.fillRect(bx+4,y+h-80,w-8,12);
  ctx.fillStyle='#ffdd44';ctx.fillRect(bx+10,y+h-84,w-20,8);
  ctx.fillStyle='#ffe866';ctx.fillRect(bx+20,y+h-86,w-40,6);
  // Lid lip (rim around edge)
  ctx.fillStyle='#cc8800';ctx.fillRect(bx,y+h-56,8,12);ctx.fillRect(bx+w-8,y+h-56,8,12);
  ctx.fillStyle='#ffaa00';ctx.fillRect(bx+2,y+h-56,5,12);ctx.fillRect(bx+w-7,y+h-56,5,12);
  // Engraved ring lines
  ctx.fillStyle='#aa7700';
  ctx.fillRect(bx+12,y+h-70,w-24,3);ctx.fillRect(bx+20,y+h-76,w-40,3);

  // ‚îÄ‚îÄ ROYAL FACE on the lid ‚îÄ‚îÄ
  // Eyes: angry brows
  ctx.fillStyle='#553300';ctx.fillRect(bx+30,y+h-64,40,6); // left brow
  ctx.fillRect(bx+w-70,y+h-64,40,6);                       // right brow
  ctx.fillStyle='#220000';ctx.fillRect(bx+30,y+h-64,10,6); // brow shadow
  ctx.fillRect(bx+w-40,y+h-64,10,6);
  // Eye sockets
  ctx.fillStyle='#000000';ctx.fillRect(bx+32,y+h-58,34,22);ctx.fillRect(bx+w-66,y+h-58,34,22);
  // Pupils ‚Äî golden royal eyes
  ctx.fillStyle=pulse?'#ffcc00':'#ff9900';
  ctx.fillRect(bx+36,y+h-54,26,14);ctx.fillRect(bx+w-62,y+h-54,26,14);
  ctx.fillStyle='#ffe866';ctx.fillRect(bx+38,y+h-54,8,6);ctx.fillRect(bx+w-60,y+h-54,8,6);
  ctx.fillStyle='#000000';ctx.fillRect(bx+46,y+h-54,8,8);ctx.fillRect(bx+w-50,y+h-54,8,8);
  // Regal nose
  ctx.fillStyle='#aa7700';ctx.fillRect(cx-8,y+h-44,16,10);ctx.fillRect(cx-12,y+h-36,24,8);
  // Stern royal mouth
  ctx.fillStyle='#553300';ctx.fillRect(bx+28,y+h-28,w-56,6);
  ctx.fillStyle='#000000';ctx.fillRect(bx+30,y+h-26,w-60,4);

  // ‚îÄ‚îÄ JEWELLED CROWN on top ‚îÄ‚îÄ
  ctx.fillStyle='#ffcc00';
  ctx.fillRect(bx+8,y-22,w-16,24); // crown band base
  ctx.fillStyle='#ffee44';ctx.fillRect(bx+8,y-22,w-16,8); // shine strip
  ctx.fillStyle='#cc9900';ctx.fillRect(bx+8,y-2,w-16,4);  // bottom rim
  // Crown points (5 tall points)
  const crownPts=[0.1,0.28,0.5,0.72,0.9];
  const crownH=[28,22,34,22,28];
  crownPts.forEach((p,i)=>{
    const px=Math.floor(bx+p*w);const ph=crownH[i];
    ctx.fillStyle='#ffcc00';ctx.fillRect(px-8,y-22-ph,16,ph+2);
    ctx.fillStyle='#ffee44';ctx.fillRect(px-5,y-22-ph,6,ph);
    ctx.fillStyle='#cc9900';ctx.fillRect(px+4,y-22-ph,4,ph);
    // Gem on each crown point
    const gemCol=['#ff0000','#00ff44','#0088ff','#ff00ff','#ff8800'][i];
    ctx.fillStyle=gemCol;ctx.fillRect(px-5,y-22-ph+2,10,12);
    ctx.fillStyle='#ffffff';ctx.fillRect(px-3,y-22-ph+3,4,4);
  });
  // Crown jewels in band
  ['#ff0000','#00ff88','#ff0000','#0088ff','#ff0000'].forEach((gc,i)=>{
    const gx=bx+24+i*Math.floor((w-48)/4);
    ctx.fillStyle=gc;ctx.fillRect(gx,y-20,14,14);
    ctx.fillStyle='#ffffff';ctx.fillRect(gx,y-20,5,5);
    if(shimmer===i%3){ctx.save();ctx.globalAlpha=0.6;ctx.fillStyle='#ffffff';ctx.fillRect(gx,y-20,14,14);ctx.restore();}
  });

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'THE LID KING','#ffcc00');
}

// ‚îÄ‚îÄ‚îÄ BOSS 1: FROSTLOCK (Level 10) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// A giant ice cube / frozen container ‚Äî translucent blue-white cuboid,
// sharp ice crystal spikes growing out of it, frozen angry face
function drawFrostlock(bx,y,w,h,hp,mHp,shk){
  const tk=Math.floor(Date.now()/100);
  const iceShimmer=Math.floor(Date.now()/300)%4;

  // ‚îÄ‚îÄ ICE CRYSTAL SPIKES (before body so body overlaps base) ‚îÄ‚îÄ
  const spikePositions=[
    {x:0.08,topH:42,baseW:16},{x:0.22,topH:28,baseW:12},{x:0.38,topH:52,baseW:18},
    {x:0.5, topH:60,baseW:20},{x:0.62,topH:52,baseW:18},{x:0.78,topH:28,baseW:12},{x:0.92,topH:42,baseW:16}
  ];
  spikePositions.forEach(sp=>{
    const sx=Math.floor(bx+sp.x*w);
    // Shadow spike
    ctx.fillStyle='#002255';ctx.fillRect(sx-sp.baseW/2+4,y-sp.topH+4,sp.baseW,sp.topH);
    ctx.fillRect(sx-sp.baseW/4+4,y-sp.topH-8+4,sp.baseW/2,10);
    // Main spike
    ctx.fillStyle='#aaddff';ctx.fillRect(sx-sp.baseW/2,y-sp.topH,sp.baseW,sp.topH);
    ctx.fillStyle='#ddf0ff';ctx.fillRect(sx-sp.baseW/2,y-sp.topH,sp.baseW/3,sp.topH);
    // Tip
    ctx.fillStyle='#eef8ff';ctx.fillRect(sx-sp.baseW/4,y-sp.topH-10,sp.baseW/2,12);
    ctx.fillRect(sx-2,y-sp.topH-18,4,10);
    // Facet lines (ice geometry)
    ctx.fillStyle='#4499cc';ctx.fillRect(sx+sp.baseW/4,y-sp.topH,4,sp.topH);
  });

  // ‚îÄ‚îÄ BODY: frozen tupperware container ‚îÄ‚îÄ
  // Outer frost shadow
  ctx.fillStyle='#002244';ctx.fillRect(bx,y,w,h);
  // Main ice body
  ctx.fillStyle='#1155aa';ctx.fillRect(bx+4,y+4,w-8,h-4);
  ctx.fillStyle='#2277cc';ctx.fillRect(bx+8,y+8,w-16,h-12);
  // Ice interior glow
  ctx.fillStyle='#3399ee';ctx.fillRect(bx+14,y+14,w-28,h-22);
  ctx.fillStyle='#44aaff';ctx.fillRect(bx+20,y+20,w-40,h-34);
  // Translucent inner core
  ctx.save();ctx.globalAlpha=0.5;ctx.fillStyle='#88ccff';ctx.fillRect(bx+28,y+28,w-56,h-50);ctx.restore();

  // ‚îÄ‚îÄ FROST TEXTURE (cracked ice lines) ‚îÄ‚îÄ
  ctx.fillStyle='#aaccee';
  // Crack lines across body
  [[0,0.3,0.4,0.7],[0.2,0.1,0.6,0.5],[0.5,0.0,0.8,0.4],[0.1,0.5,0.3,0.8],[0.7,0.2,0.9,0.6]].forEach(([x1,y1,x2,y2])=>{
    const lx1=Math.floor(bx+x1*w),ly1=Math.floor(y+y1*h),lx2=Math.floor(bx+x2*w),ly2=Math.floor(y+y2*h);
    ctx.fillRect(Math.min(lx1,lx2),ly1,Math.abs(lx2-lx1)+2,2);
    ctx.fillRect(lx1,Math.min(ly1,ly2),2,Math.abs(ly2-ly1)+2);
  });

  // ‚îÄ‚îÄ FROZEN FACE ‚îÄ‚îÄ
  // Frost over eyes = pale blue sockets
  ctx.fillStyle='#000a22';ctx.fillRect(bx+20,y+22,44,28);ctx.fillRect(bx+w-64,y+22,44,28);
  ctx.fillStyle='#0044aa';ctx.fillRect(bx+24,y+26,36,20);ctx.fillRect(bx+w-60,y+26,36,20);
  ctx.fillStyle='#55aaff';ctx.fillRect(bx+28,y+30,28,12);ctx.fillRect(bx+w-56,y+30,28,12);
  ctx.fillStyle='#aaddff';ctx.fillRect(bx+30,y+30,10,8);ctx.fillRect(bx+w-54,y+30,10,8);
  // Frozen pupil ‚Äî black dot encased in ice
  ctx.fillStyle='#000000';ctx.fillRect(bx+38,y+33,10,8);ctx.fillRect(bx+w-48,y+33,10,8);
  ctx.fillStyle='#ffffff';ctx.fillRect(bx+38,y+33,4,4);ctx.fillRect(bx+w-48,y+33,4,4);
  // Frowning frozen mouth
  ctx.fillStyle='#000a22';ctx.fillRect(bx+24,y+h-38,w-48,10);
  ctx.fillStyle='#0033aa';ctx.fillRect(bx+26,y+h-36,w-52,6);
  // Icicle teeth hanging from lid
  ctx.fillStyle='#aaddff';
  for(let it=0;it<8;it++){ctx.fillRect(bx+22+it*18,y+h-38,8,12+it%3*4);ctx.fillRect(bx+24+it*18,y+h-38,4,16+it%2*4);}

  // ‚îÄ‚îÄ LID: flat top rim ‚îÄ‚îÄ
  ctx.fillStyle='#003388';ctx.fillRect(bx-4,y-2,w+8,12);
  ctx.fillStyle='#1166cc';ctx.fillRect(bx+2,y-2,w-4,8);
  ctx.fillStyle='#66aaee';ctx.fillRect(bx+8,y-2,w-16,4);
  // Side clips (frozen solid)
  ctx.fillStyle='#0044aa';ctx.fillRect(bx-10,y+h/3-8,10,20);ctx.fillRect(bx+w,y+h/3-8,10,20);
  ctx.fillStyle='#3377cc';ctx.fillRect(bx-10,y+h/3-8,5,20);ctx.fillRect(bx+w,y+h/3-8,5,20);

  // ‚îÄ‚îÄ SHIMMER sparkle ‚îÄ‚îÄ
  if(iceShimmer<3){
    ctx.save();ctx.globalAlpha=0.7;ctx.fillStyle='#ffffff';
    const sparkleX=[bx+30,bx+w-40,bx+w/2,bx+50,bx+w-60];
    const sparkleY=[y+30,y+50,y+20,y+h-40,y+h-30];
    ctx.fillRect(sparkleX[iceShimmer]-4,sparkleY[iceShimmer],8,2);
    ctx.fillRect(sparkleX[iceShimmer],sparkleY[iceShimmer]-4,2,8);
    ctx.restore();
  }

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'FROSTLOCK','#88ddff');
}

// ‚îÄ‚îÄ‚îÄ BOSS 2: SAUCEPAN SAM (Level 15) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// A big round saucepan ‚Äî circular pot body, long handle on the side,
// bubbling lid on top with steam holes, angry red-faced chef expression
function drawSaucepanSam(bx,y,w,h,hp,mHp,shk){
  const tk=Math.floor(Date.now()/80);
  const bubble=Math.floor(Date.now()/250)%4;
  const steam=Math.floor(Date.now()/150)%3;
  const cx=bx+w/2;
  const boil=hp/mHp<0.5; // boiling rage below half HP

  // ‚îÄ‚îÄ HANDLE (sticking out right side) ‚îÄ‚îÄ
  ctx.fillStyle='#333333';ctx.fillRect(bx+w,y+h/2-8,52,16);
  ctx.fillStyle='#555555';ctx.fillRect(bx+w,y+h/2-8,50,8);
  ctx.fillStyle='#222222';ctx.fillRect(bx+w,y+h/2,50,8);
  // Handle grip (wood-style)
  ctx.fillStyle='#884422';ctx.fillRect(bx+w+16,y+h/2-10,30,20);
  ctx.fillStyle='#aa5533';ctx.fillRect(bx+w+16,y+h/2-10,30,9);
  ctx.fillStyle='#663311';ctx.fillRect(bx+w+16,y+h/2,30,10);
  // Grip lines
  ctx.fillStyle='#552211';
  for(let g=0;g<4;g++)ctx.fillRect(bx+w+20+g*6,y+h/2-10,3,20);
  // Small stub handle left
  ctx.fillStyle='#333333';ctx.fillRect(bx-20,y+h/2-6,20,12);
  ctx.fillStyle='#555555';ctx.fillRect(bx-20,y+h/2-6,20,5);

  // ‚îÄ‚îÄ POT BODY (wide rounded barrel) ‚îÄ‚îÄ
  // Dark shadow/base
  ctx.fillStyle='#111111';ctx.fillRect(bx+2,y+10,w-4,h-10);
  // Main body - dark steel
  ctx.fillStyle='#2a2a2a';ctx.fillRect(bx+4,y+6,w-8,h-6);
  ctx.fillStyle='#383838';ctx.fillRect(bx+8,y+4,w-16,h-4);
  ctx.fillStyle='#424242';ctx.fillRect(bx+12,y+6,w-24,h-8);
  // Hot glow from bottom (boiling)
  if(boil){
    ctx.save();ctx.globalAlpha=0.35+0.15*Math.sin(Date.now()*0.01);
    ctx.fillStyle='#ff4400';ctx.fillRect(bx+12,y+h-28,w-24,28);
    ctx.globalAlpha=0.2;ctx.fillStyle='#ff8800';ctx.fillRect(bx+8,y+h-20,w-16,20);
    ctx.restore();
  }
  // Highlight stripe
  ctx.fillStyle='#555555';ctx.fillRect(bx+12,y+6,20,h-8);
  ctx.fillStyle='#666666';ctx.fillRect(bx+14,y+6,8,h-8);
  // Pot rim (thick lip at top)
  ctx.fillStyle='#555555';ctx.fillRect(bx+2,y+2,w-4,8);
  ctx.fillStyle='#666666';ctx.fillRect(bx+4,y+2,w-8,5);
  ctx.fillStyle='#888888';ctx.fillRect(bx+6,y+2,w-12,3);
  // Pot base ring
  ctx.fillStyle='#111111';ctx.fillRect(bx+8,y+h-6,w-16,8);
  ctx.fillStyle='#333333';ctx.fillRect(bx+12,y+h-4,w-24,6);

  // ‚îÄ‚îÄ BUBBLING LID on top ‚îÄ‚îÄ
  ctx.fillStyle='#111111';ctx.fillRect(bx-2,y-12,w+4,14);
  ctx.fillStyle='#2a2a2a';ctx.fillRect(bx,y-10,w,12);
  ctx.fillStyle='#333333';ctx.fillRect(bx+4,y-12,w-8,10);
  ctx.fillStyle='#444444';ctx.fillRect(bx+8,y-14,w-16,8);
  ctx.fillStyle='#555555';ctx.fillRect(bx+16,y-15,w-32,6);
  // Lid knob
  ctx.fillStyle='#333333';ctx.fillRect(cx-12,y-22,24,10);
  ctx.fillStyle='#555555';ctx.fillRect(cx-10,y-22,20,6);
  ctx.fillStyle='#666666';ctx.fillRect(cx-8,y-22,12,4);
  // Steam holes in lid
  const holes=[cx-50,cx-20,cx,cx+20,cx+50];
  holes.forEach(hx=>{
    ctx.fillStyle='#000000';ctx.fillRect(hx-4,y-12,8,8);
    ctx.fillStyle='#1a1a1a';ctx.fillRect(hx-3,y-12,6,6);
  });
  // Steam wisps rising from holes
  holes.forEach((hx,i)=>{
    const sw=(steam+i)%3;
    ctx.save();ctx.globalAlpha=0.6-sw*0.15;ctx.fillStyle='#ccccaa';
    ctx.fillRect(hx-3,y-12-sw*10,6,8);
    ctx.fillRect(hx-5,y-20-sw*10,10,6);
    ctx.fillRect(hx-7,y-26-sw*10,14,5);
    ctx.restore();
  });

  // ‚îÄ‚îÄ ANGRY FACE on pot body ‚îÄ‚îÄ
  // Angry red glow around face area when boiling
  if(boil){ctx.save();ctx.globalAlpha=0.25;ctx.fillStyle='#ff0000';ctx.fillRect(bx+14,y+22,w-28,65);ctx.restore();}
  // Eyebrows (deep angry V shape)
  ctx.fillStyle='#000000';
  // Left brow: inner high, outer low
  ctx.fillRect(bx+22,y+28,12,6);ctx.fillRect(bx+32,y+24,10,6);ctx.fillRect(bx+40,y+20,8,6);
  // Right brow: mirror
  ctx.fillRect(bx+w-34,y+28,12,6);ctx.fillRect(bx+w-42,y+24,10,6);ctx.fillRect(bx+w-48,y+20,8,6);
  // Eyes
  ctx.fillStyle='#111111';ctx.fillRect(bx+24,y+34,36,24);ctx.fillRect(bx+w-60,y+34,36,24);
  ctx.fillStyle=boil?'#ff3300':'#cc2200';ctx.fillRect(bx+28,y+38,28,16);ctx.fillRect(bx+w-56,y+38,28,16);
  ctx.fillStyle=boil?'#ff8800':'#ff4400';ctx.fillRect(bx+32,y+40,18,10);ctx.fillRect(bx+w-50,y+40,18,10);
  ctx.fillStyle='#ffffff';ctx.fillRect(bx+34,y+40,7,7);ctx.fillRect(bx+w-48,y+40,7,7);
  ctx.fillStyle='#000000';ctx.fillRect(bx+40,y+42,6,6);ctx.fillRect(bx+w-42,y+42,6,6);
  // Boiling nose drip
  ctx.fillStyle='#cc3300';ctx.fillRect(cx-8,y+60,16,12);
  ctx.fillStyle='#ff4400';ctx.fillRect(cx-10,y+68,20,10);
  // Grumpy downturned mouth
  ctx.fillStyle='#000000';ctx.fillRect(bx+22,y+h-36,w-44,14);
  // Teeth showing (gritted)
  ctx.fillStyle='#eeeeee';
  for(let t2=0;t2<7;t2++)ctx.fillRect(bx+26+t2*19,y+h-34,14,10);
  ctx.fillStyle='#888888';
  for(let t2=0;t2<7;t2++)ctx.fillRect(bx+26+t2*19,y+h-34,3,10);
  // Bubble counter - boiling liquid splashes near bottom
  if(boil){
    ctx.fillStyle='#ff6600';
    const bx2=[cx-60,cx-20,cx+20,cx+50];
    bx2.forEach((bxb,i)=>{if((bubble+i)%4<2){ctx.fillRect(bxb,y+h-14,10,10);ctx.fillRect(bxb-3,y+h-20,6,8);}});
  }

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'SAUCEPAN SAM','#ffaa44');
}

// ‚îÄ‚îÄ‚îÄ BOSS 3: CRISPER LORD (Level 20) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// A wide, flat rectangular crisper drawer ‚Äî the kind from a fridge.
// Long horizontal body, transparent window showing frozen vegetables,
// blue-lit face, cold vapour vents
function drawCrisperLord(bx,y,w,h,hp,mHp,shk){
  const tk=Math.floor(Date.now()/100);
  const vapour=Math.floor(Date.now()/200)%5;
  const pulse=Math.floor(Date.now()/300)%2;

  // ‚îÄ‚îÄ DRAWER RAILS (sides sticking out) ‚îÄ‚îÄ
  ctx.fillStyle='#112233';ctx.fillRect(bx-14,y+h/2-5,14,10);ctx.fillRect(bx+w,y+h/2-5,14,10);
  ctx.fillStyle='#224466';ctx.fillRect(bx-14,y+h/2-5,14,5);ctx.fillRect(bx+w,y+h/2-5,14,5);

  // ‚îÄ‚îÄ MAIN DRAWER BODY (wide & flat) ‚îÄ‚îÄ
  // Outer frame (fridge plastic - grey-white)
  ctx.fillStyle='#223344';ctx.fillRect(bx,y,w,h);
  ctx.fillStyle='#2a4466';ctx.fillRect(bx+2,y+2,w-4,h-4);
  ctx.fillStyle='#334455';ctx.fillRect(bx+4,y+4,w-8,h-8);
  // Inner compartment (darker)
  ctx.fillStyle='#0a1a2a';ctx.fillRect(bx+8,y+10,w-16,h-20);
  // Cold blue interior glow
  ctx.save();ctx.globalAlpha=0.4+0.15*Math.sin(Date.now()*0.003);
  ctx.fillStyle='#0066aa';ctx.fillRect(bx+10,y+12,w-20,h-24);ctx.restore();
  // Frost condensation around edges
  ctx.fillStyle='#558899';
  ctx.fillRect(bx+8,y+10,4,h-20);ctx.fillRect(bx+w-12,y+10,4,h-20);
  ctx.fillRect(bx+8,y+10,w-16,4);ctx.fillRect(bx+8,y+h-14,w-16,4);

  // ‚îÄ‚îÄ TRANSPARENT WINDOW (showing vegetables inside) ‚îÄ‚îÄ
  ctx.fillStyle='#001122';ctx.fillRect(bx+16,y+18,w-32,h/2);
  ctx.save();ctx.globalAlpha=0.7;ctx.fillStyle='#003355';ctx.fillRect(bx+18,y+20,w-36,h/2-4);ctx.restore();
  // Frozen veggies: broccoli, carrot, pea shapes
  // Broccoli (green cluster)
  ctx.fillStyle='#005500';ctx.fillRect(bx+26,y+26,18,12);
  ctx.fillStyle='#008800';ctx.fillRect(bx+22,y+22,10,10);ctx.fillRect(bx+32,y+20,10,12);ctx.fillRect(bx+40,y+24,8,10);
  ctx.fillStyle='#00aa00';ctx.fillRect(bx+24,y+22,6,6);ctx.fillRect(bx+34,y+20,6,8);
  // Carrot (orange)
  ctx.fillStyle='#cc5500';ctx.fillRect(bx+60,y+24,8,18);
  ctx.fillStyle='#ff7700';ctx.fillRect(bx+60,y+24,8,10);
  ctx.fillStyle='#006600';ctx.fillRect(bx+62,y+18,4,8); // carrot top
  // Peas (dots)
  ctx.fillStyle='#339933';
  [78,88,94,82,72].forEach((px,i)=>ctx.fillRect(px+bx-50,y+22+i%2*8,8,8));
  // Frost glaze overlay on window
  ctx.save();ctx.globalAlpha=0.25;ctx.fillStyle='#88ccee';ctx.fillRect(bx+18,y+20,w-36,h/2-4);ctx.restore();
  // Window border
  ctx.fillStyle='#2266aa';ctx.fillRect(bx+14,y+16,w-28,4);ctx.fillRect(bx+14,y+h/2+18,w-28,4);
  ctx.fillRect(bx+14,y+16,4,h/2+6);ctx.fillRect(bx+w-18,y+16,4,h/2+6);

  // ‚îÄ‚îÄ FACE in lower half of drawer ‚îÄ‚îÄ
  const fy=y+h/2+6;
  // Cold blue eyes
  ctx.fillStyle='#001122';ctx.fillRect(bx+24,fy,36,22);ctx.fillRect(bx+w-60,fy,36,22);
  ctx.fillStyle='#0055aa';ctx.fillRect(bx+28,fy+4,28,14);ctx.fillRect(bx+w-56,fy+4,28,14);
  ctx.fillStyle=pulse?'#00aaff':'#0066cc';ctx.fillRect(bx+32,fy+6,20,10);ctx.fillRect(bx+w-52,fy+6,20,10);
  ctx.fillStyle='#66ddff';ctx.fillRect(bx+32,fy+6,7,5);ctx.fillRect(bx+w-52,fy+6,7,5);
  ctx.fillStyle='#000000';ctx.fillRect(bx+40,fy+8,6,6);ctx.fillRect(bx+w-46,fy+8,6,6);
  // Snide smirk (thinks he's better than you)
  ctx.fillStyle='#000000';ctx.fillRect(bx+30,y+h-20,w-60,8);
  ctx.fillStyle='#001a33';ctx.fillRect(bx+32,y+h-18,w-64,4);
  ctx.fillStyle='#334455';ctx.fillRect(bx+30,y+h-22,14,4);// one corner up = smirk
  // Frost vapour venting from sides
  const ventH=[y+h*0.2,y+h*0.5,y+h*0.75];
  ventH.forEach((vy,i)=>{
    if((vapour+i)%5<3){
      ctx.save();ctx.globalAlpha=0.4-((vapour+i)%5)*0.1;ctx.fillStyle='#aaccdd';
      ctx.fillRect(bx-18-(vapour+i)%5*4,vy-4,10,8);
      ctx.fillRect(bx+w+8+(vapour+i)%5*4,vy-4,10,8);ctx.restore();
    }
  });
  // Cold temp badge
  ctx.fillStyle='#0055aa';ctx.fillRect(cx-20,y+4,40,12);
  ctx.fillStyle='#aaddff';ctx.fillRect(cx-18,y+5,36,10);
  ctx.save();ctx.font="6px 'Press Start 2P',monospace";ctx.fillStyle='#003366';ctx.textAlign='center';
  ctx.fillText('-18¬∞C',cx,y+13);ctx.restore();

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'CRISPER LORD','#4499ff');
}

// ‚îÄ‚îÄ‚îÄ BOSS 4: THERMOS PRIME (Level 25) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// A tall cylindrical thermos ‚Äî matte black body with metallic bands,
// a screw-top cap, built-in temperature gauge, robotic arms/vents
// on the sides that look like weaponized exhaust pipes
function drawThermosPrime(bx,y,w,h,hp,mHp,shk){
  const tk=Math.floor(Date.now()/60);
  const ventPulse=Math.floor(Date.now()/120)%2;
  const rage=1-hp/mHp;
  const cx=bx+w/2;

  // ‚îÄ‚îÄ EXHAUST PIPES / WEAPON ARMS ‚îÄ‚îÄ
  // Left side pipes
  ctx.fillStyle='#111111';
  ctx.fillRect(bx-28,y+h*0.2,28,12);  // pipe 1
  ctx.fillRect(bx-32,y+h*0.4,32,12);  // pipe 2
  ctx.fillRect(bx-28,y+h*0.6,28,12);  // pipe 3
  ctx.fillStyle='#333333';
  ctx.fillRect(bx-28,y+h*0.2,28,5);ctx.fillRect(bx-32,y+h*0.4,32,5);ctx.fillRect(bx-28,y+h*0.6,28,5);
  // Exhaust glow from pipes
  const exhaustCol=ventPulse?'#ff4400':'#ff8800';
  ctx.fillStyle=exhaustCol;
  ctx.fillRect(bx-36,y+h*0.2+2,8,8);ctx.fillRect(bx-40,y+h*0.4+2,8,8);ctx.fillRect(bx-36,y+h*0.6+2,8,8);
  if(rage>0.3){ctx.save();ctx.globalAlpha=rage*0.5;ctx.fillStyle='#ff4400';
    ctx.fillRect(bx-52,y+h*0.2,16,8);ctx.fillRect(bx-52,y+h*0.4,16,8);ctx.fillRect(bx-52,y+h*0.6,16,8);
    ctx.restore();}
  // Right side pipes
  ctx.fillStyle='#111111';
  ctx.fillRect(bx+w,y+h*0.2,28,12);ctx.fillRect(bx+w,y+h*0.4,32,12);ctx.fillRect(bx+w,y+h*0.6,28,12);
  ctx.fillStyle='#333333';
  ctx.fillRect(bx+w,y+h*0.2,28,5);ctx.fillRect(bx+w,y+h*0.4,32,5);ctx.fillRect(bx+w,y+h*0.6,28,5);
  ctx.fillStyle=exhaustCol;
  ctx.fillRect(bx+w+28,y+h*0.2+2,8,8);ctx.fillRect(bx+w+32,y+h*0.4+2,8,8);ctx.fillRect(bx+w+28,y+h*0.6+2,8,8);

  // ‚îÄ‚îÄ THERMOS MAIN BODY ‚îÄ‚îÄ
  // Outer body: matte black with shine
  ctx.fillStyle='#0a0a0a';ctx.fillRect(bx+2,y+20,w-4,h-20);
  ctx.fillStyle='#141414';ctx.fillRect(bx+4,y+18,w-8,h-18);
  ctx.fillStyle='#1a1a1a';ctx.fillRect(bx+8,y+16,w-16,h-16);
  ctx.fillStyle='#222222';ctx.fillRect(bx+12,y+16,w-24,h-16);
  // Metallic shine strip
  ctx.fillStyle='#2a2a2a';ctx.fillRect(bx+12,y+16,12,h-16);
  ctx.fillStyle='#333333';ctx.fillRect(bx+14,y+16,5,h-16);
  // Horizontal metallic bands
  ctx.fillStyle='#3a3a3a';
  [0.2,0.4,0.6,0.8].forEach(bp=>{ctx.fillRect(bx+4,y+h*bp,w-8,6);});
  ctx.fillStyle='#555555';
  [0.2,0.4,0.6,0.8].forEach(bp=>{ctx.fillRect(bx+4,y+h*bp,w-8,2);});
  // Red DANGER stripe
  ctx.fillStyle='#cc0000';ctx.fillRect(bx+4,y+h*0.72,w-8,8);
  ctx.fillStyle='#ff0000';ctx.fillRect(bx+4,y+h*0.72,w-8,3);
  // Warning text
  ctx.save();ctx.font="5px 'Press Start 2P',monospace";ctx.fillStyle='#000000';ctx.textAlign='center';
  ctx.fillText('DANGER',cx,y+h*0.72+6);ctx.restore();

  // ‚îÄ‚îÄ SCREW-TOP CAP ‚îÄ‚îÄ
  // Cap base
  ctx.fillStyle='#111111';ctx.fillRect(bx-2,y+4,w+4,16);
  ctx.fillStyle='#222222';ctx.fillRect(bx,y+4,w,14);
  ctx.fillStyle='#333333';ctx.fillRect(bx+4,y+4,w-8,12);
  // Screw thread lines
  ctx.fillStyle='#111111';
  for(let sc=0;sc<6;sc++)ctx.fillRect(bx+4+sc*(w-8)/6,y+6,(w-8)/12,10);
  // Cap top dome
  ctx.fillStyle='#1a1a1a';ctx.fillRect(bx+6,y-2,w-12,8);
  ctx.fillStyle='#282828';ctx.fillRect(bx+14,y-6,w-28,8);
  ctx.fillStyle='#333333';ctx.fillRect(bx+22,y-8,w-44,6);
  // Drink spout
  ctx.fillStyle='#111111';ctx.fillRect(cx-10,y-14,20,12);
  ctx.fillStyle='#222222';ctx.fillRect(cx-8,y-14,16,10);
  ctx.fillStyle='#000000';ctx.fillRect(cx-5,y-14,10,8);

  // ‚îÄ‚îÄ TEMPERATURE GAUGE (glows with HP) ‚îÄ‚îÄ
  const gaugeX=bx+14,gaugeY=y+h*0.3,gaugeH=h*0.25;
  ctx.fillStyle='#000000';ctx.fillRect(gaugeX,gaugeY,16,gaugeH);
  ctx.fillStyle='#1a1a1a';ctx.fillRect(gaugeX+2,gaugeY+2,12,gaugeH-4);
  // Fill based on HP (hot = full HP, empty = dying)
  const fillAmt=hp/mHp;
  const heatCol=fillAmt>0.6?'#ff0000':fillAmt>0.3?'#ff8800':'#ff4400';
  ctx.fillStyle=heatCol;ctx.fillRect(gaugeX+2,gaugeY+2+Math.floor(gaugeH*0.85*(1-fillAmt)),12,Math.floor(gaugeH*0.85*fillAmt));
  // Gauge glow
  ctx.save();ctx.globalAlpha=fillAmt*0.4;ctx.fillStyle=heatCol;ctx.fillRect(gaugeX-4,gaugeY,24,gaugeH);ctx.restore();
  // Gauge scale marks
  ctx.fillStyle='#555555';for(let gm=0;gm<5;gm++)ctx.fillRect(gaugeX+12,gaugeY+4+gm*gaugeH*0.2,4,2);

  // ‚îÄ‚îÄ ROBOTIC FACE ‚îÄ‚îÄ
  const fy=y+h*0.3+gaugeH+8;
  // Visor band (horizontal scanner line)
  ctx.fillStyle='#000000';ctx.fillRect(bx+10,fy,w-20,24);
  ctx.fillStyle=ventPulse?'#ff0000':'#cc2200';ctx.fillRect(bx+14,fy+4,w-28,16);
  ctx.fillStyle='#ff4400';ctx.fillRect(bx+14,fy+4,w-28,6);
  // Scanner line moving across
  ctx.fillStyle='#ff8800';ctx.fillRect(bx+14+(tk*3%(w-28)),fy+4,8,16);
  // Nostril vents
  ctx.fillStyle='#000000';ctx.fillRect(cx-14,fy+26,10,8);ctx.fillRect(cx+4,fy+26,10,8);
  ctx.fillStyle='#330000';ctx.fillRect(cx-12,fy+28,6,4);ctx.fillRect(cx+6,fy+28,6,4);
  // Mouth: speaker grille
  ctx.fillStyle='#000000';ctx.fillRect(bx+20,fy+36,w-40,10);
  ctx.fillStyle='#111111';for(let sg=0;sg<8;sg++)ctx.fillRect(bx+24+sg*(w-48)/8,fy+37,5,8);

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'THERMOS PRIME','#ff4444');
}

// ‚îÄ‚îÄ‚îÄ BOSS 5: THE SEAL (Level 30 Phase 1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// A giant wax-sealed container ‚Äî round body with a massive
// embossed wax seal on the front, regal/ancient looking,
// glowing seal symbol, melting wax drips, old ornate container design
function drawTheSeal(bx,y,w,h,hp,mHp,shk){
  const tk=Math.floor(Date.now()/80);
  const waxDrip=Math.floor(Date.now()/400)%4;
  const sealGlow=0.7+0.3*Math.sin(Date.now()*0.004);
  const cx=bx+w/2;
  const pulse=Math.floor(Date.now()/150)%2;

  // ‚îÄ‚îÄ ORNATE SIDE SCROLLWORK ‚îÄ‚îÄ
  ctx.fillStyle='#550000';
  // Left scroll
  [y+h*0.15,y+h*0.4,y+h*0.65].forEach(sy=>{
    ctx.fillRect(bx-18,sy-5,18,10);ctx.fillRect(bx-22,sy-8,8,16);
    ctx.fillStyle='#880000';ctx.fillRect(bx-20,sy-5,6,10);ctx.fillStyle='#550000';
  });
  // Right scroll
  [y+h*0.15,y+h*0.4,y+h*0.65].forEach(sy=>{
    ctx.fillRect(bx+w,sy-5,18,10);ctx.fillRect(bx+w+14,sy-8,8,16);
    ctx.fillStyle='#880000';ctx.fillRect(bx+w+14,sy-5,6,10);ctx.fillStyle='#550000';
  });

  // ‚îÄ‚îÄ MAIN CONTAINER BODY (deep crimson ancient vessel) ‚îÄ‚îÄ
  ctx.fillStyle='#1a0000';ctx.fillRect(bx,y,w,h);
  ctx.fillStyle='#220000';ctx.fillRect(bx+4,y+4,w-8,h-4);
  ctx.fillStyle='#2a0000';ctx.fillRect(bx+8,y+8,w-16,h-8);
  ctx.fillStyle='#330000';ctx.fillRect(bx+12,y+12,w-24,h-12);
  // Embossed panel lines (ornate)
  ctx.fillStyle='#440000';
  ctx.fillRect(bx+8,y+8,4,h-16);ctx.fillRect(bx+w-12,y+8,4,h-16);
  ctx.fillRect(bx+8,y+8,w-16,4);ctx.fillRect(bx+8,y+h-12,w-16,4);
  ctx.fillRect(bx+16,y+16,2,h-32);ctx.fillRect(bx+w-18,y+16,2,h-32);
  // Gold trim accents
  ctx.fillStyle='#884400';
  ctx.fillRect(bx+2,y+2,w-4,4);ctx.fillRect(bx+2,y+h-6,w-4,4);
  ctx.fillRect(bx+2,y+2,4,h-4);ctx.fillRect(bx+w-6,y+2,4,h-4);
  ctx.fillStyle='#aa6600';
  ctx.fillRect(bx+4,y+2,w-8,2);ctx.fillRect(bx+2,y+4,2,h-8);

  // ‚îÄ‚îÄ MASSIVE WAX SEAL (central emblem) ‚îÄ‚îÄ
  const sr=52; // seal radius
  // Outer seal ring (embossed)
  ctx.fillStyle='#660000';ctx.fillRect(cx-sr,y+h/2-sr,sr*2,sr*2);
  ctx.fillStyle='#880000';ctx.fillRect(cx-sr+4,y+h/2-sr+4,sr*2-8,sr*2-8);
  ctx.fillStyle='#aa0000';ctx.fillRect(cx-sr+8,y+h/2-sr+8,sr*2-16,sr*2-16);
  // Seal glow aura
  ctx.save();ctx.globalAlpha=sealGlow*0.4;ctx.fillStyle='#ff0000';
  ctx.fillRect(cx-sr-8,y+h/2-sr-8,sr*2+16,sr*2+16);ctx.restore();
  // Wax seal center
  ctx.fillStyle='#cc2200';ctx.fillRect(cx-sr+12,y+h/2-sr+12,sr*2-24,sr*2-24);
  ctx.fillStyle='#dd3300';ctx.fillRect(cx-sr+16,y+h/2-sr+16,sr*2-32,sr*2-32);
  // Seal star pattern (5-pointed)
  ctx.fillStyle='#ff4400';
  const sealCX=cx,sealCY=y+h/2;
  [[0,1],[0.59,0.31],[0.95,-0.81],[-.95,-0.81],[-.59,.31]].forEach(([sx2,sy2])=>{
    ctx.fillRect(sealCX+sx2*30-6,sealCY+sy2*30-6,12,12);
    ctx.fillRect(sealCX+sx2*16-4,sealCY+sy2*16-4,8,8);
  });
  // Center crown symbol
  ctx.fillStyle='#ffcc00';ctx.fillRect(sealCX-12,sealCY-16,24,6);
  ctx.fillRect(sealCX-10,sealCY-22,6,8);ctx.fillRect(sealCX-3,sealCY-26,6,12);ctx.fillRect(sealCX+4,sealCY-22,6,8);
  ctx.fillRect(sealCX-12,sealCY-12,24,16);
  ctx.fillStyle='#ffe866';ctx.fillRect(sealCX-10,sealCY-12,8,6);
  // S lettering on seal
  ctx.save();ctx.font="bold 14px 'Press Start 2P',monospace";ctx.fillStyle='#ffee88';ctx.textAlign='center';
  ctx.fillText('S',sealCX,sealCY+32);ctx.restore();
  // Seal ring sunburst
  ctx.fillStyle='#770000';
  for(let sr2=0;sr2<12;sr2++){
    const a=sr2/12*Math.PI*2;
    const rx=Math.round(sealCX+Math.cos(a)*44),ry=Math.round(sealCY+Math.sin(a)*44);
    ctx.fillRect(rx-3,ry-3,6,6);
  }

  // ‚îÄ‚îÄ WAX DRIPS flowing down from seal ‚îÄ‚îÄ
  ctx.fillStyle='#cc0000';
  const drips=[cx-30,cx-8,cx+10,cx+28];
  drips.forEach((dx,i)=>{
    const dripLen=12+(waxDrip+i)%4*6;
    ctx.fillRect(dx-4,y+h/2+sr-4,8,dripLen);
    ctx.fillRect(dx-6,y+h/2+sr+dripLen-8,12,8); // drip blob end
    ctx.fillStyle='#dd2200';ctx.fillRect(dx-3,y+h/2+sr-4,4,dripLen);ctx.fillStyle='#cc0000';
  });

  // ‚îÄ‚îÄ ANCIENT FACE (barely visible, etched into vessel) ‚îÄ‚îÄ
  const fy=y+h*0.68;
  ctx.fillStyle='#550000';ctx.fillRect(bx+22,fy,36,20);ctx.fillRect(bx+w-58,fy,36,20);
  ctx.fillStyle=pulse?'#ff0000':'#aa0000';ctx.fillRect(bx+26,fy+4,28,12);ctx.fillRect(bx+w-54,fy+4,28,12);
  ctx.fillStyle='#ff3300';ctx.fillRect(bx+30,fy+6,18,8);ctx.fillRect(bx+w-50,fy+6,18,8);
  ctx.fillStyle='#ffffff';ctx.fillRect(bx+32,fy+7,5,5);ctx.fillRect(bx+w-48,fy+7,5,5);
  ctx.fillStyle='#000000';ctx.fillRect(bx+36,fy+9,5,4);ctx.fillRect(bx+w-44,fy+9,5,4);
  // Curved frown (ancient displeasure)
  ctx.fillStyle='#440000';ctx.fillRect(bx+28,fy+22,w-56,6);
  ctx.fillStyle='#000000';ctx.fillRect(bx+30,fy+24,w-60,3);
  ctx.fillStyle='#440000';ctx.fillRect(bx+28,fy+22,12,3);ctx.fillRect(bx+w-40,fy+22,12,3);

  // ‚îÄ‚îÄ CONTAINER LID ‚îÄ‚îÄ
  ctx.fillStyle='#110000';ctx.fillRect(bx-2,y-6,w+4,10);
  ctx.fillStyle='#220000';ctx.fillRect(bx,y-4,w,8);
  ctx.fillStyle='#440000';ctx.fillRect(bx+6,y-4,w-12,6);
  ctx.fillStyle='#664400';ctx.fillRect(bx+4,y-6,w-8,3);
  // Lid wax seal drop
  ctx.fillStyle='#aa0000';ctx.fillRect(cx-8,y-10,16,8);
  ctx.fillStyle='#cc2200';ctx.fillRect(cx-6,y-10,12,5);

  drawBossLaser(bx,y,w,h);
  drawBossHPBar(bx,y,w,h,hp,mHp,'SUPERNOVA','#ff00ff');
}

// ‚îÄ‚îÄ‚îÄ DISPATCHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawBoss(){
  if(!boss)return;
  const{x,y,w,h,hp,mHp,shk,tier}=boss;
  const ox=shk>0?(Math.floor(Math.random()*3)*4-4):0;
  const bx=x+ox;
  if(tier===0) drawLidKing(bx,y,w,h,hp,mHp,shk);
  else if(tier===1) drawFrostlock(bx,y,w,h,hp,mHp,shk);
  else if(tier===2) drawSaucepanSam(bx,y,w,h,hp,mHp,shk);
  else if(tier===3) drawCrisperLord(bx,y,w,h,hp,mHp,shk);
  else if(tier===4) drawThermosPrime(bx,y,w,h,hp,mHp,shk);
  else              drawTheSeal(bx,y,w,h,hp,mHp,shk);
}

// ‚îÄ‚îÄ Player spaceship ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawPlayer(){
  const{x,y,w,h}=player;
  const hc=lOn?'#44ffff':'#8844ff';
  const dc2=lOn?'#006688':'#330077';
  const ac=lOn?'#00ccee':'#aa55ff';

  // ‚îÄ‚îÄ Thrusters / Engine flames ‚îÄ‚îÄ
  const fT=Math.floor(Date.now()/55)%4;
  const fC=['#ff3300','#ff7700','#ffaa00','#ff5500'];
  const flH=10+fT*3;
  // Left engine
  ctx.fillStyle=fC[fT];ctx.fillRect(x+9,y+h,10,flH);ctx.fillStyle=fC[(fT+1)%4];ctx.fillRect(x+11,y+h+3,6,flH-3);ctx.fillStyle='#ffff88';ctx.fillRect(x+13,y+h,3,4);
  // Center engine
  ctx.fillStyle=fC[fT];ctx.fillRect(x+w/2-6,y+h,12,flH+5);ctx.fillStyle=fC[(fT+2)%4];ctx.fillRect(x+w/2-3,y+h,6,flH+2);ctx.fillStyle='#ffffff';ctx.fillRect(x+w/2-2,y+h,4,5);
  // Right engine
  ctx.fillStyle=fC[fT];ctx.fillRect(x+w-19,y+h,10,flH);ctx.fillStyle=fC[(fT+1)%4];ctx.fillRect(x+w-17,y+h+3,6,flH-3);ctx.fillStyle='#ffff88';ctx.fillRect(x+w-16,y+h,3,4);

  // ‚îÄ‚îÄ Left wing assembly ‚îÄ‚îÄ
  ctx.fillStyle=dc2;
  ctx.fillRect(x,y+h-22,12,22);      // main wing body
  ctx.fillRect(x-10,y+h-14,10,14);   // outer wing
  ctx.fillRect(x+8,y+h-32,10,12);    // inner strake
  ctx.fillStyle=hc;ctx.fillRect(x+2,y+h-22,6,16);// wing top stripe

  // ‚îÄ‚îÄ Right wing assembly ‚îÄ‚îÄ
  ctx.fillStyle=dc2;
  ctx.fillRect(x+w-12,y+h-22,12,22);
  ctx.fillRect(x+w,y+h-14,10,14);
  ctx.fillRect(x+w-18,y+h-32,10,12);
  ctx.fillStyle=hc;ctx.fillRect(x+w-8,y+h-22,6,16);

  // ‚îÄ‚îÄ Engine nacelles ‚îÄ‚îÄ
  ctx.fillStyle='#444466';
  ctx.fillRect(x+5,y+h-10,14,12);ctx.fillRect(x+w-19,y+h-10,14,12);
  ctx.fillStyle='#8888aa';ctx.fillRect(x+7,y+h-10,10,5);ctx.fillRect(x+w-17,y+h-10,10,5);

  // ‚îÄ‚îÄ Main hull (tapered body) ‚îÄ‚îÄ
  ctx.fillStyle=hc;
  ctx.fillRect(x+12,y+h-38,w-24,38);   // lower body
  ctx.fillRect(x+18,y+h-54,w-36,18);   // mid section
  ctx.fillRect(x+24,y+h-68,w-48,16);   // upper section
  ctx.fillRect(x+29,y+h-80,w-58,14);   // nose cone base
  ctx.fillRect(x+34,y+h-92,w-68,14);   // nose cone
  ctx.fillRect(x+38,y+h-103,w-76,13);  // tip

  // Hull shading panels
  ctx.fillStyle=dc2;
  ctx.fillRect(x+12,y+h-38,5,38);ctx.fillRect(x+w-17,y+h-38,5,38);
  ctx.fillRect(x+18,y+h-54,4,16);ctx.fillRect(x+w-22,y+h-54,4,16);
  // Panel lines
  ctx.fillStyle=dc2;
  ctx.fillRect(x+18,y+h-30,w-36,2);ctx.fillRect(x+18,y+h-18,w-36,2);

  // ‚îÄ‚îÄ Accent stripes ‚îÄ‚îÄ
  ctx.fillStyle=ac;
  ctx.fillRect(x+16,y+h-38,4,34);ctx.fillRect(x+w-20,y+h-38,4,34);

  // ‚îÄ‚îÄ Cockpit ‚îÄ‚îÄ
  ctx.fillStyle=lOn?'#00ffff':'#0099ff';
  ctx.fillRect(x+w/2-13,y+h-80,26,22);
  ctx.fillStyle=lOn?'#88ffff':'#55aaff';
  ctx.fillRect(x+w/2-13,y+h-80,9,9);
  ctx.fillStyle='#001133';ctx.fillRect(x+w/2-1,y+h-62,3,5);

  // ‚îÄ‚îÄ Main cannon ‚îÄ‚îÄ
  ctx.fillStyle='#777799';ctx.fillRect(x+w/2-5,y+h-112,10,22);
  ctx.fillStyle='#aaaacc';ctx.fillRect(x+w/2-4,y+h-115,8,5);
  ctx.fillStyle='#555566';ctx.fillRect(x+w/2-5,y+h-112,3,14);ctx.fillRect(x+w/2+2,y+h-112,3,14);
  // Cannon tip glow
  ctx.fillStyle=lOn?'#00ffcc':'#aaaaff';ctx.fillRect(x+w/2-3,y+h-116,6,4);

  // ‚îÄ‚îÄ Side cannons ‚îÄ‚îÄ
  ctx.fillStyle='#555577';
  ctx.fillRect(x+8,y+h-48,7,16);ctx.fillRect(x+w-15,y+h-48,7,16);
  ctx.fillStyle='#8888aa';ctx.fillRect(x+9,y+h-50,5,5);ctx.fillRect(x+w-14,y+h-50,5,5);
  ctx.fillStyle='#aaaacc';ctx.fillRect(x+10,y+h-51,3,3);ctx.fillRect(x+w-13,y+h-51,3,3);

  // ‚îÄ‚îÄ Shield aura ‚îÄ‚îÄ
  // Bubble shield aura
  if(typeof bubbleOn!=='undefined'&&bubbleOn){
    const flicker=bubbleFrames<60&&Math.floor(Date.now()/80)%2===0;
    const bA=flicker?.05:(.30+.18*Math.sin(Date.now()*.005));
    ctx.strokeStyle=`rgba(0,220,255,${bA})`;ctx.lineWidth=6;
    ctx.strokeRect(x-14,y+h-126,w+28,142);
    ctx.strokeStyle=`rgba(100,240,255,${bA*.5})`;ctx.lineWidth=2;
    ctx.strokeRect(x-20,y+h-132,w+40,154);
    ctx.lineWidth=1;
  } else if(shields>0){
    ctx.strokeStyle=`rgba(0,160,255,${.28+.16*Math.sin(Date.now()*.003)})`;
    ctx.lineWidth=5;ctx.strokeRect(x-8,y+h-118,w+16,134);ctx.lineWidth=1;
  }
  // ‚îÄ‚îÄ Laser charge aura ‚îÄ‚îÄ
  if(lOn){
    ctx.strokeStyle='#00ffcc';ctx.lineWidth=3;ctx.strokeRect(x-5,y+h-118,w+10,130);ctx.lineWidth=1;
  }
}

// ‚îÄ‚îÄ Laser beams ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawPlayerLaser(){
  if(!lOn)return;
  const cx=Math.floor(player.x+player.w/2);
  const alpha=Math.min(1,lFrames/24);
  ctx.save();
  ctx.globalAlpha=alpha*.18;ctx.fillStyle='#00ffcc';ctx.fillRect(cx-26,0,52,player.y+14);
  ctx.globalAlpha=alpha*.5;ctx.fillStyle='#44ffdd';ctx.fillRect(cx-10,0,20,player.y+14);
  ctx.globalAlpha=alpha;
  for(let sy=0;sy<player.y;sy+=16){ctx.fillStyle='#ffffff';ctx.fillRect(cx-4,sy,8,8);ctx.fillStyle='#00ffcc';ctx.fillRect(cx-4,sy+8,8,8);}
  const tk=Math.floor(Date.now()/50);
  for(let i=0;i<6;i++){const sy=((tk*37+i*113)%(player.y||1));const sx=cx+((tk*19+i*71)%30)-15;ctx.globalAlpha=((i+tk)%3===0)?alpha:alpha*.5;ctx.fillStyle='#ffffff';ctx.fillRect(Math.floor(sx),Math.floor(sy),6,6);}
  ctx.globalAlpha=1;ctx.restore();
}

// ‚îÄ‚îÄ Main draw call ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function draw(){
  drawBG();
  if(lOn)drawPlayerLaser();
  if(!bossUp)for(const e of enemies)drawEnemy(e);
  if(boss)drawBoss();
  drawPlayer();

  // Bullets ‚Äî player
  for(const b of bullets){
    ctx.fillStyle='#ffff00';ctx.fillRect(b.x-4,b.y-10,8,13);
    ctx.fillStyle='#ffffff';ctx.fillRect(b.x-2,b.y-10,4,5);
  }
  // Bullets ‚Äî enemy (telegraph bullets pulse orange/transparent)
  for(const b of eBullets){
    if(b._tT!==undefined&&b._tT>0){
      // Still in warning phase ‚Äî draw as pulsing outline, not solid
      const pulse=0.4+0.5*Math.sin(Date.now()*0.015);
      ctx.globalAlpha=pulse;
      ctx.fillStyle='#ffaa00';
      ctx.fillRect(b.x-b.r,b.y-b.r,b.r*2,b.r*2);
      ctx.globalAlpha=1;
      ctx.fillStyle='#ffffff';ctx.fillRect(b.x-2,b.y-2,4,4);
    } else {
      ctx.fillStyle=b.col;
      ctx.fillRect(b.x-4,b.y,8,4);ctx.fillRect(b.x-2,b.y-4,4,4);ctx.fillRect(b.x-2,b.y+4,4,4);
      ctx.fillStyle='#ffffff';ctx.fillRect(b.x-1,b.y,2,2);
    }
  }
  // Particles
  for(const p of particles){ctx.globalAlpha=p.al;ctx.fillStyle=p.col;const s=Math.max(2,p.r|0);ctx.fillRect(Math.round(p.x),Math.round(p.y),s,s);}
  ctx.globalAlpha=1;

  // Heart drops (pixel heart shape)
  for(const h of heartDrops){
    const hx=Math.floor(h.x),hy=Math.floor(h.y);
    // Pulsing glow
    ctx.globalAlpha=0.22+0.12*Math.sin(Date.now()*0.008);
    ctx.fillStyle='#ff2244';ctx.fillRect(hx-9,hy-9,18,18);
    ctx.globalAlpha=1;
    // Pixel heart
    ctx.fillStyle='#ff2244';
    ctx.fillRect(hx-5,hy-6,4,4);ctx.fillRect(hx+1,hy-6,4,4);
    ctx.fillRect(hx-7,hy-2,14,6);
    ctx.fillRect(hx-5,hy+4,10,4);
    ctx.fillRect(hx-3,hy+8,6,3);
    ctx.fillRect(hx-1,hy+11,2,2);
    ctx.fillStyle='#ff88aa';
    ctx.fillRect(hx-4,hy-5,2,2);ctx.fillRect(hx+2,hy-5,2,2);
  }
  ctx.globalAlpha=1;

  // Floating score texts
  for(const f of floatTexts){
    ctx.save();
    ctx.globalAlpha=Math.min(1,f.al);
    ctx.font="bold 10px 'Press Start 2P',monospace";
    ctx.textAlign='center';
    ctx.fillStyle='#000';ctx.fillText(f.txt,Math.floor(f.x)+1,Math.floor(f.y)+1);
    ctx.fillStyle=f.col;ctx.fillText(f.txt,Math.floor(f.x),Math.floor(f.y));
    ctx.restore();
  }

  // Ground dashes
  ctx.fillStyle='rgba(100,80,180,0.32)';for(let gx=0;gx<GW;gx+=12)ctx.fillRect(gx,GH-6,8,3);
  // Laser screen tint
  if(lOn){ctx.save();ctx.globalAlpha=.05;ctx.fillStyle='#00ffcc';ctx.fillRect(0,0,GW,GH);ctx.restore();}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPLASH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function splash(){
  ctx.fillStyle='#00000a';ctx.fillRect(0,0,GW,GH);
  // Draw stars from new arrays
  for(const s of STARS_A){ctx.globalAlpha=.35;ctx.fillStyle='#334477';ctx.fillRect(s.x,s.y,1,1);}
  for(const s of STARS_B){ctx.globalAlpha=.55;ctx.fillStyle='#5577aa';ctx.fillRect(s.x,s.y,2,2);}
  for(const s of STARS_C){ctx.globalAlpha=.8; ctx.fillStyle='#ffffff';ctx.fillRect(s.x,s.y,3,3);}
  ctx.globalAlpha=1;ctx.textAlign='center';ctx.imageSmoothingEnabled=false;
  ctx.font="28px 'Press Start 2P',monospace";ctx.fillStyle='#ff2200';ctx.fillText('TUPPER',GW/2,GH/2-62);
  ctx.fillStyle='#ff6600';ctx.fillText('WARS',GW/2,GH/2-26);
  ctx.font="9px 'Press Start 2P',monospace";ctx.fillStyle='#aaaaff';
  ctx.fillText('30 LEVELS  6 ENEMY TYPES  6 BOSSES',GW/2,GH/2+14);
  ctx.fillText('LASER  BUBBLE SHIELD  DIFFICULTY SELECT',GW/2,GH/2+34);
  ctx.font="7px 'Press Start 2P',monospace";ctx.fillStyle='#445566';
  ctx.fillText('MOVE:A/D  FIRE:Space  LASER:X  SHIELD:E  PAUSE:P',GW/2,GH/2+62);
})();

resizeCanvas();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PIXEL-ART ICONS (canvas buttons + logo + app icon)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawPixelGrid(cv,grid,bw,bh,palette,bgCol){
  const c=cv.getContext('2d');
  if(bgCol){c.fillStyle=bgCol;c.fillRect(0,0,cv.width,cv.height);}
  const ox=Math.floor((cv.width-bw*grid[0].length)/2);
  const oy=Math.floor((cv.height-bh*grid.length)/2);
  grid.forEach((row,r)=>row.forEach((v,pc)=>{
    if(v&&palette[v]){c.fillStyle=palette[v];c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}
  }));
}

function drawArrowLeft(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#0b0b1e';c.fillRect(0,0,s,s);
  const G=[
    [0,0,0,1,0,0,0,0,0,0],
    [0,0,1,1,0,0,0,0,0,0],
    [0,1,1,1,1,1,1,1,0,0],
    [1,1,1,1,1,1,1,1,1,0],
    [1,1,1,1,1,1,1,1,1,0],
    [0,1,1,1,1,1,1,1,0,0],
    [0,0,1,1,0,0,0,0,0,0],
    [0,0,0,1,0,0,0,0,0,0],
  ];
  const bw=Math.floor(s/11),bh=Math.floor(s/9);
  const ox=Math.floor((s-bw*10)/2),oy=Math.floor((s-bh*8)/2);
  G.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){c.fillStyle=pc<2?'#ccaaff':pc>7?'#7755bb':'#a78bfa';c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}
  }));
}

function drawArrowUp(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#0b0b1e';c.fillRect(0,0,s,s);
  const G=[
    [0,0,0,0,1,0,0,0,0,0],
    [0,0,0,1,1,1,0,0,0,0],
    [0,0,1,1,1,1,1,0,0,0],
    [0,1,1,1,1,1,1,1,0,0],
    [1,1,1,1,1,1,1,1,1,0],
    [0,0,0,1,1,1,0,0,0,0],
    [0,0,0,1,1,1,0,0,0,0],
    [0,0,0,1,1,1,0,0,0,0],
  ];
  const bw=Math.floor(s/11),bh=Math.floor(s/9);
  const ox=Math.floor((s-bw*10)/2),oy=Math.floor((s-bh*8)/2);
  G.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){c.fillStyle=r<2?'#ccaaff':r>6?'#7755bb':'#a78bfa';c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}
  }));
}
function drawArrowDown(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#0b0b1e';c.fillRect(0,0,s,s);
  const G=[
    [0,0,0,1,1,1,0,0,0,0],
    [0,0,0,1,1,1,0,0,0,0],
    [0,0,0,1,1,1,0,0,0,0],
    [1,1,1,1,1,1,1,1,1,0],
    [0,1,1,1,1,1,1,1,0,0],
    [0,0,1,1,1,1,1,0,0,0],
    [0,0,0,1,1,1,0,0,0,0],
    [0,0,0,0,1,0,0,0,0,0],
  ];
  const bw=Math.floor(s/11),bh=Math.floor(s/9);
  const ox=Math.floor((s-bw*10)/2),oy=Math.floor((s-bh*8)/2);
  G.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){c.fillStyle=r>6?'#ccaaff':r<1?'#7755bb':'#a78bfa';c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}
  }));
}
function drawArrowRight(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#0b0b1e';c.fillRect(0,0,s,s);
  const G=[
    [0,0,0,0,0,0,0,1,0,0],
    [0,0,0,0,0,0,1,1,0,0],
    [0,0,1,1,1,1,1,1,1,0],
    [0,1,1,1,1,1,1,1,1,1],
    [0,1,1,1,1,1,1,1,1,1],
    [0,0,1,1,1,1,1,1,1,0],
    [0,0,0,0,0,0,1,1,0,0],
    [0,0,0,0,0,0,0,1,0,0],
  ];
  const bw=Math.floor(s/11),bh=Math.floor(s/9);
  const ox=Math.floor((s-bw*10)/2),oy=Math.floor((s-bh*8)/2);
  G.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){c.fillStyle=pc>7?'#ccaaff':pc<2?'#7755bb':'#a78bfa';c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}
  }));
}

function drawFireBtn(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#160800';c.fillRect(0,0,s,s);
  // Rocket bullet shape
  const G=[
    [0,0,1,1,0,0],
    [0,1,1,1,1,0],
    [0,1,2,2,1,0],
    [0,1,1,1,1,0],
    [0,0,1,1,0,0],
    [0,0,1,1,0,0],
    [0,0,1,1,0,0],
    [0,3,3,3,3,0],
    [3,3,0,0,3,3],
    [3,0,0,0,0,3],
  ];
  const bw=Math.floor(s/8),bh=Math.floor(s/11);
  const ox=Math.floor((s-bw*6)/2),oy=Math.floor((s-bh*10)/2);
  const pal={1:'#ff9900',2:'#ffffff',3:'#ff4400'};
  G.forEach((row,r)=>row.forEach((v,pc)=>{if(pal[v]){c.fillStyle=pal[v];c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}}));
}

function drawLaserBtn(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#001510';c.fillRect(0,0,s,s);
  // Lightning bolt
  const G=[
    [0,0,1,1,1,0,0],
    [0,1,1,1,0,0,0],
    [1,1,1,0,0,0,0],
    [1,1,1,1,1,0,0],
    [0,1,1,1,1,1,0],
    [0,0,0,1,1,1,0],
    [0,0,0,0,1,1,0],
    [0,0,0,0,0,1,0],
  ];
  const bw=Math.floor(s/9),bh=Math.floor(s/9);
  const ox=Math.floor((s-bw*7)/2),oy=Math.floor((s-bh*8)/2);
  G.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){c.fillStyle=r<2?'#ffffff':r<4?'#aaffee':'#06d6a0';c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}
  }));
}

function drawShieldBtn(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#00101a';c.fillRect(0,0,s,s);
  // Hexagonal bubble shield
  const G=[
    [0,0,1,1,1,1,0,0],
    [0,1,0,0,0,0,1,0],
    [1,0,0,2,2,0,0,1],
    [1,0,2,0,0,0,0,1],
    [1,0,0,0,0,0,0,1],
    [1,0,0,0,0,2,0,1],
    [0,1,0,0,0,0,1,0],
    [0,0,1,1,1,1,0,0],
  ];
  const bw=Math.floor(s/10),bh=Math.floor(s/10);
  const ox=Math.floor((s-bw*8)/2),oy=Math.floor((s-bh*8)/2);
  const pal={1:'#00aaff',2:'#88ddff'};
  G.forEach((row,r)=>row.forEach((v,pc)=>{if(pal[v]){c.fillStyle=pal[v];c.fillRect(ox+pc*bw,oy+r*bh,bw,bh);}}));
}

function drawPauseBtn(cv){
  const c=cv.getContext('2d'),s=cv.width;
  c.fillStyle='#080814';c.fillRect(0,0,s,s);
  const bw=Math.floor(s*.2),bh=Math.floor(s*.54),oy=Math.floor(s*.23);
  // Left bar
  c.fillStyle='#aaaaff';c.fillRect(Math.floor(s*.18),oy,bw,bh);
  c.fillStyle='#8888cc';c.fillRect(Math.floor(s*.18),oy,2,bh);
  // Right bar
  c.fillStyle='#aaaaff';c.fillRect(Math.floor(s*.62),oy,bw,bh);
  c.fillStyle='#8888cc';c.fillRect(Math.floor(s*.62),oy,2,bh);
}

function drawSidebarLogo(cv){
  const c=cv.getContext('2d'),w=cv.width,h=cv.height;
  c.clearRect(0,0,w,h);
  // Tiny 5x6 skull pixel art
  const G=[[0,1,1,1,0],[1,0,0,0,1],[1,1,0,1,1],[1,1,1,1,1],[0,1,0,1,0],[0,1,1,1,0]];
  const ps=Math.floor(Math.min(w/5,h/6)*0.8);
  const ox=Math.floor((w-5*ps)/2),oy=Math.floor((h-6*ps)/2);
  G.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){
      c.fillStyle=r<2?'#ff6b35':r===2?'#ff4400':'#cc3300';
      c.fillRect(ox+pc*ps,oy+r*ps,ps,ps);
    }
  }));
}

function generateAppIcon(){
  const ic=document.createElement('canvas');ic.width=512;ic.height=512;
  const c=ic.getContext('2d');
  // Background
  const bg=c.createRadialGradient(256,180,20,256,256,300);
  bg.addColorStop(0,'#1a0000');bg.addColorStop(0.6,'#0a0008');bg.addColorStop(1,'#000000');
  c.fillStyle=bg;c.fillRect(0,0,512,512);
  // Red frame
  c.strokeStyle='#cc2200';c.lineWidth=20;c.strokeRect(10,10,492,492);
  c.strokeStyle='#ff440044';c.lineWidth=8;c.strokeRect(22,22,468,468);
  // Title text
  c.fillStyle='#ff2200';c.font="bold 60px monospace";c.textAlign='center';c.fillText('TUPPER',256,130);
  c.fillStyle='#ff8800';c.fillText('WARS',256,200);
  // Big pixel skull (12x10 grid at 32px each)
  const SK=[
    [0,0,1,1,1,1,1,1,0,0,0,0],
    [0,1,1,1,1,1,1,1,1,0,0,0],
    [1,1,1,1,1,1,1,1,1,1,0,0],
    [1,1,0,0,1,1,1,0,0,1,1,0],
    [1,1,0,0,1,1,1,0,0,1,1,0],
    [1,1,1,1,1,1,1,1,1,1,0,0],
    [1,1,1,0,1,1,1,0,1,1,1,0],
    [0,1,1,1,1,1,1,1,1,1,0,0],
    [0,0,1,0,0,1,0,0,1,0,0,0],
    [0,0,1,1,0,1,0,1,1,0,0,0],
  ];
  const PS2=30,sw2=12*PS2,sh2=10*PS2,sx=(512-sw2)/2,sy=240;
  SK.forEach((row,r)=>row.forEach((p,pc)=>{
    if(p){
      c.fillStyle=r<3?'#ffffff':r<6?'#dddddd':'#bb0000';
      c.fillRect(Math.floor(sx+pc*PS2),Math.floor(sy+r*PS2),PS2,PS2);
      c.fillStyle='rgba(255,255,255,0.2)';c.fillRect(Math.floor(sx+pc*PS2),Math.floor(sy+r*PS2),8,8);
    }
  }));
  // Glow under skull
  const gl=c.createRadialGradient(256,490,10,256,440,100);
  gl.addColorStop(0,'rgba(255,80,0,0.5)');gl.addColorStop(1,'rgba(0,0,0,0)');
  c.fillStyle=gl;c.fillRect(100,380,312,132);
  // Stars in background
  for(let i=0;i<40;i++){
    const sx2=(i*7919+12345)%480+16,sy2=(i*6173+54321)%200+16;
    c.fillStyle='rgba(255,255,255,0.6)';c.fillRect(sx2,sy2,3,3);
  }
  const lnk=document.querySelector("link[rel='icon']")||document.createElement('link');
  lnk.rel='icon';lnk.href=ic.toDataURL();
  if(!lnk.parentNode)document.head.appendChild(lnk);
  // Also set apple-touch-icon
  const ati=document.getElementById('ati-link');
  if(ati)ati.href=ic.toDataURL();
}

function wireCanvasBtn(id,prop,cb){
  const el=document.getElementById(id);if(!el)return;
  const dn=pid=>{BP[pid]=prop;TK[prop]=true;el.classList.add('tapped');if(cb)cb();};
  const up=pid=>{if(BP[pid]===prop){delete BP[pid];if(!Object.values(BP).includes(prop)){TK[prop]=false;el.classList.remove('tapped');}}};
  el.addEventListener('pointerdown',ev=>{ev.preventDefault();el.setPointerCapture(ev.pointerId);dn(ev.pointerId);},{passive:false});
  el.addEventListener('pointerup',ev=>{ev.preventDefault();up(ev.pointerId);},{passive:false});
  el.addEventListener('pointercancel',ev=>{ev.preventDefault();up(ev.pointerId);},{passive:false});
  el.addEventListener('pointerleave',ev=>{if(!el.hasPointerCapture(ev.pointerId))up(ev.pointerId);});
}

setTimeout(()=>{
  const cvL=document.getElementById('cb-left');   if(cvL)drawArrowLeft(cvL);
  const cvR=document.getElementById('cb-right');  if(cvR)drawArrowRight(cvR);
  const cvU=document.getElementById('cb-up');     if(cvU)drawArrowUp(cvU);
  const cvDn=document.getElementById('cb-down');  if(cvDn)drawArrowDown(cvDn);
  const cvF=document.getElementById('cb-fire');   if(cvF)drawFireBtn(cvF);
  const cvLa=document.getElementById('cb-laser'); if(cvLa)drawLaserBtn(cvLa);
  const cvSh=document.getElementById('cb-shield');if(cvSh)drawShieldBtn(cvSh);
  const cvPa=document.getElementById('cb-pause'); if(cvPa)drawPauseBtn(cvPa);
  try{generateAppIcon();}catch(e){}
  wireCanvasBtn('cb-left','left');
  wireCanvasBtn('cb-right','right');
  wireCanvasBtn('cb-up','up');
  wireCanvasBtn('cb-down','down');
  wireCanvasBtn('cb-fire','fire',()=>{if(running&&!paused)doShoot();});
  wireCanvasBtn('cb-laser','laser',()=>{if(running&&!paused)doLaser();});
  wireCanvasBtn('cb-shield','shield',()=>{if(running&&!paused)doBubble();});
  wireCanvasBtn('cb-pause','pause',()=>{if(running)doPause();});

  // Draw main menu title canvas
  const mmCv=document.getElementById('mm-canvas');
  if(mmCv){
    const c=mmCv.getContext('2d'),w=mmCv.width,h=mmCv.height;
    c.clearRect(0,0,w,h);
    c.font="bold 52px 'Press Start 2P',monospace";
    c.textAlign='center';
    // deep shadow
    c.fillStyle='#1a0000';c.fillText('TUPPER',w/2+5,56);c.fillText('WARS',w/2+5,105);
    c.fillStyle='#550000';c.fillText('TUPPER',w/2+2,53);c.fillText('WARS',w/2+2,102);
    // fiery gradient
    const grd=c.createLinearGradient(0,0,0,h);
    grd.addColorStop(0,'#ffaa00');grd.addColorStop(0.35,'#ff4400');
    grd.addColorStop(0.7,'#cc0000');grd.addColorStop(1,'#880000');
    c.fillStyle=grd;
    c.fillText('TUPPER',w/2,50);c.fillText('WARS',w/2,99);
    // scanline sheen
    c.globalAlpha=0.10;c.fillStyle='#ffffff';
    for(let sy=0;sy<h;sy+=4)c.fillRect(0,sy,w,2);
    c.globalAlpha=1;
  }

  // Animated menu background
  const mmBg=document.getElementById('mm-bg-canvas');
  if(mmBg){
    mmBg.width=window.innerWidth;mmBg.height=window.innerHeight;
    const bc=mmBg.getContext('2d');
    // Generate star field for menu
    const menuStars=Array.from({length:180},()=>({
      x:Math.random()*mmBg.width,y:Math.random()*mmBg.height,
      r:Math.random()*1.8+0.3,spd:Math.random()*0.4+0.05,
      br:Math.random(),phase:Math.random()*Math.PI*2,
    }));
    // ‚îÄ‚îÄ Menu ship + enemies sim ‚îÄ‚îÄ
    const mmShip={x:mmBg.width*.5,y:mmBg.height*.75,vx:1.2,vy:0};
    const mmEnemies=Array.from({length:12},(_,i)=>({
      x:80+Math.random()*(mmBg.width-160),y:30+Math.random()*(mmBg.height*.45),
      vx:(Math.random()-.5)*1.2,vy:Math.random()*.3+.1,
      w:28,h:22,col:['#06d6a0','#ff9f1c','#ef476f','#a78bfa','#00ddff'][i%5],
      hp:3,
    }));
    const mmBullets=[];
    const mmExplosions=[];
    let mmShootCD=0;

    function drawPixelShip(ctx,x,y,scale){
      const s=scale||1;
      ctx.fillStyle='#aaddff';
      ctx.fillRect(x-2*s,y,4*s,8*s);
      ctx.fillRect(x-8*s,y+5*s,16*s,5*s);
      ctx.fillRect(x-14*s,y+8*s,28*s,4*s);
      ctx.fillStyle='#ff6b35';
      ctx.fillRect(x-6*s,y+10*s,4*s,5*s);
      ctx.fillRect(x+2*s,y+10*s,4*s,5*s);
      ctx.fillStyle='#fff';
      ctx.fillRect(x-1*s,y+1*s,2*s,3*s);
    }
    function drawPixelEnemy(ctx,x,y,col){
      ctx.fillStyle=col;
      ctx.fillRect(x-10,y,20,14);
      ctx.fillRect(x-14,y+5,28,6);
      ctx.fillStyle='#ff2244';
      ctx.fillRect(x-4,y+9,4,4);ctx.fillRect(x,y+9,4,4);
    }

    let mmT=0;
    function animMenuBg(){
      if(!document.getElementById('main-menu').classList.contains('hidden')){
        const bw=mmBg.width,bh=mmBg.height;
        // Deep space bg
        bc.fillStyle='#00000a';bc.fillRect(0,0,bw,bh);
        // Nebula hint
        const ng=bc.createRadialGradient(bw*.3,bh*.4,20,bw*.3,bh*.4,bh*.6);
        ng.addColorStop(0,'rgba(80,0,120,0.12)');ng.addColorStop(1,'transparent');
        bc.fillStyle=ng;bc.fillRect(0,0,bw,bh);
        const ng2=bc.createRadialGradient(bw*.75,bh*.6,10,bw*.75,bh*.6,bh*.5);
        ng2.addColorStop(0,'rgba(120,30,0,0.10)');ng2.addColorStop(1,'transparent');
        bc.fillStyle=ng2;bc.fillRect(0,0,bw,bh);
        // Animate stars
        for(const s of menuStars){
          s.y-=s.spd;if(s.y<0)s.y=bh;
          const tw=0.4+0.6*Math.sin(mmT*0.03+s.phase);
          bc.globalAlpha=tw*(0.4+s.br*0.5);
          bc.fillStyle=s.br>0.8?'#ffddaa':s.br>0.5?'#aabbff':'#ffffff';
          bc.fillRect(s.x,s.y,s.r,s.r);
          if(s.br>0.85&&tw>0.8){
            bc.globalAlpha=tw*0.3;bc.fillStyle='#ffffff';
            bc.fillRect(s.x-2,s.y,5,1);bc.fillRect(s.x,s.y-2,1,5);
          }
        }
        bc.globalAlpha=1;

        // ‚îÄ‚îÄ Ship + enemies ‚îÄ‚îÄ
        if(mmT%2===0){ // update every other frame
          // Move ship
          mmShip.x+=mmShip.vx;
          if(mmShip.x<60||mmShip.x>bw-60)mmShip.vx*=-1;
          // Move enemies
          for(const e of mmEnemies){
            e.x+=e.vx;e.y+=e.vy;
            if(e.x<20||e.x>bw-20){e.vx*=-1;}
            if(e.y>bh*.55){e.vy=-(Math.random()*.3+.1);e.y=bh*.55;}
            if(e.y<20){e.vy=Math.random()*.3+.1;}
          }
          // Ship auto-fires at nearest enemy
          mmShootCD--;
          if(mmShootCD<=0&&mmEnemies.length>0){
            mmShootCD=18;
            let nearest=null,nd=9999;
            for(const e of mmEnemies){const d=Math.abs(e.x-mmShip.x);if(d<nd){nd=d;nearest=e;}}
            if(nearest)mmBullets.push({x:mmShip.x,y:mmShip.y-8,vx:(nearest.x-mmShip.x)*.04,vy:-5,target:nearest});
          }
          // Move bullets
          for(const b of mmBullets){b.x+=b.vx;b.y+=b.vy;}
          // Bullet hits
          for(let bi=mmBullets.length-1;bi>=0;bi--){
            const b=mmBullets[bi];
            for(let ei=mmEnemies.length-1;ei>=0;ei--){
              const e=mmEnemies[ei];
              if(Math.abs(b.x-e.x)<14&&Math.abs(b.y-e.y)<12){
                mmBullets.splice(bi,1);e.hp--;
                if(e.hp<=0){
                  mmExplosions.push({x:e.x,y:e.y,t:20,col:e.col});
                  mmEnemies.splice(ei,1);
                  // Respawn
                  setTimeout(()=>mmEnemies.push({
                    x:20+Math.random()*(bw-40),y:20+Math.random()*(bh*.4),
                    vx:(Math.random()-.5)*1.2,vy:Math.random()*.3+.1,
                    w:28,h:22,col:['#06d6a0','#ff9f1c','#ef476f','#a78bfa','#00ddff'][Math.floor(Math.random()*5)],
                    hp:3,
                  }),1200+Math.random()*1500);
                }
                break;
              }
            }
          }
          // Clean up
          for(let i=mmExplosions.length-1;i>=0;i--){mmExplosions[i].t--;if(mmExplosions[i].t<=0)mmExplosions.splice(i,1);}
          mmBullets.splice(0,mmBullets.length,...mmBullets.filter(b=>b.y>-20&&b.y<bh+20&&b.x>0&&b.x<bw));
        }

        // Draw enemies
        bc.globalAlpha=0.55;
        for(const e of mmEnemies)drawPixelEnemy(bc,e.x,e.y,e.col);
        // Draw bullets
        bc.globalAlpha=0.75;bc.fillStyle='#00ffcc';
        for(const b of mmBullets)bc.fillRect(b.x-2,b.y-5,4,10);
        // Draw explosions
        for(const ex of mmExplosions){
          const p=ex.t/20;
          bc.globalAlpha=p*0.6;bc.fillStyle=ex.col;
          bc.fillRect(ex.x-12*p,ex.y-10*p,24*p,20*p);
          bc.globalAlpha=p*0.4;bc.fillStyle='#ffffff';
          bc.fillRect(ex.x-6*p,ex.y-5*p,12*p,10*p);
        }
        // Draw ship
        bc.globalAlpha=0.7;
        drawPixelShip(bc,mmShip.x,mmShip.y,1.5);
        bc.globalAlpha=1;

        mmT++;
      }
      requestAnimationFrame(animMenuBg);
    }
    function resizeMenuBg(){mmBg.width=window.innerWidth;mmBg.height=window.innerHeight;}
  window.addEventListener('resize',resizeMenuBg);resizeMenuBg();
    animMenuBg();
    // Start main menu music after brief delay
    setTimeout(startMMMusic,200);
  }

  // Wire stats button
  document.getElementById('set-stats-btn').addEventListener('click',()=>{
    sfxMenuClick();buildStatsGrid();
    document.getElementById('stats-screen').style.display='flex';
    document.getElementById('settings-screen').style.display='none';
  });
  document.getElementById('stats-back').addEventListener('click',()=>{
    sfxMenuBack();
    document.getElementById('stats-screen').style.display='none';
    document.getElementById('settings-screen').style.display='flex';
  });

  // Wire reset button
  document.getElementById('set-reset-btn').addEventListener('click',()=>{
    sfxMenuClick();
    document.getElementById('reset-confirm-overlay').style.display='flex';
  });
  document.getElementById('reset-cancel-btn').addEventListener('click',()=>{
    sfxMenuBack();
    document.getElementById('reset-confirm-overlay').style.display='none';
    document.getElementById('reset-step1').style.display='flex';
    document.getElementById('reset-step2').style.display='none';
  });
  document.getElementById('reset-cancel-btn2').addEventListener('click',()=>{
    sfxMenuBack();
    document.getElementById('reset-confirm-overlay').style.display='none';
    document.getElementById('reset-step1').style.display='flex';
    document.getElementById('reset-step2').style.display='none';
  });
  document.getElementById('reset-confirm-btn').addEventListener('click',()=>{
    sfxMenuClick();
    // Show step 2 confirmation
    document.getElementById('reset-step1').style.display='none';
    document.getElementById('reset-step2').style.display='flex';
  });
  document.getElementById('reset-confirm-btn2').addEventListener('click',()=>{
    doResetProgress();
  });

  // Stop MM music when starting game, restart when returning to menu
  const _origBegin=window._beginLvl;

},100);

</script>
</body>
</html>
